////////////////////////////////////////////////////////////////////////////////
// MRS_ИнтеграцияЕЛМАСервер: Серверный модуль интеграции с системой ЕЛМА
//
// Обеспечивает:
// - Авторизацию в ЕЛМА через REST API
// - Отправку документов "Установка цен номенклатуры" в ЕЛМА
// - Опрос и синхронизацию статусов процессов согласования
// - Автоматическое проведение документов при подписании приказов
// - Выгрузку цен в Simphony после проведения
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область РегламентныеПроцедуры

// Главная функция регламентного задания интеграции с ЕЛМА
// Выполняет последовательно:
// 1. Обработку очереди отправки документов
// 2. Опрос статусов процессов в ЕЛМА
// 3. Проведение документов по дате применения
//
// Главная функция регламентного задания интеграции с ЕЛМА
// Версия 3.0 (callback-архитектура)
// 
// Выполняет последовательно:
// 1. Обработку очереди отправки документов
// 2. Проведение документов по дате применения (статусы обновляются через callback)
//
Процедура ВыполнитьИнтеграциюЕЛМА() Экспорт
	
	ЗаписатьЛог("Запуск регламентного задания интеграции с ЕЛМА (v3.0, callback)", УровеньЖурналаРегистрации.Информация);
	
	// 1. Обработка очереди отправки
	Попытка
		
		РезультатОтправки = ОбработатьОчередьОтправки();
		ЗаписатьЛог(СтрШаблон("Обработка очереди завершена. Отправлено: %1, Ошибок: %2", 
			РезультатОтправки.Отправлено, РезультатОтправки.Ошибок), УровеньЖурналаРегистрации.Информация);
		
	Исключение
		
		ЗаписатьЛог("Ошибка при обработке очереди отправки: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			УровеньЖурналаРегистрации.Ошибка);
		
	КонецПопытки;
	
	// 2. Опрос статусов процессов УДАЛЕН (v3.0)
	// Статусы теперь обновляются через callback от ЕЛМА в реал-тайм
	
	// 3. Проведение документов по дате применения
	Попытка
		
		РезультатПроведения = ПровестиДокументыПоДатеПрименения();
		ЗаписатьЛог(СтрШаблон("Проведение документов завершено. Проведено: %1, Ошибок: %2", 
			РезультатПроведения.Проведено, РезультатПроведения.Ошибок), УровеньЖурналаРегистрации.Информация);
		
	Исключение
		
		ЗаписатьЛог("Ошибка при проведении документов: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			УровеньЖурналаРегистрации.Ошибка);
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСОчередью

// Проверяет необходимость отправки документа в ЕЛМА при проведении
// Вызывается из подписки ПередЗаписью документа УстановкаЦенНоменклатуры
//
// Параметры:
//  Документ - ДокументОбъект.УстановкаЦенНоменклатуры - проводимый документ
//  Отказ - Булево - флаг отказа от записи
//
Процедура ПроверитьНеобходимостьОтправкиВЕЛМА(Документ, Отказ) Экспорт
	
	// Проверяем, нужна ли отправка в ЕЛМА
	// ЕСЛИ ВидЦены привязан к питУдаленныеКассы → открыть форму параметров приказа
	Если НЕ ТребуетсяОтправкаВЕЛМА(Документ) Тогда
		Возврат;
	КонецЕсли;
	
	// Открытие формы параметров приказа будет реализовано на клиенте
	// через механизм ПриЗаписиНаСервере с интерактивной формой
	
КонецПроцедуры

// Отправляет документ в ЕЛМА немедленно (без очереди)
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - документ для отправки
//  ПараметрыПриказа - Структура - параметры приказа из формы:
//   * ОтветственныйЗаИсполнение - СправочникСсылка.ФизическиеЛица
//   * СписокКОзнакомлению - ТаблицаЗначений с колонкой ФизическоеЛицо
//   * ДатаНачалаДействия - Дата
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ТекстОшибки - Строка - текст ошибки при неудаче
//   * УИДЕЛМА - Строка - УИД процесса в ЕЛМА при успехе
//
Функция ОтправитьДокументВЕЛМАНемедленно(ДокументСсылка, ПараметрыПриказа) Экспорт
	
	Результат = Новый Структура("Успех, ТекстОшибки", Ложь, "");
	
	Попытка
		
		// 1. Валидация параметров
		РезультатВалидации = ВалидироватьДокументПередОтправкой(ДокументСсылка, ПараметрыПриказа);
		Если НЕ РезультатВалидации.Успех Тогда
			
			Результат.ТекстОшибки = СтрСоединить(РезультатВалидации.МассивОшибок, Символы.ПС);
			Возврат Результат;
			
		КонецЕсли;
		
		// 2. Генерация UID документа для ЕЛМА (ключ для callback)
		UidДокумента1С = ГенерироватьUidДокумента1С(ДокументСсылка);
		
		// 3. Авторизация в ЕЛМА
		РезультатАвторизации = АвторизоватьсяВЕЛМА();
		Если НЕ РезультатАвторизации.Успех Тогда
			
			Результат.ТекстОшибки = "Ошибка авторизации в ЕЛМА: " + РезультатАвторизации.ТекстОшибки;
			ЗаписатьЛог(Результат.ТекстОшибки, УровеньЖурналаРегистрации.Ошибка);
			Возврат Результат;
			
		КонецЕсли;
		
		AuthToken = РезультатАвторизации.Токен;
		
		// 4. Отправка документа в ЕЛМА
		РезультатОтправки = ОтправитьВЕЛМА(ДокументСсылка, AuthToken, ПараметрыПриказа);
		
		Если РезультатОтправки.Успех Тогда
			
			// 5. Сохранение результата в регистре (новая логика v3.0)
			МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.UidДокумента1С = UidДокумента1С;
			МенеджерЗаписи.Документ1С = ДокументСсылка;
			
			// Статус = "Отправлен" (НЕ "НаСогласовании"!)
			// УИДЕЛМА пока НЕ заполнен (придет через callback от ЕЛМА)
			МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииELMA.Отправлен;
			МенеджерЗаписи.ДатаОтправки = ТекущаяДатаСеанса();
			МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
			МенеджерЗаписи.ДатаПоследнейПопытки = ТекущаяДатаСеанса();
			МенеджерЗаписи.КоличествоПопыток = 0;
			МенеджерЗаписи.ТекстОшибки = "";
			
			// Сохраняем параметры приказа в поле Запрос (JSON)
			ЗаписьJSON = Новый ЗаписьJSON;
			ЗаписьJSON.УстановитьСтроку();
			ЗаписатьJSON(ЗаписьJSON, ПараметрыПриказа);
			JSONПараметров = ЗаписьJSON.Закрыть();
			МенеджерЗаписи.Запрос = JSONПараметров;
			
			// Сохраняем JSON запроса для отладки
			Если РезультатОтправки.Свойство("JSONЗапроса") Тогда
				МенеджерЗаписи.Запрос = РезультатОтправки.JSONЗапроса;
			КонецЕсли;
			
			// Сохраняем ответ от ЕЛМА
			Если РезультатОтправки.Свойство("JSONОтвета") Тогда
				МенеджерЗаписи.Ответ = РезультатОтправки.JSONОтвета;
			КонецЕсли;
			
			МенеджерЗаписи.Записать();
			
			ЗаписатьЛог(СтрШаблон("Документ %1 (UID: %2) успешно отправлен в ЕЛМА (result: True). " + 
				"Ожидание callback с УИДЕЛМА и статусом.", ДокументСсылка, UidДокумента1С), 
				УровеньЖурналаРегистрации.Информация);
			
			Результат.Успех = Истина;
			
		Иначе
			
			Результат.ТекстОшибки = РезультатОтправки.ТекстОшибки;
			ЗаписатьЛог(СтрШаблон("Ошибка отправки документа %1 в ЕЛМА: %2", 
				ДокументСсылка, РезультатОтправки.ТекстОшибки), УровеньЖурналаРегистрации.Ошибка);
			
		КонецЕсли;
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписатьЛог("Критическая ошибка при отправке документа в ЕЛМА: " + Результат.ТекстОшибки, 
			УровеньЖурналаРегистрации.Ошибка);
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Ставит документ в очередь на отправку в ЕЛМА
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - документ для отправки
//  ПараметрыПриказа - Структура - параметры приказа из формы:
//   * ОтветственныйЗаИсполнение - СправочникСсылка.ФизическиеЛица
//   * СписокКОзнакомлению - ТаблицаЗначений с колонкой ФизическоеЛицо
//
// Возвращаемое значение:
//  Булево - Истина если документ поставлен в очередь
//
Функция ПоставитьДокументВОчередьЕЛМА(ДокументСсылка, ПараметрыПриказа) Экспорт
	
	Попытка
		
		// Валидация параметров
		РезультатВалидации = ВалидироватьДокументПередОтправкой(ДокументСсылка, ПараметрыПриказа);
		Если НЕ РезультатВалидации.Успех Тогда
			
			// Формируем текст ошибки из массива
			ТекстОшибки = СтрСоединить(РезультатВалидации.МассивОшибок, Символы.ПС);
			ВызватьИсключение ТекстОшибки;
			
		КонецЕсли;
		
		// Генерация UID документа для ЕЛМА (ключ для callback)
		UidДокумента1С = ГенерироватьUidДокумента1С(ДокументСсылка);
		
		// Создание записи в регистре MRS_ПроцессыЕЛМА (новая структура с UidДокумента1С)
		МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.UidДокумента1С = UidДокумента1С;
		МенеджерЗаписи.Документ1С = ДокументСсылка;
		МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииELMA.ВОчереди;
		МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
		МенеджерЗаписи.ДатаПоследнейПопытки = ТекущаяДатаСеанса();
		МенеджерЗаписи.КоличествоПопыток = 0;
		
		// Сохраняем параметры приказа в поле Запрос (JSON)
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, ПараметрыПриказа);
		JSONПараметров = ЗаписьJSON.Закрыть();
		
		МенеджерЗаписи.Запрос = JSONПараметров;
		
		МенеджерЗаписи.Записать();
		
		ЗаписатьЛог(СтрШаблон("Документ %1 (UID: %2) поставлен в очередь ЕЛМА", 
			ДокументСсылка, UidДокумента1С), УровеньЖурналаРегистрации.Информация);
		
		Возврат Истина;
		
	Исключение
		
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписатьЛог("Ошибка постановки документа в очередь ЕЛМА: " + ТекстОшибки, 
			УровеньЖурналаРегистрации.Ошибка);
		
		Возврат Ложь;
		
	КонецПопытки;
	
КонецФункции

// Обрабатывает очередь документов на отправку в ЕЛМА
//
// Возвращаемое значение:
//  Структура:
//   * Отправлено - Число - количество успешно отправленных документов
//   * Ошибок - Число - количество ошибок
//
Функция ОбработатьОчередьОтправки() Экспорт
	
	Результат = Новый Структура("Отправлено, Ошибок", 0, 0);
	
	// Авторизация в ЕЛМА
	РезультатАвторизации = АвторизоватьсяВЕЛМА();
	Если НЕ РезультатАвторизации.Успех Тогда
		ЗаписатьЛог("Не удалось авторизоваться в ЕЛМА: " + РезультатАвторизации.ТекстОшибки, 
			УровеньЖурналаРегистрации.Ошибка);
		Возврат Результат;
	КонецЕсли;
	
	AuthToken = РезультатАвторизации.Токен;
	
	// Выборка документов из очереди (максимум 10 за раз)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 10
		|	ПроцессыЕЛМА.UidДокумента1С КАК UidДокумента1С,
		|	ПроцессыЕЛМА.Документ1С КАК Документ1С,
		|	ПроцессыЕЛМА.КоличествоПопыток КАК КоличествоПопыток,
		|	ПроцессыЕЛМА.Запрос КАК JSONПараметров
		|ИЗ
		|	РегистрСведений.MRS_ПроцессыELMA КАК ПроцессыЕЛМА
		|ГДЕ
		|	(ПроцессыЕЛМА.Статус = ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииELMA.ВОчереди)
		|		ИЛИ ПроцессыЕЛМА.Статус = ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииELMA.Ошибка)
		|			И ПроцессыЕЛМА.КоличествоПопыток < 3)
		|
		|УПОРЯДОЧИТЬ ПО
		|	ПроцессыЕЛМА.ДатаПоследнейПопытки";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Попытка
			
			// Восстанавливаем параметры приказа из поля Запрос (JSON)
			Если ПустаяСтрока(Выборка.JSONПараметров) Тогда
				
				ЗаписатьЛог(СтрШаблон("Для документа %1 отсутствуют параметры приказа", Выборка.Документ1С), 
					УровеньЖурналаРегистрации.Предупреждение);
				Продолжить;
				
			КонецЕсли;
			
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(Выборка.JSONПараметров);
			ПараметрыПриказа = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			// Отправка в ЕЛМА
			РезультатОтправки = ОтправитьВЕЛМА(Выборка.Документ1С, AuthToken, ПараметрыПриказа);
			
			Если РезультатОтправки.Успех Тогда
				
				// Обновление записи в регистре (новая логика для callback-архитектуры)
				МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.UidДокумента1С = Выборка.UidДокумента1С;
				МенеджерЗаписи.Прочитать();
				
				Если МенеджерЗаписи.Выбран() Тогда
					
					// Статус = "Отправлен" (НЕ "НаСогласовании"!)
					// УИДЕЛМА пока НЕ заполнен (придет через callback от ЕЛМА)
					МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отправлен;
					МенеджерЗаписи.ДатаОтправки = ТекущаяДатаСеанса();
					МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
					МенеджерЗаписи.ТекстОшибки = "";
					МенеджерЗаписи.КоличествоПопыток = 0;
					
					// Сохраняем JSON запроса для отладки и повторной отправки
					Если РезультатОтправки.Свойство("JSONЗапроса") Тогда
						МенеджерЗаписи.Запрос = РезультатОтправки.JSONЗапроса;
					КонецЕсли;
					
					// Сохраняем ответ от ЕЛМА
					Если РезультатОтправки.Свойство("JSONОтвета") Тогда
						МенеджерЗаписи.Ответ = РезультатОтправки.JSONОтвета;
					КонецЕсли;
					
					МенеджерЗаписи.Записать();
					
				КонецЕсли;
				
				Результат.Отправлено = Результат.Отправлено + 1;
				
			Иначе
				
				// Обработка ошибки
				МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.UidДокумента1С = Выборка.UidДокумента1С;
				МенеджерЗаписи.Прочитать();
				
				Если МенеджерЗаписи.Выбран() Тогда
					
					МенеджерЗаписи.КоличествоПопыток = МенеджерЗаписи.КоличествоПопыток + 1;
					МенеджерЗаписи.ТекстОшибки = РезультатОтправки.ТекстОшибки;
					МенеджерЗаписи.ДатаПоследнейПопытки = ТекущаяДатаСеанса();
					МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
					
					Если МенеджерЗаписи.КоличествоПопыток >= 3 Тогда
						МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ТребуетВнимания;
					Иначе
						МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Ошибка;
					КонецЕсли;
					
					МенеджерЗаписи.Записать();
					
				КонецЕсли;
				
				Результат.Ошибок = Результат.Ошибок + 1;
				
			КонецЕсли;
			
		Исключение
			
			ЗаписатьЛог(СтрШаблон("Ошибка отправки документа %1: %2", 
				Выборка.Документ1С, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())), 
				УровеньЖурналаРегистрации.Ошибка);
			Результат.Ошибок = Результат.Ошибок + 1;
			
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область CallbackОтЕЛМА

// Обрабатывает callback от ЕЛМА с обновлением статуса процесса
// Вызывается из HTTP сервиса при приеме уведомления от ЕЛМА
//
// Параметры:
//  RequestErp - Структура - данные от ЕЛМА:
//   * Uid_ERP - Строка - UID документа 1С
//   * Uid_Elma - Строка - UID процесса в ЕЛМА
//   * Status - Строка - новый статус (НаСогласовании, Согласован, Подписан, Отклонен, Отменен)
//   * URLProcess - Строка - ссылка на процесс в ЕЛМА
//  ТелоЗапросаJSON - Строка - исходный JSON для логирования
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ТекстОшибки - Строка
//
Функция ОбработатьCallbackОтЕЛМА(RequestErp, ТелоЗапросаJSON) Экспорт
	
	Результат = Новый Структура("Успех, ТекстОшибки", Ложь, "");
	
	Попытка
		
		// 1. Поиск записи в регистре по UidДокумента1С
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ПроцессыЕЛМА.UidДокумента1С КАК UidДокумента1С,
			|	ПроцессыЕЛМА.Документ1С КАК Документ1С,
			|	ПроцессыЕЛМА.УИДЕЛМА КАК УИДЕЛМА,
			|	ПроцессыЕЛМА.Статус КАК Статус
			|ИЗ
			|	РегистрСведений.MRS_ПроцессыELMA КАК ПроцессыЕЛМА
			|ГДЕ
			|	ПроцессыЕЛМА.UidДокумента1С = &UidДокумента1С";
		
		Запрос.УстановитьПараметр("UidДокумента1С", RequestErp.Uid_ERP);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если НЕ Выборка.Следующий() Тогда
			
			Результат.ТекстОшибки = СтрШаблон("Документ с Uid_ERP '%1' не найден в регистре MRS_ПроцессыELMA", 
				RequestErp.Uid_ERP);
			ЗаписатьЛог(Результат.ТекстОшибки, УровеньЖурналаРегистрации.Предупреждение);
			Возврат Результат;
			
		КонецЕсли;
		
		// 2. Обновление записи в регистре
		МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.UidДокумента1С = RequestErp.Uid_ERP;
		МенеджерЗаписи.Прочитать();
		
		Если НЕ МенеджерЗаписи.Выбран() Тогда
			
			Результат.ТекстОшибки = "Не удалось прочитать запись из регистра";
			ЗаписатьЛог(Результат.ТекстОшибки, УровеньЖурналаРегистрации.Ошибка);
			Возврат Результат;
			
		КонецЕсли;
		
		СтарыйСтатус = МенеджерЗаписи.Статус;
		
		// Заполняем УИДЕЛМА, если пришел впервые
		Если ПустаяСтрока(МенеджерЗаписи.УИДЕЛМА) И RequestErp.Свойство("Uid_Elma") 
			И ЗначениеЗаполнено(RequestErp.Uid_Elma) Тогда
			
			МенеджерЗаписи.УИДЕЛМА = RequestErp.Uid_Elma;
			
		КонецЕсли;
		
		// Обновляем статус
		НовыйСтатус = ПолучитьСтатусПоИмени(RequestErp.Status);
		МенеджерЗаписи.Статус = НовыйСтатус;
		
		// Сохраняем ссылку на процесс
		Если RequestErp.Свойство("URLProcess") И ЗначениеЗаполнено(RequestErp.URLProcess) Тогда
			МенеджерЗаписи.URLProcess = RequestErp.URLProcess;
		КонецЕсли;
		
		// Обновляем дату последнего обновления
		МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
		
		// Сохраняем JSON callback для истории
		Если ЗначениеЗаполнено(ТелоЗапросаJSON) Тогда
			
			// Ответ содержит последний callback от ЕЛМА
			МенеджерЗаписи.Ответ = Лев(ТелоЗапросаJSON, 0); // Строка без ограничения длины
			
		КонецЕсли;
		
		МенеджерЗаписи.Записать();
		
		// Логирование смены статуса
		Если СтарыйСтатус <> НовыйСтатус Тогда
			
			ЗаписатьЛог(СтрШаблон("Статус документа %1 изменен с '%2' на '%3' (callback от ЕЛМА)", 
				Выборка.Документ1С, СтарыйСтатус, НовыйСтатус), УровеньЖурналаРегистрации.Информация);
			
			// Отправка email-уведомления
			ОтправитьEmailУведомлениеОСменеСтатуса(Выборка.Документ1С, НовыйСтатус);
			
		КонецЕсли;
		
		Результат.Успех = Истина;
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписатьЛог("Ошибка обработки callback от ЕЛМА: " + Результат.ТекстОшибки, 
			УровеньЖурналаРегистрации.Ошибка);
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Преобразует строковый статус от ЕЛМА в перечисление 1С
//
// Параметры:
//  СтатусСтрока - Строка - статус от ЕЛМА
//
// Возвращаемое значение:
//  ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//
Функция ПолучитьСтатусПоИмени(СтатусСтрока) Экспорт
	
	Если СтатусСтрока = "НаСогласовании" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании;
		
	ИначеЕсли СтатусСтрока = "Согласован" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Согласован;
		
	ИначеЕсли СтатусСтрока = "Подписан" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Подписан;
		
	ИначеЕсли СтатусСтрока = "Отклонен" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отклонен;
		
	ИначеЕсли СтатусСтрока = "Отменен" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отменен;
		
	Иначе
		
		ЗаписатьЛог(СтрШаблон("Неизвестный статус от ЕЛМА: '%1'", СтатусСтрока), 
			УровеньЖурналаРегистрации.Предупреждение);
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ТребуетВнимания;
		
	КонецЕсли;
	
КонецФункции

// Генерирует UID документа для использования в ЕЛМА
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  Строка - строковый UID документа (без дефисов, 32 символа)
//
Функция ГенерироватьUidДокумента1С(ДокументСсылка) Экспорт
	
	// Получаем UUID документа и преобразуем в строку
	УИДДокумента = ДокументСсылка.УникальныйИдентификатор();
	СтроковыйУИД = Строка(УИДДокумента);
	
	// Удаляем дефисы для более компактного представления (опционально)
	// СтроковыйУИД = СтрЗаменить(СтроковыйУИД, "-", "");
	
	Возврат СтроковыйУИД;
	
КонецФункции

#КонецОбласти

#Область РабораСоСтатусами

// ❌ УСТАРЕЛА в v3.0 (callback-архитектура)
// Опрашивает статусы процессов в ЕЛМА и обновляет их в 1С
// 
// ⚠️ В версии 3.0 статусы обновляются через callback от ЕЛМА в реал-тайм.
// Эта функция оставлена для совместимости, но больше не вызывается из РЗ.
//
// Возвращаемое значение:
//  Структура:
//   * Обновлено - Число - количество обновленных статусов
//   * Ошибок - Число - количество ошибок
//
Функция ОпроситьСтатусыДокументов() Экспорт
	
	Результат = Новый Структура("Обновлено, Ошибок", 0, 0);
	
	// Авторизация в ЕЛМА
	РезультатАвторизации = АвторизоватьсяВЕЛМА();
	Если НЕ РезультатАвторизации.Успех Тогда
		Возврат Результат;
	КонецЕсли;
	
	AuthToken = РезультатАвторизации.Токен;
	
	// Выборка документов для опроса (те, у которых процесс не завершен)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПроцессыЕЛМА.Документ1С КАК Документ1С,
		|	ПроцессыЕЛМА.УИДЕЛМА КАК УИДЕЛМА,
		|	ПроцессыЕЛМА.Статус КАК Статус,
		|	ПроцессыЕЛМА.ДатаПоследнегоОбновления КАК ДатаПоследнегоОбновления
		|ИЗ
		|	РегистрСведений.MRS_ПроцессыELMA КАК ПроцессыЕЛМА
		|ГДЕ
		|	ПроцессыЕЛМА.УИДЕЛМА <> """"
		|	И НЕ ПроцессыЕЛМА.Статус В (ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииЕЛМА.Подписан),
		|		ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииЕЛМА.Отклонен),
		|		ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииЕЛМА.Отменен))
		|	И (ПроцессыЕЛМА.ДатаПоследнегоОбновления < &ДатаГраницы
		|		ИЛИ ПроцессыЕЛМА.ДатаПоследнегоОбновления = ДАТАВРЕМЯ(1, 1, 1))";
	
	ДатаГраницы = ТекущаяДатаСеанса() - 300; // 5 минут назад
	Запрос.УстановитьПараметр("ДатаГраницы", ДатаГраницы);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Попытка
			
			// Получение статуса из ЕЛМА
			РезультатОпроса = ПолучитьСтатусИзЕЛМА(Выборка.УИДЕЛМА, AuthToken);
			
			Если РезультатОпроса.Успех Тогда
				
				// Обновление статуса в регистре
				НаборЗаписей = РегистрыСведений.MRS_ПроцессыЕЛМА.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.Документ1С.Установить(Выборка.Документ1С);
				НаборЗаписей.Прочитать();
				
				Если НаборЗаписей.Количество() > 0 Тогда
					
					Запись = НаборЗаписей[0];
					
					СтарыйСтатус = Запись.Статус;
					НовыйСтатус = ПреобразоватьСтатусЕЛМАВСтатус1С(РезультатОпроса.СтатусЕЛМА);
					
					Запись.СтатусЕЛМА = РезультатОпроса.СтатусЕЛМА;
					Запись.Статус = НовыйСтатус;
					Запись.ДатаПоследнегоОпроса = ТекущаяДатаСеанса();
					
					Если ЗначениеЗаполнено(РезультатОпроса.Комментарий) Тогда
						Запись.КомментарийЕЛМА = РезультатОпроса.Комментарий;
					КонецЕсли;
					
					НаборЗаписей.Записать();
					
					// Отправка уведомления при изменении статуса
					Если СтарыйСтатус <> НовыйСтатус Тогда
						ОтправитьEmailУведомлениеОСменеСтатуса(Выборка.Документ1С, НовыйСтатус);
					КонецЕсли;
					
				КонецЕсли;
				
				Результат.Обновлено = Результат.Обновлено + 1;
				
			Иначе
				
				ЗаписатьЛог(СтрШаблон("Ошибка опроса статуса для УИДЕЛМА %1: %2", 
					Выборка.УИДЕЛМА, РезультатОпроса.ТекстОшибки), 
					УровеньЖурналаРегистрации.Предупреждение);
				Результат.Ошибок = Результат.Ошибок + 1;
				
			КонецЕсли;
			
		Исключение
			
			ЗаписатьЛог(СтрШаблон("Ошибка опроса статуса для документа %1: %2", 
				Выборка.Документ1С, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())), 
				УровеньЖурналаРегистрации.Ошибка);
			Результат.Ошибок = Результат.Ошибок + 1;
			
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Получает текущий статус документа из регистра MRS_ПроцессыЕЛМА
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА - текущий статус или Неопределено
//
Функция ПолучитьСтатусДокумента(ДокументСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	 |	MRS_ПроцессыELMA.Документ1С КАК Документ1С,
	 |	MRS_ПроцессыELMA.УИДЕЛМА КАК УИДЕЛМА,
	 |	MRS_ПроцессыELMA.Статус КАК Статус,
	 |	MRS_ПроцессыELMA.ДатаОтправки КАК ДатаОтправки,
	 |	MRS_ПроцессыELMA.URLProcess КАК URLProcess,
	 |	MRS_ПроцессыELMA.КомментарийЕЛМА КАК КомментарийЕЛМА
	 |ИЗ
	 |	РегистрСведений.MRS_ПроцессыELMA КАК MRS_ПроцессыELMA
	 |ГДЕ
	 |	MRS_ПроцессыELMA.Документ1С = &Документ1С";
	
	Запрос.УстановитьПараметр("Документ1С", ДокументСсылка);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	СтруктураСтатуса = Новый Структура;
	СтруктураСтатуса.Вставить("Статус", Выборка.Статус);
	СтруктураСтатуса.Вставить("УИДЕЛМА", Выборка.УИДЕЛМА);
	СтруктураСтатуса.Вставить("ДатаОтправки", Выборка.ДатаОтправки);
	СтруктураСтатуса.Вставить("URLProcess", Выборка.URLProcess); // v3.0: ссылка на процесс в ЕЛМА
	СтруктураСтатуса.Вставить("КомментарийЕЛМА", Выборка.КомментарийЕЛМА);
	
	Возврат СтруктураСтатуса;
	
КонецФункции

// Получает ранее сохраненные параметры приказа для документа
// Используется для предзаполнения формы параметров при повторной отправке
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - документ
//
// Возвращаемое значение:
//  Структура, Неопределено - параметры приказа или Неопределено если не найдено
//   * ОтветственныйЗаИсполнение - СправочникСсылка.ФизическиеЛица
//   * СписокКОзнакомлению - ТаблицаЗначений
//   * ДатаНачалаДействия - Дата
//
Функция ПолучитьСохраненныеПараметрыПриказа(ДокументСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	MRS_ПроцессыELMA.Запрос КАК JSONПараметров
	|ИЗ
	|	РегистрСведений.MRS_ПроцессыELMA КАК MRS_ПроцессыELMA
	|ГДЕ
	|	MRS_ПроцессыELMA.Документ1С = &Документ1С";
	
	Запрос.УстановитьПараметр("Документ1С", ДокументСсылка);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	// Параметры приказа сохранены в поле Запрос (JSON) - v3.0
	JSONПараметров = Выборка.JSONПараметров;
	
	Если ПустаяСтрока(JSONПараметров) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		
		// Парсим параметры из JSON
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(JSONПараметров);
		ПараметрыПриказа = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		Если ТипЗнч(ПараметрыПриказа) = Тип("Структура") ИЛИ ТипЗнч(ПараметрыПриказа) = Тип("Соответствие") Тогда
			Возврат ПараметрыПриказа;
		КонецЕсли;
		
	Исключение
		// Ошибка парсинга JSON
		ЗаписатьЛог("Ошибка восстановления параметров приказа из JSON: " + ОписаниеОшибки(), 
			УровеньЖурналаРегистрации.Предупреждение);
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область РаботаСЕЛМА_API

// Выполняет авторизацию в системе ЕЛМА и получает AuthToken
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * Токен - Строка - AuthToken при успехе
//   * ТекстОшибки - Строка - описание ошибки при неудаче
//
Функция АвторизоватьсяВЕЛМА() Экспорт
	
	Результат = Новый Структура("Успех, Токен, ТекстОшибки", Ложь, "", "");
	
	Попытка
		
		// Получение параметров подключения из констант
		// URL = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_URLСервисаЕЛМА");
		URL = "http://10.21.180.147:8000";
		//ApplicationToken = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ApplicationTokenЕЛМА");
		ApplicationToken = "201DBA782EA73FC4E7D51A2F17B1FD32C016DC1716E8CA2D33E583061E546D8D67CC86A4F2A953059664E26FAD00AA05582847D53149A5D5030C68675FE9E378";
		Таймаут = Число(60);
		//Логин = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ИмяПользователяЕЛМА");
		Логин = "integration_user";
		//Пароль = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ПарольЕЛМА");
		Пароль = "123";
		Таймаут = Число(60);
		
		Если НЕ ЗначениеЗаполнено(URL) Или НЕ ЗначениеЗаполнено(ApplicationToken) 
			Или НЕ ЗначениеЗаполнено(Логин) Или НЕ ЗначениеЗаполнено(Пароль) Тогда
			
			Результат.ТекстОшибки = "Не заполнены параметры подключения к ЕЛМА в РС.ДополнительныеКонстанты";
			Возврат Результат;
			
		КонецЕсли;
		
		// Формирование URL запроса
		ПолныйURL = URL + "/API/REST/Authorization/LoginWith?username=" + Логин;
		
		// Разбор URL для создания соединения
		СтруктураURL = РазобратьURL(URL);
		
		// Создание защищенного соединения для HTTPS
		ЗащищенноеСоединение = Неопределено;
		Если СтруктураURL.Схема = "https" Тогда
			ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL(Неопределено, Неопределено);
		КонецЕсли;
		
		// Создание HTTP-соединения
		Соединение = Новый HTTPСоединение(
			СтруктураURL.Имя,
			СтруктураURL.Порт,
			,
			,
			,
			Таймаут,
			ЗащищенноеСоединение);
		
		Соединение = Новый HTTPСоединение(
			"10.21.180.147",
			8000,
			,
			,
			,
			Таймаут,
			);
			
		HTTPЗапрос = Новый HTTPЗапрос("/API/REST/Authorization/LoginWith?username=" + Логин);
		
		HTTPЗапрос.Заголовки.Вставить("ApplicationToken", ApplicationToken);
		HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
		HTTPЗапрос.УстановитьТелоИзСтроки(Пароль, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
		
		// Выполнение запроса
		HTTPОтвет = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
		// Обработка ответа
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			
			// Парсинг JSON
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
			ОтветJSON = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ТипЗнч(ОтветJSON) = Тип("Структура") И ОтветJSON.Свойство("AuthToken") Тогда
				
				Результат.Успех = Истина;
				Результат.Токен = ОтветJSON.AuthToken;
				
			ИначеЕсли ТипЗнч(ОтветJSON) = Тип("Строка") Тогда
				
				// Иногда ЕЛМА возвращает токен просто строкой
				Результат.Успех = Истина;
				Результат.Токен = ОтветJSON;
				
			Иначе
				
				Результат.ТекстОшибки = "Неожиданный формат ответа от ЕЛМА: " + ТелоОтвета;
				
			КонецЕсли;
			
		Иначе
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			Результат.ТекстОшибки = СтрШаблон("HTTP %1: %2", HTTPОтвет.КодСостояния, ТелоОтвета);
			
		КонецЕсли;
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Отправляет документ в ЕЛМА, создавая процесс согласования приказа
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  AuthToken - Строка - токен авторизации ЕЛМА
//  ПараметрыПриказа - Структура - параметры из формы
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * УИДЕЛМА - Строка - идентификатор процесса в ЕЛМА
//   * ТекстОшибки - Строка
//
Функция ОтправитьВЕЛМА(ДокументСсылка, AuthToken, ПараметрыПриказа) Экспорт
	
	Результат = Новый Структура("Успех, ТекстОшибки, JSONЗапроса, JSONОтвета", Ложь, "", "", "");
	
	Попытка
		
		// Формирование JSON для отправки (новая структура с ID1C, InitiatorString)
		JSONДанные = СформироватьJSONДляЕЛМА(ДокументСсылка, ПараметрыПриказа);
		
		// Сериализация в строку
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, JSONДанные);
		JSONТекст = ЗаписьJSON.Закрыть();
		
		// Сохраняем запрос для логирования
		Результат.JSONЗапроса = JSONТекст;
		
		// Получение параметров подключения
		// URL = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_URLСервисаЕЛМА");
		URL = "http://10.21.180.147:8000";
		//ApplicationToken = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ApplicationTokenЕЛМА");
		ApplicationToken = "201DBA782EA73FC4E7D51A2F17B1FD32C016DC1716E8CA2D33E583061E546D8D67CC86A4F2A953059664E26FAD00AA05582847D53149A5D5030C68675FE9E378";
		Таймаут = Число(60);
		
		// Разбор URL для создания соединения
		СтруктураURL = РазобратьURL(URL);
		
		// Создание защищенного соединения для HTTPS
		ЗащищенноеСоединение = Неопределено;
		Если СтруктураURL.Схема = "https" Тогда
			ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL(Неопределено, Неопределено);
		КонецЕсли;
		
		// Создание HTTP-соединения
		Соединение = Новый HTTPСоединение(
			СтруктураURL.Имя,
			СтруктураURL.Порт,
			,
			,
			,
			Таймаут,
			ЗащищенноеСоединение);
		
		// Новый endpoint для callback-архитектуры
		HTTPЗапрос = Новый HTTPЗапрос("/API/REST/Process/StartWithData");
		
		HTTPЗапрос.Заголовки.Вставить("ApplicationToken", ApplicationToken);
		HTTPЗапрос.Заголовки.Вставить("AuthToken", AuthToken);
		HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
		HTTPЗапрос.УстановитьТелоИзСтроки(JSONТекст, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
		
		// Выполнение запроса
		HTTPОтвет = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
		// Обработка ответа
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			Результат.JSONОтвета = ТелоОтвета;
			
			// Парсинг JSON ответа
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
			ОтветJSON = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ТипЗнч(ОтветJSON) = Тип("Структура") Тогда
				
				// Новая логика: проверяем result = "True"
				// УИДЕЛМА придет позже через callback
				Если ОтветJSON.Свойство("result") И ОтветJSON.result = "True" Тогда
					
					Результат.Успех = Истина;
					ЗаписатьЛог(СтрШаблон("Документ %1 успешно принят ЕЛМА (result: True). " + 
						"Ожидание callback с УИДЕЛМА и статусом.", ДокументСсылка), 
						УровеньЖурналаРегистрации.Информация);
					
				Иначе
					
					Результат.ТекстОшибки = СтрШаблон("ЕЛМА вернула result <> True: %1", ТелоОтвета);
					
				КонецЕсли;
				
			Иначе
				
				Результат.ТекстОшибки = "Неожиданный формат ответа от ЕЛМА: " + ТелоОтвета;
				
			КонецЕсли;
			
		Иначе
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			Результат.JSONОтвета = ТелоОтвета;
			Результат.ТекстОшибки = СтрШаблон("HTTP %1: %2", HTTPОтвет.КодСостояния, ТелоОтвета);
			
		КонецЕсли;
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает статус процесса из ЕЛМА
//
// Параметры:
//  УИДЕЛМА - Строка - идентификатор процесса в ЕЛМА
//  AuthToken - Строка - токен авторизации
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * СтатусЕЛМА - Строка - статус процесса в ЕЛМА
//   * Комментарий - Строка - комментарий при отклонении
//   * ТекстОшибки - Строка
//
Функция ПолучитьСтатусИзЕЛМА(УИДЕЛМА, AuthToken) Экспорт
	
	Результат = Новый Структура("Успех, СтатусЕЛМА, Комментарий, ТекстОшибки", Ложь, "", "", "");
	
	Попытка
		
		// Получение параметров подключения
		URL = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_URLСервисаЕЛМА");
		ApplicationToken = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ApplicationTokenЕЛМА");
		DecreeTypeUid = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_DecreeTypeУИДЕЛМА");
		Таймаут = Число(ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ТаймаутЗапросаЕЛМА", 30));
		
		// Формирование URL запроса
		URLЗапроса = СтрШаблон("/API/REST/Entity/Load?type=%1&id=%2", DecreeTypeUid, УИДЕЛМА);
		
		// Разбор URL для создания соединения
		СтруктураURL = РазобратьURL(URL);
		
		// Создание защищенного соединения для HTTPS
		ЗащищенноеСоединение = Неопределено;
		Если СтруктураURL.Схема = "https" Тогда
			ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL(Неопределено, Неопределено);
		КонецЕсли;
		
		// Создание HTTP-соединения
		Соединение = Новый HTTPСоединение(
			СтруктураURL.Имя,
			СтруктураURL.Порт,
			,
			,
			,
			Таймаут,
			ЗащищенноеСоединение);
		
		HTTPЗапрос = Новый HTTPЗапрос(URLЗапроса);
		
		HTTPЗапрос.Заголовки.Вставить("ApplicationToken", ApplicationToken);
		HTTPЗапрос.Заголовки.Вставить("AuthToken", AuthToken);
		
		// Выполнение запроса
		HTTPОтвет = Соединение.ВызватьHTTPМетод("GET", HTTPЗапрос);
		
		// Обработка ответа
		Если HTTPОтвет.КодСостояния = 200 Тогда
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			
			// Парсинг JSON
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
			ОтветJSON = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ТипЗнч(ОтветJSON) = Тип("Структура") Тогда
				
				// Извлечение статуса из WorkflowInstance
				Если ОтветJSON.Свойство("WorkflowInstance") И ТипЗнч(ОтветJSON.WorkflowInstance) = Тип("Структура") Тогда
					
					Если ОтветJSON.WorkflowInstance.Свойство("Status") Тогда
						Результат.СтатусЕЛМА = ОтветJSON.WorkflowInstance.Status;
					КонецЕсли;
					
				КонецЕсли;
				
				// Извлечение комментария при отклонении
				Если ОтветJSON.Свойство("ApprovementResult") И ТипЗнч(ОтветJSON.ApprovementResult) = Тип("Структура") Тогда
					
					Если ОтветJSON.ApprovementResult.Свойство("Comment") Тогда
						Результат.Комментарий = ОтветJSON.ApprovementResult.Comment;
					КонецЕсли;
					
				КонецЕсли;
				
				Результат.Успех = Истина;
				
			Иначе
				
				Результат.ТекстОшибки = "Неожиданный формат ответа от ЕЛМА: " + ТелоОтвета;
				
			КонецЕсли;
			
		Иначе
			
			ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку("utf-8");
			Результат.ТекстОшибки = СтрШаблон("HTTP %1: %2", HTTPОтвет.КодСостояния, ТелоОтвета);
			
		КонецЕсли;
		
	Исключение
		
		Результат.ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Локальная отмена приказа в 1С (v3.0)
//
// ⚠️ API ЕЛМА НЕ ПОДДЕРЖИВАЕТ программную отмену процессов!
// Эта функция только изменяет статус в 1С. Отмена в ЕЛМА должна выполняться вручную.
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  Булево - Истина если локальная отмена успешна
//
Функция ОтменитьПриказЛокально(ДокументСсылка) Экспорт
	
	Попытка
		
		// Получить статус из регистра
		СтатусДокумента = ПолучитьСтатусДокумента(ДокументСсылка);
		
		Если СтатусДокумента = Неопределено Тогда
			Возврат Истина; // Документ не отправлялся в ЕЛМА
		КонецЕсли;
		
		// Проверка текущего статуса
		Если СтатусДокумента.Статус = Перечисления.MRS_СтатусыСинхронизацииELMA.Отменен Тогда
			Возврат Истина; // Уже отменен
		КонецЕсли;
		
		// Локальная отмена - только обновление статуса в регистре
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	ПроцессыЕЛМА.UidДокумента1С КАК UidДокумента1С
		|ИЗ
		|	РегистрСведений.MRS_ПроцессыELMA КАК ПроцессыЕЛМА
		|ГДЕ
		|	ПроцессыЕЛМА.Документ1С = &Документ1С";
		
		Запрос.УстановитьПараметр("Документ1С", ДокументСсылка);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			
			МенеджерЗаписи = РегистрыСведений.MRS_ПроцессыELMA.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.UidДокумента1С = Выборка.UidДокумента1С;
			МенеджерЗаписи.Прочитать();
			
			Если МенеджерЗаписи.Выбран() Тогда
				МенеджерЗаписи.Статус = Перечисления.MRS_СтатусыСинхронизацииELMA.Отменен;
				МенеджерЗаписи.ДатаПоследнегоОбновления = ТекущаяДатаСеанса();
				МенеджерЗаписи.Записать();
				
				ЗаписатьЛог(СтрШаблон("Документ %1 локально отменен в 1С. " + 
					"ВНИМАНИЕ: Процесс в ЕЛМА (%2) остается активным и требует ручной отмены!", 
					ДокументСсылка, СтатусДокумента.URLProcess), 
					УровеньЖурналаРегистрации.Предупреждение);
				
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат Истина;
		
	Исключение
		
		ЗаписатьЛог("Ошибка локальной отмены приказа: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), 
			УровеньЖурналаРегистрации.Ошибка);
		
		Возврат Ложь;
		
	КонецПопытки;
	
КонецФункции

// ❌ УСТАРЕЛА - оставлена для обратной совместимости
// Используйте ОтменитьПриказЛокально()
//
Функция ОтменитьПриказВЕЛМА(ДокументСсылка) Экспорт
	
	Возврат ОтменитьПриказЛокально(ДокументСсылка);
	
КонецФункции

#КонецОбласти

#Область ФормированиеДанных

// Формирует JSON-структуру для отправки в ЕЛМА
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  ПараметрыПриказа - Структура - параметры из формы
//
// Возвращаемое значение:
//  Структура - данные для отправки в ЕЛМА
//
Функция СформироватьJSONДляЕЛМА(ДокументСсылка, ПараметрыПриказа) Экспорт
	
	// Чтение документа
	Документ = ДокументСсылка.ПолучитьОбъект();
	
	// Получение вида цены из первой строки табличной части
	Если Документ.Товары.Количество() = 0 Тогда
		ВызватьИсключение "В документе отсутствуют строки с ценами";
	КонецЕсли;
	
	ВидЦены = Документ.ВидыЦен[0].ВидЦены;
	
	// Получение Uid организации через план обмена
	UidОрганизации = ПолучитьUidОрганизацииИзПланаОбмена(ВидЦены);
	
	// Генерация UID документа для ЕЛМА (для callback)
	UidДокумента1С = ГенерироватьUidДокумента1С(ДокументСсылка);
	
	// Получение Uid инициатора (текущего пользователя) - СТРОКА, не объект!
	InitiatorString = ПолучитьUidТекущегоПользователяЕЛМА();
	
	// Получение наименования организации
	Организация = ПолучитьОрганизациюИзПланаОбмена(ВидЦены);
	//НаименованиеОрганизации = Организация.Наименование; TODO   убрать заглушки
	НаименованиеОрганизации = Организация;
	
	// Формирование DecreeHeadline
	DecreeHeadline = СтрШаблон("Об установке цен для %1 с %2", 
		НаименованиеОрганизации, 
		Формат(ПараметрыПриказа.ДатаНачалаДействия, "ДФ=dd.MM.yyyy"));
	
	// Формирование DecreeContent
	DecreeContent = СформироватьDecreeContent(ДокументСсылка);
	
	// Формирование Word-файла приказа
	ДвоичныеДанныеWord = СформироватьWordФайлПриказа(ДокументСсылка, ПараметрыПриказа);
	FileBase64 = Base64Строка(ДвоичныеДанныеWord);
	
	// Получение констант
	//ProcessToken = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_ProcessTokenЕЛМА");  TODO
	ProcessToken = "489d2dbf-0017-458e-8edb-f5d5aa70b00f";
	//DecreeTypeUid = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту("MRS_DecreeTypeУИДЕЛМА"); TODO
	DecreeTypeUid = "571c78cc-baa0-4529-a00f-8e6c65790ae7";
	
	// Формирование структуры Context (новая структура PRD v3.0)
	Context = Новый Структура;
	
	// Organization с ID1C (UID документа 1С) и Uid (Uid организации в ЕЛМА)
	OrganizationObj = Новый Структура;
	OrganizationObj.Вставить("ID1C", UidДокумента1С); // UID документа 1С для callback
	OrganizationObj.Вставить("Uid", UidОрганизации);  // Uid организации в ЕЛМА
	Context.Вставить("Organization", OrganizationObj);
	
	// InitiatorString - СТРОКА, не объект {Uid: "..."}!
	Context.Вставить("InitiatorString", InitiatorString);
	
	Context.Вставить("DecreeType", Новый Структура("Uid", DecreeTypeUid));
	Context.Вставить("DecreeHeadline", DecreeHeadline);
	Context.Вставить("Preamble", "В целях актуализации прейскуранта");
	Context.Вставить("DecreeContent", DecreeContent);
	Context.Вставить("StartDate", XMLСтрока(ПараметрыПриказа.ДатаНачалаДействия)); // ISO 8601
	
	// UserString - тот же что InitiatorString (для ознакомления)
	Context.Вставить("UserString", InitiatorString);
	
	Context.Вставить("FileDecree", FileBase64);
	
	// Формирование итоговой структуры
	Результат = Новый Структура;
	Результат.Вставить("ProcessToken", ProcessToken);
	Результат.Вставить("Context", Context);
	
	Возврат Результат;
	
КонецФункции

// Формирует текст приказа (DecreeContent)
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  Строка - текст приказа
//
Функция СформироватьDecreeContent(ДокументСсылка) Экспорт
	
	ТекстПриказа = 
		"1. Установить цены согласно приложению №1." + Символы.ПС +
		"2. Контроль за внесением изменений возложить на финансового контролера." + Символы.ПС +
		"3. Контроль за исполнением приказа возложить на директора департамента.";
	
	Возврат ТекстПриказа;
	
КонецФункции

// Формирует Word-файл приказа из шаблона
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  ПараметрыПриказа - Структура
//
// Возвращаемое значение:
//  ДвоичныеДанные - файл DOCX
//
Функция СформироватьWordФайлПриказа(ДокументСсылка, ПараметрыПриказа) Экспорт
	
	// TODO: Реализовать генерацию Word-документа из шаблона
	// Пока возвращаем пустой файл для тестирования
	
	ТекстДокумента = "Приказ об установке цен от " + Формат(ТекущаяДатаСеанса(), "ДФ=dd.MM.yyyy");
	
	ВременныйФайл = ПолучитьИмяВременногоФайла("txt");
	
	Попытка
		
		ЗаписьТекста = Новый ЗаписьТекста(ВременныйФайл, КодировкаТекста.UTF8);
		ЗаписьТекста.Записать(ТекстДокумента);
		ЗаписьТекста.Закрыть();
		
		ДвоичныеДанные = Новый ДвоичныеДанные(ВременныйФайл);
		
		УдалитьФайлы(ВременныйФайл);
		
		Возврат ДвоичныеДанные;
		
	Исключение
		
		ЗаписатьЛог("Ошибка формирования Word-файла: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), 
			УровеньЖурналаРегистрации.Ошибка);
		
		// Возвращаем пустые данные
		Возврат Новый ДвоичныеДанные("");
		
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область РаботаСУид

// Получает Uid организации через план обмена питУдаленныеКассы
//
// Параметры:
//  ВидЦены - СправочникСсылка.ВидыЦен
//
// Возвращаемое значение:
//  Строка - Uid организации в ЕЛМА
//
Функция ПолучитьUidОрганизацииИзПланаОбмена(ВидЦены) Экспорт
	
	Возврат "c20aa541-d17e-499b-a9e8-755b2803a9b3";
	
	// Запрос к плану обмена
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питУдаленныеКассы.Организация КАК Организация
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|ГДЕ
		|	питУдаленныеКассы.ВидЦен = &ВидЦены";
	
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		ВызватьИсключение СтрШаблон("Не найден узел плана обмена питУдаленныеКассы для вида цены %1", ВидЦены);
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Организация = Выборка.Организация;
	
	// Получение Uid из РС.ДополнительныеКонстанты
	UidОрганизации = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту(
		"MRS_УИДЕЛМА_Организация", 
		Организация);
	
	Если НЕ ЗначениеЗаполнено(UidОрганизации) Тогда
		ВызватьИсключение СтрШаблон(
			"Для организации %1 не заполнен Uid ЕЛМА в РС.ДополнительныеКонстанты. " +
			"Добавьте запись с ИмяКонстанты='MRS_УИДЕЛМА_Организация' и Объект=Организация.",
			Организация);
	КонецЕсли;
	
	Возврат UidОрганизации;
	
КонецФункции

// Получает организацию из плана обмена по виду цены
//
// Параметры:
//  ВидЦены - СправочникСсылка.ВидыЦен
//
// Возвращаемое значение:
//  СправочникСсылка.Организации
//
Функция ПолучитьОрганизациюИзПланаОбмена(ВидЦены) Экспорт
	
	Возврат "МРИЯ-заглушка";
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питУдаленныеКассы.Организация КАК Организация
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|ГДЕ
		|	питУдаленныеКассы.ВидЦен = &ВидЦены";
	
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		ВызватьИсключение СтрШаблон("Не найден узел плана обмена питУдаленныеКассы для вида цены %1", ВидЦены);
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Организация;
	
КонецФункции

// Получает Uid физического лица из РС.ДополнительныеКонстанты
//
// Параметры:
//  ФизЛицоСсылка - СправочникСсылка.ФизическиеЛица
//
// Возвращаемое значение:
//  Строка - Uid физлица в ЕЛМА или Неопределено
//
Функция ПолучитьUidФизЛицаЕЛМА(ФизЛицоСсылка) Экспорт
	
	возврат "53f06fcf-4650-4124-bb95-418d892390b4";
	
	Если НЕ ЗначениеЗаполнено(ФизЛицоСсылка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Uid = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту(
		"MRS_УИДЕЛМА_ФизЛицо", 
		ФизЛицоСсылка);
	
	Если НЕ ЗначениеЗаполнено(Uid) Тогда
		
		ЗаписатьЛог(СтрШаблон("Для физлица %1 не заполнен Uid ЕЛМА в РС.ДополнительныеКонстанты", 
			ФизЛицоСсылка), УровеньЖурналаРегистрации.Предупреждение);
		
		Возврат Неопределено;
		
	КонецЕсли;
	
	Возврат Uid;
	
КонецФункции

// Получает Uid текущего пользователя из РС.ДополнительныеКонстанты
//
// Возвращаемое значение:
//  Строка - Uid инициатора в ЕЛМА
//
Функция ПолучитьUidТекущегоПользователяЕЛМА() Экспорт
	
	возврат "53f06fcf-4650-4124-bb95-418d892390b4";
	
	ТекущийПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
	
	// Получение физического лица текущего пользователя
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Пользователи.Ссылка КАК Ссылка,
		|	Пользователи.ФизическоеЛицо КАК ФизическоеЛицо
		|ИЗ
		|	Справочник.Пользователи КАК Пользователи
		|ГДЕ
		|	Пользователи.ИдентификаторПользователяИБ = &ИдентификаторПользователяИБ";
	
	Запрос.УстановитьПараметр("ИдентификаторПользователяИБ", ТекущийПользователь.УникальныйИдентификатор);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		ВызватьИсключение "Не найден пользователь 1С для текущего пользователя ИБ";
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	ФизЛицо = Выборка.ФизическоеЛицо;
	
	Если НЕ ЗначениеЗаполнено(ФизЛицо) Тогда
		ВызватьИсключение СтрШаблон("У текущего пользователя %1 не заполнено ФизическоеЛицо", Выборка.Ссылка);
	КонецЕсли;
	
	Uid = ПолучитьUidФизЛицаЕЛМА(ФизЛицо);
	
	Если НЕ ЗначениеЗаполнено(Uid) Тогда
		ВызватьИсключение СтрШаблон(
			"Для физлица %1 текущего пользователя не заполнен Uid ЕЛМА в РС.ДополнительныеКонстанты. " +
			"Добавьте запись с ИмяКонстанты='MRS_УИДЕЛМА_ФизЛицо' и Объект=ФизическоеЛицо.",
			ФизЛицо);
	КонецЕсли;
	
	Возврат Uid;
	
КонецФункции

#КонецОбласти

#Область ПроведениеИВыгрузка

// Проводит документы, у которых наступила дата применения
//
// Возвращаемое значение:
//  Структура:
//   * Проведено - Число
//   * Ошибок - Число
//
Функция ПровестиДокументыПоДатеПрименения() Экспорт
	
	Результат = Новый Структура("Проведено, Ошибок", 0, 0);
	
	// Выборка документов для проведения
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПроцессыЕЛМА.Документ1С КАК Документ1С,
		|	Документ.ДатаНачалаДействия КАК ДатаНачалаДействия
		|ИЗ
		|	РегистрСведений.MRS_ПроцессыЕЛМА КАК ПроцессыЕЛМА
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УстановкаЦенНоменклатуры КАК Документ
		|		ПО ПроцессыЕЛМА.Документ1С = Документ.Ссылка
		|ГДЕ
		|	ПроцессыЕЛМА.Статус = ЗНАЧЕНИЕ(Перечисление.MRS_СтатусыСинхронизацииЕЛМА.Подписан)
		|	И Документ.ДатаНачалаДействия <= &ТекущаяДата
		|	И НЕ Документ.Проведен";
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Попытка
			
			// Проведение документа
			ДокументОбъект = Выборка.Документ1С.ПолучитьОбъект();
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
			
			ЗаписатьЛог(СтрШаблон("Документ %1 успешно проведен по дате применения", Выборка.Документ1С), 
				УровеньЖурналаРегистрации.Информация);
			
			Результат.Проведено = Результат.Проведено + 1;
			
			// Выгрузка цен в Simphony
			Попытка
				ВыгрузитьЦеныВSimphony(Выборка.Документ1С);
			Исключение
				ЗаписатьЛог(СтрШаблон("Ошибка выгрузки цен в Simphony для документа %1: %2", 
					Выборка.Документ1С, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())), 
					УровеньЖурналаРегистрации.Ошибка);
			КонецПопытки;
			
		Исключение
			
			ЗаписатьЛог(СтрШаблон("Ошибка проведения документа %1: %2", 
				Выборка.Документ1С, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())), 
				УровеньЖурналаРегистрации.Ошибка);
			
			Результат.Ошибок = Результат.Ошибок + 1;
			
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Выгружает цены из документа в Simphony
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  Булево - Истина если выгрузка выполнена
//
Функция ВыгрузитьЦеныВSimphony(ДокументСсылка) Экспорт
	
	// Проверка условий
	Если НЕ ДокументСсылка.Проведен Тогда
		Возврат Ложь;
	КонецЕсли;
	
	СтатусДокумента = ПолучитьСтатусДокумента(ДокументСсылка);
	Если СтатусДокумента = Неопределено 
		Или СтатусДокумента.Статус <> Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Подписан Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Получение видов цен из документа
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	УстановкаЦен.ВидЦены КАК ВидЦены
		|ИЗ
		|	Документ.УстановкаЦенНоменклатуры.ЦеныНоменклатуры КАК УстановкаЦен
		|ГДЕ
		|	УстановкаЦен.Ссылка = &Документ";
	
	Запрос.УстановитьПараметр("Документ", ДокументСсылка);
	
	ВыборкаВидовЦен = Запрос.Выполнить().Выбрать();
	
	Пока ВыборкаВидовЦен.Следующий() Цикл
		
		ВидЦены = ВыборкаВидовЦен.ВидЦены;
		
		// Поиск кассовых узлов с этим видом цены
		ЗапросУзлов = Новый Запрос;
		ЗапросУзлов.Текст = 
			"ВЫБРАТЬ
			|	питУдаленныеКассы.Ссылка КАК КассовыйУзел,
			|	питУдаленныеКассыВидыМеню.ВидМеню КАК ВидМеню
			|ИЗ
			|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланОбмена.питУдаленныеКассы.ВидыМеню КАК питУдаленныеКассыВидыМеню
			|		ПО питУдаленныеКассы.Ссылка = питУдаленныеКассыВидыМеню.Ссылка
			|ГДЕ
				|	питУдаленныеКассы.ВидЦен В(&МассивВидовЦен)";
		
		МассивВидовЦен = Новый Массив;
		МассивВидовЦен.Добавить(ВидЦены);
		ЗапросУзлов.УстановитьПараметр("МассивВидовЦен", МассивВидовЦен);
		
		ВыборкаУзлов = ЗапросУзлов.Выполнить().Выбрать();
		
		Пока ВыборкаУзлов.Следующий() Цикл
			
			КассовыйУзел = ВыборкаУзлов.КассовыйУзел;
			ВидМеню = ВыборкаУзлов.ВидМеню;
			
			// Получение позиций меню для данного вида меню
			ЗапросПозиций = Новый Запрос;
			ЗапросПозиций.Текст = 
				"ВЫБРАТЬ
				|	питМеню.Ссылка КАК ПозицияМеню,
				|	питМеню.Номенклатура КАК Номенклатура
				|ИЗ
				|	Справочник.питМеню КАК питМеню
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УстановкаЦенНоменклатуры.ЦеныНоменклатуры КАК УстановкаЦен
				|		ПО питМеню.Номенклатура = УстановкаЦен.Номенклатура
				|ГДЕ
				|	питМеню.Владелец = &ВидМеню
				|	И НЕ питМеню.ЭтоГруппа
				|	И УстановкаЦен.Ссылка = &Документ
				|	И УстановкаЦен.ВидЦены = &ВидЦены";
			
			ЗапросПозиций.УстановитьПараметр("ВидМеню", ВидМеню);
			ЗапросПозиций.УстановитьПараметр("Документ", ДокументСсылка);
			ЗапросПозиций.УстановитьПараметр("ВидЦены", ВидЦены);
			
			ВыборкаПозиций = ЗапросПозиций.Выполнить().Выбрать();
			
			Пока ВыборкаПозиций.Следующий() Цикл
				
				// Постановка позиции в очередь выгрузки Simphony
				MRS_ИнтеграцияSimphonyСервер.ПоставитьВОчередьВыгрузки(
					ВыборкаПозиций.ПозицияМеню,
					КассовыйУзел,
					"Изменение");
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЦикла;
	
	ЗаписатьЛог(СтрШаблон("Цены из документа %1 поставлены в очередь выгрузки Simphony", ДокументСсылка), 
		УровеньЖурналаРегистрации.Информация);
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Проверяет, требуется ли отправка документа в ЕЛМА
//
// Параметры:
//  Документ - ДокументОбъект.УстановкаЦенНоменклатуры
//
// Возвращаемое значение:
//  Булево - Истина если требуется отправка в ЕЛМА
//
Функция ТребуетсяОтправкаВЕЛМА(Документ) Экспорт
	
	// Проверяем, есть ли виды цен, привязанные к питУдаленныеКассы
	Если Документ.Товары.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Получаем уникальные виды цен из документа
	МассивВидовЦен = Новый Массив;
	Для Каждого Строка Из Документ.ВидыЦен Цикл
		Если МассивВидовЦен.Найти(Строка.ВидЦены) = Неопределено Тогда
			МассивВидовЦен.Добавить(Строка.ВидЦены);
		КонецЕсли;
	КонецЦикла;
	
	// Проверяем наличие видов цен в плане обмена
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питУдаленныеКассы.ВидЦен КАК ВидЦен,
		|	питУдаленныеКассы.Организация КАК Организация
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|ГДЕ
		|	питУдаленныеКассы.ВидЦен В(&МассивВидовЦен)";
	
	Запрос.УстановитьПараметр("МассивВидовЦен", МассивВидовЦен);
	
	Результат = Запрос.Выполнить();
	
	Возврат НЕ Результат.Пустой();
	
КонецФункции

// Валидирует документ перед отправкой в ЕЛМА
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  ПараметрыПриказа - Структура
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ТекстОшибки - Строка
//
Функция ВалидироватьДокументПередОтправкой(ДокументСсылка, ПараметрыПриказа) Экспорт
	
	Результат = Новый Структура("Успех, ТекстОшибки", Истина, "");
	
	Попытка
		
		// Проверка заполнения ответственного
		Если НЕ ПараметрыПриказа.Свойство("ОтветственныйЗаИсполнение") 
			Или НЕ ЗначениеЗаполнено(ПараметрыПриказа.ОтветственныйЗаИсполнение) Тогда
			
			Результат.Успех = Ложь;
			Результат.ТекстОшибки = "Необходимо заполнить поле 'Ответственный за исполнение'";
			Возврат Результат;
			
		КонецЕсли;
		
		// Чтение документа
		Документ = ДокументСсылка.ПолучитьОбъект();
		
		Если Документ.Товары.Количество() = 0 Тогда
			Результат.Успех = Ложь;
			Результат.ТекстОшибки = "В документе отсутствуют строки с ценами";
			Возврат Результат;
		КонецЕсли;
		
		ВидЦены = Документ.ВидыЦен[0].ВидЦены;
		
		// Проверка наличия Uid организации
		//UidОрганизации = ПолучитьUidОрганизацииИзПланаОбмена(ВидЦены);
		
		// Проверка наличия Uid текущего пользователя
		//UidИнициатора = ПолучитьUidТекущегоПользователяЕЛМА();
		
		// Проверка наличия Uid ответственного
		//UidОтветственного = ПолучитьUidФизЛицаЕЛМА(ПараметрыПриказа.ОтветственныйЗаИсполнение);
		
		//Если НЕ ЗначениеЗаполнено(UidОтветственного) Тогда
		//	Результат.Успех = Ложь;
		//	Результат.ТекстОшибки = СтрШаблон(
		//		"Для ответственного %1 не заполнен Uid ЕЛМА в РС.ДополнительныеКонстанты",
		//		ПараметрыПриказа.ОтветственныйЗаИсполнение);
		//	Возврат Результат;
		//КонецЕсли;
		
	Исключение
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Преобразует статус ЕЛМА в статус 1С
//
// Параметры:
//  СтатусЕЛМА - Строка - статус процесса в ЕЛМА
//
// Возвращаемое значение:
//  ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//
Функция ПреобразоватьСтатусЕЛМАВСтатус1С(СтатусЕЛМА) Экспорт
	
	// Маппинг статусов ЕЛМА → 1С
	Если СтатусЕЛМА = "InProgress" Или СтатусЕЛМА = "Active" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании;
		
	ИначеЕсли СтатусЕЛМА = "Approved" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Согласован;
		
	ИначеЕсли СтатусЕЛМА = "Signed" Или СтатусЕЛМА = "Completed" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Подписан;
		
	ИначеЕсли СтатусЕЛМА = "Rejected" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отклонен;
		
	ИначеЕсли СтатусЕЛМА = "Cancelled" Тогда
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отменен;
		
	Иначе
		// Неизвестный статус, оставляем На согласовании
		Возврат Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании;
		
	КонецЕсли;
	
КонецФункции

// Отправляет email-уведомление о смене статуса
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  НовыйСтатус - ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//
Процедура ОтправитьEmailУведомлениеОСменеСтатуса(ДокументСсылка, НовыйСтатус) Экспорт
	
	// TODO: Реализовать отправку email через БСП
	// Пока просто логируем событие
	
	ЗаписатьЛог(СтрШаблон("Статус документа %1 изменен на %2", ДокументСсылка, НовыйСтатус), 
		УровеньЖурналаРегистрации.Информация);
	
КонецПроцедуры

// Разбирает URL на компоненты (схема, хост, порт, путь)
//
// Параметры:
//  URL - Строка - URL для разбора (например, "https://example.com:8080/path")
//
// Возвращаемое значение:
//  Структура:
//   * Схема - Строка - "http" или "https"
//   * Имя - Строка - имя хоста
//   * Порт - Число - порт (80 для http, 443 для https по умолчанию)
//   * Путь - Строка - путь к ресурсу
//
Функция РазобратьURL(URL)
	
	Результат = Новый Структура;
	Результат.Вставить("Схема", "http");
	Результат.Вставить("Имя", "");
	Результат.Вставить("Порт", 0);
	Результат.Вставить("Путь", "");
	
	РабочаяСтрока = СокрЛП(URL);
	
	// Извлечение схемы
	Позиция = СтрНайти(РабочаяСтрока, "://");
	Если Позиция > 0 Тогда
		
		Результат.Схема = НРег(Лев(РабочаяСтрока, Позиция - 1));
		РабочаяСтрока = Сред(РабочаяСтрока, Позиция + 3);
		
	КонецЕсли;
	
	// Извлечение пути (если есть)
	Позиция = СтрНайти(РабочаяСтрока, "/");
	Если Позиция > 0 Тогда
		
		Результат.Путь = Сред(РабочаяСтрока, Позиция);
		РабочаяСтрока = Лев(РабочаяСтрока, Позиция - 1);
		
	КонецЕсли;
	
	// Извлечение порта (если указан)
	Позиция = СтрНайти(РабочаяСтрока, ":");
	Если Позиция > 0 Тогда
		
		СтрокаПорта = СокрЛП(Сред(РабочаяСтрока, Позиция + 1));
		
		// Проверяем, что строка содержит только цифры
		ПортВалиден = Истина;
		Для Индекс = 1 По СтрДлина(СтрокаПорта) Цикл
			
			Символ = Сред(СтрокаПорта, Индекс, 1);
			Если СтрНайти("0123456789", Символ) = 0 Тогда
				ПортВалиден = Ложь;
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		Если ПортВалиден И СтрДлина(СтрокаПорта) > 0 Тогда
			Результат.Порт = Число(СтрокаПорта);
		КонецЕсли;
		
		РабочаяСтрока = Лев(РабочаяСтрока, Позиция - 1);
		
	КонецЕсли;
	
	// Оставшаяся часть - имя хоста
	Результат.Имя = РабочаяСтрока;
	
	// Установка порта по умолчанию, если не указан
	Если Результат.Порт = 0 Тогда
		
		Если Результат.Схема = "https" Тогда
			Результат.Порт = 443;
		Иначе
			Результат.Порт = 80;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Записывает сообщение в журнал регистрации
//
// Параметры:
//  Сообщение - Строка - текст сообщения
//  Уровень - УровеньЖурналаРегистрации - уровень важности
//
Процедура ЗаписатьЛог(Сообщение, Уровень = Неопределено) Экспорт
	
	Если Уровень = Неопределено Тогда
		Уровень = УровеньЖурналаРегистрации.Информация;
	КонецЕсли;
	
	ЗаписьЖурналаРегистрации("MRS.ЕЛМА", Уровень,,, Сообщение);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

