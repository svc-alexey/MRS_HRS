// << MRS #VINE-195 ВикторовАГ <Artem.Viktorov@mriyaresort.com> 20.10.25, (Акцизные марки диапазонного алкоголя)
// << Швецов. 22.12.25 Полностью переписано, не учтена вся бизнес-логика
// Проверяет соответствие количества акцизных марок количеству алкогольной продукции в документе СборкаТоваров
//
// Параметры:
//  ЭтотОбъект - ДокументОбъект.СборкаТоваров - проверяемый документ
//  Отказ - Булево - флаг отказа в записи/проведении документа
//
Процедура ОбработкаПроведенияСборкаТоваров(ЭтотОбъект, Отказ) Экспорт 
	
	// Шаг 1: Предварительные проверки
	Если ЭтотОбъект.Ссылка.Пустая() Тогда 
		Возврат;
	КонецЕсли;
	
	// Проверка флагов разрешения записи
	питРазрешитьЗаписьТиповогоДокумента = Ложь;
	Если ЭтотОбъект.ДополнительныеСвойства.Свойство("питРазрешитьЗаписьТиповогоДокумента") Тогда 
		питРазрешитьЗаписьТиповогоДокумента = ЭтотОбъект.ДополнительныеСвойства.питРазрешитьЗаписьТиповогоДокумента;
	КонецЕсли;
	
	MRS_АвтоматическоеПроведение = Ложь;
	Если ЭтотОбъект.ДополнительныеСвойства.Свойство("MRS_АвтоматическоеПроведение") Тогда 
		MRS_АвтоматическоеПроведение = ЭтотОбъект.ДополнительныеСвойства.MRS_АвтоматическоеПроведение;
	КонецЕсли;
	
	Если питРазрешитьЗаписьТиповогоДокумента 
		ИЛИ питТиповыеДокументы.НайтиДокументпитДляТиповогоДокумента(ЭтотОбъект.Ссылка) 
		ИЛИ MRS_АвтоматическоеПроведение Тогда
		Возврат;
	КонецЕсли;
	
	// Шаг 2: Получение данных документа
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СборкаТоваровТовары.Номенклатура КАК Номенклатура,
		|	СборкаТоваровТовары.КоличествоУпаковок КАК КоличествоУпаковок,
		|	СборкаТоваровТовары.Серия КАК Серия,
		|	СборкаТоваровТовары.СтатусУказанияСерий КАК СтатусУказанияСерий,
		|	СборкаТоваровТовары.Упаковка КАК Упаковка
		|ИЗ
		|	Документ.СборкаТоваров.Товары КАК СборкаТоваровТовары
		|ГДЕ
		|	СборкаТоваровТовары.Ссылка = &Ссылка
		|	И СборкаТоваровТовары.Номенклатура.ВидАлкогольнойПродукции.Маркируемый = ИСТИНА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СборкаТоваровСерии.Номенклатура КАК Номенклатура,
		|	СборкаТоваровСерии.Серия КАК Серия,
		|	СборкаТоваровСерии.Количество КАК Количество
		|ИЗ
		|	Документ.СборкаТоваров.Серии КАК СборкаТоваровСерии
		|ГДЕ
		|	СборкаТоваровСерии.Ссылка = &Ссылка
		|	И СборкаТоваровСерии.Номенклатура.ВидАлкогольнойПродукции.Маркируемый = ИСТИНА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КОЛИЧЕСТВО(*) КАК КоличествоМарок
		|ИЗ
		|	Документ.СборкаТоваров.MRS_ДополнительныеАкцизныеМарки КАК СборкаТоваровMRS_ДополнительныеАкцизныеМарки
		|ГДЕ
		|	СборкаТоваровMRS_ДополнительныеАкцизныеМарки.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА Номенклатура.ВидАлкогольнойПродукции.Маркируемый = ИСТИНА
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК Маркируемый
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка = &НоменклатураДокумента";
	
	Запрос.УстановитьПараметр("Ссылка", ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("НоменклатураДокумента", ЭтотОбъект.Номенклатура);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	// Получаем данные из результатов запроса
	ТаблицаМаркируемыхТоваров = РезультатыЗапроса[0].Выгрузить();
	ТаблицаМаркируемыхСерий = РезультатыЗапроса[1].Выгрузить();
	
	// Количество марок из ТЧ MRS_ДополнительныеАкцизныеМарки (используется ТОЛЬКО для статуса 14)
	КоличествоМарокИзТЧ = 0;
	Если НЕ РезультатыЗапроса[2].Пустой() Тогда
		ВыборкаМарок = РезультатыЗапроса[2].Выбрать();
		Если ВыборкаМарок.Следующий() Тогда
			КоличествоМарокИзТЧ = ВыборкаМарок.КоличествоМарок;
		КонецЕсли;
	КонецЕсли;
	
	ЕстьМаркируемыеВДокументе = Ложь;
	Если НЕ РезультатыЗапроса[3].Пустой() Тогда
		ВыборкаНоменклатуры = РезультатыЗапроса[3].Выбрать();
		Если ВыборкаНоменклатуры.Следующий() Тогда
			ЕстьМаркируемыеВДокументе = ВыборкаНоменклатуры.Маркируемый;
		КонецЕсли;
	КонецЕсли;
	
	// Шаг 3: Проверка наличия маркируемой продукции
	ЕстьМаркируемыеВТоварах = ТаблицаМаркируемыхТоваров.Количество() > 0;
	ЕстьМаркируемыеВСериях = ТаблицаМаркируемыхСерий.Количество() > 0;
	
	// Если нигде нет маркируемой продукции - выходим
	Если НЕ ЕстьМаркируемыеВТоварах И НЕ ЕстьМаркируемыеВДокументе И НЕ ЕстьМаркируемыеВСериях Тогда
		Возврат;
	КонецЕсли;
	
	// Шаг 4: Определение сценария и подсчет количеств
	КоличествоТребуется = 0;
	КоличествоФакт = 0;
	ТипСценария = "";
	
	// Проверка на Сценарий 1: Прямая сборка с маркировкой (Статус 14)
	ЕстьСтатус14 = Ложь;
	Для Каждого Строка Из ТаблицаМаркируемыхТоваров Цикл
		Если Строка.СтатусУказанияСерий = 14 Тогда
			ЕстьСтатус14 = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ЕстьСтатус14 Тогда
		
		// Сценарий 1: Прямая сборка с маркировкой
		ТипСценария = "ПрямаяСборка";
		
		// Подсчет требуемого количества марок 
		Для Каждого Строка Из ТаблицаМаркируемыхТоваров Цикл
			Если Строка.СтатусУказанияСерий = 14 Тогда
				
				// Проверка на дробное количество упаковок (недопустимо для диапазона)
				Если Строка.КоличествоУпаковок <> Цел(Строка.КоличествоУпаковок) Тогда
					
					ТекстОшибки = СтрШаблон(
						"Для маркируемой номенклатуры ""%1"" указано дробное количество упаковок (%2)! При прямой сборке с маркировкой укажите целое количество упаковок или заполните реквизит ""Упаковка"".",
						Строка.Номенклатура,
						Формат(Строка.КоличествоУпаковок, "ЧЦ=15; ЧДЦ=3"));
					
					ОбщегоНазначения.СообщитьПользователю(ТекстОшибки, , , , Отказ);
					Возврат;
					
				КонецЕсли;
				
				КоличествоТребуется = КоличествоТребуется + Строка.КоличествоУпаковок;
				
			КонецЕсли;
		КонецЦикла;
		
		// Для статуса 14 марки в ТЧ MRS_ДополнительныеАкцизныеМарки и/или в реквизите MRS_АкцизнаяМарка
		КоличествоФакт = КоличествоМарокИзТЧ;
		
		// Добавляем марку из шапки документа, если заполнена
		Если ЗначениеЗаполнено(ЭтотОбъект.MRS_АкцизнаяМарка) Тогда
			КоличествоФакт = КоличествоФакт + 1;
		КонецЕсли;
		
		
	ИначеЕсли ЭтотОбъект.СтатусУказанияСерий = 0 И ЕстьМаркируемыеВТоварах Тогда
		
		// Сценарий: Вскрытие в несерийную литражную номенклатуру
		ТипСценария = "Вскрытие";
		
		// При вскрытии марки хранятся в ТЧ Серии 
		// Проверяем: количество строк ТЧ Товары = количество строк ТЧ Серии
		КоличествоТребуется = ТаблицаМаркируемыхТоваров.Количество();
		КоличествоФакт = ТаблицаМаркируемыхСерий.Количество();
		
		// Дополнительная проверка: объем в шапке документа должен соответствовать объему вскрываемых бутылок
		Если ТаблицаМаркируемыхСерий.Количество() > 0 Тогда

			// Получаем объем одной бутылки из первой строки ТЧ Серии
			ПерваяСерия = ТаблицаМаркируемыхСерий[0];

			ОбъемДАЛ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПерваяСерия.Номенклатура, "ОбъемДАЛ");

			Если ЗначениеЗаполнено(ОбъемДАЛ) Тогда

				// Объем одной бутылки в литрах = ОбъемДАЛ * 10
				ОбъемОднойБутылкиЛитры = ОбъемДАЛ * 10;

				// Общий объем вскрываемых бутылок
				ОбщийОбъемВскрываемыхБутылок = ОбъемОднойБутылкиЛитры * ТаблицаМаркируемыхСерий.Количество();

				// Проверяем, что в шапке документа указано достаточно литров
				Если ЭтотОбъект.КоличествоУпаковок <> ОбщийОбъемВскрываемыхБутылок Тогда

					ТекстОшибки = СтрШаблон(
						"При вскрытии указано недостаточное количество в результате! Вскрывается %1 бутылок по %2 л (итого %3 л), а в документе указано только %4 л. Укажите недостающие акцизные марки!",
						ТаблицаМаркируемыхСерий.Количество(),
						Формат(ОбъемОднойБутылкиЛитры, "ЧЦ=15; ЧДЦ=3"),
						Формат(ОбщийОбъемВскрываемыхБутылок, "ЧЦ=15; ЧДЦ=3"),
						Формат(ЭтотОбъект.КоличествоУпаковок, "ЧЦ=15; ЧДЦ=3"));

					ОбщегоНазначения.СообщитьПользователю(ТекстОшибки, , , , Отказ);
					Возврат;

				КонецЕсли;

			КонецЕсли;
		КонецЕсли;
    
	ИначеЕсли ЭтотОбъект.СтатусУказанияСерий = 4 И ЗначениеЗаполнено(ЭтотОбъект.Упаковка) Тогда
		
		// Сценарий 2: Пересборка номенклатуры (марки в ТЧ Серии)
		ТипСценария = "Пересборка";
		
		// Подсчет марок из ТЧ Серии (исходная серийная номенклатура из ТЧ Товары)
		Для Каждого СтрокаСерии Из ТаблицаМаркируемыхСерий Цикл
			
			// Проверяем, что это серия для номенклатуры из ТЧ Товары с количеством = 1
			Если СтрокаСерии.Количество = 1 Тогда
				
				// Проверяем наличие этой номенклатуры в ТЧ Товары
				ЕстьВТоварах = Ложь;
				Для Каждого СтрокаТовара Из ТаблицаМаркируемыхТоваров Цикл
					Если СтрокаТовара.Номенклатура = СтрокаСерии.Номенклатура Тогда
						ЕстьВТоварах = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				
				Если ЕстьВТоварах Тогда
					КоличествоТребуется = КоличествоТребуется + 1;
					КоличествоФакт = КоличествоФакт + 1; // Каждая строка ТЧ Серии - это марка
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
	ИначеЕсли ЕстьМаркируемыеВТоварах Тогда
		
		// Проверка на Сценарии 3-4: Сборка из серийной в литражную
		ЕстьСтатус4ВТоварах = Ложь;
		Для Каждого Строка Из ТаблицаМаркируемыхТоваров Цикл
			Если Строка.СтатусУказанияСерий = 4 И Строка.КоличествоУпаковок = 1 Тогда
				ЕстьСтатус4ВТоварах = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если ЕстьСтатус4ВТоварах Тогда
			
			// Сценарии 3 или 4: Сборка из серийной в литражную (марки в ТЧ Серии)
			ТипСценария = "СборкаВЛитражную";
			
			// Подсчет марок из ТЧ Серии для номенклатуры из ТЧ Товары
			Для Каждого СтрокаСерии Из ТаблицаМаркируемыхСерий Цикл
				
				// Проверяем наличие этой номенклатуры в ТЧ Товары
				ЕстьВТоварах = Ложь;
				Для Каждого СтрокаТовара Из ТаблицаМаркируемыхТоваров Цикл
					Если СтрокаТовара.Номенклатура = СтрокаСерии.Номенклатура Тогда
						ЕстьВТоварах = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				
				Если ЕстьВТоварах Тогда
					КоличествоТребуется = КоличествоТребуется + 1;
					КоличествоФакт = КоличествоФакт + 1; // Каждая строка ТЧ Серии - это марка
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	ИначеЕсли ЕстьМаркируемыеВСериях Тогда
		
		// Обработка случая, когда маркируемая продукция только в ТЧ Серии
		ТипСценария = "МаркируемыеВСериях";
		
		// Марки в ТЧ Серии - количество строк
		КоличествоТребуется = ТаблицаМаркируемыхСерий.Количество();
		КоличествоФакт = ТаблицаМаркируемыхСерий.Количество(); // Каждая строка - это марка
		
	КонецЕсли;
	
	// Шаг 6: Сравнение и выдача ошибки
	Если КоличествоТребуется <> КоличествоФакт Тогда

		Если ТипСценария = "ПрямаяСборка" Тогда
			
			ТекстОшибки = СтрШаблон(
				"Количество алкогольной продукции в табличной части Товары (%1 упаковок) не совпадает с количеством акцизных марок в табличной части MRS_ДополнительныеАкцизныеМарки (%2 марок)! Укажите недостающие акцизные марки!",
				Формат(КоличествоТребуется, "ЧЦ=15; ЧДЦ=3"),
				Формат(КоличествоФакт, "ЧЦ=15; ЧДЦ=3"));
			
		ИначеЕсли ТипСценария = "Вскрытие" Тогда
			
			ТекстОшибки = СтрШаблон(
				"При вскрытии упаковок количество вскрываемых единиц (%1) не совпадает с количеством акцизных марок (%2)! Укажите акцизные марки для всех вскрываемых упаковок!",
				Формат(КоличествоТребуется, "ЧЦ=15; ЧДЦ=3"),
				Формат(КоличествоФакт, "ЧЦ=15; ЧДЦ=3"));
			
		ИначеЕсли ТипСценария = "Пересборка" Тогда
			
			ТекстОшибки = СтрШаблон(
				"При пересборке серийной продукции количество исходных упаковок (%1) не совпадает с количеством указанных акцизных марок (%2)! Проверьте табличную часть Серии и акцизные марки!",
				Формат(КоличествоТребуется, "ЧЦ=15; ЧДЦ=3"),
				Формат(КоличествоФакт, "ЧЦ=15; ЧДЦ=3"));
			
		ИначеЕсли ТипСценария = "СборкаВЛитражную" ИЛИ ТипСценария = "МаркируемыеВСериях" Тогда
			
			ТекстОшибки = СтрШаблон(
				"При сборке из серийной номенклатуры количество исходных единиц (%1) не совпадает с количеством акцизных марок (%2)! Укажите акцизные марки для всех единиц исходной продукции!",
				Формат(КоличествоТребуется, "ЧЦ=15; ЧДЦ=3"),
				Формат(КоличествоФакт, "ЧЦ=15; ЧДЦ=3"));
			
		Иначе
			
			ТекстОшибки = СтрШаблон(
				"Количество алкогольной продукции по данным документа (%1) не совпадает с количеством акцизных марок (%2)! Укажите акцизные марки!",
				Формат(КоличествоТребуется, "ЧЦ=15; ЧДЦ=3"),
				Формат(КоличествоФакт, "ЧЦ=15; ЧДЦ=3"));
			
		КонецЕсли;
		
		ОбщегоНазначения.СообщитьПользователю(ТекстОшибки, , , , Отказ);
		
	КонецЕсли;
	
КонецПроцедуры