////////////////////////////////////////////////////////////////////////////////
// MRS_ИнтеграцияЕЛМАКлиент: Клиентский модуль интеграции с ЕЛМА
//
// Обеспечивает клиентскую логику:
// - Обработчики команд форм
// - Интерактивное взаимодействие с пользователем
// - Обработчики ожидания для автообновления статусов
// - Открытие форм параметров приказа
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область ОбработчикиКоманд

// Обработчик команды "Отправить в ЕЛМА"
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура КомандаОтправитьВЕЛМА(Форма) Экспорт
	
	// Проверка записи документа
	Если Форма.Модифицированность Тогда
		
		Ответ = Вопрос("Документ не записан. Записать документ перед отправкой в ЕЛМА?", 
			РежимДиалогаВопрос.ДаНет);
		
		Если Ответ = КодВозвратаДиалога.Да Тогда
			
			Попытка
				Форма.Записать();
			Исключение
				ПоказатьПредупреждение(, "Не удалось записать документ: " + ОписаниеОшибки());
				Возврат;
			КонецПопытки;
			
		Иначе
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	// Получение ранее сохраненных параметров приказа (если документ уже отправлялся)
	РанееСохраненныеПараметры = ПолучитьРанееСохраненныеПараметрыВызовСервера(Форма.Объект.Ссылка);
	
	// Если есть ранее сохраненные параметры - предлагаем использовать их
	Если РанееСохраненныеПараметры <> Неопределено Тогда
		
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("Форма", Форма);
		ДополнительныеПараметры.Вставить("РанееСохраненныеПараметры", РанееСохраненныеПараметры);
		
		ОповещениеОЗакрытии = Новый ОписаниеОповещения("ПослеВыбораИспользованияСохраненныхПараметров", ЭтотОбъект, 
			ДополнительныеПараметры);
		
		ТекстВопроса = "Документ уже отправлялся в ЕЛМА. Использовать предыдущие параметры приказа?";
		ПоказатьВопрос(ОповещениеОЗакрытии, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
		
	Иначе
		
		// Параметров нет - открываем форму для заполнения
		ОткрытьФормуПараметровПриказа(Форма, Неопределено);
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик закрытия формы параметров приказа
//
// Параметры:
//  РезультатВыбора - Структура - параметры приказа или Неопределено
//  ДополнительныеПараметры - ФормаКлиентскогоПриложения - форма документа
//
Процедура ПослеВыбораПараметровПриказа(РезультатВыбора, ДополнительныеПараметры) Экспорт
	
	Форма = ДополнительныеПараметры;
	
	Если РезультатВыбора = Неопределено Тогда
		// Пользователь отменил отправку
		Возврат;
	КонецЕсли;
	
	// Отправка документа в ЕЛМА немедленно
	РезультатОтправки = ОтправитьДокументВЕЛМАВызовСервера(Форма.Объект.Ссылка, РезультатВыбора);
	
	Если РезультатОтправки.Успех Тогда
		
		ПоказатьОповещениеПользователя(
			"Документ отправлен в ЕЛМА",
			,
			СтрШаблон("Документ успешно отправлен в систему ЕЛМА. Ожидаем согласование процесса."),
			БиблиотекаКартинок.Информация32);
		
		// Обновление статуса на форме
		ОбновитьСтатусНаФорме(Форма);
		
		// Подключение автообновления статуса
		//ПодключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса", 30);
		
	Иначе
		
		ТекстОшибки = "Не удалось отправить документ в ЕЛМА:" + Символы.ПС + РезультатОтправки.ТекстОшибки;
		ПоказатьПредупреждение(, ТекстОшибки, 15, "Ошибка отправки");
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик ответа на вопрос об использовании сохраненных параметров
//
// Параметры:
//  РезультатВопроса - КодВозвратаДиалога - результат выбора пользователя
//  ДополнительныеПараметры - Структура:
//   * Форма - ФормаКлиентскогоПриложения - форма документа
//   * РанееСохраненныеПараметры - Структура - сохраненные параметры приказа
//
Процедура ПослеВыбораИспользованияСохраненныхПараметров(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Форма = ДополнительныеПараметры.Форма;
	
	Если РезультатВопроса = КодВозвратаДиалога.Да Тогда
		
		// Используем сохраненные параметры - сразу отправляем
		РанееСохраненныеПараметры = ДополнительныеПараметры.РанееСохраненныеПараметры;
		ПослеВыбораПараметровПриказа(РанееСохраненныеПараметры, Форма);
		
	ИначеЕсли РезультатВопроса = КодВозвратаДиалога.Нет Тогда
		
		// Открываем форму для изменения параметров с предзаполнением
		РанееСохраненныеПараметры = ДополнительныеПараметры.РанееСохраненныеПараметры;
		ОткрытьФормуПараметровПриказа(Форма, РанееСохраненныеПараметры);
		
	Иначе
		
		// Отмена - ничего не делаем
		Возврат;
		
	КонецЕсли;
	
КонецПроцедуры

// Открывает форму параметров приказа ЕЛМА
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//  РанееСохраненныеПараметры - Структура, Неопределено - параметры для предзаполнения
//
Процедура ОткрытьФормуПараметровПриказа(Форма, РанееСохраненныеПараметры)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ДокументСсылка", Форма.Объект.Ссылка);
	
	// Передаем ранее сохраненные параметры для предзаполнения формы
	Если РанееСохраненныеПараметры <> Неопределено Тогда
		
		Если РанееСохраненныеПараметры.Свойство("ОтветственныйЗаИсполнение") Тогда
			ПараметрыФормы.Вставить("ОтветственныйЗаИсполнение", РанееСохраненныеПараметры.ОтветственныйЗаИсполнение);
		КонецЕсли;
		
		Если РанееСохраненныеПараметры.Свойство("СписокКОзнакомлению") Тогда
			ПараметрыФормы.Вставить("СписокКОзнакомлению", РанееСохраненныеПараметры.СписокКОзнакомлению);
		КонецЕсли;
		
		Если РанееСохраненныеПараметры.Свойство("ДатаНачалаДействия") Тогда
			ПараметрыФормы.Вставить("ДатаНачалаДействия", РанееСохраненныеПараметры.ДатаНачалаДействия);
		КонецЕсли;
		
	КонецЕсли;
	
	ОповещениеОЗакрытии = Новый ОписаниеОповещения("ПослеВыбораПараметровПриказа", ЭтотОбъект, Форма);
	
	ОткрытьФорму("ОбщаяФорма.MRS_ФормаПараметровПриказаЕЛМА", ПараметрыФормы, Форма, , , , ОповещениеОЗакрытии);
	
КонецПроцедуры

// Обработчик команды "Печать приказа ЕЛМА"
// Формирует Word-документ и показывает пользователю
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура КомандаПечатьПриказаЕЛМА(Форма) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Форма.Объект.Ссылка) Тогда
		ПоказатьПредупреждение(, "Документ не записан. Сначала запишите документ.");
		Возврат;
	КонецЕсли;
	
	// Формируем Word-документ приказа на сервере
	ДвоичныеДанные = MRS_ИнтеграцияЕЛМАСервер.СформироватьПриказЕЛМА(Форма.Объект.Ссылка);
	
	Если ДвоичныеДанные = Неопределено Тогда
		ПоказатьПредупреждение(, "Не удалось сформировать приказ. Проверьте наличие макета печати и закладки ""СтрокаТаблицы"".");
		Возврат;
	КонецЕсли;
	
	// Помещаем во временное хранилище для передачи на клиент
	Адрес = ПоместитьВоВременноеХранилище(ДвоичныеДанные, Форма.УникальныйИдентификатор);
	
	// Открываем документ для просмотра пользователю
	Попытка
		ФайловаяСистемаКлиент.ОткрытьФайл(Адрес, , "ПриказЕЛМА.docx");
	Исключение
		ПолучитьФайл(Адрес, "ПриказЕЛМА.docx", Истина);
	КонецПопытки;
	
КонецПроцедуры

// Показывает историю интеграции с ЕЛМА для документа
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
Процедура ПоказатьИсториюИнтеграцииЕЛМА(ДокументСсылка) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДокументСсылка) Тогда
		ПоказатьПредупреждение(, "Документ не записан");
		Возврат;
	КонецЕсли;
	
	// TODO: Открыть форму журнала интеграции с отбором по документу
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("УстановкаЦен", ДокументСсылка);
	
	ОткрытьФорму("РегистрСведений.MRS_ПроцессыЕЛМА.ФормаСписка", ПараметрыОтбора);
	
КонецПроцедуры

#КонецОбласти

#Область ОбновлениеСтатуса

// Обновляет статус документа на форме
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбновитьСтатусНаФорме(Форма) Экспорт
	
	MRS_ИнтеграцияЕЛМАКлиентСервер.ЗагрузитьСтатусДокумента(Форма);
	
	// Обновление видимости и доступности элементов формы
	ОбновитьВидимостьЭлементовФормы(Форма);
	
КонецПроцедуры

// Обновляет видимость и доступность элементов формы в зависимости от статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбновитьВидимостьЭлементовФормы(Форма) Экспорт
	
	// Команда "Отправить в ЕЛМА" доступна всегда (для повторной отправки)
	// Команда "Обновить статус" доступна только если документ отправлялся
	
	Если Форма.Элементы.Найти("КомандаОбновитьСтатусЕЛМА") <> Неопределено Тогда
		Форма.Элементы.КомандаОбновитьСтатусЕЛМА.Доступность = ЗначениеЗаполнено(Форма.УИДЕЛМА);
	КонецЕсли;
	
КонецПроцедуры

// Подключает обработчик ожидания для автоматического обновления статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ПодключитьОбработчикОжиданияКлиент(Форма) Экспорт
	
	// Проверяем, нужно ли автообновление статуса
	Если НЕ ЗначениеЗаполнено(Форма.УИДЕЛМА) Тогда
		Возврат;
	КонецЕсли;
	
	// TODO: Получить статус из формы и проверить необходимость автообновления
	// Пока подключаем для всех
	
	ПодключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса", 30);
	
КонецПроцедуры

// Обработчик ожидания для автоматического обновления статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбработчикОжиданияОбновлениеСтатуса(Форма) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Форма.УИДЕЛМА) Тогда
		ОтключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса");
		Возврат;
	КонецЕсли;
	
	// Обновляем статус
	ОбновитьСтатусНаФорме(Форма);
	
	// TODO: Проверить, нужно ли продолжать автообновление
	// Если статус финальный (Подписан, Отклонен, Отменен), отключаем обработчик
	
КонецПроцедуры

#КонецОбласти

#Область ВызовыСервера

// Отправялет документ в ЕЛМА (вызов сервера)
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  ПараметрыПриказа - Структура - параметры из формы
//
// Возвращаемое значение:
//  Булево - Истина если постановка в очередь выполнена
//
Функция ОтправитьДокументВЕЛМАВызовСервера(ДокументСсылка, ПараметрыПриказа)
	
	Возврат MRS_ИнтеграцияЕЛМАСервер.ОтправитьДокументВЕЛМАНемедленно(ДокументСсылка, ПараметрыПриказа);
	
КонецФункции

// Получает ранее сохраненные параметры приказа для документа (если документ уже отправлялся)
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - документ
//
// Возвращаемое значение:
//  Структура, Неопределено - параметры приказа или Неопределено если документ не отправлялся
//
Функция ПолучитьРанееСохраненныеПараметрыВызовСервера(ДокументСсылка)
	
	Возврат MRS_ИнтеграцияЕЛМАСервер.ПолучитьСохраненныеПараметрыПриказаДляКлиента(ДокументСсылка);
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Показывает информационное сообщение пользователю
//
// Параметры:
//  Текст - Строка - текст сообщения
//  Заголовок - Строка - заголовок сообщения
//
Процедура ПоказатьИнформацию(Текст, Заголовок = "Интеграция с ЕЛМА") Экспорт
	
	ПоказатьПредупреждение(, Текст, 10, Заголовок);
	
КонецПроцедуры

// Показывает вопрос пользователю с кнопками Да/Нет
//
// Параметры:
//  Текст - Строка - текст вопроса
//  ОписаниеОповещенияОЗакрытии - ОписаниеОповещения - обработчик ответа
//
Процедура ПоказатьВопросПользователю(Текст, ОписаниеОповещенияОЗакрытии) Экспорт
	
	ПоказатьВопрос(ОписаниеОповещенияОЗакрытии, Текст, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

