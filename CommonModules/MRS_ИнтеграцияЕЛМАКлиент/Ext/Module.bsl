////////////////////////////////////////////////////////////////////////////////
// MRS_ИнтеграцияЕЛМАКлиент: Клиентский модуль интеграции с ЕЛМА
//
// Обеспечивает клиентскую логику:
// - Обработчики команд форм
// - Интерактивное взаимодействие с пользователем
// - Обработчики ожидания для автообновления статусов
// - Открытие форм параметров приказа
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область ОбработчикиКоманд

// Обработчик команды "Отправить в ЕЛМА"
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура КомандаОтправитьВЕЛМА(Форма) Экспорт
	
	// Проверка заполнения документа
	РезультатВалидации = MRS_ИнтеграцияЕЛМАКлиентСервер.ВалидироватьДокументПередОтправкой(Форма.Объект);
	
	Если НЕ РезультатВалидации.Успех Тогда
		
		ТекстОшибок = "";
		Для Каждого Ошибка Из РезультатВалидации.МассивОшибок Цикл
			ТекстОшибок = ТекстОшибок + Ошибка + Символы.ПС;
		КонецЦикла;
		
		ПоказатьПредупреждение(, ТекстОшибок, 5);
		Возврат;
		
	КонецЕсли;
	
	// Проверка записи документа
	Если Форма.Модифицированность Тогда
		
		Ответ = Вопрос("Документ не записан. Записать документ перед отправкой в ЕЛМА?", 
			РежимДиалогаВопрос.ДаНет);
		
		Если Ответ = КодВозвратаДиалога.Да Тогда
			
			Попытка
				Форма.Записать();
			Исключение
				ПоказатьПредупреждение(, "Не удалось записать документ: " + ОписаниеОшибки());
				Возврат;
			КонецПопытки;
			
		Иначе
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	// Открытие формы параметров приказа
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ДокументСсылка", Форма.Объект.Ссылка);
	
	ОповещениеОЗакрытии = Новый ОписаниеОповещения("ПослеВыбораПараметровПриказа", ЭтотОбъект, Форма);
	
	ОткрытьФорму("ОбщаяФорма.MRS_ФормаПараметровПриказаЕЛМА", ПараметрыФормы, Форма,,,, ОповещениеОЗакрытии);
	
КонецПроцедуры

// Обработчик закрытия формы параметров приказа
//
// Параметры:
//  РезультатВыбора - Структура - параметры приказа или Неопределено
//  ДополнительныеПараметры - ФормаКлиентскогоПриложения - форма документа
//
Процедура ПослеВыбораПараметровПриказа(РезультатВыбора, ДополнительныеПараметры) Экспорт
	
	Форма = ДополнительныеПараметры;
	
	Если РезультатВыбора = Неопределено Тогда
		// Пользователь отменил отправку
		Возврат;
	КонецЕсли;
	
	// Отправка документа в ЕЛМА
	Попытка
		
		Успех = ПоставитьДокументВОчередьВызовСервера(Форма.Объект.Ссылка, РезультатВыбора);
		
		Если Успех Тогда
			
			ПоказатьОповещениеПользователя(
				"Документ отправлен в ЕЛМА",
				,
				"Документ поставлен в очередь на отправку в систему ЕЛМА для согласования",
				БиблиотекаКартинок.Информация32);
			
			// Обновление статуса на форме
			ОбновитьСтатусНаФорме(Форма);
			
			// Подключение автообновления статуса
			ПодключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса", 30);
			
		Иначе
			
			ПоказатьПредупреждение(, "Не удалось отправить документ в ЕЛМА. Подробности см. в журнале регистрации.");
			
		КонецЕсли;
		
	Исключение
		
		ПоказатьПредупреждение(, "Ошибка отправки документа в ЕЛМА: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

// Обработчик команды "Обновить статус ЕЛМА"
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура КомандаОбновитьСтатусЕЛМА(Форма) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Форма.Объект.Ссылка) Тогда
		ПоказатьПредупреждение(, "Документ не записан");
		Возврат;
	КонецЕсли;
	
	// Запрос статуса с сервера
	ОбновитьСтатусНаФорме(Форма);
	
	ПоказатьОповещениеПользователя(
		"Статус обновлен",
		,
		"Статус документа в ЕЛМА обновлен",
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

// Показывает историю интеграции с ЕЛМА для документа
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//
Процедура ПоказатьИсториюИнтеграцииЕЛМА(ДокументСсылка) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДокументСсылка) Тогда
		ПоказатьПредупреждение(, "Документ не записан");
		Возврат;
	КонецЕсли;
	
	// TODO: Открыть форму журнала интеграции с отбором по документу
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("Документ1С", ДокументСсылка);
	
	ОткрытьФорму("РегистрСведений.MRS_ПроцессыЕЛМА.ФормаСписка", ПараметрыОтбора);
	
КонецПроцедуры

#КонецОбласти

#Область ОбновлениеСтатуса

// Обновляет статус документа на форме
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбновитьСтатусНаФорме(Форма) Экспорт
	
	MRS_ИнтеграцияЕЛМАКлиентСервер.ЗагрузитьСтатусДокумента(Форма);
	
	// Обновление видимости и доступности элементов формы
	ОбновитьВидимостьЭлементовФормы(Форма);
	
КонецПроцедуры

// Обновляет видимость и доступность элементов формы в зависимости от статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбновитьВидимостьЭлементовФормы(Форма) Экспорт
	
	// Команда "Отправить в ЕЛМА" доступна всегда (для повторной отправки)
	// Команда "Обновить статус" доступна только если документ отправлялся
	
	Если Форма.Элементы.Найти("КомандаОбновитьСтатусЕЛМА") <> Неопределено Тогда
		Форма.Элементы.КомандаОбновитьСтатусЕЛМА.Доступность = ЗначениеЗаполнено(Форма.УИДЕЛМА);
	КонецЕсли;
	
КонецПроцедуры

// Подключает обработчик ожидания для автоматического обновления статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ПодключитьОбработчикОжидания(Форма) Экспорт
	
	// Проверяем, нужно ли автообновление статуса
	Если НЕ ЗначениеЗаполнено(Форма.УИДЕЛМА) Тогда
		Возврат;
	КонецЕсли;
	
	// TODO: Получить статус из формы и проверить необходимость автообновления
	// Пока подключаем для всех
	
	ПодключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса", 30);
	
КонецПроцедуры

// Обработчик ожидания для автоматического обновления статуса
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ОбработчикОжиданияОбновлениеСтатуса(Форма) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Форма.УИДЕЛМА) Тогда
		ОтключитьОбработчикОжидания("ОбработчикОжиданияОбновлениеСтатуса");
		Возврат;
	КонецЕсли;
	
	// Обновляем статус
	ОбновитьСтатусНаФорме(Форма);
	
	// TODO: Проверить, нужно ли продолжать автообновление
	// Если статус финальный (Подписан, Отклонен, Отменен), отключаем обработчик
	
КонецПроцедуры

#КонецОбласти

#Область ВызовыСервера

// Ставит документ в очередь на отправку в ЕЛМА (вызов сервера)
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры
//  ПараметрыПриказа - Структура - параметры из формы
//
// Возвращаемое значение:
//  Булево - Истина если постановка в очередь выполнена
//
Функция ПоставитьДокументВОчередьВызовСервера(ДокументСсылка, ПараметрыПриказа)
	
	Возврат MRS_ИнтеграцияЕЛМАСервер.ПоставитьДокументВОчередьЕЛМА(ДокументСсылка, ПараметрыПриказа);
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Показывает информационное сообщение пользователю
//
// Параметры:
//  Текст - Строка - текст сообщения
//  Заголовок - Строка - заголовок сообщения
//
Процедура ПоказатьИнформацию(Текст, Заголовок = "Интеграция с ЕЛМА") Экспорт
	
	ПоказатьПредупреждение(, Текст, 10, Заголовок);
	
КонецПроцедуры

// Показывает вопрос пользователю с кнопками Да/Нет
//
// Параметры:
//  Текст - Строка - текст вопроса
//  ОписаниеОповещенияОЗакрытии - ОписаниеОповещения - обработчик ответа
//
Процедура ПоказатьВопрос(Текст, ОписаниеОповещенияОЗакрытии) Экспорт
	
	ПоказатьВопрос(ОписаниеОповещенияОЗакрытии, Текст, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

