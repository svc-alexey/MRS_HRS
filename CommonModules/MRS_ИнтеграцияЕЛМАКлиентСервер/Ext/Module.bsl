////////////////////////////////////////////////////////////////////////////////
// MRS_ИнтеграцияЕЛМАКлиентСервер: Клиент-серверный модуль интеграции с ЕЛМА
//
// Содержит функции, используемые как на клиенте, так и на сервере:
// - Работа с формами (добавление реквизитов и команд)
// - Форматирование и преобразование данных
// - Валидация
// - Получение представлений статусов и цветов
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область РаботаСФормами

// Вызывается при создании формы документа УстановкаЦенНоменклатуры на сервере
// Добавляет элементы интеграции с ЕЛМА на форму программно
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//  Отказ - Булево - флаг отказа от создания формы
//  СтандартнаяОбработка - Булево - флаг стандартной обработки
//
Процедура ПриСозданииНаСервере(Форма, Отказ, СтандартнаяОбработка) Экспорт
	
	// Добавление реквизитов формы для хранения данных ЕЛМА
	МассивРеквизитов = Новый Массив;
	
	МассивРеквизитов.Добавить(Новый РеквизитФормы("СтатусЕЛМА", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(50))));
	МассивРеквизитов.Добавить(Новый РеквизитФормы("ДатаОтправкиВЕЛМА", Новый ОписаниеТипов("Дата")));
	МассивРеквизитов.Добавить(Новый РеквизитФормы("УИДЕЛМА", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(36))));
	МассивРеквизитов.Добавить(Новый РеквизитФормы("КомментарийЕЛМА", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(500))));
	
	Форма.ИзменитьРеквизиты(МассивРеквизитов);
	
	// Добавление команд формы
	КомандаОтправить = Форма.Команды.Добавить("КомандаОтправитьВЕЛМА");
	КомандаОтправить.Действие = "Подключаемый_КомандаОтправитьВЕЛМА";
	КомандаОтправить.Заголовок = "Отправить в ЕЛМА";
	КомандаОтправить.Подсказка = "Отправить документ в систему ЕЛМА для согласования";
	
	КомандаОбновить = Форма.Команды.Добавить("КомандаОбновитьСтатусЕЛМА");
	КомандаОбновить.Действие = "Подключаемый_КомандаОбновитьСтатусЕЛМА";
	КомандаОбновить.Заголовок = "Обновить статус ЕЛМА";
	КомандаОбновить.Подсказка = "Запросить актуальный статус документа из ЕЛМА";
	
	// TODO: Добавление элементов формы (группы, декорации) программно
	// Это требует более сложной логики работы с формами
	
	// Загрузка текущего статуса документа из регистра
	Если ЗначениеЗаполнено(Форма.Объект.Ссылка) Тогда
		ЗагрузитьСтатусДокумента(Форма);
	КонецЕсли;
	
КонецПроцедуры

// Загружает статус документа из регистра MRS_ПроцессыЕЛМА и заполняет реквизиты формы
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма документа
//
Процедура ЗагрузитьСтатусДокумента(Форма) Экспорт
	
	#Если Сервер Тогда
		
		СтруктураСтатуса = MRS_ИнтеграцияЕЛМАСервер.ПолучитьСтатусДокумента(Форма.Объект.Ссылка);
		
		Если СтруктураСтатуса <> Неопределено Тогда
			
			Форма.СтатусЕЛМА = ПолучитьТекстСтатусаЕЛМА(СтруктураСтатуса.Статус);
			Форма.ДатаОтправкиВЕЛМА = СтруктураСтатуса.ДатаОтправки;
			Форма.УИДЕЛМА = СтруктураСтатуса.УИДЕЛМА;
			Форма.КомментарийЕЛМА = СтруктураСтатуса.КомментарийЕЛМА;
			
		КонецЕсли;
		
	#КонецЕсли
	
КонецПроцедуры

#КонецОбласти

#Область ПреобразованиеДанных

// Получает текстовое представление статуса ЕЛМА для отображения пользователю
//
// Параметры:
//  СтатусЕЛМА - ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА или Строка
//
// Возвращаемое значение:
//  Строка - текстовое представление статуса
//
Функция ПолучитьТекстСтатусаЕЛМА(СтатусЕЛМА) Экспорт
	
	Если ТипЗнч(СтатусЕЛМА) = Тип("Строка") Тогда
		Возврат СтатусЕЛМА;
	КонецЕсли;
	
	#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
		
		Если СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ВОчереди Тогда
			Возврат "В очереди на отправку";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании Тогда
			Возврат "На согласовании";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Согласован Тогда
			Возврат "Согласован";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Подписан Тогда
			Возврат "Подписан";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отклонен Тогда
			Возврат "Отклонен";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отменен Тогда
			Возврат "Отменен";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Ошибка Тогда
			Возврат "Ошибка отправки";
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ТребуетВнимания Тогда
			Возврат "Требует внимания";
			
		Иначе
			Возврат "Не определен";
			
		КонецЕсли;
		
	#Иначе
		
		// На клиенте используем строковое представление
		Возврат Строка(СтатусЕЛМА);
		
	#КонецЕсли
	
КонецФункции

// Получает цвет для отображения статуса ЕЛМА
//
// Параметры:
//  СтатусЕЛМА - ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//
// Возвращаемое значение:
//  Цвет - цвет для оформления статуса
//
Функция ПолучитьЦветСтатусаЕЛМА(СтатусЕЛМА) Экспорт
	
	#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
		
		Если СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ВОчереди Тогда
			Возврат ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС; // Серый
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании Тогда
			Возврат ЦветаСтиля.ЦветГиперссылкиГосИС; // Синий
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Согласован Тогда
			Возврат ЦветаСтиля.ЦветГиперссылкиГосИС; // Синий
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Подписан Тогда
			Возврат ЦветаСтиля.ЦветТекстаУспехГосИС; // Зеленый
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отклонен Тогда
			Возврат ЦветаСтиля.ЦветОтрицательногоЧислаГосИС; // Красный
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отменен Тогда
			Возврат ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС; // Серый
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Ошибка Тогда
			Возврат ЦветаСтиля.ЦветТекстаТребуетВниманияГосИС; // Желтый
			
		ИначеЕсли СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ТребуетВнимания Тогда
			Возврат ЦветаСтиля.ЦветОтрицательногоЧислаГосИС; // Красный
			
		Иначе
			Возврат Новый Цвет; // Цвет по умолчанию
			
		КонецЕсли;
		
	#Иначе
		
		// На клиенте возвращаем цвет по умолчанию
		Возврат Новый Цвет;
		
	#КонецЕсли
	
КонецФункции

#КонецОбласти

#Область Валидация

// Валидирует документ перед отправкой в ЕЛМА (клиент-серверная проверка)
//
// Параметры:
//  Документ - ДокументОбъект.УстановкаЦенНоменклатуры или СтруктураДанных
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * МассивОшибок - Массив из Строка - список ошибок валидации
//
Функция ВалидироватьДокументПередОтправкой(Документ) Экспорт
	
	Результат = Новая Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("МассивОшибок", Новый Массив);
	
	// Проверка заполнения даты начала действия
	Если НЕ ЗначениеЗаполнено(Документ.ДатаНачалаДействия) Тогда
		Результат.МассивОшибок.Добавить("Не заполнена дата начала действия цен");
	КонецЕсли;
	
	// Проверка наличия строк с ценами
	#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
		
		Если Документ.ЦеныНоменклатуры.Количество() = 0 Тогда
			Результат.МассивОшибок.Добавить("В документе отсутствуют строки с ценами");
		КонецЕсли;
		
	#КонецЕсли
	
	// Проверка даты в будущем
	Если ЗначениеЗаполнено(Документ.ДатаНачалаДействия) Тогда
		
		Если Документ.ДатаНачалаДействия < НачалоДня(ТекущаяДатаСеанса()) Тогда
			Результат.МассивОшибок.Добавить("Дата начала действия не может быть в прошлом");
		КонецЕсли;
		
	КонецЕсли;
	
	Результат.Успех = (Результат.МассивОшибок.Количество() = 0);
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область Форматирование

// Форматирует дату для отображения в интерфейсе
//
// Параметры:
//  Дата - Дата - дата для форматирования
//  СПодробностями - Булево - включать ли время
//
// Возвращаемое значение:
//  Строка - отформатированная дата
//
Функция ФорматироватьДату(Дата, СПодробностями = Ложь) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Дата) Тогда
		Возврат "";
	КонецЕсли;
	
	Если СПодробностями Тогда
		Возврат Формат(Дата, "ДФ='dd.MM.yyyy HH:mm:ss'");
	Иначе
		Возврат Формат(Дата, "ДФ='dd.MM.yyyy'");
	КонецЕсли;
	
КонецФункции

// Формирует описание статуса для подсказки пользователю
//
// Параметры:
//  СтатусЕЛМА - ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//  ДатаОтправки - Дата
//  Комментарий - Строка
//
// Возвращаемое значение:
//  Строка - полное описание статуса
//
Функция ПолучитьОписаниеСтатуса(СтатусЕЛМА, ДатаОтправки = Неопределено, Комментарий = "") Экспорт
	
	Описание = ПолучитьТекстСтатусаЕЛМА(СтатусЕЛМА);
	
	Если ЗначениеЗаполнено(ДатаОтправки) Тогда
		Описание = Описание + Символы.ПС + "Дата отправки: " + ФорматироватьДату(ДатаОтправки, Истина);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Комментарий) Тогда
		Описание = Описание + Символы.ПС + "Комментарий: " + Комментарий;
	КонецЕсли;
	
	Возврат Описание;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Проверяет доступность функциональности интеграции с ЕЛМА
//
// Возвращаемое значение:
//  Булево - Истина если интеграция доступна
//
Функция ИнтеграцияЕЛМАДоступна() Экспорт
	
	// TODO: Реализовать проверку настроек и прав доступа
	// Пока всегда возвращаем Истина
	
	Возврат Истина;
	
КонецФункции

// Получает признак необходимости автоматического обновления статуса
//
// Параметры:
//  СтатусЕЛМА - ПеречислениеСсылка.MRS_СтатусыСинхронизацииЕЛМА
//
// Возвращаемое значение:
//  Булево - Истина если нужно обновлять статус автоматически
//
Функция ТребуетсяАвтообновлениеСтатуса(СтатусЕЛМА) Экспорт
	
	#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
		
		// Автообновление нужно для промежуточных статусов
		Если СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.ВОчереди
			Или СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.НаСогласовании
			Или СтатусЕЛМА = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Согласован Тогда
			
			Возврат Истина;
			
		КонецЕсли;
		
	#КонецЕсли
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти

#КонецОбласти

