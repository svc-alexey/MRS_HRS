# Анализ изменений: Сортировка строк перемещения по документу приобретения

**Дата реализации:** 2026-02-06

## Цель изменений

Изменить логику сортировки строк в документе "Перемещение товаров" так, чтобы порядок строк соответствовал порядку строк в документе "Приобретение товаров/услуг" (вместо заказа на перемещение).

## Измененный файл

`CommonModules/ПЛ_Формы/Ext/Module.bsl` - процедура `докПриобретениеТоваровУслугПослеЗаписиНаСервере`

## Внесенные изменения

### 1. Пакет 2 запроса (строка 65)

**Добавлено:**
```bsl
МИНИМУМ(ВТ_ПриобретениеТиУ.КодСтроки) КАК КодСтрокиПТУ
```

**Обоснование:** При группировке нескольких строк с одинаковой номенклатурой используется минимальный `КодСтроки` для сохранения порядка первого появления в документе приобретения.

### 2. Пакет 4 запроса (строки 144-156)

**Добавлено:**
- Новое поле в SELECT:
```bsl
СоединениеСПТУ.КодСтрокиПТУ КАК КодСтрокиПТУ
```

- ЛЕВОЕ СОЕДИНЕНИЕ:
```bsl
ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТоварыКОтгрузке КАК СоединениеСПТУ
ПО ВТ_ЗаказыНаПеремещение.ЗаказНаПеремещение = СоединениеСПТУ.ЗаказНаПеремещение
    И ВТ_ЗаказыНаПеремещение.Номенклатура = СоединениеСПТУ.НоменклатураЗаказа
    И ВТ_ЗаказыНаПеремещение.Характеристика = СоединениеСПТУ.Характеристика
    И ВТ_ЗаказыНаПеремещение.Назначение = СоединениеСПТУ.Назначение
```

- Изменена сортировка (УПОРЯДОЧИТЬ ПО):
```bsl
УПОРЯДОЧИТЬ ПО
    КодСтрокиПТУ,                                      // ← ПРИОРИТЕТ: порядок из ПТУ
    ВТ_ЗаказыНаПеремещение.ЗаказНаПеремещение.Дата,   // затем по дате заказа
    ВТ_ЗаказыНаПеремещение.НомерСтроки                 // и номеру строки в заказе
```

**Обоснование:** Сортировка на уровне СУБД - наиболее эффективный способ. ЛЕВОЕ СОЕДИНЕНИЕ используется для получения `КодСтрокиПТУ` из временной таблицы.

### 3. Таблица глобального распределения (строка 339)

**Добавлено:**
```bsl
ТЗ_ГлобальноеРаспределение.Колонки.Добавить("КодСтрокиПТУ", Новый ОписаниеТипов("Число"));
```

**Обоснование:** Требуется для режима с несколькими заказами на один склад.

### 4. Заполнение глобального распределения (строка 355)

**Добавлено:**
```bsl
НоваяСтрока.КодСтрокиПТУ = СтрокаЗаказа.КодСтрокиПТУ;
```

**Обоснование:** Передача значения `КодСтрокиПТУ` из результата запроса в таблицу распределения.

### 5. Сортировка глобального распределения (строка 380)

**Было:**
```bsl
ТЗ_ГлобальноеРаспределение.Сортировать("ДатаЗаказа, КодСтрокиЗаказа");
```

**Стало:**
```bsl
ТЗ_ГлобальноеРаспределение.Сортировать("КодСтрокиПТУ, ДатаЗаказа, КодСтрокиЗаказа");
```

**Обоснование:** Изменен приоритет сортировки - сначала по порядку из ПТУ, затем по дате и коду строки заказа.

## Особенности реализации

### Замена номенклатуры

Механизм подмены вскрытой/закрытой упаковки (строки 288-295, 365-376) работает корректно: все подмененные строки получают один `КодСтрокиПТУ` от строки-источника в ПТУ.

### Группировка строк

При агрегации нескольких строк ПТУ с одинаковой номенклатурой используется `MIN(КодСтроки)` - порядок определяется по первому появлению в приобретении.

### Работа с сериями

Серии обрабатываются отдельно (строки 160-173 запроса и 593-623 в коде) и не влияют на сортировку строк.

## Проверка синтаксиса

Выполнена проверка через `syntaxcheck`. Результат:
- ✅ Синтаксических ошибок нет
- ⚠️ Незначительные замечания по стилю кода (не критично)

## Преимущества решения

- ✅ Минимальные изменения кода (5 точек редактирования)
- ✅ Сортировка на уровне СУБД (быстро и эффективно)
- ✅ Работает для обоих режимов (с несколькими заказами и стандартный)
- ✅ Не требует изменения метаданных конфигурации
- ✅ Обратная совместимость - существующие документы не затрагиваются

## Рекомендации по тестированию

После внесения изменений рекомендуется проверить:

1. **Стандартный режим:** Создать ПТУ с 5 строками, проверить порядок в перемещении
2. **Режим с несколькими заказами:** Один склад + несколько заказов на перемещение
3. **Замена номенклатуры:** Вскрытая/закрытая упаковка
4. **Серийные номера:** Корректность работы с сериями
5. **Производительность:** Проверка на реальных объемах данных

## Статус

✅ **Реализация завершена**

Все запланированные изменения внесены и проверены на синтаксические ошибки.
