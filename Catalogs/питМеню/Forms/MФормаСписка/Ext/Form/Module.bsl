// Модуль формы списка справочника

Перем СпособРасчетаРецептур;  			// Способ подбора основной рецептуры для блюда.

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

&НаСервере
Функция ПолучитьИнформациюОбОшибке(ИнформацияОбОшибке)
	
	Результат = ИнформацияОбОшибке;
	Если ИнформацияОбОшибке <> Неопределено Тогда
		Если ИнформацияОбОшибке.Причина <> Неопределено Тогда
			Результат = ПолучитьИнформациюОбОшибке(ИнформацияОбОшибке.Причина);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура Очистить(Команда)
	ПоказатьВопрос(Новый ОписаниеОповещения("ОчиститьЗавершение", ЭтотОбъект), "Удалить все позиции из меню?",РежимДиалогаВопрос.ДаНет,,КодВозвратаДиалога.Нет,);
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Нет Тогда 
		Возврат; 
	КонецЕсли;
	
	ОчиститьСервер();
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьСервер()
	ВладелецПрайсЛиста = ПолучитьТекущегоВладельца();
	Справочники.питМеню.ОчиститьПрайсЛист(ВладелецПрайсЛиста)
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	питИзменениеОтраслевыхФормСервер.ПриСозданииНаСервереВНачале(ЭтаФорма, Отказ, СтандартнаяОбработка);
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	Если Параметры.Отбор.Свойство("Владелец") Тогда
		ОтборВладелец = Параметры.Отбор.Владелец;
		Элементы.СтраницыОтборВидПрайсЛиста.ТекущаяСтраница = Элементы.ГруппаОтображениеВидПрайсЛиста;
		Параметры.Отбор.Удалить("Владелец");
	Иначе
		Если ОтборВладелец.Пустая() Тогда
			ОтборВладелец = Справочники.питВидыМеню.ОсновнойВидМеню;
		КонецЕсли;
		Элементы.СтраницыОтборВидПрайсЛиста.ТекущаяСтраница = Элементы.ГруппаОтборВидПрайсЛиста;
	КонецЕсли;
	ОтборВладелецИспользование = ЗначениеЗаполнено(ОтборВладелец);
	питОбщегоНазначенияКлиентСервер.УстановитьБыстрыйОтбор(ЭтотОбъект, "Владелец");
	
	Если ТолькоПросмотр Тогда
		Элементы.ФормаУдалить.Доступность   = Ложь;
		Элементы.ФормаОчистить.Доступность	= Ложь;
	КонецЕсли;
	
	УправлениеДиалогом(ЭтаФорма);
	УстановитьВидимость();
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимость()
		
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
// Управляет видимостью и доступностью элементов формы.
Процедура УправлениеДиалогом(Форма)
	Элементы = Форма.Элементы;
	Доступно = ВладелецУстановлен(Форма);
	Элементы.ФормаОчистить.Доступность	= Доступно; 
	Элементы.ФормаВыгрузить.Доступность	= Доступно;
КонецПроцедуры // УправлениеДиалогом()


&НаКлиенте
Процедура ОбработкаЗаписиНового(НовыйОбъект, Источник, СтандартнаяОбработка)
	Попытка
		// Идентификатор может быть отличен от "Список",
		// позиционируемся на введенный объект через попытку.
		ЭтаФорма.Элементы.Список.ТекущаяСтрока = НовыйОбъект.Ссылка;
	Исключение КонецПопытки;
КонецПроцедуры

&НаСервере
Функция ПолучитьТекущегоВладельца()
	ВладелецОтбор = питОбщегоНазначенияКлиентСервер.ЭлементОтбораСпискаПоИмени(Список, "Владелец");
	Если ВладелецОтбор <> Неопределено Тогда
		ВладелецОтбор = ВладелецОтбор.ПравоеЗначение;
	Иначе
		ВладелецОтбор = Справочники.питВидыМеню.ПустаяСсылка()
	КонецЕсли;
	Возврат ВладелецОтбор
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ВладелецУстановлен(Форма)
	ВладелецОтбор = питОбщегоНазначенияКлиентСервер.ЭлементОтбораСпискаПоИмени(Форма.Список, "Владелец");
	Если ВладелецОтбор <> Неопределено Тогда
		ЗначениеОтбораВладелец = ?(ВладелецОтбор = Неопределено, Форма.ВидПрайсЛистаПустаяСсылка, ВладелецОтбор.ПравоеЗначение);
		ИспользованиеОтбораВладелец = ?(ВладелецОтбор = Неопределено, Ложь, ВладелецОтбор.Использование);
		
		Доступно = ЗначениеЗаполнено(ЗначениеОтбораВладелец) И ИспользованиеОтбораВладелец;
	Иначе
		Доступно = Ложь;
	КонецЕсли;
	
	Возврат Доступно;
КонецФункции

&НаКлиенте
Процедура УдалитьМеню(Команда)
	текСтрока = Элементы.Список.ТекущаяСтрока;
	Если ЗначениеЗаполнено(текСтрока) Тогда
		УдалитьМенюСервер(текСтрока);
		Элементы.Список.Обновить();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура УстановитьЦены(Команда)
	
	// Формирование списка вариантов выбора
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить("Выделенные", "Только выделенные позиции");
	СписокВыбора.Добавить("Группа", "Всю текущую группу");
	СписокВыбора.Добавить("ВсеМеню", "Все меню текущего вида");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("УстановитьЦеныВыборРежима", ЭтотОбъект);
	ПоказатьВыборИзМеню(ОписаниеОповещения, СписокВыбора, Элементы.ФормаУстановитьЦены);
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьЦеныВыборРежима(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = ВыбранныйЭлемент.Значение;
	
	// Получение выделенных строк
	ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	// Создание документа установки цен
	РезультатСоздания = СоздатьДокументУстановкиЦенНаСервере(Режим, ВыделенныеСтроки);
	
	Если РезультатСоздания.Успешно Тогда
		
		ТекстСообщения = СтрШаблон("Создан документ с %1 позициями номенклатуры", РезультатСоздания.КоличествоПозиций);
		ПоказатьОповещениеПользователя("Установка цен", , ТекстСообщения, БиблиотекаКартинок.Информация32);
		
		// Открытие созданного документа
		ОткрытьФорму("Документ.УстановкаЦенНоменклатуры.Форма.ФормаДокумента", 
			Новый Структура("Ключ", РезультатСоздания.Документ));
		
	Иначе
		
		ПоказатьПредупреждение(, РезультатСоздания.Сообщение);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоставитьВОчередьВыгрузки(Команда)
	
	// Формирование списка вариантов выбора
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить("Выделенные", "Только выделенные позиции");
	СписокВыбора.Добавить("Группа", "Всю текущую группу");
	СписокВыбора.Добавить("ВсеМеню", "Все меню текущего вида");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПоставитьВОчередьВыгрузкиВыборРежима", ЭтотОбъект);
	ПоказатьВыборИзМеню(ОписаниеОповещения, СписокВыбора, Элементы.ФормаПоставитьВОчередьВыгрузки);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоставитьВОчередьВыгрузкиВыборРежима(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = ВыбранныйЭлемент.Значение;
	
	// Получение выделенных строк
	ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	// Вызов серверной процедуры
	Результат = ПоставитьВОчередьВыгрузкиНаСервере(Режим, ВыделенныеСтроки);
	
	// Вывод результата
	Если Результат.Успешно Тогда
		
		Если Результат.КоличествоПропущено > 0 Тогда
			ТекстСообщения = СтрШаблон("Поставлено в очередь: %1 позиций. Пропущено: %2 (нет записи о цене).", 
				Результат.КоличествоПозиций, Результат.КоличествоПропущено);
		Иначе
			ТекстСообщения = СтрШаблон("Поставлено в очередь: %1 позиций.", Результат.КоличествоПозиций);
		КонецЕсли;
		
		ПоказатьОповещениеПользователя("Постановка в очередь", , ТекстСообщения, БиблиотекаКартинок.Информация32);
		
	Иначе
		
		ПоказатьПредупреждение(, Результат.Сообщение);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПоставитьВОчередьВыгрузкиНаСервере(Знач Режим, Знач ВыделенныеСтроки)
	
	Результат = Новый Структура("Успешно, Сообщение, КоличествоПозиций, КоличествоПропущено", Ложь, "", 0, 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Получение кассового узла по виду меню
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если Не ЗначениеЗаполнено(КассовыйУзел) Тогда
			Результат.Сообщение = "Не найден кассовый узел для данного вида меню";
			Возврат Результат;
		КонецЕсли;
		
		// Проверка вида цен у кассового узла
		ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
		
		Если Не ЗначениеЗаполнено(ВидЦен) Тогда
			Результат.Сообщение = СтрШаблон("Не указан вид цен для кассового узла ""%1""", Строка(КассовыйУзел));
			Возврат Результат;
		КонецЕсли;
		
		// Формирование списка позиций в зависимости от режима
		МассивПозиций = Новый Массив;
		
		Если Режим = "Выделенные" Тогда
			
			МассивПозиций = ПолучитьВыделенныеПозиции(ВыделенныеСтроки);
			
		ИначеЕсли Режим = "Группа" Тогда
			
			// Вся текущая группа
			ТекущийРодитель = Элементы.Список.ТекущийРодитель;
			МассивПозиций = ПолучитьВсеПозицииГруппы(ТекущийРодитель, ВидМеню);
			
		ИначеЕсли Режим = "ВсеМеню" Тогда
			
			// Все позиции вида меню
			МассивПозиций = ПолучитьВсеПозицииВидаМеню(ВидМеню);
			
		Иначе
			
			Результат.Сообщение = "Неизвестный режим постановки в очередь";
			Возврат Результат;
			
		КонецЕсли;
		
		Если МассивПозиций.Количество() = 0 Тогда
			Результат.Сообщение = "Не найдено позиций для постановки в очередь";
			Возврат Результат;
		КонецЕсли;
		
		// Получение данных о позициях с проверкой наличия цен
		ТаблицаПозицийСЦенами = ПолучитьПозицииСПроверкойЦен(МассивПозиций, КассовыйУзел);
		
		КоличествоДобавлено = 0;
		КоличествоПропущено = 0;
		
		// Постановка позиций в очередь с проверкой цены
		Для Каждого СтрокаПозиции Из ТаблицаПозицийСЦенами Цикл
			
			Если СтрокаПозиции.ЕстьЦена Тогда
				
				MRS_ИнтеграцияSimphonyСервер.ДобавитьВОчередьВыгрузки(СтрокаПозиции.Позиция, "CREATE", КассовыйУзел);
				КоличествоДобавлено = КоличествоДобавлено + 1;
				
			Иначе
				
				КоличествоПропущено = КоличествоПропущено + 1;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Результат.Успешно = Истина;
		Результат.КоличествоПозиций = КоличествоДобавлено;
		Результат.КоличествоПропущено = КоличествоПропущено;
		
	Исключение
		
		Результат.Сообщение = "Ошибка постановки в очередь: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Функция ПолучитьВыделенныеПозиции(Знач ВыделенныеСтроки)
	
	МассивПозиций = Новый Массив;
	
	Для Каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
		
		Если ТипЗнч(ВыделеннаяСтрока) = Тип("СправочникСсылка.питМеню") Тогда
			
			Если Не ВыделеннаяСтрока.ЭтоГруппа Тогда
				МассивПозиций.Добавить(ВыделеннаяСтрока);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат МассивПозиций;
	
КонецФункции

&НаСервере
Функция ПолучитьВсеПозицииГруппы(Родитель, ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	НЕ питМеню.ЭтоГруппа
		|	И питМеню.Родитель = &Родитель
		|	И питМеню.Владелец = &ВидМеню
		|	И НЕ питМеню.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("Родитель", Родитель);
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

&НаСервере
Функция ПолучитьВсеПозицииВидаМеню(ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	НЕ питМеню.ЭтоГруппа
		|	И питМеню.Владелец = &ВидМеню
		|	И НЕ питМеню.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

&НаСервере
Функция ПолучитьКассовыйУзелПоВидуМеню(ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питВидыМенюКассовыеУзлы.КассовыйУзел КАК КассовыйУзел
		|ИЗ
		|	Справочник.питВидыМеню.КассовыеУзлы КАК питВидыМенюКассовыеУзлы
		|ГДЕ
		|	питВидыМенюКассовыеУзлы.Ссылка = &ВидМеню";
	
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.КассовыйУзел;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

&НаКлиенте
Процедура ВыгрузитьМеню(Команда)
	
	ВидМеню = ПолучитьТекущегоВладельцаНаКлиенте();
	
	Если Не ЗначениеЗаполнено(ВидМеню) Тогда
		ПоказатьПредупреждение(, "Не выбран вид меню для выгрузки");
		Возврат;
	КонецЕсли;
	
	ТекстВопроса = СтрШаблон("Выгрузить все позиции меню ""%1"" в Simphony?", Строка(ВидМеню));
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыгрузитьМенюПодтверждение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьМенюПодтверждение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	// Вызов серверной процедуры
	Результат = ВыгрузитьМенюВSimphonyНаСервере();
	
	// Вывод результата
	Если Результат.Успешно Тогда
		
		ТекстСообщения = СтрШаблон("Выгружено: %1, Ошибок: %2", Результат.КоличествоУспешно, Результат.КоличествоОшибок);
		
		Если Результат.КоличествоОшибок > 0 Тогда
			ПоказатьПредупреждение(, ТекстСообщения);
		Иначе
			ПоказатьОповещениеПользователя("Выгрузка меню", , ТекстСообщения, БиблиотекаКартинок.Успешно32);
		КонецЕсли;
		
	Иначе
		
		ПоказатьПредупреждение(, Результат.Сообщение);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВыгрузитьМенюВSimphonyНаСервере()
	
	Результат = Новый Структура("Успешно, Сообщение, КоличествоУспешно, КоличествоОшибок", Ложь, "", 0, 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Получение кассового узла
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если Не ЗначениеЗаполнено(КассовыйУзел) Тогда
			Результат.Сообщение = "Не найден кассовый узел для данного вида меню";
			Возврат Результат;
		КонецЕсли;
		
		// Получение всех позиций меню
		МассивПозиций = ПолучитьВсеПозицииВидаМеню(ВидМеню);
		
		Если МассивПозиций.Количество() = 0 Тогда
			Результат.Сообщение = "Нет позиций для выгрузки";
			Возврат Результат;
		КонецЕсли;
		
		// Выгрузка позиций
		КоличествоУспешно = 0;
		КоличествоОшибок = 0;
		
		Для Каждого Позиция Из МассивПозиций Цикл
			
			РезультатВыгрузки = MRS_ИнтеграцияSimphonyСервер.ВыгрузитьПозициюВSimphony(Позиция, КассовыйУзел);
			
			Если РезультатВыгрузки.Успешно Тогда
				КоличествоУспешно = КоличествоУспешно + 1;
			Иначе
				КоличествоОшибок = КоличествоОшибок + 1;
			КонецЕсли;
			
		КонецЦикла;
		
		Результат.Успешно = Истина;
		Результат.КоличествоУспешно = КоличествоУспешно;
		Результат.КоличествоОшибок = КоличествоОшибок;
		
	Исключение
		
		Результат.Сообщение = "Ошибка выгрузки меню: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Функция ПолучитьТекущегоВладельцаНаКлиенте()
	
	Возврат ОтборВладелец;
	
КонецФункции

&НаСервере
Функция СоздатьДокументУстановкиЦенНаСервере(Знач Режим, Знач ВыделенныеСтроки)
	
	Результат = Новый Структура("Успешно, Сообщение, Документ, КоличествоПозиций", Ложь, "", Неопределено, 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Определение списка позиций в зависимости от режима
		МассивПозиций = Новый Массив;
		
		Если Режим = "Выделенные" Тогда
			
			// Только выделенные позиции
			Для Каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
				Если ТипЗнч(ВыделеннаяСтрока) = Тип("СправочникСсылка.питМеню") Тогда
					МассивПозиций.Добавить(ВыделеннаяСтрока);
				КонецЕсли;
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "Не выбрано ни одной позиции меню";
				Возврат Результат;
			КонецЕсли;
			
		ИначеЕсли Режим = "Группа" Тогда
			
			// Все элементы из текущей группы
			Если ВыделенныеСтроки.Количество() = 0 Тогда
				Результат.Сообщение = "Не выбрана группа";
				Возврат Результат;
			КонецЕсли;
			
			ТекущийРодитель = ВыделенныеСтроки[0];
			Если ТипЗнч(ТекущийРодитель) <> Тип("СправочникСсылка.питМеню") Тогда
				Результат.Сообщение = "Не выбрана группа";
				Возврат Результат;
			КонецЕсли;
			
			// Получение всех элементов группы
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	питМеню.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.питМеню КАК питМеню
				|ГДЕ
				|	питМеню.Родитель = &Родитель
				|	И НЕ питМеню.ЭтоГруппа
				|	И питМеню.Владелец = &ВидМеню";
			Запрос.УстановитьПараметр("Родитель", ТекущийРодитель);
			Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				МассивПозиций.Добавить(Выборка.Ссылка);
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "В выбранной группе нет элементов";
				Возврат Результат;
			КонецЕсли;
			
		ИначеЕсли Режим = "ВсеМеню" Тогда
			
			// Все элементы вида меню (кроме групп)
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	питМеню.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.питМеню КАК питМеню
				|ГДЕ
				|	питМеню.Владелец = &ВидМеню
				|	И НЕ питМеню.ЭтоГруппа";
			Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				МассивПозиций.Добавить(Выборка.Ссылка);
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "В меню нет элементов";
				Возврат Результат;
			КонецЕсли;
			
		Иначе
			
			Результат.Сообщение = "Неизвестный режим работы";
			Возврат Результат;
			
		КонецЕсли;
		
		// Сбор номенклатуры из позиций меню
		МассивНоменклатуры = Новый Массив;
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	питМеню.Номенклатура КАК Номенклатура
			|ИЗ
			|	Справочник.питМеню КАК питМеню
			|ГДЕ
			|	питМеню.Ссылка В(&МассивПозиций)
			|	И НЕ питМеню.ЭтоГруппа
			|	И питМеню.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
		Запрос.УстановитьПараметр("МассивПозиций", МассивПозиций);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			МассивНоменклатуры.Добавить(Выборка.Номенклатура);
		КонецЦикла;
		
		Если МассивНоменклатуры.Количество() = 0 Тогда
			Результат.Сообщение = "Не найдено позиций с заполненной номенклатурой";
			Возврат Результат;
		КонецЕсли;
		
		// Создание документа
		НовыйДокумент = Документы.УстановкаЦенНоменклатуры.СоздатьДокумент();
		НовыйДокумент.Дата = ТекущаяДатаСеанса();
		НовыйДокумент.Ответственный = Пользователи.ТекущийПользователь();
		НовыйДокумент.Комментарий = СтрШаблон("Создано из вида меню ""%1""", Строка(ВидМеню));
		
		// Заполнение табличной части Товары
		Для Каждого Номенклатура Из МассивНоменклатуры Цикл
			
			НоваяСтрока = НовыйДокумент.Товары.Добавить();
			НоваяСтрока.Номенклатура = Номенклатура;
			
		КонецЦикла;
		
		// Получение вида цен из кассового узла
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если ЗначениеЗаполнено(КассовыйУзел) Тогда
			
			ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
			
			Если ЗначениеЗаполнено(ВидЦен) Тогда
				
				НоваяСтрокаВида = НовыйДокумент.ВидыЦен.Добавить();
				НоваяСтрокаВида.ВидЦены = ВидЦен;
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Запись документа
		НовыйДокумент.Записать(РежимЗаписиДокумента.Запись);
		
		Результат.Успешно = Истина;
		Результат.Документ = НовыйДокумент.Ссылка;
		Результат.КоличествоПозиций = МассивНоменклатуры.Количество();
		
	Исключение
		
		Результат.Сообщение = "Ошибка создания документа: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Функция ПолучитьВидЦенКассовогоУзла(КассовыйУзел)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питУдаленныеКассы.ВидЦен КАК ВидЦен
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|ГДЕ
		|	питУдаленныеКассы.Ссылка = &КассовыйУзел";
	
	Запрос.УстановитьПараметр("КассовыйУзел", КассовыйУзел);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ВидЦен;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

&НаСервере
Функция ПолучитьПозицииСПроверкойЦен(МассивПозиций, КассовыйУзел)
	
	// Получаем вид цен кассового узла
	ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
	
	Если Не ЗначениеЗаполнено(ВидЦен) Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	// Формируем таблицу позиций с информацией о наличии цен
	ТаблицаПозиций = Новый ТаблицаЗначений;
	ТаблицаПозиций.Колонки.Добавить("Позиция", Новый ОписаниеТипов("СправочникСсылка.питМеню"));
	ТаблицаПозиций.Колонки.Добавить("ЕстьЦена", Новый ОписаниеТипов("Булево"));
	
	// Запрос для проверки наличия цен для всех позиций за один раз
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Позиция,
		|	питМеню.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ВТ_Позиции
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	питМеню.Ссылка В(&МассивПозиций)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЦеныНоменклатуры.Номенклатура КАК Номенклатура,
		|	МАКСИМУМ(ЦеныНоменклатуры.Цена) КАК Цена
		|ПОМЕСТИТЬ ВТ_Цены
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|ГДЕ
		|	ЦеныНоменклатуры.ВидЦены = &ВидЦены
		|	И ЦеныНоменклатуры.Период <= &Период
		|	И ЦеныНоменклатуры.Номенклатура В
		|			(ВЫБРАТЬ
		|				ВТ_Позиции.Номенклатура
		|			ИЗ
		|				ВТ_Позиции КАК ВТ_Позиции)
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦеныНоменклатуры.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Позиции.Позиция КАК Позиция,
		|	ВЫБОР
		|		КОГДА ВТ_Цены.Номенклатура ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьЦена
		|ИЗ
		|	ВТ_Позиции КАК ВТ_Позиции
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Цены КАК ВТ_Цены
		|		ПО ВТ_Позиции.Номенклатура = ВТ_Цены.Номенклатура";
	
	Запрос.УстановитьПараметр("МассивПозиций", МассивПозиций);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦен);
	Запрос.УстановитьПараметр("Период", ТекущаяДатаСеанса());
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура УдалитьМенюСервер(Меню)
	МенюОбъект = Меню.ПолучитьОбъект();
	МенюОбъект.ОбменДанными.Загрузка = Истина; //?? временно, исправление ошибки удаления элемента меню с правами Бухгалтера.
	// Из-за вот этого(↑↑↑↑↑↑↑)флага, при удалении объекта,
	// если это группа, то платформа не производит удаление дочерних,
	// поэтому остаются битые ссылки.
	// Ищем все дочерние элементы с учетом иерархии, для того, чтобы и их тоже удалить.
	МассивДочерних = Новый Массив;
	Если МенюОбъект.ОбменДанными.Загрузка И МенюОбъект.ЭтоГруппа Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	питМеню.Ссылка
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	питМеню.Родитель В ИЕРАРХИИ(&Родитель)";
		Запрос.УстановитьПараметр("Родитель", Меню);
		МассивДочерних = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	КонецЕсли;
	
	Попытка
		Если МенюОбъект.ОбменДанными.Загрузка Тогда
			// Удаление дочерних вручную
			Для каждого ТекДочернийЭлемент Из МассивДочерних Цикл
				ТекДочернийОбъект = ТекДочернийЭлемент.ПолучитьОбъект();
				ТекДочернийОбъект.ОбменДанными.Загрузка = Истина; //?? временно, исправление ошибки удаления элемента меню с правами Бухгалтера.
				ТекДочернийОбъект.Удалить();
			КонецЦикла;
		КонецЕсли;
		// Удаление непосредственно элемента меню
		МенюОбъект.Удалить();
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
	КонецПопытки;
КонецПроцедуры
