// Модуль формы списка справочника "питМеню"
//
// Описание:
//  Форма предназначена для управления списком позиций меню.
//  Обеспечивает функции:
//   - Создание и удаление позиций и групп меню
//   - Установку цен на позиции меню
//   - Постановку позиций в очередь выгрузки в Simphony
//   - Выгрузку меню в систему Simphony
//   - Навигацию по иерархической структуре меню
//

#Область ПеременныеМодуля

Перем СпособРасчетаРецептур; // Способ подбора основной рецептуры для блюда

#КонецОбласти

#Область ОбработчикиСобытийФормы

// Обработчик события создания формы на сервере.
//
// Параметры:
//  Отказ - Булево - признак отказа от создания формы
//  СтандартнаяОбработка - Булево - признак выполнения стандартной обработки события
//
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	питИзменениеОтраслевыхФормСервер.ПриСозданииНаСервереВНачале(ЭтаФорма, Отказ, СтандартнаяОбработка);
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	Если Параметры.Отбор.Свойство("Владелец") Тогда
		ОтборВладелец = Параметры.Отбор.Владелец;
		Элементы.СтраницыОтборВидПрайсЛиста.ТекущаяСтраница = Элементы.ГруппаОтображениеВидПрайсЛиста;
		Параметры.Отбор.Удалить("Владелец");
	Иначе
		Если ОтборВладелец.Пустая() Тогда
			ОтборВладелец = Справочники.питВидыМеню.ОсновнойВидМеню;
		КонецЕсли;
		Элементы.СтраницыОтборВидПрайсЛиста.ТекущаяСтраница = Элементы.ГруппаОтборВидПрайсЛиста;
	КонецЕсли;
	ОтборВладелецИспользование = ЗначениеЗаполнено(ОтборВладелец);
	питОбщегоНазначенияКлиентСервер.УстановитьБыстрыйОтбор(ЭтотОбъект, "Владелец");
	
	Если ТолькоПросмотр Тогда
		Элементы.ФормаУдалить.Доступность   = Ложь;
	КонецЕсли;
	
	УправлениеДиалогом(ЭтаФорма);
	УстановитьВидимость();
	
	НастроитьУсловноеОформлениеВыключен();	

КонецПроцедуры

// Обработчик события открытия формы.
//
// Параметры:
//  Отказ - Булево - признак отказа от открытия формы
//
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
КонецПроцедуры

// Обработчик события записи нового объекта.
//
// Параметры:
//  НовыйОбъект - СправочникОбъект - записанный объект
//  Источник - ФормаКлиентскогоПриложения - форма источника события
//  СтандартнаяОбработка - Булево - признак выполнения стандартной обработки события
//
&НаКлиенте
Процедура ОбработкаЗаписиНового(НовыйОбъект, Источник, СтандартнаяОбработка)
	
	// Идентификатор может быть отличен от "Список",
	// позиционируемся на введенный объект
	Попытка
		ЭтаФорма.Элементы.Список.ТекущаяСтрока = НовыйОбъект.Ссылка;
	Исключение
		// Не критично, если не удалось установить текущую строку
		Возврат;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

// Обработчик активизации строки в дереве групп меню.
// Устанавливает отбор списка по выбранной группе.
//
// Параметры:
//  Элемент - ПолеФормы - элемент формы "Дерево"
//
&НаКлиенте
Процедура ДеревоПриАктивизацииСтроки(Элемент)
	
	ТекущаяСтрока = Элемент.ТекущаяСтрока;
	
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем, изменился ли родитель - если нет, не делаем ничего
	Если ТекущийРодительДерева = ТекущаяСтрока Тогда
		Возврат;
	КонецЕсли;
	
	// Сохраняем текущего родителя
	ТекущийРодительДерева = ТекущаяСтрока;
	
	// Отложенное изменение отбора (чтобы не вызывать серверные методы в обработчике активизации)
	ПодключитьОбработчикОжидания("УстановитьОтборПоВыбраннойГруппе", 0.1, Истина);
	
КонецПроцедуры

// Обработчик изменения вида меню (владельца).
// Обновляет дерево групп и список меню.
//
// Параметры:
//  Элемент - ПолеФормы - элемент формы "ОтборВидПрайсЛиста"
//
&НаКлиенте
Процедура ОтборВидПрайсЛистаПриИзменении(Элемент)
	
	// Обновляем дерево групп
	//Элементы.Дерево.Обновить();
	
	// Сбрасываем текущего родителя дерева
	ТекущийРодительДерева = Неопределено;
	
	// Отложенное изменение отбора (чтобы не вызывать серверные методы в обработчике активизации)
	ПодключитьОбработчикОжидания("УстановитьОтборПоВыбранномуВидуМеню", 0.1, Истина);
	
КонецПроцедуры

// Обработчик изменения использования отбора по виду меню.
// Обновляет дерево групп и список меню.
//
// Параметры:
//  Элемент - ПолеФормы - элемент формы "ОтборВидПрайсЛистаИспользование"
//
&НаКлиенте
Процедура ОтборВидПрайсЛистаИспользованиеПриИзменении(Элемент)
	
	// Обновляем дерево групп
	Элементы.Дерево.Обновить();
	
	// Сбрасываем текущего родителя дерева
	ТекущийРодительДерева = Неопределено;
	
	// Обновляем список меню
	Элементы.Список.Обновить();
	
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиКомандФормы

#Область КомандыСозданияИУдаления

// Команда создания нового элемента меню.
// Открывает форму элемента с заполнением владельца и родителя.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура Создать(Команда)
	
	// Формируем параметры для открытия формы
	ПараметрыФормы = Новый Структура;
	// Передаём обработчик закрытия
	Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияФормы", ЭтаФорма);
	
	// Передаем владельца, если он установлен
	Если ЗначениеЗаполнено(ОтборВладелец) Тогда
		
		ПараметрыФормы.Вставить("ЗначенияЗаполнения", Новый Структура("Владелец, Родитель", ОтборВладелец, Элементы.Дерево.ТекущаяСтрока));
		
	КонецЕсли;
	
	// Открываем форму элемента
	ОткрытьФорму("Справочник.питМеню.Форма.МФормаЭлемента", ПараметрыФормы, ЭтаФорма, , , , Оповещение);
	
КонецПроцедуры

// Обработчик закрытия формы элемента меню.
// Обновляет список при успешной записи.
//
// Параметры:
//  Результат - Булево - признак успешного закрытия формы с записью
//  ДопПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура ПослеЗакрытияФормы(Результат, ДопПараметры) Экспорт
	
	// Обновляем список, если запись прошла
	Если Результат = Истина Тогда
		Элементы.Список.Обновить();
	КонецЕсли;
	
КонецПроцедуры

// Команда создания новой группы меню.
// Открывает форму группы с заполнением владельца.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура СоздатьГруппу(Команда)
	
	// Формируем параметры для открытия формы
	ПараметрыФормы = Новый Структура;
	
	// Передаем владельца, если он установлен
	Если ЗначениеЗаполнено(ОтборВладелец) Тогда
		
		ПараметрыФормы.Вставить("ЗначенияЗаполнения", Новый Структура("Владелец", ОтборВладелец));
		ПараметрыФормы.Вставить("ЭтоГруппа", Истина);
		
	КонецЕсли;
	
	// Открываем форму группы
	ОткрытьФорму("Справочник.питМеню.Форма.ФормаГруппы", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

// Команда очистки всех позиций из меню.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура Очистить(Команда)
	
	ПоказатьВопрос(Новый ОписаниеОповещения("ОчиститьЗавершение", ЭтотОбъект), 
		"Удалить все позиции из меню?", РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
	
КонецПроцедуры

// Обработчик завершения подтверждения очистки меню.
//
// Параметры:
//  РезультатВопроса - КодВозвратаДиалога - результат диалога
//  ДополнительныеПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура ОчиститьЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	ОчиститьСервер();
	Элементы.Список.Обновить();
	
КонецПроцедуры

// Команда удаления выбранной позиции меню.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура УдалитьМеню(Команда)
	
	текСтрока = Элементы.Список.ТекущаяСтрока;
	Если ЗначениеЗаполнено(текСтрока) Тогда
		УдалитьМенюСервер(текСтрока);
				
		Элементы.Список.Обновить();
		Элементы.Дерево.Обновить();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область УстановкаЦен

// Команда установки цен на позиции меню.
// Предоставляет выбор режима: выделенные, группа или все меню.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура УстановитьЦены(Команда)
	
	// Формирование списка вариантов выбора
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить("Выделенные", "Только выделенные позиции");
	СписокВыбора.Добавить("Группа", "Всю текущую группу");
	СписокВыбора.Добавить("ВсеМеню", "Все меню текущего вида");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("УстановитьЦеныВыборРежима", ЭтотОбъект);
	ПоказатьВыборИзМеню(ОписаниеОповещения, СписокВыбора);
	
КонецПроцедуры

// Обработчик выбора режима установки цен.
// Создает документ УстановкаЦенНоменклатуры на основе выбранных позиций.
//
// Параметры:
//  ВыбранныйЭлемент - ЭлементСпискаЗначений - выбранный режим работы
//  ДополнительныеПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура УстановитьЦеныВыборРежима(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = ВыбранныйЭлемент.Значение;
	
	// Получение выделенных строк
	ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	// Создание документа установки цен
	РезультатСоздания = СоздатьДокументУстановкиЦенНаСервере(Режим, ВыделенныеСтроки);
	
	Если РезультатСоздания.Успешно Тогда
		
		ТекстСообщения = СтрШаблон("Подготовлен документ с %1 позициями номенклатуры", РезультатСоздания.КоличествоПозиций);
		ПоказатьОповещениеПользователя("Установка цен", , ТекстСообщения, БиблиотекаКартинок.Информация32);
		
		// Открытие формы нового документа с оповещением о закрытии
		ПараметрыФормы = Новый Структура("АдресДокументаВХранилище", РезультатСоздания.АдресДокумента);
		Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияФормыУстановкиЦен", ЭтаФорма);
		ОткрытьФорму("Документ.УстановкаЦенНоменклатуры.Форма.ФормаДокумента", 
			ПараметрыФормы, ЭтаФорма, , , , Оповещение);
		
	Иначе
		
		ПоказатьПредупреждение(, РезультатСоздания.Сообщение);
		
	КонецЕсли;
	
КонецПроцедуры

// Обработчик закрытия формы документа установки цен.
// Обновляет список меню для отображения установленных цен.
//
// Параметры:
//  Результат - Произвольный - результат закрытия формы
//  ДопПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура ПослеЗакрытияФормыУстановкиЦен(Результат, ДопПараметры) Экспорт
	
	// Обновляем список меню независимо от результата,
	// чтобы подхватить новые установленные цены
	Элементы.Список.Обновить();
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСОчередьюВыгрузки

// Команда постановки позиций меню в очередь выгрузки в Simphony.
// Предоставляет выбор режима: выделенные, группа или все меню.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура ПоставитьВОчередьВыгрузки(Команда)
	
	// Формирование списка вариантов выбора
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить("Выделенные", "Только выделенные позиции");
	СписокВыбора.Добавить("Группа", "Всю текущую группу");
	СписокВыбора.Добавить("ВсеМеню", "Все меню текущего вида");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПоставитьВОчередьВыгрузкиВыборРежима", ЭтотОбъект);
	ПоказатьВыборИзМеню(ОписаниеОповещения, СписокВыбора);
	
КонецПроцедуры

// Обработчик выбора режима постановки в очередь выгрузки.
// Добавляет выбранные позиции в очередь выгрузки в Simphony.
//
// Параметры:
//  ВыбранныйЭлемент - ЭлементСпискаЗначений - выбранный режим работы
//  ДополнительныеПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура ПоставитьВОчередьВыгрузкиВыборРежима(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = ВыбранныйЭлемент.Значение;
	
	// Получение выделенных строк
	ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	// Вызов серверной процедуры
	Результат = ПоставитьВОчередьВыгрузкиНаСервере(Режим, ВыделенныеСтроки);
	
	// Вывод результата
	Если Результат.Успешно Тогда
		
		Если Результат.КоличествоПропущено > 0 Тогда
			ТекстСообщения = СтрШаблон("Поставлено в очередь: %1 позиций. Пропущено: %2 (нет записи о цене).", 
				Результат.КоличествоПозиций, Результат.КоличествоПропущено);
		Иначе
			ТекстСообщения = СтрШаблон("Поставлено в очередь: %1 позиций.", Результат.КоличествоПозиций);
		КонецЕсли;
		
		ПоказатьОповещениеПользователя("Постановка в очередь", , ТекстСообщения, БиблиотекаКартинок.Информация32);
		
	Иначе
		
		ПоказатьПредупреждение(, Результат.Сообщение);
		
	КонецЕсли;
	
	Элементы.Список.Обновить();
КонецПроцедуры

#КонецОбласти

#Область ВыгрузкаВSimphony

// Команда выгрузки меню в систему Simphony.
// Предоставляет выбор режима: выделенные, группа или все меню.
//
// Параметры:
//  Команда - КомандаФормы - выполняемая команда
//
&НаКлиенте
Процедура ВыгрузитьМеню(Команда)
	
	ВидМеню = ПолучитьТекущегоВладельцаНаКлиенте();
	
	Если Не ЗначениеЗаполнено(ВидМеню) Тогда
		ПоказатьПредупреждение(, "Не выбран вид меню для выгрузки");
		Возврат;
	КонецЕсли;
	
	// Формирование списка вариантов выбора
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить("Выделенные", "Только выделенные позиции");
	СписокВыбора.Добавить("Группа", "Всю текущую группу");
	СписокВыбора.Добавить("ВсеМеню", "Все меню текущего вида");
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыгрузитьМенюВыборРежима", ЭтотОбъект);
	ПоказатьВыборИзМеню(ОписаниеОповещения, СписокВыбора);
	
КонецПроцедуры

// Обработчик выбора режима выгрузки меню в Simphony.
// Запрашивает подтверждение и выполняет выгрузку выбранных позиций.
//
// Параметры:
//  ВыбранныйЭлемент - ЭлементСпискаЗначений - выбранный режим работы
//  ДополнительныеПараметры - Произвольный - дополнительные параметры
//
&НаКлиенте
Процедура ВыгрузитьМенюВыборРежима(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = ВыбранныйЭлемент.Значение;
	
	// Формируем текст вопроса в зависимости от режима
	ВидМеню = ПолучитьТекущегоВладельцаНаКлиенте();
	
	Если Режим = "Выделенные" Тогда
		ТекстВопроса = СтрШаблон("Выгрузить выделенные позиции меню ""%1"" в Simphony?", Строка(ВидМеню));
	ИначеЕсли Режим = "Группа" Тогда
		ТекстВопроса = СтрШаблон("Выгрузить всю текущую группу меню ""%1"" в Simphony?", Строка(ВидМеню));
	Иначе
		ТекстВопроса = СтрШаблон("Выгрузить все позиции меню ""%1"" в Simphony?", Строка(ВидМеню));
	КонецЕсли;
	
	// Получение выделенных строк
	ВыделенныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	// Подготовка параметров для обработчика подтверждения
	ДопПараметры = Новый Структура;
	ДопПараметры.Вставить("Режим", Режим);
	ДопПараметры.Вставить("ВыделенныеСтроки", ВыделенныеСтроки);
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыгрузитьМенюПодтверждение", ЭтотОбъект, ДопПараметры);
	ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да);
	
КонецПроцедуры

// Обработчик подтверждения выгрузки меню в Simphony.
// Выполняет выгрузку и выводит результат пользователю.
//
// Параметры:
//  РезультатВопроса - КодВозвратаДиалога - результат диалога
//  ДополнительныеПараметры - Структура - дополнительные параметры:
//   * Режим - Строка - режим работы: "Выделенные", "Группа" или "ВсеМеню"
//   * ВыделенныеСтроки - Массив - массив выделенных строк списка
//
&НаКлиенте
Процедура ВыгрузитьМенюПодтверждение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	// Вызов серверной процедуры с параметрами режима
	Результат = ВыгрузитьМенюВSimphonyНаСервере(ДополнительныеПараметры.Режим, ДополнительныеПараметры.ВыделенныеСтроки);
	
	// Вывод результата
	Если Результат.Успешно Тогда
		
		ТекстСообщения = СтрШаблон("Выгружено: %1, Ошибок: %2", Результат.КоличествоУспешно, Результат.КоличествоОшибок);
		
		Если Результат.КоличествоОшибок > 0 Тогда
			
			Если Результат.Свойство("СообщенияОбОшибках") И Результат.СообщенияОбОшибках.Количество() > 0 Тогда
				ТекстСообщения = ТекстСообщения + Символы.ПС + Символы.ПС + "Детали ошибок:" + Символы.ПС 
					+ СтрСоединить(Результат.СообщенияОбОшибках, Символы.ПС);
			КонецЕсли;
			
			ПоказатьПредупреждение(, ТекстСообщения);
			
		Иначе
			ПоказатьОповещениеПользователя("Выгрузка меню", , ТекстСообщения, БиблиотекаКартинок.Успешно32);
		КонецЕсли;
		
	Иначе
		
		ПоказатьПредупреждение(, Результат.Сообщение);
		
	КонецЕсли;
	
	Элементы.Список.Обновить();

КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область УправлениеФормой

// Устанавливает видимость элементов формы.
//
&НаСервере
Процедура УстановитьВидимость()
	
КонецПроцедуры

// Управляет видимостью и доступностью элементов формы в зависимости от установленного владельца.
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма списка
//
&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеДиалогом(Форма)
	
	Элементы = Форма.Элементы;
	Доступно = ВладелецУстановлен(Форма);
	
КонецПроцедуры

// Проверяет, установлен ли владелец (вид меню) в отборе списка.
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма списка
//
// Возвращаемое значение:
//  Булево - Истина, если владелец установлен и используется в отборе
//
&НаКлиентеНаСервереБезКонтекста
Функция ВладелецУстановлен(Форма)
	
	ВладелецОтбор = питОбщегоНазначенияКлиентСервер.ЭлементОтбораСпискаПоИмени(Форма.Список, "Владелец");
	Если ВладелецОтбор <> Неопределено Тогда
		ЗначениеОтбораВладелец = ?(ВладелецОтбор = Неопределено, Форма.ВидПрайсЛистаПустаяСсылка, ВладелецОтбор.ПравоеЗначение);
		ИспользованиеОтбораВладелец = ?(ВладелецОтбор = Неопределено, Ложь, ВладелецОтбор.Использование);
		
		Доступно = ЗначениеЗаполнено(ЗначениеОтбораВладелец) И ИспользованиеОтбораВладелец;
	Иначе
		Доступно = Ложь;
	КонецЕсли;
	
	Возврат Доступно;
	
КонецФункции

Процедура НастроитьУсловноеОформлениеВыключен()

	// Условное оформление для выключенных позиций - отображаем картинку "крестик"
	ЭлементУО = Список.УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = ЭлементУО.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных("Выключен");
	
	ОтборЭлемента = ЭлементУО.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Выключен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Картинка", БиблиотекаКартинок.ВводимыеСимволыСкрыты);
	
	// Условное оформление для активных позиций - отображаем картинку "галочка"
	ЭлементУО = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = ЭлементУО.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных("Выключен");
	
	ОтборЭлемента = ЭлементУО.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Выключен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;
	
	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Картинка", БиблиотекаКартинок.ВводимыеСимволыВидны);
	
КонецПроцедуры
#КонецОбласти

#Область РаботаСОтборами

// Устанавливает отбор списка по выбранной в дереве группе.
// Вызывается отложенно через обработчик ожидания.
//
&НаКлиенте
Процедура УстановитьОтборПоВыбраннойГруппе()
	
	// Устанавливаем отбор списка по выбранной группе
	ИспользоватьОтбор = ЗначениеЗаполнено(ТекущийРодительДерева);
	ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Родитель", ТекущийРодительДерева, ИспользоватьОтбор);
	
	// Сохраняем текущего родителя для создания новых элементов
	Элементы.Список.ТекущийРодитель = ТекущийРодительДерева;
	
КонецПроцедуры

// Устанавливает отбор списка по выбранному Виду меню (владельцу).
// Вызывается отложенно через обработчик ожидания.
//
&НаКлиенте
Процедура УстановитьОтборПоВыбранномуВидуМеню()
	
	// Устанавливаем отбор списка по выбранной группе
	ИспользоватьОтбор = ЗначениеЗаполнено(ОтборВладелец);
	ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(Список, "Владелец", ОтборВладелец, ИспользоватьОтбор);
	ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(Дерево, "Владелец", ОтборВладелец, ИспользоватьОтбор);
	
КонецПроцедуры

// Получает текущего владельца (вид меню) из отбора списка.
//
// Возвращаемое значение:
//  СправочникСсылка.питВидыМеню - выбранный вид меню или пустая ссылка
//
&НаСервере
Функция ПолучитьТекущегоВладельца()
	
	ВладелецОтбор = питОбщегоНазначенияКлиентСервер.ЭлементОтбораСпискаПоИмени(Список, "Владелец");
	Если ВладелецОтбор <> Неопределено Тогда
		ВладелецОтбор = ВладелецОтбор.ПравоеЗначение;
	Иначе
		ВладелецОтбор = Справочники.питВидыМеню.ПустаяСсылка();
	КонецЕсли;
	
	Возврат ВладелецОтбор;
	
КонецФункции

// Получает текущего владельца (вид меню) на клиенте из реквизита формы.
//
// Возвращаемое значение:
//  СправочникСсылка.питВидыМеню - выбранный вид меню
//
&НаКлиенте
Функция ПолучитьТекущегоВладельцаНаКлиенте()
	
	Возврат ОтборВладелец;
	
КонецФункции

#КонецОбласти

#Область РаботаСДанными

// Выполняет очистку всех позиций текущего вида меню на сервере.
//
&НаСервере
Процедура ОчиститьСервер()
	
	ВладелецПрайсЛиста = ПолучитьТекущегоВладельца();
	Справочники.питМеню.ОчиститьПрайсЛист(ВладелецПрайсЛиста);
	
КонецПроцедуры

// Удаляет позицию меню и при необходимости все дочерние элементы.
//
// Параметры:
//  Меню - СправочникСсылка.питМеню - удаляемая позиция меню
//
&НаСервере
Процедура УдалитьМенюСервер(Знач Меню)
	
	МенюОбъект = Меню.ПолучитьОбъект();
	
	// Если это не группа и есть код Simphony - сначала удаляем из Simphony
	Если НЕ МенюОбъект.ЭтоГруппа И ЗначениеЗаполнено(МенюОбъект.MRS_КодSimphony) Тогда
		
		// Получаем кассовый узел
		КассовыйУзел = ПолучитьКассовыйУзелДляПозиции(МенюОбъект.Владелец);
		
		Если ЗначениеЗаполнено(КассовыйУзел) Тогда
			
			// Получаем hierStrucId
			HierStrucId = MRS_ИнтеграцияSimphonyСервер.ПолучитьКодSimphonyУзла(КассовыйУзел);
			
			Если ЗначениеЗаполнено(HierStrucId) Тогда
				
				// Удаляем из Simphony
				РезультатУдаления = MRS_ИнтеграцияSimphonyСервер.УдалитьПозициюИзSimphonyСинхронно(
					МенюОбъект.MRS_КодSimphony,
					HierStrucId,
					МенюОбъект.Наименование
				);
				
				Если НЕ РезультатУдаления.Успешно Тогда
					
					// Не удалось удалить из Simphony - отменяем удаление
					ТекстСообщения = СтрШаблон("Не удалось удалить позицию из Simphony (HTTP %1): %2. Удаление отменено.", 
						РезультатУдаления.HTTPСтатус, 
						РезультатУдаления.Сообщение);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
					Возврат;
					
				Иначе
					
					// Успешно удалено из Simphony
					ТекстСообщения = СтрШаблон("Позиция удалена из Simphony. %1", РезультатУдаления.Сообщение);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Удаляем из базы 1С
	МенюОбъект.ОбменДанными.Загрузка = Истина; // Временно, исправление ошибки удаления элемента меню с правами Бухгалтера
	
	// Из-за флага ОбменДанными.Загрузка, при удалении объекта,
	// если это группа, то платформа не производит удаление дочерних,
	// поэтому остаются битые ссылки.
	// Ищем все дочерние элементы с учетом иерархии, для того, чтобы и их тоже удалить
	МассивДочерних = Новый Массив;
	Если МенюОбъект.ОбменДанными.Загрузка И МенюОбъект.ЭтоГруппа Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
			"ВЫБРАТЬ
			|	питМеню.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.питМеню КАК питМеню
			|ГДЕ
			|	питМеню.Родитель В ИЕРАРХИИ(&Родитель)";
		Запрос.УстановитьПараметр("Родитель", Меню);
		МассивДочерних = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
		
	КонецЕсли;
	
	Попытка
		
		Если МенюОбъект.ОбменДанными.Загрузка Тогда
			
			// Удаление дочерних вручную
			Для Каждого ТекДочернийЭлемент Из МассивДочерних Цикл
				
				ТекДочернийОбъект = ТекДочернийЭлемент.ПолучитьОбъект();
				ТекДочернийОбъект.ОбменДанными.Загрузка = Истина; // Временно, исправление ошибки удаления элемента меню с правами Бухгалтера
				ТекДочернийОбъект.Удалить();
				
			КонецЦикла;
			
		КонецЕсли;
		
		// Удаление непосредственно элемента меню
		МенюОбъект.Удалить();
		
	Исключение
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

// Получает кассовый узел для позиции меню по виду меню
//
// Параметры:
//  ВидМеню - СправочникСсылка.питВидыМеню - вид меню
//
// Возвращаемое значение:
//  ПланОбменаСсылка.питУдаленныеКассы - кассовый узел
//
&НаСервере
Функция ПолучитьКассовыйУзелДляПозиции(ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питУдаленныеКассы.Ссылка КАК Ссылка
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланОбмена.питУдаленныеКассы.ВидыМеню КАК питУдаленныеКассыВидыМеню
		|		ПО питУдаленныеКассы.Ссылка = питУдаленныеКассыВидыМеню.Ссылка
		|ГДЕ
		|	питУдаленныеКассыВидыМеню.ВидМеню = &ВидМеню";
	
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Получает список выделенных позиций меню (элементов, не групп).
//
// Параметры:
//  ВыделенныеСтроки - Массив - массив выделенных строк списка
//
// Возвращаемое значение:
//  Массив - массив ссылок на элементы справочника питМеню
//
&НаСервере
Функция ПолучитьВыделенныеПозиции(Знач ВыделенныеСтроки)
	
	МассивПозиций = Новый Массив;
	
	Для Каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
		
		Если ТипЗнч(ВыделеннаяСтрока) = Тип("СправочникСсылка.питМеню") Тогда
			
			Если Не ВыделеннаяСтрока.ЭтоГруппа Тогда
				МассивПозиций.Добавить(ВыделеннаяСтрока);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат МассивПозиций;
	
КонецФункции

// Получает все позиции меню из указанной группы.
//
// Параметры:
//  Родитель - СправочникСсылка.питМеню - группа меню
//  ВидМеню - СправочникСсылка.питВидыМеню - вид меню
//
// Возвращаемое значение:
//  Массив - массив ссылок на элементы справочника питМеню
//
&НаСервере
Функция ПолучитьВсеПозицииГруппы(Родитель, ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	НЕ питМеню.ЭтоГруппа
		|	И питМеню.Родитель = &Родитель
		|	И питМеню.Владелец = &ВидМеню
		|	И НЕ питМеню.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("Родитель", Родитель);
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

// Получает все позиции указанного вида меню.
//
// Параметры:
//  ВидМеню - СправочникСсылка.питВидыМеню - вид меню
//
// Возвращаемое значение:
//  Массив - массив ссылок на элементы справочника питМеню
//
&НаСервере
Функция ПолучитьВсеПозицииВидаМеню(ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	НЕ питМеню.ЭтоГруппа
		|	И питМеню.Владелец = &ВидМеню
		|	И НЕ питМеню.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

// Получает кассовый узел, связанный с указанным видом меню.
//
// Параметры:
//  ВидМеню - СправочникСсылка.питВидыМеню - вид меню
//
// Возвращаемое значение:
//  ПланОбменаСсылка.питУдаленныеКассы, Неопределено - кассовый узел или Неопределено, если не найден
//
&НаСервере
Функция ПолучитьКассовыйУзелПоВидуМеню(ВидМеню)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	питУдаленныеКассыВидыМеню.Ссылка КАК КассовыйУзел
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы.ВидыМеню КАК питУдаленныеКассыВидыМеню
		|ГДЕ
		|	питУдаленныеКассыВидыМеню.ВидМеню = &ВидМеню";
	
	Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.КассовыйУзел;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Получает вид цен, связанный с указанным кассовым узлом.
//
// Параметры:
//  КассовыйУзел - ПланОбменаСсылка.питУдаленныеКассы - кассовый узел
//
// Возвращаемое значение:
//  СправочникСсылка.ВидыЦен, Неопределено - вид цен или Неопределено, если не найден
//
&НаСервере
Функция ПолучитьВидЦенКассовогоУзла(КассовыйУзел)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питУдаленныеКассы.ВидЦен КАК ВидЦен
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы КАК питУдаленныеКассы
		|ГДЕ
		|	питУдаленныеКассы.Ссылка = &КассовыйУзел";
	
	Запрос.УстановитьПараметр("КассовыйУзел", КассовыйУзел);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ВидЦен;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область УстановкаЦен

// Создает документ установки цен на основе выбранных позиций меню.
//
// Параметры:
//  Режим - Строка - режим работы: "Выделенные", "Группа" или "ВсеМеню"
//  ВыделенныеСтроки - Массив - массив выделенных строк списка
//
// Возвращаемое значение:
//  Структура - результат выполнения операции:
//   * Успешно - Булево - признак успешного создания документа
//   * Сообщение - Строка - текст сообщения об ошибке
//   * Документ - ДокументСсылка.УстановкаЦенНоменклатуры - созданный документ
//   * КоличествоПозиций - Число - количество позиций номенклатуры в документе
//
&НаСервере
Функция СоздатьДокументУстановкиЦенНаСервере(Знач Режим, Знач ВыделенныеСтроки)
	
	Результат = Новый Структура("Успешно, Сообщение, АдресДокумента, КоличествоПозиций", Ложь, "", "", 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Определение списка позиций в зависимости от режима
		МассивПозиций = Новый Массив;
		
		Если Режим = "Выделенные" Тогда
			
			// Только выделенные позиции
			Для Каждого ВыделеннаяСтрока Из ВыделенныеСтроки Цикл
				Если ТипЗнч(ВыделеннаяСтрока) = Тип("СправочникСсылка.питМеню") Тогда
					МассивПозиций.Добавить(ВыделеннаяСтрока);
				КонецЕсли;
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "Не выбрано ни одной позиции меню";
				Возврат Результат;
			КонецЕсли;
			
		ИначеЕсли Режим = "Группа" Тогда
			
			// Все элементы из текущей группы
			Если ВыделенныеСтроки.Количество() = 0 Тогда
				Результат.Сообщение = "Не выбрана группа";
				Возврат Результат;
			КонецЕсли;
			
			ТекущийРодитель = ВыделенныеСтроки[0];
			Если ТипЗнч(ТекущийРодитель) <> Тип("СправочникСсылка.питМеню") Тогда
				Результат.Сообщение = "Не выбрана группа";
				Возврат Результат;
			КонецЕсли;
			
			// Получение всех элементов группы
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	питМеню.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.питМеню КАК питМеню
				|ГДЕ
				|	питМеню.Родитель = &Родитель
				|	И НЕ питМеню.ЭтоГруппа
				|	И питМеню.Владелец = &ВидМеню";
			Запрос.УстановитьПараметр("Родитель", ТекущийРодитель);
			Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				МассивПозиций.Добавить(Выборка.Ссылка);
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "В выбранной группе нет элементов";
				Возврат Результат;
			КонецЕсли;
			
		ИначеЕсли Режим = "ВсеМеню" Тогда
			
			// Все элементы вида меню (кроме групп)
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	питМеню.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.питМеню КАК питМеню
				|ГДЕ
				|	питМеню.Владелец = &ВидМеню
				|	И НЕ питМеню.ЭтоГруппа";
			Запрос.УстановитьПараметр("ВидМеню", ВидМеню);
			
			Выборка = Запрос.Выполнить().Выбрать();
			Пока Выборка.Следующий() Цикл
				МассивПозиций.Добавить(Выборка.Ссылка);
			КонецЦикла;
			
			Если МассивПозиций.Количество() = 0 Тогда
				Результат.Сообщение = "В меню нет элементов";
				Возврат Результат;
			КонецЕсли;
			
		Иначе
			
			Результат.Сообщение = "Неизвестный режим работы";
			Возврат Результат;
			
		КонецЕсли;
		
		// Сбор номенклатуры из позиций меню 
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	питУдаленныеКассыВидыМеню.Ссылка КАК Ссылка,
		|	питУдаленныеКассыMRS_КостПродаж.ГФУ_МЖ КАК ГФУ_МЖ,
		|	питУдаленныеКассыMRS_КостПродаж.ПроцентНаценки КАК ПроцентНаценки,
		|	питУдаленныеКассыMRS_КостПродаж.Ссылка.Организация КАК Организация,
		|	питУдаленныеКассыMRS_КостПродаж.Ссылка.СкладРеализации КАК СкладРеализации,
		|	питУдаленныеКассыВидыМеню.ВидМеню КАК ВидМеню
		|ПОМЕСТИТЬ ВТ_Наценка
		|ИЗ
		|	ПланОбмена.питУдаленныеКассы.ВидыМеню КАК питУдаленныеКассыВидыМеню
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПланОбмена.питУдаленныеКассы.MRS_КостПродаж КАК питУдаленныеКассыMRS_КостПродаж
		|		ПО (питУдаленныеКассыВидыМеню.Ссылка = питУдаленныеКассыMRS_КостПродаж.Ссылка)
		|ГДЕ
		|	питУдаленныеКассыВидыМеню.ВидМеню = &ВидМеню
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	питМеню.Номенклатура КАК Номенклатура,
		|	ВТ_Наценка.ПроцентНаценки КАК ПроцентНаценки,
		|	ВТ_Наценка.Организация КАК Организация,
		|	ВТ_Наценка.СкладРеализации КАК СкладРеализации,
		|	СтоимостьТоваровСрезПоследних.Стоимость КАК Стоимость,
		|	СтоимостьТоваровСрезПоследних.Стоимость
		|        * 1.2
		|        * (1 + ЕСТЬNULL(ВТ_Наценка.ПроцентНаценки, 0) / 100) КАК СтоимостьСНаценкой
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Наценка КАК ВТ_Наценка
		|		ПО (питМеню.Владелец = питМеню.Владелец)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров.СрезПоследних(&ТекущаяДата, ) КАК СтоимостьТоваровСрезПоследних
		|		ПО (питМеню.Номенклатура = СтоимостьТоваровСрезПоследних.АналитикаУчетаНоменклатуры.Номенклатура)
		|			И (СтоимостьТоваровСрезПоследних.АналитикаУчетаНоменклатуры.МестоХранения = ВТ_Наценка.СкладРеализации)
		|			И (СтоимостьТоваровСрезПоследних.Организация = ВТ_Наценка.Организация)
		|ГДЕ
		|	питМеню.Ссылка В(&МассивПозиций)
		|	И НЕ питМеню.ЭтоГруппа
		|	И питМеню.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";

		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
		
		Запрос.УстановитьПараметр("МассивПозиций", МассивПозиций);
		Запрос.УстановитьПараметр("ВидМеню", ВидМеню); 
		
		РезультатЗапроса = Запрос.Выполнить();

		Если РезультатЗапроса.Пустой() Тогда
			Результат.Сообщение = "Не найдено позиций с заполненной номенклатурой";
			Возврат Результат;
		КонецЕсли;

		ТаблицаДанных = РезультатЗапроса.Выгрузить();		
				
		// Создание документа
		НовыйДокумент = Документы.УстановкаЦенНоменклатуры.СоздатьДокумент();
		НовыйДокумент.Дата = ТекущаяДатаСеанса();
		НовыйДокумент.Ответственный = Пользователи.ТекущийПользователь();
		НовыйДокумент.Комментарий = СтрШаблон("Создано из вида меню ""%1""", Строка(ВидМеню));
		НовыйДокумент.Согласован = Истина;
		НовыйДокумент.Статус = Перечисления.СтатусыУстановокЦенНоменклатуры.Согласован;
				
		// Получение вида цен из кассового узла
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если ЗначениеЗаполнено(КассовыйУзел) Тогда
			
			ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
			
			Если ЗначениеЗаполнено(ВидЦен) Тогда
				
				НоваяСтрокаВида = НовыйДокумент.ВидыЦен.Добавить();
				НоваяСтрокаВида.ВидЦены = ВидЦен;
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Заполнение табличной части Товары
		КоличествоПозиций = 0;
		
		Для Каждого СтрокаДанных Из ТаблицаДанных Цикл
			
			НоваяСтрокаТовары = НовыйДокумент.Товары.Добавить();
			НоваяСтрокаТовары.Номенклатура = СтрокаДанных.Номенклатура;
			НоваяСтрокаТовары.ВидЦены = ВидЦен;
			НоваяСтрокаТовары.Цена = СтрокаДанных.СтоимостьСНаценкой;
			
			КоличествоПозиций = КоличествоПозиций + 1;
			
		КонецЦикла;
		
		
		// Сериализуем незаписанный документ в XML и помещаем во временное хранилище
		ЗаписьXML = Новый ЗаписьXML;
		ЗаписьXML.УстановитьСтроку();
		СериализаторXDTO.ЗаписатьXML(ЗаписьXML, НовыйДокумент, НазначениеТипаXML.Явное);
		XMLСтрока = ЗаписьXML.Закрыть();
		
		АдресДокумента = ПоместитьВоВременноеХранилище(XMLСтрока, УникальныйИдентификатор);
		
		Результат.Успешно = Истина;
		Результат.АдресДокумента = АдресДокумента;
		Результат.КоличествоПозиций = КоличествоПозиций;		
	Исключение
		
		Результат.Сообщение = "Ошибка создания документа: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ВыгрузкаВSimphony

// Постановка позиций меню в очередь выгрузки в Simphony на сервере.
//
// Параметры:
//  Режим - Строка - режим работы: "Выделенные", "Группа" или "ВсеМеню"
//  ВыделенныеСтроки - Массив - массив выделенных строк списка
//
// Возвращаемое значение:
//  Структура - результат выполнения операции:
//   * Успешно - Булево - признак успешного выполнения
//   * Сообщение - Строка - текст сообщения об ошибке
//   * КоличествоПозиций - Число - количество поставленных в очередь позиций
//   * КоличествоПропущено - Число - количество пропущенных позиций (нет цены)
//
&НаСервере
Функция ПоставитьВОчередьВыгрузкиНаСервере(Знач Режим, Знач ВыделенныеСтроки)
	
	Результат = Новый Структура("Успешно, Сообщение, КоличествоПозиций, КоличествоПропущено", Ложь, "", 0, 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Получение кассового узла по виду меню
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если Не ЗначениеЗаполнено(КассовыйУзел) Тогда
			Результат.Сообщение = "Не найден кассовый узел для данного вида меню";
			Возврат Результат;
		КонецЕсли;
		
		// Проверка вида цен у кассового узла
		ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
		
		Если Не ЗначениеЗаполнено(ВидЦен) Тогда
			Результат.Сообщение = СтрШаблон("Не указан вид цен для кассового узла ""%1""", Строка(КассовыйУзел));
			Возврат Результат;
		КонецЕсли;
		
		// Формирование списка позиций в зависимости от режима
		МассивПозиций = Новый Массив;
		
		Если Режим = "Выделенные" Тогда
			
			МассивПозиций = ПолучитьВыделенныеПозиции(ВыделенныеСтроки);
			
		ИначеЕсли Режим = "Группа" Тогда
			
			// Вся текущая группа
			ТекущийРодитель = Элементы.Список.ТекущийРодитель;
			МассивПозиций = ПолучитьВсеПозицииГруппы(ТекущийРодитель, ВидМеню);
			
		ИначеЕсли Режим = "ВсеМеню" Тогда
			
			// Все позиции вида меню
			МассивПозиций = ПолучитьВсеПозицииВидаМеню(ВидМеню);
			
		Иначе
			
			Результат.Сообщение = "Неизвестный режим постановки в очередь";
			Возврат Результат;
			
		КонецЕсли;
		
		Если МассивПозиций.Количество() = 0 Тогда
			Результат.Сообщение = "Не найдено позиций для постановки в очередь";
			Возврат Результат;
		КонецЕсли;
		
		// Получение данных о позициях с проверкой наличия цен
		ТаблицаПозицийСЦенами = ПолучитьПозицииСПроверкойЦен(МассивПозиций, КассовыйУзел);
		
		КоличествоДобавлено = 0;
		КоличествоПропущено = 0;
		
		// Постановка позиций в очередь с проверкой цены
		Для Каждого СтрокаПозиции Из ТаблицаПозицийСЦенами Цикл
			
			Если СтрокаПозиции.ЕстьЦена Тогда
				
				MRS_ИнтеграцияSimphonyСервер.ДобавитьВОчередьВыгрузки(СтрокаПозиции.Позиция, "CREATE", КассовыйУзел);
				КоличествоДобавлено = КоличествоДобавлено + 1;
				
			Иначе
				
				КоличествоПропущено = КоличествоПропущено + 1;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Результат.Успешно = Истина;
		Результат.КоличествоПозиций = КоличествоДобавлено;
		Результат.КоличествоПропущено = КоличествоПропущено;
		
	Исключение
		
		Результат.Сообщение = "Ошибка постановки в очередь: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает таблицу позиций меню с информацией о наличии цен.
//
// Параметры:
//  МассивПозиций - Массив - массив ссылок на позиции меню
//  КассовыйУзел - ПланОбменаСсылка.питУдаленныеКассы - кассовый узел для определения вида цен
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица с колонками:
//   * Позиция - СправочникСсылка.питМеню - позиция меню
//   * ЕстьЦена - Булево - признак наличия цены для позиции
//
&НаСервере
Функция ПолучитьПозицииСПроверкойЦен(МассивПозиций, КассовыйУзел)
	
	// Получаем вид цен кассового узла
	ВидЦен = ПолучитьВидЦенКассовогоУзла(КассовыйУзел);
	
	Если Не ЗначениеЗаполнено(ВидЦен) Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	// Формируем таблицу позиций с информацией о наличии цен
	ТаблицаПозиций = Новый ТаблицаЗначений;
	ТаблицаПозиций.Колонки.Добавить("Позиция", Новый ОписаниеТипов("СправочникСсылка.питМеню"));
	ТаблицаПозиций.Колонки.Добавить("ЕстьЦена", Новый ОписаниеТипов("Булево"));
	
	// Запрос для проверки наличия цен для всех позиций за один раз
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	питМеню.Ссылка КАК Позиция,
		|	питМеню.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ВТ_Позиции
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	питМеню.Ссылка В(&МассивПозиций)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЦеныНоменклатуры.Номенклатура КАК Номенклатура,
		|	МАКСИМУМ(ЦеныНоменклатуры.Цена) КАК Цена
		|ПОМЕСТИТЬ ВТ_Цены
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|ГДЕ
		|	ЦеныНоменклатуры.ВидЦены = &ВидЦены
		|	И ЦеныНоменклатуры.Период <= &Период
		|	И ЦеныНоменклатуры.Номенклатура В
		|			(ВЫБРАТЬ
		|				ВТ_Позиции.Номенклатура КАК Номенклатура
		|			ИЗ
		|				ВТ_Позиции КАК ВТ_Позиции)
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦеныНоменклатуры.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Позиции.Позиция КАК Позиция,
		|	ВЫБОР
		|		КОГДА ВТ_Цены.Номенклатура ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЕстьЦена
		|ИЗ
		|	ВТ_Позиции КАК ВТ_Позиции
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Цены КАК ВТ_Цены
		|		ПО ВТ_Позиции.Номенклатура = ВТ_Цены.Номенклатура";
	
	Запрос.УстановитьПараметр("МассивПозиций", МассивПозиций);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦен);
	Запрос.УстановитьПараметр("Период", ТекущаяДатаСеанса());
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат;
	
КонецФункции

// Выгружает позиции меню в систему Simphony.
//
// Параметры:
//  Режим - Строка - режим работы: "Выделенные", "Группа" или "ВсеМеню"
//  ВыделенныеСтроки - Массив - массив выделенных строк списка
//
// Возвращаемое значение:
//  Структура - результат выполнения операции:
//   * Успешно - Булево - признак успешного выполнения
//   * Сообщение - Строка - текст сообщения об ошибке
//   * КоличествоУспешно - Число - количество успешно выгруженных позиций
//   * КоличествоОшибок - Число - количество позиций с ошибками при выгрузке
//   * СообщенияОбОшибках - Массив из Строка - детальные сообщения об ошибках для каждой позиции
//
&НаСервере
Функция ВыгрузитьМенюВSimphonyНаСервере(Знач Режим, Знач ВыделенныеСтроки)
	
	Результат = Новый Структура("Успешно, Сообщение, КоличествоУспешно, КоличествоОшибок", Ложь, "", 0, 0);
	
	Попытка
		
		// Получение вида меню
		ВидМеню = ПолучитьТекущегоВладельца();
		
		Если Не ЗначениеЗаполнено(ВидМеню) Тогда
			Результат.Сообщение = "Не выбран вид меню";
			Возврат Результат;
		КонецЕсли;
		
		// Получение кассового узла
		КассовыйУзел = ПолучитьКассовыйУзелПоВидуМеню(ВидМеню);
		
		Если Не ЗначениеЗаполнено(КассовыйУзел) Тогда
			Результат.Сообщение = "Не найден кассовый узел для данного вида меню";
			Возврат Результат;
		КонецЕсли;
		
		// Формирование списка позиций в зависимости от режима
		МассивПозиций = Новый Массив;
		
		Если Режим = "Выделенные" Тогда
			
			МассивПозиций = ПолучитьВыделенныеПозиции(ВыделенныеСтроки);
			
		ИначеЕсли Режим = "Группа" Тогда
			
			// Вся текущая группа
			ТекущийРодитель = Элементы.Дерево.ТекущаяСтрока;
			МассивПозиций = ПолучитьВсеПозицииГруппы(ТекущийРодитель, ВидМеню);
			
		ИначеЕсли Режим = "ВсеМеню" Тогда
			
			// Все позиции вида меню
			МассивПозиций = ПолучитьВсеПозицииВидаМеню(ВидМеню);
			
		Иначе
			
			Результат.Сообщение = "Неизвестный режим выгрузки";
			Возврат Результат;
			
		КонецЕсли;
		
	Если МассивПозиций.Количество() = 0 Тогда
		Результат.Сообщение = "Нет позиций для выгрузки";
		Возврат Результат;
	КонецЕсли;
	
		// Выгрузка позиций
		КоличествоУспешно = 0;
		КоличествоОшибок = 0;
		МассивСообщенийОбОшибках = Новый Массив;
		
		Для Каждого Позиция Из МассивПозиций Цикл
			
			РезультатВыгрузки = MRS_ИнтеграцияSimphonyСервер.ВыгрузитьПозициюВSimphony(Позиция, КассовыйУзел);
			
			Если РезультатВыгрузки.Успешно Тогда
				КоличествоУспешно = КоличествоУспешно + 1;
			Иначе
				КоличествоОшибок = КоличествоОшибок + 1;
				
				Если ЗначениеЗаполнено(РезультатВыгрузки.Сообщение) Тогда
					ТекстОшибки = СтрШаблон("%1: %2", Строка(Позиция), РезультатВыгрузки.Сообщение);
					МассивСообщенийОбОшибках.Добавить(ТекстОшибки);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Результат.Успешно = Истина;
		Результат.КоличествоУспешно = КоличествоУспешно;
		Результат.КоличествоОшибок = КоличествоОшибок;
		Результат.Вставить("СообщенияОбОшибках", МассивСообщенийОбОшибках);
		
	Исключение
		
		Результат.Сообщение = "Ошибка выгрузки меню: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#КонецОбласти
