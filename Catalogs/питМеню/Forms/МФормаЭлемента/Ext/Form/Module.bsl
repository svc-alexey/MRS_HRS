// Модуль формы элемента справочника.
Перем СпособРасчетаРецептур;  			// Способ подбора основной рецептуры для блюда. 
Перем ПредыдущаяНоменклатура; // Предыдущее значение номенклатуры для отслеживания изменений.

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ



&НаСервере
// Проверяет вид номенклатуры на допустимость для добавления в меню.
//  Номенклатура - проверяемый элемент номенклатуры.
//
// Возвращаемое значение:
//  ТекстОшибки - текст ошибки, если вид номенклатуры не допустимый.
//  Булево      – Истина, если эту номенклатуру можно добавлять в меню.
//
Функция ПроверитьДопустимыйВидНоменклатуры(Номенклатура, ТекстОшибки="")
	
	ТекстОшибки="";
	
	Если Номенклатура.ЭтоГруппа ИЛИ Номенклатура.Пустая() Тогда
		Возврат Истина;
	Иначе
		ВидНоменклатуры = Номенклатура.питВидНоменклатуры;
		Если ВидНоменклатуры = Перечисления.питВидыНоменклатуры.Блюдо
			ИЛИ ВидНоменклатуры = Перечисления.питВидыНоменклатуры.Товар
			ИЛИ ВидНоменклатуры = Перечисления.питВидыНоменклатуры.БизнесЛанч
			ИЛИ ВидНоменклатуры = Перечисления.питВидыНоменклатуры.Услуга Тогда
			Возврат Истина;
		Иначе
			ТекстОшибки = "Меню может содержать только номенклатуру вида: блюдо, услуга, товар, бизнес-ланч.";
			Объект.Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
КонецФункции // ПроверитьДопустимыйВидНоменклатуры()


&НаСервере
// Генерирует 9-значный код Simphony
// Первая цифра: всегда 9
// Вторая цифра: берется из MRS_КодMajorGroup группы аналитического учета номенклатуры
// Оставшиеся 7 цифр: уникальный порядковый номер
//
// Возвращаемое значение:
//   Число - сгенерированный 9-значный код Simphony
//
Функция СгенерироватьКодSimphony()
	
	КодSimphony = 0;
	
	// Проверяем наличие номенклатуры
	Если НЕ ЗначениеЗаполнено(Объект.Номенклатура) Тогда
		Возврат КодSimphony;
	КонецЕсли;
	
	// Получаем данные о группе аналитического учета номенклатуры
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.ГруппаАналитическогоУчета.Родитель.MRS_КодMajorGroup КАК КодMajorGroup
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка = &Номенклатура";
	
	Запрос.УстановитьПараметр("Номенклатура", Объект.Номенклатура);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если НЕ Выборка.Следующий() Тогда
		Возврат КодSimphony;
	КонецЕсли;
	
	// Проверяем, заполнен ли код MajorGroup
	Если НЕ ЗначениеЗаполнено(Выборка.КодMajorGroup) Тогда
		Возврат КодSimphony;
	КонецЕсли;
	
	// Получаем первую цифру из кода MajorGroup для использования в качестве второй цифры кода Simphony
	СтрокаКодMajorGroup = Формат(Выборка.КодMajorGroup, "ЧГ=0");
	ВтораяЦифраКода = Число(Лев(СтрокаКодMajorGroup, 1));
	
	// Находим максимальный существующий код Simphony, начинающийся с 9 и заданной второй цифры
	ЗапросМаксКод = Новый Запрос;
	ЗапросМаксКод.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(МАКСИМУМ(питМеню.MRS_КодSimphony), 0) КАК МаксКод
		|ИЗ
		|	Справочник.питМеню КАК питМеню
		|ГДЕ
		|	питМеню.MRS_КодSimphony >= &МинГраница
		|	И питМеню.MRS_КодSimphony < &МаксГраница";
	
	// Определяем границы диапазона для кодов формата 9X0000000 - 9X9999999
	// где X - вторая цифра из КодMajorGroup
	МинГраница = 900000000 + ВтораяЦифраКода * 10000000;
	МаксГраница = 900000000 + (ВтораяЦифраКода + 1) * 10000000;
	
	ЗапросМаксКод.УстановитьПараметр("МинГраница", МинГраница);
	ЗапросМаксКод.УстановитьПараметр("МаксГраница", МаксГраница);
	
	РезультатМаксКод = ЗапросМаксКод.Выполнить();
	ВыборкаМаксКод = РезультатМаксКод.Выбрать();
	
	Если ВыборкаМаксКод.Следующий() Тогда
		
		Если ВыборкаМаксКод.МаксКод = 0 Тогда
			// Это первый код с такой комбинацией цифр (9X)
			КодSimphony = МинГраница;
		Иначе
			// Увеличиваем максимальный код на 1
			КодSimphony = ВыборкаМаксКод.МаксКод + 1;
		КонецЕсли;
		
	Иначе
		// Ошибка выполнения запроса
		КодSimphony = МинГраница;
	КонецЕсли;
	
	Возврат КодSimphony;
	
КонецФункции

&НаСервере
Процедура УстановитьЗначениеРеквизитовПриСменеНоменклатуры()
	Объект.Наименование = Объект.Номенклатура.Наименование;
	
	Если ЗначениеЗаполнено(Объект.Номенклатура) Тогда
		Если НЕ ЗначениеЗаполнено(СпособРасчетаРецептур) Тогда
			//СпособРасчетаРецептур	= Константы.питСпособРасчетаРецептур.Получить();
			СпособРасчетаРецептур	= питОбщегоНазначенияСервер.ПолучитьЗначениеПоУмолчанию("СпособРасчетаРецептур");
		КонецЕсли;	
		
		Если Объект.Номенклатура.питВидНоменклатуры = Перечисления.питВидыНоменклатуры.Блюдо Тогда
			Объект.Рецептура	= питПроизводство.ВернутьОсновнуюРецептуру(Объект.Номенклатура,,Перечисления.питХозяйственныеОперации.РецептураПриготовление,ТекущаяДата(),СпособРасчетаРецептур);
		Иначе
			Объект.Рецептура = Документы.питРецептура.ПустаяСсылка();
		КонецЕсли;
		
		//Объект.ЕдиницаИзмерения = Объект.Номенклатура.ЕдиницаИзмерения;
		Справочники.УпаковкиЕдиницыИзмерения.ОтобразитьИнформациюОЕдиницеХранения(Объект.Номенклатура, Элементы.ЕдиницаИзмерения);
	КонецЕсли;
	
	// Генерация/перегенерация кода Simphony при изменении номенклатуры
	НоменклатураИзменилась = НЕ ЗначениеЗаполнено(ПредыдущаяНоменклатура) 
		ИЛИ Объект.Номенклатура <> ПредыдущаяНоменклатура;
	
	Если ЗначениеЗаполнено(Объект.Номенклатура) И НоменклатураИзменилась Тогда
		Объект.MRS_КодSimphony = СгенерироватьКодSimphony();
		ПредыдущаяНоменклатура = Объект.Номенклатура;
	КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	
	// Проверим, можно ли использовать номенклатуру.	
	ТекстОшибки = "";
	Если НЕ ПроверитьДопустимыйВидНоменклатуры(Объект.Номенклатура, ТекстОшибки) Тогда
		ПоказатьПредупреждение(,ТекстОшибки);
		Возврат;
	КонецЕсли; 
	
	УстановитьЗначениеРеквизитовПриСменеНоменклатуры();
КонецПроцедуры

&НаКлиенте
// Обработчик изменения флага "Выключен"
// Синхронизирует изменение с Simphony API
//
Процедура ВыключенПриИзменении(Элемент)
	
	// Проверяем, что элемент уже записан
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Возврат;
	КонецЕсли;
	
	// Сохраняем текущее значение для возможного отката
	ПредыдущееЗначениеВыключен = НЕ Объект.Выключен;
	
	// Формируем текст вопроса
	ТекстВопроса = "";
	
	Если Объект.Выключен Тогда
		ТекстВопроса = "Вы уверены, что хотите скрыть позицию меню в Simphony?" + Символы.ПС + 
			"Позиция будет недоступна для выбора на кассе.";
	Иначе
		ТекстВопроса = "Вы уверены, что хотите показать позицию меню в Simphony?" + Символы.ПС + 
			"Позиция станет доступна для выбора на кассе.";
	КонецЕсли;
	
	// Параметры для передачи в обработчик завершения
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ПредыдущееЗначениеВыключен", ПредыдущееЗначениеВыключен);
	ДополнительныеПараметры.Вставить("ТекущееЗначениеВыключен", Объект.Выключен);
	
	// Показываем диалог подтверждения
	ПоказатьВопрос(
		Новый ОписаниеОповещения("ВыключенПриИзмененииЗавершение", ЭтотОбъект, ДополнительныеПараметры),
		ТекстВопроса,
		РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
// Обработчик завершения диалога подтверждения изменения видимости
//
// Параметры:
//  РезультатВопроса - КодВозвратаДиалога - результат диалога
//  ДополнительныеПараметры - Структура - дополнительные параметры
//
Процедура ВыключенПриИзмененииЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса <> КодВозвратаДиалога.Да Тогда
		
		// Пользователь отказался - откатываем изменение
		Объект.Выключен = ДополнительныеПараметры.ПредыдущееЗначениеВыключен;
		Возврат;
		
	КонецЕсли;
	
	// Вызываем серверную функцию для обновления видимости
	РезультатОбновления = ОбновитьВидимостьПозицииНаСервере(Объект.Ссылка, ДополнительныеПараметры.ТекущееЗначениеВыключен);
	
	Если НЕ РезультатОбновления.Успешно Тогда
		
		// Откатываем изменение флага
		Объект.Выключен = ДополнительныеПараметры.ПредыдущееЗначениеВыключен;
		
		// Показываем сообщение об ошибке
		ПоказатьПредупреждение(, "Ошибка синхронизации с Simphony:" + Символы.ПС + РезультатОбновления.Сообщение);
		
	Иначе
		
		// Показываем информационное сообщение об успешной синхронизации
		ПоказатьОповещениеПользователя("Синхронизация с Simphony", , РезультатОбновления.Сообщение, БиблиотекаКартинок.Информация32);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
// Вызывает серверную функцию обновления видимости позиции в Simphony
//
// Параметры:
//  Позиция - СправочникСсылка.питМеню - позиция меню
//  ЗначениеВыключен - Булево - новое значение флага Выключен
//
// Возвращаемое значение:
//  Структура - результат обновления от сервера
//
Функция ОбновитьВидимостьПозицииНаСервере(Позиция, ЗначениеВыключен)
	
	Возврат MRS_ИнтеграцияSimphonyСервер.ОбновитьВидимостьПозиции(Позиция, ЗначениеВыключен);
	
КонецФункции




&НаСервере
Функция ТоварУникаленВПрайсе()
	Если Объект.Владелец.ФлагУникальности И НЕ Справочники.питМеню.ТоварУникаленВПрайсе(Объект) Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
КонецФункции




////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ ЭЛЕМЕНТОВ УПРАВЛЕНИЯ ФОРМЫ


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	питИзменениеОтраслевыхФормСервер.ПриСозданииНаСервереВНачале(ЭтаФорма, Отказ, СтандартнаяОбработка);
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	Справочники.УпаковкиЕдиницыИзмерения.ОтобразитьИнформациюОЕдиницеХранения(Объект.Номенклатура, Элементы.ЕдиницаИзмерения);
	
	Если Параметры.ЗначенияЗаполнения.Свойство("Владелец") Тогда
		Элементы.Владелец.Видимость = Ложь;
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Объект", Объект);
	ДополнительныеПараметры.Вставить("ИмяЭлементаДляРазмещения", "ГруппаДополнительныеРеквизиты");
	УправлениеСвойствами.ПриСозданииНаСервере(ЭтотОбъект, ДополнительныеПараметры);
	
	// Сохраняем текущее значение номенклатуры для отслеживания изменений
	ПредыдущаяНоменклатура = Объект.Номенклатура;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УправлениеСвойствамиКлиент.ПослеЗагрузкиДополнительныхРеквизитов(ЭтотОбъект);
	Если ЗначениеЗаполнено(Объект.Ссылка)  Тогда
	Иначе
				
		// Генерация кода Simphony для нового элемента
		Если ЗначениеЗаполнено(Объект.Номенклатура) И НЕ ЗначениеЗаполнено(Объект.MRS_КодSimphony) Тогда
			Объект.MRS_КодSimphony = СгенерироватьКодSimphony();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Если НЕ ЗначениеЗаполнено(Объект.Наименование) Тогда
		Объект.Наименование = Объект.Номенклатура.Наименование;
	КонецЕсли;
	
	// Генерация кода Simphony для нового элемента, если он еще не сгенерирован
	Если ЗначениеЗаполнено(Объект.Номенклатура) И НЕ ЗначениеЗаполнено(Объект.MRS_КодSimphony) Тогда
		Объект.MRS_КодSimphony = СгенерироватьКодSimphony();
	КонецЕсли;
	
	УправлениеСвойствами.ПередЗаписьюНаСервере(ЭтаФорма, ТекущийОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	Если ЗначениеЗаполнено(Объект.Владелец) Тогда
		Если Не ТоварУникаленВПрайсе() Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Товар не уникален в меню <" + Объект.Владелец + ">";
			Сообщение.Сообщить();
			Отказ = Истина;
			Возврат;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	УправлениеСвойствами.ПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если УправлениеСвойствамиКлиент.ОбрабатыватьОповещения(ЭтотОбъект, ИмяСобытия, Параметр) Тогда
		ОбновитьЭлементыДополнительныхРеквизитов();
		УправлениеСвойствамиКлиент.ПослеЗагрузкиДополнительныхРеквизитов(ЭтотОбъект);
	КонецЕсли;
КонецПроцедуры

#Область УправлениеСвойствами

&НаКлиенте
Процедура ОбновитьЗависимостиДополнительныхРеквизитов()
	УправлениеСвойствамиКлиент.ОбновитьЗависимостиДополнительныхРеквизитов(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПриИзмененииДополнительногоРеквизита(Элемент)
	УправлениеСвойствамиКлиент.ОбновитьЗависимостиДополнительныхРеквизитов(ЭтотОбъект);
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДополнительныхРеквизитов()
	УправлениеСвойствами.ОбновитьЭлементыДополнительныхРеквизитов(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_СвойстваВыполнитьКоманду(ЭлементИлиКоманда, НавигационнаяСсылка = Неопределено, СтандартнаяОбработка = Неопределено)
	УправлениеСвойствамиКлиент.ВыполнитьКоманду(ЭтотОбъект, ЭлементИлиКоманда, СтандартнаяОбработка);
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	УправлениеСвойствами.ОбработкаПроверкиЗаполнения(ЭтаФорма, Отказ, ПроверяемыеРеквизиты);
КонецПроцедуры

&НаКлиенте
// Обработчик нажатия на гиперссылку "История синхронизации"
//
Процедура MRS_ИсторияСинхронизацииНажатие(Элемент)
	
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		ПоказатьПредупреждение(, "Сначала необходимо сохранить элемент!");
		Возврат;
		
	КонецЕсли;
	
	// Открываем регистр сведений с отбором по текущей позиции меню
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Отбор", Новый Структура("ПозицияМеню", Объект.Ссылка));
	
	ОткрытьФорму(
		"РегистрСведений.MRS_ИсторияСинхронизацииМенюSimphony.ФормаСписка",
		ПараметрыФормы,
		ЭтотОбъект,
		УникальныйИдентификатор
	);
	
КонецПроцедуры

#КонецОбласти
