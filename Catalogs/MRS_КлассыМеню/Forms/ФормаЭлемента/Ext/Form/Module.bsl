
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Создаем схему компоновки данных с доступными полями
	СоздатьСхемуКомпоновки();
	
	// Загружаем условия из табличной части в компоновщик
	ЗагрузитьУсловияИзТабличнойЧасти();
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	// Выгружаем условия из компоновщика в табличную часть
	ВыгрузитьУсловияВТабличнуюЧасть(ТекущийОбъект);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура СоздатьСхемуКомпоновки()
	
	СхемаКД = Новый СхемаКомпоновкиДанных;
	
	// Набор данных
	НаборДанных = СхемаКД.НаборыДанных.Добавить(Тип("НаборДанныхОбъектСхемыКомпоновкиДанных"));
	НаборДанных.Имя = "НаборДанных1";
	
	// Добавляем доступные поля для условий
	
	// СтавкаНДС
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "СтавкаНДС";
	Поле.ТипЗначения = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2));
	Поле.Заголовок = "Ставка НДС";
	
	// МернаяЕдиницаИзмерения
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "МернаяЕдиницаИзмерения";
	Поле.ТипЗначения = Новый ОписаниеТипов("Булево");
	Поле.Заголовок = "Мерная единица измерения";
	
	// СвободнаяЦена
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "СвободнаяЦена";
	Поле.ТипЗначения = Новый ОписаниеТипов("Булево");
	Поле.Заголовок = "Свободная цена";
	
	// ЕдиницаИзмерения
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "ЕдиницаИзмерения";
	Поле.ТипЗначения = Новый ОписаниеТипов("СправочникСсылка.УпаковкиЕдиницыИзмерения");
	Поле.Заголовок = "Единица измерения";
	
	// Номенклатура
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "Номенклатура";
	Поле.ТипЗначения = Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
	Поле.Заголовок = "Номенклатура";
	
	// Инициализируем компоновщик настроек
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКД));
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьУсловияИзТабличнойЧасти()
	
	// Очищаем текущие условия в компоновщике
	КомпоновщикНастроек.Настройки.Отбор.Элементы.Очистить();
	
	// Загружаем условия из табличной части
	Для Каждого СтрокаУсловия Из Объект.Условия Цикл
		
		ЭлементОтбора = КомпоновщикНастроек.Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(СтрокаУсловия.ВидУсловия);
		ЭлементОтбора.ВидСравнения = ПолучитьВидСравнения(СтрокаУсловия.Оператор);
		ЭлементОтбора.ПравоеЗначение = СтрокаУсловия.Значение;
		ЭлементОтбора.Использование = Истина;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ВыгрузитьУсловияВТабличнуюЧасть(ТекущийОбъект)
	
	// Очищаем табличную часть
	ТекущийОбъект.Условия.Очистить();
	
	// Выгружаем условия из компоновщика
	Для Каждого ЭлементОтбора Из КомпоновщикНастроек.Настройки.Отбор.Элементы Цикл
		
		Если ТипЗнч(ЭлементОтбора) = Тип("ЭлементОтбораКомпоновкиДанных") 
			И ЭлементОтбора.Использование Тогда
			
			НоваяСтрока = ТекущийОбъект.Условия.Добавить();
			НоваяСтрока.ВидУсловия = Строка(ЭлементОтбора.ЛевоеЗначение);
			НоваяСтрока.Оператор = ПолучитьОператорИзВидаСравнения(ЭлементОтбора.ВидСравнения);
			НоваяСтрока.Значение = ЭлементОтбора.ПравоеЗначение;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьВидСравнения(Оператор)
	
	Если Оператор = "Равно" Тогда
		Возврат ВидСравненияКомпоновкиДанных.Равно;
	ИначеЕсли Оператор = "НеРавно" Тогда
		Возврат ВидСравненияКомпоновкиДанных.НеРавно;
	ИначеЕсли Оператор = "Больше" Тогда
		Возврат ВидСравненияКомпоновкиДанных.Больше;
	ИначеЕсли Оператор = "БольшеИлиРавно" Тогда
		Возврат ВидСравненияКомпоновкиДанных.БольшеИлиРавно;
	ИначеЕсли Оператор = "Меньше" Тогда
		Возврат ВидСравненияКомпоновкиДанных.Меньше;
	ИначеЕсли Оператор = "МеньшеИлиРавно" Тогда
		Возврат ВидСравненияКомпоновкиДанных.МеньшеИлиРавно;
	ИначеЕсли Оператор = "Содержит" Тогда
		Возврат ВидСравненияКомпоновкиДанных.Содержит;
	ИначеЕсли Оператор = "НеСодержит" Тогда
		Возврат ВидСравненияКомпоновкиДанных.НеСодержит;
	ИначеЕсли Оператор = "Заполнено" Тогда
		Возврат ВидСравненияКомпоновкиДанных.Заполнено;
	ИначеЕсли Оператор = "НеЗаполнено" Тогда
		Возврат ВидСравненияКомпоновкиДанных.НеЗаполнено;
	Иначе
		Возврат ВидСравненияКомпоновкиДанных.Равно;
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ПолучитьОператорИзВидаСравнения(ВидСравнения)
	
	Если ВидСравнения = ВидСравненияКомпоновкиДанных.Равно Тогда
		Возврат "Равно";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно Тогда
		Возврат "НеРавно";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.Больше Тогда
		Возврат "Больше";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.БольшеИлиРавно Тогда
		Возврат "БольшеИлиРавно";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.Меньше Тогда
		Возврат "Меньше";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.МеньшеИлиРавно Тогда
		Возврат "МеньшеИлиРавно";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.Содержит Тогда
		Возврат "Содержит";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.НеСодержит Тогда
		Возврат "НеСодержит";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.Заполнено Тогда
		Возврат "Заполнено";
	ИначеЕсли ВидСравнения = ВидСравненияКомпоновкиДанных.НеЗаполнено Тогда
		Возврат "НеЗаполнено";
	Иначе
		Возврат "Равно";
	КонецЕсли;
	
КонецФункции

#КонецОбласти
