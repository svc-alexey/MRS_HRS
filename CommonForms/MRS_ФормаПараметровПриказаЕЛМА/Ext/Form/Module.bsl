////////////////////////////////////////////////////////////////////////////////
// MRS_ФормаПараметровПриказаЕЛМА: Форма параметров приказа ЕЛМА
//
// Назначение:
//   Форма для заполнения параметров приказа ЕЛМА при отправке документа
//   "Установка цен номенклатуры" в систему ЕЛМА для согласования
//
// Параметры формы:
//   ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - отправляемый документ
//
// Возвращаемое значение:
//   Структура с полями:
//     * ОтветственныйЗаИсполнение - СправочникСсылка.ФизическиеЛица
//     * СписокКОзнакомлению - ТаблицаЗначений с колонкой ФизическоеЛицо
//   или Неопределено при отмене
//
////////////////////////////////////////////////////////////////////////////////

#Область ОписаниеПеременных

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Добавление реквизитов формы
	МассивРеквизитов = Новый Массив;
	
	// Реквизит для ответственного за исполнение
	МассивРеквизитов.Добавить(Новый РеквизитФормы(
		"ОтветственныйЗаИсполнение",
		Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"),
		,
		"Ответственный за исполнение"));
	
	// Табличная часть для списка к ознакомлению
	МассивРеквизитов.Добавить(Новый РеквизитФормы(
		"СписокКОзнакомлению",
		Новый ОписаниеТипов("ТаблицаЗначений")));
	
	МассивРеквизитов.Добавить(Новый РеквизитФормы(
		"ФизическоеЛицо",
		Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"),
		"СписокКОзнакомлению",
		"Физическое лицо"));
	
	ИзменитьРеквизиты(МассивРеквизитов);
	
	// Привязка элементов формы к реквизитам
	Элементы.ОтветсвенныйЗаИсполнение.ПутьКДанным = "ОтветственныйЗаИсполнение";
	Элементы.СписокКОзнакомлению.ПутьКДанным = "СписокКОзнакомлению";
	Элементы.СписокКОзнакомлениюФизическоеЛицо.ПутьКДанным = "СписокКОзнакомлению.ФизическоеЛицо";
	
	// Настройка команд кнопок
	Элементы.ФормаОк.Действие = "ОК";
	Элементы.Отмена.Действие = "Отмена";
	
	// Получение документа из параметров
	Если Параметры.Свойство("ДокументСсылка") И ЗначениеЗаполнено(Параметры.ДокументСсылка) Тогда
		ДокументСсылка = Параметры.ДокументСсылка;
	КонецЕсли;
	
	// Загрузка значений по умолчанию
	ЗагрузитьЗначенияПоУмолчанию();
	
	// Настройка заголовка формы
	Если ЗначениеЗаполнено(ДокументСсылка) Тогда
		Заголовок = СтрШаблон("Параметры приказа ЕЛМА для документа %1", ДокументСсылка);
	Иначе
		Заголовок = "Параметры приказа ЕЛМА";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОК(Команда)
	
	// Валидация заполнения обязательных полей
	МассивОшибок = Новый Массив;
	
	Если НЕ ЗначениеЗаполнено(ОтветственныйЗаИсполнение) Тогда
		МассивОшибок.Добавить("Необходимо заполнить поле ""Ответственный за исполнение""");
	КонецЕсли;
	
	// Проверка наличия Uid для ответственного на сервере
	Если ЗначениеЗаполнено(ОтветственныйЗаИсполнение) Тогда
		
		РезультатПроверки = ПроверитьНаличиеUidНаСервере(ОтветственныйЗаИсполнение);
		
		Если НЕ РезультатПроверки.Успех Тогда
			МассивОшибок.Добавить(РезультатПроверки.ТекстОшибки);
		КонецЕсли;
		
	КонецЕсли;
	
	// Проверка Uid для всех физлиц в списке ознакомления
	Для Каждого СтрокаСписка Из СписокКОзнакомлению Цикл
		
		Если ЗначениеЗаполнено(СтрокаСписка.ФизическоеЛицо) Тогда
			
			РезультатПроверки = ПроверитьНаличиеUidНаСервере(СтрокаСписка.ФизическоеЛицо);
			
			Если НЕ РезультатПроверки.Успех Тогда
				МассивОшибок.Добавить(СтрШаблон(
					"Для физлица ""%1"" в списке к ознакомлению: %2",
					СтрокаСписка.ФизическоеЛицо,
					РезультатПроверки.ТекстОшибки));
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Если есть ошибки, показываем их и не закрываем форму
	Если МассивОшибок.Количество() > 0 Тогда
		
		ТекстОшибок = "";
		Для Каждого Ошибка Из МассивОшибок Цикл
			ТекстОшибок = ТекстОшибок + "• " + Ошибка + Символы.ПС;
		КонецЦикла;
		
		ПоказатьПредупреждение(, ТекстОшибок, 10, "Ошибки валидации");
		Возврат;
		
	КонецЕсли;
	
	// Формирование результата
	РезультатВыбора = Новый Структура;
	РезультатВыбора.Вставить("ОтветственныйЗаИсполнение", ОтветственныйЗаИсполнение);
	РезультатВыбора.Вставить("СписокКОзнакомлению", СписокКОзнакомлению.Выгрузить());
	
	// Закрытие формы с результатом
	Закрыть(РезультатВыбора);
	
КонецПроцедуры

&НаКлиенте
Процедура Отмена(Команда)
	
	// Закрытие формы без результата
	Закрыть(Неопределено);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗагрузитьЗначенияПоУмолчанию()
	
	// Попытка установить текущего пользователя как ответственного
	ТекущийПользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Пользователи.ФизическоеЛицо КАК ФизическоеЛицо
		|ИЗ
		|	Справочник.Пользователи КАК Пользователи
		|ГДЕ
		|	Пользователи.ИдентификаторПользователяИБ = &ИдентификаторПользователяИБ";
	
	Запрос.УстановитьПараметр("ИдентификаторПользователяИБ", ТекущийПользователь.УникальныйИдентификатор);
	
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		
		Если ЗначениеЗаполнено(Выборка.ФизическоеЛицо) Тогда
			ОтветственныйЗаИсполнение = Выборка.ФизическоеЛицо;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроверитьНаличиеUidНаСервере(ФизЛицоСсылка)
	
	Результат = Новый Структура("Успех, ТекстОшибки", Истина, "");
	
	Если НЕ ЗначениеЗаполнено(ФизЛицоСсылка) Тогда
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Физическое лицо не заполнено";
		Возврат Результат;
	КонецЕсли;
	
	// Проверка наличия Uid в РС.ДополнительныеКонстанты
	Uid = ПЛ_ДополнительныеКонстантыПовтИсп.ВернутьДополнительнуюКонстанту(
		"MRS_УИДЕЛМА_ФизЛицо",
		ФизЛицоСсылка);
	
	Если НЕ ЗначениеЗаполнено(Uid) Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = СтрШаблон(
			"Не заполнен Uid ЕЛМА в РС.ДополнительныеКонстанты. " +
			"Добавьте запись: ИмяКонстанты=""MRS_УИДЕЛМА_ФизЛицо"", Объект=%1",
			ФизЛицоСсылка);
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОбработкаВыбораФизическогоЛица(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	// Можно добавить дополнительную логику при выборе физлица
	
КонецПроцедуры

#КонецОбласти

