////////////////////////////////////////////////////////////////////////////////
// MRS_ФормаПараметровПриказаЕЛМА: Форма параметров приказа ЕЛМА
//
// Назначение:
//   Форма для заполнения параметров приказа ЕЛМА при отправке документа
//   "Установка цен номенклатуры" в систему ЕЛМА для согласования
//
// Параметры формы:
//   ДокументСсылка - ДокументСсылка.УстановкаЦенНоменклатуры - отправляемый документ
//
// Возвращаемое значение:
//   Структура с полями:
//     * ОтветственныйЗаИсполнение - СправочникСсылка.ФизическиеЛица
//     * СписокКОзнакомлению - ТаблицаЗначений с колонкой ФизическоеЛицо
//   или Неопределено при отмене
//
////////////////////////////////////////////////////////////////////////////////

#Область ОписаниеПеременных

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Получение документа из параметров
	Если Параметры.Свойство("ДокументСсылка") И ЗначениеЗаполнено(Параметры.ДокументСсылка) Тогда
		ДокументСсылка = Параметры.ДокументСсылка;
	КонецЕсли;
	
	Если Параметры.Свойство("ВидЦены") И ЗначениеЗаполнено(Параметры.ВидЦены) Тогда
		ВидЦены = Параметры.ВидЦены;
	КонецЕсли;
	
	// Предзаполнение ранее сохраненными параметрами
	// Сначала пытаемся загрузить из регистра (если документ уже отправлялся)
	СохраненныеПараметры = Неопределено;
	
	Если ЗначениеЗаполнено(ДокументСсылка) Тогда
		СохраненныеПараметры = MRS_ИнтеграцияЕЛМАСервер.ПолучитьСохраненныеПараметрыПриказа(ДокументСсылка);	
	КонецЕсли;
	
	// Если сохраненные параметры найдены, используем их
	Если СохраненныеПараметры <> Неопределено Тогда
		
		// Заполнение простых реквизитов
		МассивРеквизитов = Новый Массив;
		МассивРеквизитов.Добавить("ОтветственныйЗаИсполнение");
		МассивРеквизитов.Добавить("ДатаНачалаДействия");
		МассивРеквизитов.Добавить("Тема");
		МассивРеквизитов.Добавить("Цель");
		МассивРеквизитов.Добавить("Организация");
		МассивРеквизитов.Добавить("Склад");
		
		Для Каждого ИмяРеквизита Из МассивРеквизитов Цикл
			ЗаполнитьРеквизитФормыИзСтруктуры(ЭтотОбъект, СохраненныеПараметры, ИмяРеквизита);
		КонецЦикла;
		
		// Заполнение табличной части СписокКОзнакомлению
		Если СохраненныеПараметры.Свойство("СписокКОзнакомлению") 
			И ТипЗнч(СохраненныеПараметры.СписокКОзнакомлению) = Тип("ТаблицаЗначений") Тогда
			
			СписокКОзнакомлению.Загрузить(СохраненныеПараметры.СписокКОзнакомлению);
			
		КонецЕсли;
		
	Иначе
		
		ЗагрузитьЗначенияПоУмолчанию(ВидЦены);	
		
	КонецЕсли;
	
	// Настройка заголовка формы
	Если ЗначениеЗаполнено(ДокументСсылка) Тогда
		Заголовок = СтрШаблон("Параметры приказа ЕЛМА для документа %1", ДокументСсылка);
	Иначе
		Заголовок = "Параметры приказа ЕЛМА";
	КонецЕсли;
	
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОК(Команда)
	
	// Формируем параметры приказа
	ПараметрыПриказа = Новый Структура;
	ПараметрыПриказа.Вставить("ОтветственныйЗаИсполнение", ОтветственныйЗаИсполнение);
	ПараметрыПриказа.Вставить("СписокКОзнакомлению", СписокКОзнакомлению);
	ПараметрыПриказа.Вставить("ДатаНачалаДействия", ДатаНачалаДействия);
	ПараметрыПриказа.Вставить("Тема", Тема);
	ПараметрыПриказа.Вставить("Цель", Цель);
	ПараметрыПриказа.Вставить("Организация", Организация);
	ПараметрыПриказа.Вставить("Склад", Склад);
	ПараметрыПриказа.Вставить("ГуидЕлмаОрганизации", ГуидЕлмаОрганизации);
	
	// Полная валидация документа и параметров приказа на сервере
	РезультатВалидации = ВалидироватьДокументИПараметрыНаСервере(ДокументСсылка, ПараметрыПриказа);
	
	Если НЕ РезультатВалидации.Успех Тогда
		
		// Формируем текст ошибок
		ТекстОшибок = "";
		Для Каждого Ошибка Из РезультатВалидации.МассивОшибок Цикл
			ТекстОшибок = ТекстОшибок + "• " + Ошибка + Символы.ПС;
		КонецЦикла;
		
		// Показываем ошибки и НЕ закрываем форму
		ПоказатьПредупреждение(, ТекстОшибок, 10, "Ошибки валидации");
		Возврат;
		
	КонецЕсли;
	
	// Формирование результата для возврата
	РезультатВыбора = Новый Структура;
	РезультатВыбора.Вставить("ОтветственныйЗаИсполнение", ОтветственныйЗаИсполнение);
	РезультатВыбора.Вставить("СписокКОзнакомлению", СписокКОзнакомлению);
	РезультатВыбора.Вставить("ДатаНачалаДействия", ДатаНачалаДействия);
	РезультатВыбора.Вставить("Тема", Тема);
	РезультатВыбора.Вставить("Цель", Цель);
	РезультатВыбора.Вставить("Организация", Организация);
	РезультатВыбора.Вставить("Склад", Склад);
	РезультатВыбора.Вставить("ГуидЕлмаОрганизации", ГуидЕлмаОрганизации);
	
	// Закрытие формы с результатом
	Закрыть(РезультатВыбора);
	
КонецПроцедуры
&НаКлиенте
Процедура Отмена(Команда)
	
	// Закрытие формы без результата
	Закрыть(Неопределено);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗагрузитьЗначенияПоУмолчанию(ВидЦены)
	
	СтруктураДанных = MRS_ИнтеграцияЕЛМАСервер.ПолучитьДанныеПоВидуЦен(ВидЦены);
	
	Тема = СтрШаблон("Об утверждении прейскуранта цен на блюда на точке/точках питания %1", СтруктураДанных.Склад);
	Цель = СтрШаблон("В целях организации сбыта товаров, реализуемых на точке/точках питания %1", СтруктураДанных.Склад);
	Организация = СтруктураДанных.Организация;
	Склад = СтруктураДанных.Склад;
	
	Если СтруктураДанных.Свойство("ГуидЕлмаОрганизации") И ЗначениеЗаполнено(СтруктураДанных.ГуидЕлмаОрганизации) Тогда
		ГуидЕлмаОрганизации = СтруктураДанных.ГуидЕлмаОрганизации;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ВалидироватьДокументИПараметрыНаСервере(Знач ДокументСсылка, Знач ПараметрыПриказа)
	
	// Получаем объект документа
	Документ = ДокументСсылка.ПолучитьОбъект();
	
	// Вызываем функцию валидации из клиент-серверного модуля
	Результат = MRS_ИнтеграцияЕЛМАКлиентСервер.ВалидироватьДокументПередОтправкой(Документ, ПараметрыПриказа);
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОбработкаВыбораФизическогоЛица(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	//добавить дополнительную логику при выборе физлица
	
КонецПроцедуры

// Заполняет реквизит формы значением из структуры параметров
//
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - форма, в которой заполняется реквизит
//  СтруктураПараметров - Структура - структура с параметрами
//  ИмяРеквизита - Строка - имя реквизита для заполнения
//
&НаСервере
Процедура ЗаполнитьРеквизитФормыИзСтруктуры(Форма, СтруктураПараметров, ИмяРеквизита)
	
	Если СтруктураПараметров.Свойство(ИмяРеквизита) 
		И ЗначениеЗаполнено(СтруктураПараметров[ИмяРеквизита]) Тогда
		
		Форма[ИмяРеквизита] = СтруктураПараметров[ИмяРеквизита];
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

