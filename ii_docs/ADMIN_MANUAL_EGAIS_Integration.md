# Инструкция администратора: Интеграция ЕГАИС 1С-Simphony

**Версия:** 1.0  
**Дата:** 05.02.2026  
**Назначение:** Руководство для администраторов по настройке и поддержке интеграции обмена марками ЕГАИС между 1С и Simphony Fiscal DB

---

## 1. Введение

Данная инструкция описывает процесс настройки, проверки и поддержки автоматической синхронизации данных ЕГАИС (маркировки алкогольной продукции) между системой учета 1С и кассовой системой Simphony.

### 1.1. Что синхронизируется

Для алкогольных позиций меню автоматически передаются:

1. **ЕГАИС-атрибуты позиции:**
   - `objnum` - код Simphony позиции
   - `volume` - объем в декалитрах
   - `unit` - единица измерения

2. **Штрихкоды EAN (обычные штрихкоды):**
   - Источник: Регистр `ШтрихкодыНоменклатуры`
   - API endpoint: `/rvc/{rvcId}/egais/barcodes`
   - Двусторонняя синхронизация штрихкодов EAN между 1С и Simphony
   - Автоматическое добавление новых штрихкодов
   - Автоматическое удаление устаревших штрихкодов

3. **Марки ЕГАИС (акцизные марки):**
   - Источник: ⚠️ **Требуется настройка** (см. раздел 2.3)
   - API endpoint: `/rvc/{rvcId}/egais/marks`
   - Двусторонняя синхронизация марок ЕГАИС между 1С и Simphony
   - Автоматическое добавление новых марок
   - Автоматическое удаление устаревших марок

### 1.2. Условия запуска синхронизации

Синхронизация ЕГАИС выполняется **автоматически** при следующих условиях:

- Позиция меню успешно выгружена в Simphony (HTTP 200 OK)
- Номенклатура имеет признак "Алкогольная продукция" = **Истина**
- Номенклатура имеет признак "Алкогольная продукция во вскрытой таре" = **Ложь**
- Заполнен код Simphony (`MRS_КодSimphony`)

**ВАЖНО:** Алкоголь во вскрытой таре (например, разливной коньяк) **НЕ синхронизируется** с ЕГАИС.

---

## 2. Настройка данных ЕГАИС перед эксплуатацией

### 2.1. Заполнение реквизитов номенклатуры

Для каждой алкогольной позиции необходимо заполнить следующие реквизиты в карточке номенклатуры:

#### **Шаг 1: Установить признаки алкогольной продукции**

В карточке номенклатуры (Справочник "Номенклатура"):

1. Открыть карточку алкогольной позиции
2. Установить флаг **"Алкогольная продукция"** = ☑ Истина
3. Убедиться, что флаг **"Алкогольная продукция во вскрытой таре"** = ☐ Ложь
4. Сохранить изменения

**Пример:**
- Водка "Финляндия" 0.5л: АлкогольнаяПродукция = ☑, ВоВскрытойТаре = ☐ → **Синхронизируется**
- Коньяк разливной: АлкогольнаяПродукция = ☑, ВоВскрытойТаре = ☑ → **НЕ синхронизируется**

#### **Шаг 2: Заполнить объем тары**

В карточке номенклатуры заполнить реквизит **"ОбъемДал"** (объем в декалитрах):

- 0.5 литра = 0.05 дал
- 0.75 литра = 0.075 дал
- 1 литр = 0.1 дал

**Формула:** ОбъемДал = ОбъемЛитров / 10

#### **Шаг 3: Заполнить единицу хранения**

В карточке номенклатуры заполнить реквизит **"ЕдиницаХранения"**:

- Обычно: "дал" (декалитр)
- Допустимы другие единицы измерения

### 2.2. Добавление штрихкодов EAN

Для каждой алкогольной позиции необходимо добавить штрихкоды EAN в регистр сведений **"ШтрихкодыНоменклатуры"**:

1. Открыть регистр **Регистры сведений → ШтрихкодыНоменклатуры**
2. Нажать кнопку **"Создать"**
3. Заполнить поля:
   - **Номенклатура** - выбрать алкогольную позицию
   - **Характеристика** - выбрать характеристику (если есть)
   - **Штрихкод** - ввести штрихкод (EAN-13, 13 цифр)
4. Сохранить запись
5. Повторить для всех штрихкодов данной номенклатуры

**Пример:**
```
Номенклатура: Водка "Финляндия" 0.5л
Штрихкод 1: 4601234567890
Штрихкод 2: 4601234567906
```

### 2.3. Добавление марок ЕГАИС (акцизных марок)

⚠️ **ВНИМАНИЕ:** Функционал получения марок ЕГАИС из 1С содержит **заглушку** и требует доработки!

**Необходимо реализовать:**

1. Определить источник хранения марок ЕГАИС в вашей конфигурации:
   - Справочник с марками
   - Регистр сведений
   - Документы поступления алкоголя

2. Реализовать SQL запрос в функции `ПолучитьМаркиЕГАИСИз1С()` модуля `MRS_ИнтеграцияSimphonyСервер`

3. Запрос должен возвращать массив структур с полями:
   - **code** (обязательно) - уникальный код акцизной марки ЕГАИС
   - **ean** (опционально) - штрихкод EAN, связанный с маркой
   - **store** (опционально) - идентификатор склада

**Пример структуры данных:**
```
code: "0000000000001234567890"  // Уникальный код марки ЕГАИС
ean: "4601234567890"           // Штрихкод EAN (опционально)
store: "MAIN"                  // Склад (опционально)
```

**Текущее поведение:** 
- До реализации запроса марки ЕГАИС **не синхронизируются**
- В истории будет запись: "Марки: добавлено 0, удалено 0"
- Синхронизация штрихкодов EAN работает независимо

---

## 3. Проверка результатов синхронизации

### 3.1. Просмотр истории синхронизации

Для проверки результатов синхронизации ЕГАИС:

1. Открыть **Регистры сведений → MRS_ИсторияСинхронизацииМенюSimphony**
2. Установить отбор по типу операции:
   - **EGAIS_UPDATE** - обновление ЕГАИС-атрибутов
   - **EGAIS_BARCODES** - синхронизация штрихкодов
3. Проверить статус операций:
   - **"Выгружено"** - успешная синхронизация
   - **"Ошибка"** - ошибка синхронизации (см. раздел 4)

### 3.2. Примеры записей в истории

#### **Успешная синхронизация:**

| ДатаВремя | Операция | Статус | HTTPСтатус | Сообщение |
|-----------|----------|--------|------------|-----------|
| 05.02.2026 14:30:15 | CREATE | Выгружено | 200 | Успешно выгружено |
| 05.02.2026 14:30:16 | EGAIS_UPDATE | Выгружено | 200 | ЕГАИС: Атрибуты обновлены |
| 05.02.2026 14:30:17 | EGAIS_BARCODES | Выгружено | 0 | Штрихкоды EAN: добавлено 3, удалено 1. Штрихкоды синхронизированы |
| 05.02.2026 14:30:18 | EGAIS_MARKS | Выгружено | 0 | Марки: добавлено 0, удалено 0. Марки ЕГАИС синхронизированы |

#### **Ошибка валидации:**

| ДатаВремя | Операция | Статус | HTTPСтатус | Сообщение |
|-----------|----------|--------|------------|-----------|
| 05.02.2026 15:10:20 | CREATE | Выгружено | 200 | Успешно выгружено |
| 05.02.2026 15:10:21 | EGAIS_UPDATE | Ошибка | 0 | ЕГАИС: Ошибка валидации - Не заполнен реквизит ОбъемДал в карточке номенклатуры |

### 3.3. Интерпретация сообщений

| Сообщение | Значение | Действия |
|-----------|----------|----------|
| "ЕГАИС: Атрибуты обновлены" | Успешная синхронизация | Нет действий |
| "Добавлено: N, Удалено: M" | Штрихкоды синхронизированы | Нет действий |
| "Не заполнен ОбъемДал" | Ошибка валидации | Заполнить ОбъемДал в карточке номенклатуры |
| "Не заполнена ЕдиницаХранения" | Ошибка валидации | Заполнить ЕдиницаХранения в карточке номенклатуры |
| "HTTP 502" или "HTTP 503" | EGAIS сервис недоступен | Проверить доступность сервиса, повторить выгрузку |

---

## 4. Устранение ошибок

### 4.1. Ошибки валидации данных

#### **Ошибка: "Не заполнен MRS_КодSimphony"**

**Причина:** Позиции не присвоен код Simphony.

**Решение:**
1. Открыть карточку позиции меню
2. Убедиться, что позиция была успешно выгружена в Simphony
3. Если код не заполнен, выполнить повторную выгрузку

#### **Ошибка: "Не заполнен реквизит ОбъемДал"**

**Причина:** В карточке номенклатуры не указан объем тары.

**Решение:**
1. Открыть карточку номенклатуры
2. Заполнить реквизит **"ОбъемДал"** (например, 0.05 для 0.5л)
3. Сохранить карточку
4. Выполнить повторную выгрузку позиции меню

#### **Ошибка: "ОбъемДал должен быть больше 0"**

**Причина:** Указан нулевой или отрицательный объем.

**Решение:**
1. Открыть карточку номенклатуры
2. Исправить значение **"ОбъемДал"** на корректное (например, 0.075 для 0.75л)
3. Сохранить карточку
4. Выполнить повторную выгрузку позиции меню

#### **Ошибка: "Не заполнена ЕдиницаХранения"**

**Причина:** Не указана единица измерения.

**Решение:**
1. Открыть карточку номенклатуры
2. Заполнить реквизит **"ЕдиницаХранения"** (обычно "дал")
3. Сохранить карточку
4. Выполнить повторную выгрузку позиции меню

### 4.2. Ошибки API ЕГАИС

#### **Ошибка: HTTP 400 "Bad Request"**

**Причина:** Некорректные данные в запросе к API.

**Решение:**
1. Проверить правильность заполнения всех реквизитов ЕГАИС
2. Проверить формат штрихкодов (должны быть 13 цифр)
3. Обратиться к администратору Simphony для проверки настроек API

#### **Ошибка: HTTP 404 "Not Found"**

**Причина:** Позиция меню не найдена в Simphony.

**Решение:**
1. Убедиться, что позиция была успешно выгружена в Simphony
2. Проверить наличие записи с операцией CREATE в истории синхронизации
3. При необходимости выполнить повторную выгрузку позиции

#### **Ошибка: HTTP 502/503 "Service Unavailable"**

**Причина:** EGAIS сервис временно недоступен.

**Решение:**
1. Подождать 5-10 минут
2. Проверить доступность сервиса Simphony
3. Выполнить повторную выгрузку позиции
4. Если ошибка повторяется - обратиться к администратору Simphony

### 4.3. Проблемы с штрихкодами

#### **Проблема: Штрихкоды не синхронизируются**

**Возможные причины:**
1. Штрихкоды не добавлены в регистр **ШтрихкодыНоменклатуры**
2. Неправильный формат штрихкода (должен быть EAN-13, 13 цифр)
3. Ошибка синхронизации ЕГАИС-атрибутов (штрихкоды синхронизируются только после успешного обновления атрибутов)

**Решение:**
1. Проверить наличие штрихкодов в регистре **ШтрихкодыНоменклатуры**
2. Убедиться, что штрихкоды имеют формат EAN-13 (13 цифр без пробелов)
3. Проверить успешность обновления ЕГАИС-атрибутов в истории синхронизации
4. Выполнить повторную выгрузку позиции

---

## 5. Процедура массовой проверки

### 5.1. Проверка заполнения данных ЕГАИС

Для массовой проверки корректности заполнения данных ЕГАИС выполните следующий запрос:

```sql
ВЫБРАТЬ
    питМеню.Наименование КАК ПозицияМеню,
    питМеню.Номенклатура.Наименование КАК Номенклатура,
    питМеню.MRS_КодSimphony КАК КодSimphony,
    питМеню.Номенклатура.ОбъемДал КАК ОбъемДал,
    питМеню.Номенклатура.ЕдиницаХранения.Наименование КАК ЕдиницаИзмерения,
    ВЫБОР
        КОГДА НЕ ЗначениеЗаполнено(питМеню.MRS_КодSimphony)
            ТОГДА "Не заполнен код Simphony"
        КОГДА НЕ ЗначениеЗаполнено(питМеню.Номенклатура.ОбъемДал)
            ТОГДА "Не заполнен ОбъемДал"
        КОГДА питМеню.Номенклатура.ОбъемДал <= 0
            ТОГДА "ОбъемДал <= 0"
        КОГДА НЕ ЗначениеЗаполнено(питМеню.Номенклатура.ЕдиницаХранения)
            ТОГДА "Не заполнена ЕдиницаХранения"
        ИНАЧЕ "OK"
    КОНЕЦ КАК Статус
ИЗ
    Справочник.питМеню КАК питМеню
ГДЕ
    питМеню.Номенклатура.АлкогольнаяПродукция = ИСТИНА
    И НЕ питМеню.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
    И НЕ питМеню.ПометкаУдаления
УПОРЯДОЧИТЬ ПО
    Статус УБЫВ,
    ПозицияМеню
```

**Результат:** Список всех алкогольных позиций с указанием проблем (если есть).

### 5.2. Проверка наличия штрихкодов

Для проверки наличия штрихкодов у алкогольных позиций:

```sql
ВЫБРАТЬ
    питМеню.Наименование КАК ПозицияМеню,
    питМеню.Номенклатура.Наименование КАК Номенклатура,
    КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ШтрихкодыНоменклатуры.Штрихкод) КАК КоличествоШтрихкодов
ИЗ
    Справочник.питМеню КАК питМеню
        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
        ПО питМеню.Номенклатура = ШтрихкодыНоменклатуры.Номенклатура
            И питМеню.Номенклатура.Характеристика = ШтрихкодыНоменклатуры.Характеристика
ГДЕ
    питМеню.Номенклатура.АлкогольнаяПродукция = ИСТИНА
    И НЕ питМеню.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
    И НЕ питМеню.ПометкаУдаления
СГРУППИРОВАТЬ ПО
    питМеню.Наименование,
    питМеню.Номенклатура.Наименование
УПОРЯДОЧИТЬ ПО
    КоличествоШтрихкодов,
    ПозицияМеню
```

**Результат:** Список позиций с количеством штрихкодов (позиции без штрихкодов будут вверху списка).

---

## 6. Регламентные процедуры

### 6.1. Ежедневная проверка

**Периодичность:** Ежедневно, утром перед началом работы

**Действия:**
1. Открыть регистр **MRS_ИсторияСинхронизацииМенюSimphony**
2. Установить отбор:
   - Операция: EGAIS_UPDATE или EGAIS_BARCODES
   - Статус: Ошибка
   - Дата: Вчера и сегодня
3. Просмотреть записи с ошибками
4. Для каждой ошибки:
   - Определить причину (см. раздел 4)
   - Исправить данные
   - Выполнить повторную выгрузку

### 6.2. Еженедельная проверка согласованности

**Периодичность:** Раз в неделю (например, в понедельник)

**Действия:**
1. Выполнить запрос массовой проверки данных ЕГАИС (см. раздел 5.1)
2. Исправить выявленные проблемы
3. Выполнить запрос проверки штрихкодов (см. раздел 5.2)
4. Добавить недостающие штрихкоды

---

## 7. Контакты и поддержка

При возникновении проблем, не описанных в данной инструкции, обратитесь:

- **Техническая поддержка 1С:** [контактные данные]
- **Администратор Simphony:** [контактные данные]
- **Ответственный за интеграцию:** [контактные данные]

---

## 8. История изменений

| Версия | Дата | Автор | Описание изменений |
|--------|------|-------|-------------------|
| 1.0 | 05.02.2026 | Система | Первая версия инструкции |

---

**Конец документа**
