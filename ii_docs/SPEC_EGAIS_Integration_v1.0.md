# Техническая спецификация: Интеграция обмена марками ЕГАИС между 1С и Simphony Fiscal DB

**Версия:** 1.0  
**Дата:** 05.02.2026  
**Тип документа:** Техническая спецификация  
**Статус:** Ready for Development

---

## 1. Анализ текущего состояния

### 1.1. Текущая архитектура выгрузки меню

**Точка входа:**
- Форма списка справочника `питМеню` (файл: `Catalogs\питМеню\Forms\MФормаСписка\Ext\Form\Module.bsl`)
- Команда: `ВыгрузитьМеню` (строка 508)

**Последовательность выполнения:**

```
1. Пользователь → Команда "Выгрузить меню" (строка 508)
   ↓
2. Клиент → ВыгрузитьМенюВыборРежима() (строка 536)
   ↓
3. Клиент → ВыгрузитьМенюПодтверждение() (строка 578)
   ↓
4. Сервер → ВыгрузитьМенюВSimphonyНаСервере() (строка 2047)
   ↓
5. Цикл для каждой позиции:
   Сервер → MRS_ИнтеграцияSimphonyСервер.ВыгрузитьПозициюВSimphony() (строка 2106)
   ↓
6. Сервер → СформироватьЗапросПозицииМеню() (строка 722)
   ↓
7. Отправка HTTP PUT/PATCH → Simphony API /menu-item
```

**Ключевые функции:**

| Функция | Файл | Строки | Назначение |
|---------|------|--------|------------|
| `ВыгрузитьПозициюВSimphony()` | `MRS_ИнтеграцияSimphonyСервер` | 167-326 | Основная функция выгрузки позиции |
| `СформироватьЗапросПозицииМеню()` | `MRS_ИнтеграцияSimphonyСервер` | 722-778 | Формирование JSON для API |
| `ОтправитьЗапросAPI()` | `MRS_ИнтеграцияSimphonyСервер` | 1303-1358 | Отправка HTTP запроса |
| `ВалидироватьПозициюМеню()` | `MRS_ИнтеграцияSimphonyСервер` | 1012-1090 | Валидация перед выгрузкой |

### 1.2. Текущий маппинг данных

**Запрос данных позиции меню** (строка 726-742):
```sql
ВЫБРАТЬ
    питМеню.Наименование,
    питМеню.Номенклатура,
    питМеню.Выключен,
    питМеню.Номенклатура.ГруппаАналитическогоУчета.Родитель.MRS_КодMajorGroup,
    питМеню.Номенклатура.ГруппаАналитическогоУчета.MRS_КодFamilyGroup,
    питМеню.MRS_КодSimphony,
    питМеню.Родитель.MRS_КодSimphony AS SLUINDEX,
    питМеню.MRS_СтавкаНДС,
    питМеню.Номенклатура.питПродажаПоСвободнойЦене,
    питМеню.Номенклатура.ЕдиницаИзмерения
```

**Формирование JSON** (строка 762-772):
```javascript
{
  "name": "...",
  "stringNumberId": ...,
  "majGrpObjNum": ...,
  "famGrpObjNum": ...,
  "isVisible": 0|1,
  "hierStrucId": ...,
  "menuItemClass": ...,
  "price": ...,
  "sluindex": ...
}
```

### 1.3. Метаданные 1С (существующие)

**Справочник `питМеню`:**
- `Номенклатура` (СправочникСсылка.Номенклатура)
- `MRS_КодSimphony` (Число) - objnum в Simphony
- `MRS_СтавкаНДС` (СправочникСсылка.СтавкиНДС)

**Справочник `Номенклатура`:**
- `АлкогольнаяПозиция и Не АлкогольнаяПозицияВоВскрытойТаре` (СправочникСсылка.Номенклатура) - используется для определения алкоголя
- `ЕмкостьТары` (Число) - объем в литрах
- `ЕдиницаИзмерения` (СправочникСсылка.ЕдиницыИзмерения)
- `ПодакцизныйТовар` (Булево) - альтернативный признак алкоголя

**Регистр сведений `ШтрихкодыНоменклатуры`:**
- `Номенклатура` (СправочникСсылка.Номенклатура)
- `Характеристика` (СправочникСсылка.ХарактеристикиНоменклатуры)
- `Штрихкод` (Строка)

---

## 2. Требования к реализации

### 2.1. Функциональные требования

**FR-1: Определение алкогольной продукции**

Позиция меню считается алкогольной, если выполняется :
- `Номенклатура.АлкогольнаяПродукция` = Истина
- `Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре` = Ложь

**FR-2: Условия запуска обмена**

Обмен марками ЕГАИС должен выполняться:
1. **Только для алкогольной продукции** (согласно FR-1)
2. **После успешной выгрузки** позиции меню (HTTP 200 OK на PUT/PATCH /menu-item)
3. **При наличии кода Simphony** (`MRS_КодSimphony` заполнен)

**FR-3: Последовательность операций**

1. **Обновление ЕГАИС-атрибутов** (PUT /rvc/{rvcId}/egais/menuitems/egais)
   - Передача: objnum, volume, unit (только базовые поля, без marktype, groupid, cocktailid)
2. **Получение текущих штрихкодов** из Simphony (GET /rvc/{rvcId}/egais/barcodes/{objnum})
3. **Получение актуальных штрихкодов** из 1С (запрос к регистру `ШтрихкодыНоменклатуры`)
4. **Вычисление расхождений** (Diff):
   - Удалить: в Simphony есть, в 1С нет
   - Добавить: в 1С есть, в Simphony нет
5. **Удаление устаревших** штрихкодов (DELETE для каждого)
6. **Добавление новых** штрихкодов (POST batch)

**FR-4: Обработка результата**

- Все операции записываются в `MRS_ИсторияСинхронизацииМенюSimphony`
- При ошибке в любой операции ЕГАИС:
  - Основная выгрузка считается успешной (позиция создана в меню)
  - Ошибка ЕГАИС записывается отдельной записью в историю
  - Статус: "Выгружено с предупреждением"

---

## 3. Архитектурное решение

### 3.1. Точка интеграции

**Место внедрения:** Функция `ВыгрузитьПозициюВSimphony()` в модуле `MRS_ИнтеграцияSimphonyСервер`

**Текущая структура** (строки 239-248):
```bsl
Если HTTPОтвет.КодСостояния = 200 Тогда
    // Успешная выгрузка
    УдалитьИзОчереди(Позиция, КассовыйУзел);
    Результат.Успешно = Истина;
    Результат.Сообщение = "Успешно выгружено";
    ЗаписатьВИсториюСинхронизации(...);
КонецЕсли;
```

**Новая структура:**
```bsl
Если HTTPОтвет.КодСостояния = 200 Тогда
    // Успешная выгрузка базовой позиции
    УдалитьИзОчереди(Позиция, КассовыйУзел);
    Результат.Успешно = Истина;
    Результат.Сообщение = "Успешно выгружено";
    ЗаписатьВИсториюСинхронизации(...);
    
    // НОВОЕ: Обработка ЕГАИС для алкогольной продукции
    Если ЭтоАлкогольнаяПродукция(Позиция) Тогда
        РезультатЕГАИС = ОбновитьДанныеЕГАИС(Позиция, КассовыйУзел);
        // Логирование результата ЕГАИС отдельно
    КонецЕсли;
КонецЕсли;
```

### 3.2. Новые функции

#### 3.2.1. `ЭтоАлкогольнаяПродукция()`

**Назначение:** Определение признака алкогольной продукции  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (экспортная)

```bsl
Функция ЭтоАлкогольнаяПродукция(Позиция) Экспорт
    // Получение номенклатуры из позиции меню
    // Проверка АлкогольнойПродукции и не АлкогольнаяПродукцияВоВскрытойТаре
    // Возврат: Булево
КонецФункции
```

#### 3.2.2. `ОбновитьДанныеЕГАИС()`

**Назначение:** Основная функция синхронизации ЕГАИС  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (экспортная)

```bsl
Функция ОбновитьДанныеЕГАИС(Позиция, КассовыйУзел) Экспорт
    // 1. Валидация данных ЕГАИС
    // 2. Формирование UpdateMenuItemEgaisDto
    // 3. PUT /rvc/{rvcId}/egais/menuitems/egais
    // 4. Синхронизация штрихкодов
    // 5. Логирование
    // Возврат: Структура (Успешно, Сообщение, HTTPСтатус)
КонецФункции
```

#### 3.2.3. `СформироватьЗапросEGAIS()`

**Назначение:** Формирование JSON для обновления ЕГАИС-атрибутов  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (служебная)

```bsl
Функция СформироватьЗапросEGAIS(Позиция) Экспорт
    // Получение данных номенклатуры
    // Маппинг полей ЕГАИС
    // Формирование UpdateMenuItemEgaisDto
    // Возврат: Строка (JSON)
КонецФункции
```

#### 3.2.4. `СинхронизироватьШтрихкоды()`

**Назначение:** Двусторонняя синхронизация штрихкодов  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (служебная)

```bsl
Функция СинхронизироватьШтрихкоды(Позиция, КассовыйУзел, ObjNum, RvcId) Экспорт
    // 1. GET /rvc/{rvcId}/egais/barcodes/{objnum}
    // 2. Запрос к РегистрСведений.ШтрихкодыНоменклатуры
    // 3. Вычисление Diff
    // 4. DELETE для каждого удаляемого
    // 5. POST batch для добавляемых
    // Возврат: Структура (Успешно, Добавлено, Удалено, Сообщение)
КонецФункции
```

#### 3.2.5. `ПолучитьШтрихкодыИзSimphony()`

**Назначение:** Получение текущих штрихкодов из Simphony  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (служебная)

```bsl
Функция ПолучитьШтрихкодыИзSimphony(ObjNum, RvcId, CorrelationId)
    // GET /rvc/{rvcId}/egais/barcodes/{objnum}
    // Возврат: Массив строк
КонецФункции
```

#### 3.2.6. `ПолучитьШтрихкодыИз1С()`

**Назначение:** Получение штрихкодов из регистра 1С  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (служебная)

```bsl
Функция ПолучитьШтрихкодыИз1С(Номенклатура, Характеристика)
    // Запрос к РегистрСведений.ШтрихкодыНоменклатуры
    // Возврат: Массив строк
КонецФункции
```

#### 3.2.7. `ВычислитьРазницуШтрихкодов()`

**Назначение:** Вычисление расхождений между множествами штрихкодов  
**Расположение:** `MRS_ИнтеграцияSimphonyСервер` (служебная)

```bsl
Функция ВычислитьРазницуШтрихкодов(ШтрихкодыSimphony, Штрихкоды1С)
    // Вычисление:
    // - НаДобавление = Штрихкоды1С МИНУС ШтрихкодыSimphony
    // - НаУдаление = ШтрихкодыSimphony МИНУС Штрихкоды1С
    // Возврат: Структура (НаДобавление, НаУдаление)
КонецФункции
```

---

## 4. Алгоритмы и последовательность операций

### 4.1. Алгоритм определения алкогольной продукции

```
Функция ЭтоАлкогольнаяПродукция(Позиция)
    
    1. Получить данные номенклатуры:
       Запрос:
         ВЫБРАТЬ
           питМеню.Номенклатура.АлкогольнаяПродукция,
           питМеню.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре,
         ГДЕ питМеню.Ссылка = &Позиция

КонецФункции
```

### 4.2. Алгоритм обновления данных ЕГАИС

```
Функция ОбновитьДанныеЕГАИС(Позиция, КассовыйУзел)
    
    Результат = Новый Структура("Успешно, Сообщение, HTTPСтатус", Ложь, "", 0)
    НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах()
    CorrelationId = Строка(Новый УникальныйИдентификатор)
    
    ПОПЫТКА
        
        // Шаг 1: Валидация данных ЕГАИС
        РезультатВалидации = ВалидироватьДанныеЕГАИС(Позиция)
        
        ЕСЛИ НЕ РезультатВалидации.Валидна ТОГДА
            Результат.Сообщение = "ЕГАИС: Ошибка валидации - " + СтрСоединить(РезультатВалидации.Ошибки, ", ")
            ЗаписатьВИсториюСинхронизации(Позиция, "EGAIS_UPDATE", "Ошибка", 0, Результат.Сообщение, CorrelationId, 0)
            ВОЗВРАТ Результат
        КОНЕЦ
        
        // Шаг 2: Формирование JSON для ЕГАИС
        ТелоЗапросаЕГАИС = СформироватьЗапросEGAIS(Позиция)
        
        // Шаг 3: Получение rvcId
        RvcId = ПолучитьКодSimphonyУзла(КассовыйУзел)
        
        ЕСЛИ НЕ ЗначениеЗаполнено(RvcId) ТОГДА
            Результат.Сообщение = "ЕГАИС: Не удалось получить rvcId"
            ВОЗВРАТ Результат
        КОНЕЦ
        
        // Шаг 4: Получение objnum
        ObjNum = ПолучитьКодSimphonyПозиции(Позиция)
        
        ЕСЛИ НЕ ЗначениеЗаполнено(ObjNum) ТОГДА
            Результат.Сообщение = "ЕГАИС: Не удалось получить objnum"
            ВОЗВРАТ Результат
        КОНЕЦ
        
        // Шаг 5: Отправка запроса обновления ЕГАИС-атрибутов
        Заголовки = СформироватьЗаголовки(ИмяПользователя(), CorrelationId)
        Endpoint = СтрШаблон("/rvc/%1/egais/menuitems/egais", RvcId)
        
        HTTPОтветЕГАИС = ОтправитьЗапросAPI("PUT", Endpoint, ТелоЗапросаЕГАИС, Заголовки)
        
        Результат.HTTPСтатус = HTTPОтветЕГАИС.КодСостояния
        
        ЕСЛИ HTTPОтветЕГАИС.КодСостояния = 200 ТОГДА
            
            // Успешное обновление ЕГАИС-атрибутов
            Результат.Успешно = Истина
            Результат.Сообщение = "ЕГАИС: Атрибуты обновлены"
            
            ДлительностьМс = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера
            ЗаписатьВИсториюСинхронизации(Позиция, "EGAIS_UPDATE", "Выгружено", 200, Результат.Сообщение, CorrelationId, ДлительностьМс)
            
            // Шаг 6: Синхронизация штрихкодов
            РезультатШтрихкодов = СинхронизироватьШтрихкоды(Позиция, КассовыйУзел, ObjNum, RvcId)
            
            ЕСЛИ РезультатШтрихкодов.Успешно ТОГДА
                Результат.Сообщение = Результат.Сообщение + СтрШаблон(
                    "; Штрихкоды: добавлено %1, удалено %2", 
                    РезультатШтрихкодов.Добавлено, 
                    РезультатШтрихкодов.Удалено
                )
            ИНАЧЕ
                Результат.Сообщение = Результат.Сообщение + "; Ошибка синхронизации штрихкодов: " + РезультатШтрихкодов.Сообщение
            КОНЕЦ
            
        ИНАЧЕ
            
            // Ошибка обновления ЕГАИС
            ОтветJSON = ПарсироватьОтветJSON(HTTPОтветЕГАИС)
            
            ЕСЛИ ОтветJSON <> Неопределено И ОтветJSON.Свойство("message") ТОГДА
                Результат.Сообщение = СтрШаблон("ЕГАИС HTTP %1: %2", HTTPОтветЕГАИС.КодСостояния, ОтветJSON.message)
            ИНАЧЕ
                Результат.Сообщение = СтрШаблон("ЕГАИС HTTP %1: %2", HTTPОтветЕГАИС.КодСостояния, HTTPОтветЕГАИС.ПолучитьТелоКакСтроку())
            КОНЕЦ
            
            ДлительностьМс = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера
            ЗаписатьВИсториюСинхронизации(Позиция, "EGAIS_UPDATE", "Ошибка", HTTPОтветЕГАИС.КодСостояния, Результат.Сообщение, CorrelationId, ДлительностьМс)
            
        КОНЕЦ
        
    ИСКЛЮЧЕНИЕ
        
        ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())
        Результат.Сообщение = "ЕГАИС: Ошибка соединения - " + ТекстОшибки
        
        ДлительностьМс = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера
        ЗаписатьВИсториюСинхронизации(Позиция, "EGAIS_UPDATE", "Ошибка", 0, Результат.Сообщение, CorrelationId, ДлительностьМс)
        
    КОНЕЦПОПЫТКИ
    
    ВОЗВРАТ Результат

КонецФункции
```

### 4.3. Алгоритм синхронизации штрихкодов

```
Функция СинхронизироватьШтрихкоды(Позиция, КассовыйУзел, ObjNum, RvcId)
    
    Результат = Новый Структура("Успешно, Добавлено, Удалено, Сообщение", Ложь, 0, 0, "")
    CorrelationId = Строка(Новый УникальныйИдентификатор)
    
    ПОПЫТКА
        
        // Шаг 1: Получить штрихкоды из Simphony
        ШтрихкодыSimphony = ПолучитьШтрихкодыИзSimphony(ObjNum, RvcId, CorrelationId)
        
        // Шаг 2: Получить штрихкоды из 1С
        ДанныеПозиции = ПолучитьДанныеПозиции(Позиция)
        Штрихкоды1С = ПолучитьШтрихкодыИз1С(ДанныеПозиции.Номенклатура, ДанныеПозиции.Характеристика)
        
        // Шаг 3: Вычислить расхождения
        Расхождения = ВычислитьРазницуШтрихкодов(ШтрихкодыSimphony, Штрихкоды1С)
        
        КоличествоДобавлено = 0
        КоличествоУдалено = 0
        Ошибки = Новый Массив
        
        // Шаг 4: Удаление устаревших штрихкодов
        ДЛЯ КАЖДОГО Штрихкод ИЗ Расхождения.НаУдаление ЦИКЛ
            
            Endpoint = СтрШаблон("/rvc/%1/egais/barcodes/%2/%3", RvcId, ObjNum, Штрихкод)
            Заголовки = СформироватьЗаголовки(ИмяПользователя(), CorrelationId)
            
            HTTPОтвет = ОтправитьЗапросAPI("DELETE", Endpoint, "", Заголовки)
            
            ЕСЛИ HTTPОтвет.КодСостояния = 200 ТОГДА
                КоличествоУдалено = КоличествоУдалено + 1
            ИНАЧЕ
                ТекстОшибки = СтрШаблон("Не удалось удалить штрихкод %1: HTTP %2", Штрихкод, HTTPОтвет.КодСостояния)
                Ошибки.Добавить(ТекстОшибки)
            КОНЕЦ
            
        КОНЕЦЦИКЛА
        
        // Шаг 5: Добавление новых штрихкодов (пакетом)
        ЕСЛИ Расхождения.НаДобавление.Количество() > 0 ТОГДА
            
            // Формирование JSON для batch добавления
            МассивДобавления = Новый Массив
            ДЛЯ КАЖДОГО Штрихкод ИЗ Расхождения.НаДобавление ЦИКЛ
                ЭлементJSON = Новый Структура
                ЭлементJSON.Вставить("objnum", ObjNum)
                ЭлементJSON.Вставить("barcode", Штрихкод)
                МассивДобавления.Добавить(ЭлементJSON)
            КОНЕЦЦИКЛА
            
            ЗаписьJSON = Новый ЗаписьJSON
            ЗаписьJSON.УстановитьСтроку()
            ЗаписатьJSON(ЗаписьJSON, МассивДобавления)
            ТелоЗапроса = ЗаписьJSON.Закрыть()
            
            Endpoint = СтрШаблон("/rvc/%1/egais/barcodes/batch", RvcId)
            Заголовки = СформироватьЗаголовки(ИмяПользователя(), CorrelationId)
            
            HTTPОтвет = ОтправитьЗапросAPI("POST", Endpoint, ТелоЗапроса, Заголовки)
            
            ЕСЛИ HTTPОтвет.КодСостояния = 200 ТОГДА
                
                // Парсим ответ для получения количества успешно добавленных
                ОтветJSON = ПарсироватьОтветJSON(HTTPОтвет)
                
                ЕСЛИ ОтветJSON.Свойство("success") ТОГДА
                    КоличествоДобавлено = ОтветJSON.success.Количество()
                ИНАЧЕ
                    КоличествоДобавлено = Расхождения.НаДобавление.Количество()
                КОНЕЦ
                
            ИНАЧЕ
                ТекстОшибки = СтрШаблон("Не удалось добавить штрихкоды пакетом: HTTP %1", HTTPОтвет.КодСостояния)
                Ошибки.Добавить(ТекстОшибки)
            КОНЕЦ
            
        КОНЕЦ
        
        // Формирование результата
        Результат.Добавлено = КоличествоДобавлено
        Результат.Удалено = КоличествоУдалено
        
        ЕСЛИ Ошибки.Количество() = 0 ТОГДА
            Результат.Успешно = Истина
            Результат.Сообщение = "Штрихкоды синхронизированы"
        ИНАЧЕ
            Результат.Успешно = Ложь
            Результат.Сообщение = СтрСоединить(Ошибки, "; ")
        КОНЕЦ
        
        // Логирование
        ЗаписатьВИсториюСинхронизации(
            Позиция, 
            "EGAIS_BARCODES", 
            ?(Результат.Успешно, "Выгружено", "Ошибка"), 
            0, 
            СтрШаблон("Добавлено: %1, Удалено: %2. %3", КоличествоДобавлено, КоличествоУдалено, Результат.Сообщение),
            CorrelationId, 
            0
        )
        
    ИСКЛЮЧЕНИЕ
        
        ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())
        Результат.Сообщение = "Ошибка синхронизации штрихкодов: " + ТекстОшибки
        
        ЗаписатьВИсториюСинхронизации(Позиция, "EGAIS_BARCODES", "Ошибка", 0, Результат.Сообщение, CorrelationId, 0)
        
    КОНЕЦПОПЫТКИ
    
    ВОЗВРАТ Результат

КонецФункции
```

---

## 5. Маппинг данных (упрощенная версия)

### 5.1. Маппинг для UpdateMenuItemEgaisDto

> **ВАЖНО:** В упрощенной версии передаем только базовые поля: `objnum`, `volume`, `unit`.  
> Поля `marktype`, `groupid`, `cocktailid` остаются null (не передаются в JSON).

**Endpoint:** `PUT /rvc/{rvcId}/egais/menuitems/egais`

| Поле API | Тип | Источник в 1С | Логика маппинга | Обязательность |
|----------|-----|---------------|-----------------|----------------|
| `objnum` | Integer | `питМеню.MRS_КодSimphony` | Прямое значение | ✅ Обязательно |
| `volume` | Number | `Номенклатура.ОбъемДал` | Прямое значение (уже в декалитрах) | ✅ Обязательно |
| `unit` | String | `Номенклатура.ЕдиницаХранения.Наименование` | Через `.Наименование` или `Представление()` | ✅ Обязательно |
| `marktype` | Integer / null | - | **НЕ передается** (остается null) | ❌ Не используется |
| `groupid` | Integer / null | - | **НЕ передается** (остается null) | ❌ Не используется |
| `cocktid` | Integer / null | - | **НЕ передается** (остается null) | ❌ Не используется |

**Пример JSON запроса (упрощенная версия):**
```json
{
  "objnum": 123456,
  "volume": 0.05,
  "unit": "дал"
}
```

**Примечание:** Поля `marktype`, `groupid`, `cocktailid` не включаются в JSON запрос.

**SQL запрос для получения данных:**
```sql
ВЫБРАТЬ
    питМеню.MRS_КодSimphony КАК ObjNum,
    питМеню.Номенклатура.ЕмкостьТары КАК ЕмкостьТары,
    питМеню.Номенклатура.ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
    питМеню.Номенклатура.ВидАлкогольнойПродукции.MRS_ТипМаркировкиSimphony КАК ТипМаркировки,
    питМеню.Номенклатура.ВидАлкогольнойПродукции.MRS_КодГруппыEGAIS КАК КодГруппы,
    питМеню.Номенклатура.MRS_КодКоктейляEGAIS КАК КодКоктейля,
    питМеню.Номенклатура.Характеристика КАК Характеристика
ИЗ
    Справочник.питМеню КАК питМеню
ГДЕ
    питМеню.Ссылка = &Позиция
```

### 5.2. Маппинг для AddBarcodeDto (batch)

**Endpoint:** `POST /rvc/{rvcId}/egais/barcodes/batch`

**Источник:** `РегистрСведений.ШтрихкодыНоменклатуры`

| Поле API | Тип | Источник в 1С |
|----------|-----|---------------|
| `objnum` | Integer | `питМеню.MRS_КодSimphony` |
| `barcode` | String | `ШтрихкодыНоменклатуры.Штрихкод` |

**SQL запрос для получения штрихкодов:**
```sql
ВЫБРАТЬ
    ШтрихкодыНоменклатуры.Штрихкод
ИЗ
    РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
ГДЕ
    ШтрихкодыНоменклатуры.Номенклатура = &Номенклатура
    И ШтрихкодыНоменклатуры.Характеристика = &Характеристика
```

**Пример JSON запроса:**
```json
[
  {
    "objnum": 123456,
    "barcode": "4601234567890"
  },
  {
    "objnum": 123456,
    "barcode": "4607654321098"
  }
]
```

### 5.3. Маппинг для rvcId

**Источник:** `ПланОбмена.питУдаленныеКассы.Префикс`

**Использующая функция:** `ПолучитьКодSimphonyУзла()` (уже существует, строка 1649)

**Пример:** Префикс = "40001" → rvcId = 40001

---

## 6. Используемые реквизиты метаданных 1С (без изменений)

> **ВАЖНО:** В упрощенной версии реализации НЕ создаются новые реквизиты в метаданных.  
> Используются только существующие реквизиты справочника `Номенклатура`.  
> Поля `marktype`, `groupid`, `cocktailid` в API остаются null.

### 6.1. Справочник `Номенклатура` (существующие реквизиты)

**Используемые реквизиты:**

| Имя реквизита | Тип данных | Назначение | Использование |
|---------------|------------|------------|---------------|
| `АлкогольнаяПродукция` | Булево | Признак алкогольной продукции | Определение необходимости обмена с ЕГАИС |
| `АлкогольнаяПродукцияВоВскрытойТаре` | Булево | Признак продукции во вскрытой таре | Исключение из обмена с ЕГАИС (такая продукция НЕ синхронизируется) |
| `ОбъемДал` | Число | Объем в декалитрах | Источник для поля `volume` в API |
| `ЕдиницаХранения` | СправочникСсылка | Единица измерения | Источник для поля `unit` в API (через `.Наименование` или `Представление()`) |

**Условие обмена с ЕГАИС:**

```bsl
// Позиция попадает в обмен с ЕГАИС, если:
ЭтоАлкоголь = Номенклатура.АлкогольнаяПродукция 
    И НЕ Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре;
```

**Примеры:**

| Номенклатура | АлкогольнаяПродукция | ВоВскрытойТаре | ОбъемДал | ЕдиницаХранения | Обмен ЕГАИС |
|--------------|----------------------|----------------|----------|-----------------|-------------|
| Водка Финляндия 0.5л | ✅ Истина | ❌ Ложь | 0.05 | дал | ✅ ДА |
| Вино Шардоне 0.75л | ✅ Истина | ❌ Ложь | 0.075 | дал | ✅ ДА |
| Коньяк (разливной) | ✅ Истина | ✅ Истина | - | - | ❌ НЕТ |
| Кока-Кола 0.5л | ❌ Ложь | - | - | - | ❌ НЕТ |

### 6.2. Будущее расширение (не реализуется на данном этапе)

При необходимости полной интеграции ЕГАИС (передача `marktype`, `groupid`, `cocktailid`) потребуется:

**Справочник `ВидыАлкогольнойПродукции`:**
- `MRS_ТипМаркировкиSimphony` (Число 5,0) - тип маркировки
- `MRS_КодГруппыEGAIS` (Число 10,0) - ID группы продукции

**Справочник `Номенклатура`:**
- `MRS_КодКоктейляEGAIS` (Число 10,0) - ID коктейля

> Это будет реализовано на следующем этапе по требованию заказчика.

---

## 7. Обработка ошибок

### 7.1. Принципы обработки ошибок

**Принцип 1: Независимость операций**
- Ошибка обновления ЕГАИС **НЕ отменяет** основную выгрузку позиции меню
- Основная позиция остается в статусе "Выгружено"
- Ошибка ЕГАИС записывается отдельной строкой в историю

**Принцип 2: Детальное логирование**
- Каждая операция ЕГАИС логируется отдельно:
  - `EGAIS_UPDATE` - обновление атрибутов
  - `EGAIS_BARCODES` - синхронизация штрихкодов

**Принцип 3: Повторные попытки**
- Ошибки HTTP 5xx (серверные): ставить в очередь повтора
- Ошибки HTTP 4xx (клиентские): НЕ повторять, требуется исправление данных

### 7.2. Коды ошибок и их обработка

| HTTP статус | Операция | Действие | Повтор |
|-------------|----------|----------|--------|
| **200** | PUT egais/menuitems/egais | Успех, продолжить синхронизацию штрихкодов | - |
| **400** | PUT egais/menuitems/egais | Ошибка валидации данных, записать в лог | Нет |
| **404** | PUT egais/menuitems/egais | Позиция меню не найдена (objnum некорректен) | Нет |
| **502** | PUT egais/menuitems/egais | Ошибка EGAIS сервиса, повторить через 5 минут | Да, до 3 раз |
| **503** | PUT egais/menuitems/egais | EGAIS сервис недоступен, повторить через 5 минут | Да, до 3 раз |
| **200** | GET egais/barcodes/{objnum} | Успех, получен список штрихкодов | - |
| **404** | GET egais/barcodes/{objnum} | Позиция не найдена (новая позиция, еще нет штрихкодов) - считать пустым массивом | - |
| **201** | POST egais/barcodes/batch | Штрихкоды успешно добавлены | - |
| **400** | POST egais/barcodes/batch | Некорректные данные штрихкодов, записать в лог | Нет |
| **409** | POST egais/barcodes (single) | Штрихкод уже существует (конфликт) - пропустить | - |
| **200** | DELETE egais/barcodes/{objnum}/{barcode} | Штрихкод успешно удален | - |
| **404** | DELETE egais/barcodes/{objnum}/{barcode} | Штрихкод не найден (уже удален) - считать успехом | - |

### 7.3. Структура сообщений об ошибках

**Формат записи в историю синхронизации:**

```
Операция: EGAIS_UPDATE | EGAIS_BARCODES
Статус: Выгружено | Ошибка | ВыгруженоСПредупреждением
Сообщение: [Префикс операции]: [Описание]

Примеры:
- "ЕГАИС: Атрибуты обновлены; Штрихкоды: добавлено 3, удалено 1"
- "ЕГАИС HTTP 400: Некорректное значение marktype"
- "ЕГАИС: Ошибка валидации - Не заполнен MRS_ТипМаркировкиSimphony"
- "ЕГАИС: Ошибка синхронизации штрихкодов: Не удалось добавить штрихкоды пакетом: HTTP 502"
```

### 7.4. Валидация данных перед отправкой (упрощенная версия)

> **ВАЖНО:** В упрощенной версии валидируем только обязательные поля: `objnum`, `volume`, `unit`.  
> Поля `marktype`, `groupid`, `cocktailid` НЕ проверяются (они не передаются).

**Проверяемые условия:**

```bsl
Функция ВалидироватьДанныеЕГАИС(Позиция)
    
    Результат = Новый Структура("Валидна, Ошибки", Истина, Новый Массив)
    
    // 1. Получить данные позиции
    ДанныеПозиции = ПолучитьДанныеПозицииЕГАИС(Позиция)
    
    // 2. Проверка objnum (обязательно)
    ЕСЛИ НЕ ЗначениеЗаполнено(ДанныеПозиции.ObjNum) ТОГДА
        Результат.Ошибки.Добавить("Не заполнен MRS_КодSimphony")
    КОНЕЦ
    
    // 3. Проверка volume (обязательно) - из Номенклатура.ОбъемДал
    ЕСЛИ НЕ ЗначениеЗаполнено(ДанныеПозиции.ОбъемДал) ТОГДА
        Результат.Ошибки.Добавить("Не заполнен реквизит ОбъемДал в карточке номенклатуры")
    ИНАЧЕЕСЛИ ДанныеПозиции.ОбъемДал <= 0 ТОГДА
        Результат.Ошибки.Добавить("ОбъемДал должен быть больше 0")
    КОНЕЦ
    
    // 4. Проверка unit (обязательно) - из Номенклатура.ЕдиницаХранения
    ЕСЛИ НЕ ЗначениеЗаполнено(ДанныеПозиции.ЕдиницаХранения) ТОГДА
        Результат.Ошибки.Добавить("Не заполнена ЕдиницаХранения в карточке номенклатуры")
    КОНЕЦ
    
    // Поля marktype, groupid, cocktailid не проверяем (не передаем)
    
    ЕСЛИ Результат.Ошибки.Количество() > 0 ТОГДА
        Результат.Валидна = Ложь
    КОНЕЦ
    
    ВОЗВРАТ Результат

КонецФункции
```

---

## 8. Логирование

### 8.1. Использование существующего механизма

**Регистр сведений:** `MRS_ИсторияСинхронизацииМенюSimphony`

**Структура записей:**

| Реквизит | Тип | Назначение |
|----------|-----|------------|
| ПозицияМеню | СправочникСсылка.питМеню | Позиция меню |
| ДатаВремя | ДатаВремя | Дата и время операции |
| УникальныйИдентификатор | Строка (36) | Correlation ID |
| Операция | Строка (50) | Тип операции: CREATE, UPDATE, DELETE, **EGAIS_UPDATE**, **EGAIS_BARCODES** |
| Статус | Перечисление | Выгружено, Ошибка, ВыгруженоСПредупреждением |
| HTTPСтатус | Число | Код HTTP ответа |
| Сообщение | Строка (1000) | Детальное сообщение |
| Пользователь | СправочникСсылка.Пользователи | Пользователь, инициировавший операцию |
| ДлительностьМс | Число | Длительность операции в миллисекундах |

### 8.2. Новые типы операций

**EGAIS_UPDATE:**
- Логируется после PUT /rvc/{rvcId}/egais/menuitems/egais
- Содержит результат обновления ЕГАИС-атрибутов

**EGAIS_BARCODES:**
- Логируется после синхронизации штрихкодов
- Содержит количество добавленных и удаленных штрихкодов

**Пример записей в истории:**

```
| ДатаВремя          | Операция       | Статус     | HTTPСтатус | Сообщение |
|--------------------|----------------|------------|------------|-----------|
| 2026-02-05 14:30:15| CREATE         | Выгружено  | 200        | Успешно выгружено |
| 2026-02-05 14:30:16| EGAIS_UPDATE   | Выгружено  | 200        | ЕГАИС: Атрибуты обновлены |
| 2026-02-05 14:30:17| EGAIS_BARCODES | Выгружено  | 0          | Добавлено: 3, Удалено: 1. Штрихкоды синхронизированы |
```

### 8.3. Журнал регистрации 1С

**Дополнительное логирование в журнал регистрации:**

```bsl
// При ошибке валидации
ЗаписьЖурналаРегистрации(
    "MRS.Simphony.EGAIS", 
    УровеньЖурналаРегистрации.Предупреждение,
    ,
    Позиция,
    СтрШаблон("Ошибка валидации ЕГАИС для позиции %1: %2", Позиция, СтрСоединить(ОшибкиВалидации, ", "))
)

// При успешном обновлении
ЗаписьЖурналаРегистрации(
    "MRS.Simphony.EGAIS", 
    УровеньЖурналаРегистрации.Информация,
    ,
    Позиция,
    СтрШаблон("ЕГАИС данные обновлены для позиции %1: добавлено %2 штрихкодов, удалено %3", Позиция, Добавлено, Удалено)
)

// При ошибке синхронизации
ЗаписьЖурналаРегистрации(
    "MRS.Simphony.EGAIS", 
    УровеньЖурналаРегистрации.Ошибка,
    ,
    Позиция,
    СтрШаблон("Ошибка синхронизации ЕГАИС для позиции %1: HTTP %2 - %3", Позиция, HTTPСтатус, Сообщение)
)
```

---

## 9. Переиспользуемые функции

### 9.1. Существующие функции для переиспользования

| Функция | Файл | Строки | Использование |
|---------|------|--------|---------------|
| `ОтправитьЗапросAPI()` | MRS_ИнтеграцияSimphonyСервер | 1303-1358 | Отправка HTTP запросов к API |
| `ПарсироватьОтветJSON()` | MRS_ИнтеграцияSimphonyСервер | 1368-1383 | Парсинг JSON ответов |
| `СформироватьЗаголовки()` | MRS_ИнтеграцияSimphonyСервер | 1395-1410 | Формирование HTTP заголовков |
| `ПолучитьКодSimphonyУзла()` | MRS_ИнтеграцияSimphonyСервер | 1649-1670 | Получение rvcId из кассового узла |
| `ЗаписатьВИсториюСинхронизации()` | MRS_ИнтеграцияSimphonyСервер | 1722-1748 | Логирование операций |

**Не требуется создавать новые функции для:**
- HTTP взаимодействия
- Парсинга JSON
- Получения rvcId
- Логирования

### 9.2. Функции, требующие создания

| Функция | Назначение | Приоритет |
|---------|------------|-----------|
| `ЭтоАлкогольнаяПродукция()` | Определение признака алкоголя | Высокий |
| `ОбновитьДанныеЕГАИС()` | Основная функция синхронизации ЕГАИС | Высокий |
| `СформироватьЗапросEGAIS()` | Формирование JSON для ЕГАИС | Высокий |
| `ВалидироватьДанныеЕГАИС()` | Валидация данных ЕГАИС | Высокий |
| `СинхронизироватьШтрихкоды()` | Двусторонняя синхронизация штрихкодов | Высокий |
| `ПолучитьШтрихкодыИзSimphony()` | GET штрихкодов из API | Средний |
| `ПолучитьШтрихкодыИз1С()` | Запрос к регистру штрихкодов | Средний |
| `ВычислитьРазницуШтрихкодов()` | Вычисление Diff | Средний |

---

## 10. План реализации

### 10.1. Этапы разработки

**Этап 1: Вспомогательные функции** (3-4 часа)
1. `ЭтоАлкогольнаяПродукция()` - проверка по существующим реквизитам
2. `ПолучитьШтрихкодыИз1С()` - запрос к РС.ШтрихкодыНоменклатуры
3. `ПолучитьШтрихкодыИзSimphony()` - GET запрос к API
4. `СформироватьЗапросEGAIS()` - формирование минимального JSON (objnum, volume, unit)

**Этап 2: Основная логика** (5-6 часов)
1. `ОбновитьДанныеЕГАИС()` - основная функция синхронизации
2. `СинхронизироватьШтрихкоды()` - двусторонняя синхронизация
3. Интеграция в `ВыгрузитьПозициюВSimphony()` - добавление вызова после HTTP 200
4. Обработка ошибок и логирование (EGAIS_UPDATE, EGAIS_BARCODES)

**Этап 3: Тестирование** (3-4 часа)
1. Модульные тесты для новых функций
2. Интеграционное тестирование с фискальной базой
3. Тестирование сценариев ошибок (400, 404, 502)
4. Проверка с неалкогольной продукцией (не должна попадать в ЕГАИС)

**Общая оценка трудозатрат:** 11-14 часов (вместо 18-25 часов в полной версии)

**Этап 5: Документация и обучение** (2-3 часа)
1. Инструкция по заполнению данных ЕГАИС
2. Обучение администраторов меню
3. Регламент поддержки

**Общее время разработки:** 18-25 часов

### 10.2. Критерии готовности

- [ ] Все новые реквизиты добавлены в метаданные
- [ ] Все функции созданы и протестированы
- [ ] Интеграция работает для алкогольных позиций
- [ ] Неалкогольные позиции выгружаются без изменений
- [ ] Логирование работает корректно
- [ ] Обработка ошибок реализована
- [ ] Документация готова

---

## 11. Тестовые сценарии

### 11.1. Функциональные сценарии

**Сценарий 1: Выгрузка новой алкогольной позиции**

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Создать позицию меню с алкогольной номенклатурой | Позиция создана |
| 2 | Заполнить все ЕГАИС-атрибуты (marktype, groupid) | Атрибуты заполнены |
| 3 | Добавить 3 штрихкода в регистр `ШтрихкодыНоменклатуры` | Штрихкоды добавлены |
| 4 | Выгрузить позицию в Simphony | Позиция выгружена (HTTP 200) |
| 5 | Проверить историю синхронизации | Есть записи: CREATE (200), EGAIS_UPDATE (200), EGAIS_BARCODES (0) |
| 6 | Проверить в Simphony | ЕГАИС-атрибуты заполнены, 3 штрихкода добавлены |

**Сценарий 2: Обновление штрихкодов существующей позиции**

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Взять существующую алкогольную позицию (уже выгружена) | Позиция есть |
| 2 | В 1С добавить 2 новых штрихкода | Всего 5 штрихкодов в 1С |
| 3 | В 1С удалить 1 старый штрихкод | Всего 4 штрихкода в 1С |
| 4 | Выгрузить позицию повторно | Позиция обновлена (HTTP 200) |
| 5 | Проверить историю | EGAIS_BARCODES: "Добавлено: 2, Удалено: 1" |
| 6 | Проверить в Simphony | В Simphony 4 штрихкода (совпадают с 1С) |

**Сценарий 3: Выгрузка неалкогольной позиции**

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Создать позицию меню с неалкогольной номенклатурой | Позиция создана |
| 2 | Выгрузить позицию в Simphony | Позиция выгружена (HTTP 200) |
| 3 | Проверить историю синхронизации | Только запись CREATE (200), нет EGAIS записей |
| 4 | Проверить в Simphony | Позиция создана, ЕГАИС-атрибуты не заполнены |

**Сценарий 4: Ошибка валидации ЕГАИС**

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Создать алкогольную позицию без заполнения `MRS_ТипМаркировкиSimphony` | Позиция создана |
| 2 | Выгрузить позицию | Позиция выгружена (HTTP 200) |
| 3 | Проверить историю синхронизации | CREATE (200), EGAIS_UPDATE (0, Ошибка): "Не заполнен MRS_ТипМаркировкиSimphony" |
| 4 | Проверить в Simphony | Позиция меню создана, ЕГАИС-атрибуты НЕ заполнены |

**Сценарий 5: Ошибка API ЕГАИС (HTTP 502)**

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Имитировать недоступность EGAIS сервиса | HTTP 502 на PUT egais/menuitems/egais |
| 2 | Выгрузить алкогольную позицию | Позиция выгружена (HTTP 200) |
| 3 | Проверить историю синхронизации | CREATE (200), EGAIS_UPDATE (502, Ошибка): "Ошибка EGAIS сервиса" |
| 4 | Проверить в Simphony | Позиция меню создана, ЕГАИС-атрибуты НЕ обновлены |

### 11.2. Граничные случаи

**Граничный случай 1: Позиция без штрихкодов**
- В 1С нет штрихкодов для номенклатуры
- Результат: Синхронизация штрихкодов пропускается, логируется "Добавлено: 0, Удалено: 0"

**Граничный случай 2: Пустой список штрихкодов в Simphony**
- GET /egais/barcodes/{objnum} возвращает HTTP 404 (новая позиция)
- Результат: Считается пустым массивом, добавляются все штрихкоды из 1С

**Граничный случай 3: Алкоголь во вскрытой таре**
- Номенклатура с `АлкогольнаяПродукция` = Истина И `АлкогольнаяПродукцияВоВскрытойТаре` = Истина
- Результат: Обмен с ЕГАИС НЕ выполняется (такая продукция не синхронизируется)

**Граничный случай 4: Частичная ошибка удаления штрихкодов**
- Удаление 3 штрихкодов: 2 успешно (HTTP 200), 1 ошибка (HTTP 404)
- Результат: Логируется "Удалено: 2", ошибка игнорируется (штрихкод уже удален)

---

## 12. Риски и меры по их снижению

| Риск | Вероятность | Воздействие | Меры по снижению |
|------|-------------|-------------|------------------|
| **ЕГАИС API недоступен при выгрузке** | Средняя | Среднее | - Основная выгрузка не блокируется<br>- Ошибка логируется отдельно<br>- Возможность повторной синхронизации |
| **Некорректное заполнение ЕГАИС-атрибутов** | Высокая | Высокое | - Валидация данных перед отправкой<br>- Детальные сообщения об ошибках<br>- Инструкция по заполнению |
| **Расхождение штрихкодов после синхронизации** | Низкая | Среднее | - Использование batch API для добавления<br>- Логирование всех операций со штрихкодами<br>- Возможность повторной синхронизации |
| **Изменение структуры API ЕГАИС** | Низкая | Высокое | - Версионирование API<br>- Проверка совместимости при обновлении Simphony |
| **Производительность при массовой выгрузке** | Средняя | Среднее | - Синхронизация штрихкодов batch методом<br>- Асинхронная обработка очереди<br>- Ограничение количества позиций в пакете |

---

## 13. Дополнительные рекомендации

### 13.1. Настройка данных ЕГАИС

**До начала эксплуатации:**

1. **Заполнить справочник `ВидыАлкогольнойПродукции`:**
   - Для каждого вида алкоголя указать `MRS_ТипМаркировкиSimphony`
   - Для каждого вида алкоголя указать `MRS_КодГруппыEGAIS`
   - Получить значения из документации Simphony Fiscal DB или у администратора Simphony

2. **Проверить штрихкоды номенклатуры:**
   - Убедиться, что все алкогольные позиции имеют штрихкоды в регистре `ШтрихкодыНоменклатуры`
   - Формат штрихкода: EAN-13 (13 цифр)

3. **Заполнить объем тары:**
   - Для всех алкогольных позиций заполнить `ЕмкостьТары`
   - Единица измерения: литры (не далы!)

### 13.2. Мониторинг и поддержка

**Регулярные проверки:**

1. **Проверка истории синхронизации:**
   - Регулярно просматривать записи с типом `EGAIS_UPDATE` и `EGAIS_BARCODES`
   - Выявлять позиции с ошибками валидации
   - Исправлять некорректно заполненные данные

2. **Проверка согласованности штрихкодов:**
   - Периодически сравнивать штрихкоды в 1С и Simphony
   - При расхождениях выполнять повторную выгрузку

3. **Мониторинг доступности ЕГАИС API:**
   - Отслеживать количество ошибок HTTP 502/503
   - При частых ошибках связываться с администратором Simphony

### 13.3. Процедура восстановления

**При массовых ошибках синхронизации ЕГАИС:**

1. Проверить доступность ЕГАИС сервиса
2. Получить список позиций с ошибками из истории синхронизации
3. Исправить некорректные данные ЕГАИС-атрибутов
4. Выполнить повторную выгрузку проблемных позиций

---

## 14. Приложения

### 14.1. Справочник кодов типов маркировки

| Код | Наименование | Описание |
|-----|--------------|----------|
| 1 | Партионный | Алкоголь учитывается партиями (упаковками) |
| 3 | Помарочный | Алкоголь учитывается по индивидуальным акцизным маркам |

**Источник:** Документация Simphony Fiscal DB API

### 14.2. Примеры кодов групп ЕГАИС

| Код | Группа |
|-----|--------|
| 300 | Вино столовое |
| 320 | Вино игристое |
| 410 | Пиво светлое |
| 420 | Пиво темное |
| 500 | Водка |
| 520 | Коньяк |
| 540 | Виски |

**Примечание:** Полный справочник кодов групп получается от администратора Simphony или из документации ЕГАИС.

### 14.3. Пример заполнения данных для теста

**Справочник `ВидыАлкогольнойПродукции`:**

| Наименование | MRS_ТипМаркировкиSimphony | MRS_КодГруппыEGAIS |
|--------------|---------------------------|---------------------|
| Водка | 3 | 500 |
| Вино столовое | 1 | 300 |
| Пиво светлое | 1 | 410 |

**Справочник `Номенклатура`:**

| Наименование | ВидАлкогольнойПродукции | ЕмкостьТары | MRS_КодКоктейляEGAIS |
|--------------|-------------------------|-------------|----------------------|
| Водка "Флагман" 0,5л | Водка | 0.5 | 0 |
| Вино "Массандра" сухое красное 0,75л | Вино столовое | 0.75 | 0 |
| Коктейль "Мохито" алкогольный | Вино столовое | 0.25 | 750 |

**Регистр `ШтрихкодыНоменклатуры`:**

| Номенклатура | Штрихкод |
|--------------|----------|
| Водка "Флагман" 0,5л | 4601234567890 |
| Водка "Флагман" 0,5л | 4601234567906 |
| Вино "Массандра" сухое красное 0,75л | 4607654321098 |

---

## Заключение

Данная спецификация содержит полное описание требований и архитектурного решения для реализации обмена марками алкогольной продукции между 1С и Simphony Fiscal DB.

**Ключевые особенности реализации:**
- Минимальное изменение существующей архитектуры
- Независимость операций (ошибка ЕГАИС не блокирует основную выгрузку)
- Детальное логирование для отладки и мониторинга
- Валидация данных для предотвращения ошибок API
- Использование batch операций для оптимизации производительности

**Готовность к разработке:** Спецификация готова для передачи разработчикам.
