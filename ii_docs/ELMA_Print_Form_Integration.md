# Интеграция печатной формы приказа ЕЛМА через пользовательский макет Word

## Описание реализации

Реализована функциональность для формирования печатной формы приказа ЕЛМА из пользовательского шаблона Word, сохраненного в РС.ПользовательскиеМакетыПечати.

## Измененные файлы

### 1. `CommonModules/MRS_ИнтеграцияЕЛМАСервер/Ext/Module.bsl`

Доработана функция `СформироватьПриказЕЛМА`:

- Добавлено получение макета из РС.ПользовательскиеМакетыПечати
- Реализовано заполнение шапки документа параметрами
- Реализовано заполнение табличной части с данными из документа
- Добавлена обработка ошибок
- Добавлена вспомогательная функция `ПолучитьПозициюМенюПоНоменклатуре`

### 2. `CommonModules/MRS_ИнтеграцияЕЛМАКлиент/Ext/Module.bsl`

Доработана процедура `КомандаПечатьПриказаЕЛМА`:

- Добавлена проверка записи документа
- Реализовано открытие сформированного Word-документа через:
  - `ФайловаяСистемаКлиент.ОткрытьФайл()` (БСП) - основной вариант
  - `ПолучитьФайл()` (стандартная функция) - резервный вариант для совместимости
- Добавлена обработка ошибок

## Требования к макету Word

### Настройка макета в РС.ПользовательскиеМакетыПечати

1. **Путь к макету**: `Документ.УстановкаЦенНоменклатуры.ПриказЕЛМА`
2. **Имя макета**: `ПриказЕЛМА`

### Области макета

Макет должен содержать следующие области:

1. **Шапка** (тип: "Общая") - для заголовка документа
2. **СтрокаТаблицы** (тип: "СтрокаТаблицы") - для строк таблицы с товарами

### Параметры шапки

В области "Шапка" можно использовать следующие параметры (теги вида `{v8 <ИмяПараметра>}`):

- `{v8 <Организация>}` - название организации
- `{v8 <СсылкаДата>}` - дата документа (заглушка)
- `{v8 <НомерПриказа>}` - номер приказа (заглушка)
- `{v8 <TopicOfDecree>}` - тема приказа (заглушка)
- `{v8 <ДатаНачалаДействия>}` - дата начала действия цен

### Параметры табличной части

В области "СтрокаТаблицы" можно использовать следующие параметры:

- `{v8 <ТочкаПродажи>}` - точка продажи (заглушка)
- `{v8 <ТоварыНоменклатура>}` - название блюда/товара
- `{v8 <ТипИзменения>}` - тип изменения (всегда "Установка цен")
- `{v8 <НоваяЦена>}` - новая цена товара
- `{v8 <НовоеНазвание>}` - новое название товара
- `{v8 <СтавкаНДС>}` - ставка НДС (заглушка)

## Структура данных

### Шапка документа

```bsl
ДанныеШапки = Новый Структура;
ДанныеШапки.Вставить("Организация", <Строка>);
ДанныеШапки.Вставить("СсылкаДата", <Строка>);
ДанныеШапки.Вставить("НомерПриказа", <Строка>);
ДанныеШапки.Вставить("TopicOfDecree", <Строка>);
ДанныеШапки.Вставить("ДатаНачалаДействия", <Строка>);
```

### Табличная часть

```bsl
ДанныеСтроки = Новый Структура;
ДанныеСтроки.Вставить("ТочкаПродажи", <Строка>);
ДанныеСтроки.Вставить("ТоварыНоменклатура", <Строка>);
ДанныеСтроки.Вставить("ТипИзменения", <Строка>);
ДанныеСтроки.Вставить("НоваяЦена", <Строка>);
ДанныеСтроки.Вставить("НовоеНазвание", <Строка>);
ДанныеСтроки.Вставить("СтавкаНДС", <Строка>);
```

## Использование

### Вариант 1: Пользовательский макет из РС.ПользовательскиеМакетыПечати

1. Создайте пользовательский макет Word в РС.ПользовательскиеМакетыПечати:
   - **Объект**: `Документ.УстановкаЦенНоменклатуры`
   - **Имя макета**: `ПриказЕЛМА`
   - Установите флаг **Использование**: `Истина`
2. Настройте области макета ("Шапка" и "СтрокаТаблицы")
3. Добавьте теги параметров в нужные места макета
4. В форме документа УстановкаЦенНоменклатуры нажмите кнопку "Печать приказа ЕЛМА"
5. Система сформирует и откроет Word-документ с заполненными данными

### Вариант 2: Макет в метаданных (для расширений)

1. Добавьте макет `ПриказЕЛМА` в документ `УстановкаЦенНоменклатуры` в конфигураторе
2. Настройте области макета ("Шапка" и "СтрокаТаблицы")
3. Добавьте теги параметров в нужные места макета
4. В форме документа нажмите кнопку "Печать приказа ЕЛМА"
5. Система сформирует и откроет Word-документ с заполненными данными

## Особенности реализации

1. **Получение позиции меню**: Для каждой номенклатуры система пытается найти соответствующую позицию в справочнике `питМеню`. Если найдена, выводится позиция меню, иначе - номенклатура.

2. **Формат цены**: Цены выводятся с форматом "ЧЦ=15; ЧДЦ=2; ЧН=0,00" (15 знаков, 2 десятичных знака).

3. **Дата начала действия**: Берется из ранее сохраненных параметров приказа (из РС.MRS_ПроцессыELMA).

4. **Обработка ошибок**: При возникновении ошибок информация записывается в журнал регистрации с префиксом "MRS.ЕЛМА".

## Устранение ошибки "Макет не работает"

Если получаете ошибку "Макет печати не найден", проверьте:

1. **Правильность создания макета в РС.ПользовательскиеМакетыПечати**:
   - Объект должен быть строго: `Документ.УстановкаЦенНоменклатуры`
   - Имя макета должно быть: `ПриказЕЛМА`
   - Флаг "Использование" должен быть установлен в `Истина`
   - Макет должен быть в формате DOCX

2. **Наличие РС.ПользовательскиеМакетыПечати в конфигурации**:
   - Если регистр отсутствует (не все конфигурации БСП его включают), используйте вариант с макетом в метаданных

3. **Корректность структуры макета**:
   - В макете должны быть настроены области "Шапка" и "СтрокаТаблицы"
   - Области настраиваются в Word через вкладку "Вставка" → "Закладка"

## Дальнейшие доработки

Для полной функциональности требуется:

1. Заменить заглушки реальными данными:
   - `[Ссылка.Дата]` → реальная дата документа
   - `[Ссылка.Номер]` → реальный номер документа
   - `[TopicOfDecree]` → реальная тема приказа
   - `[ТочкаПродажи]` → реальная точка продажи из вида цены
   - `[НДС]` → реальная ставка НДС товара

2. Настроить макет Word (один из вариантов):
   - В РС.ПользовательскиеМакетыПечати, или
   - В метаданных документа УстановкаЦенНоменклатуры

3. Протестировать формирование на реальных данных

## Пример использования функций БСП

### Серверная часть (формирование документа)

```bsl
// Получение макета
МакетДвоичныеДанные = УправлениеПечатью.МакетПечатнойФормы(
    "Документ.УстановкаЦенНоменклатуры.ПриказЕЛМА");

// Инициализация макета
Макет = УправлениеПечатью.ИнициализироватьМакетОфисногоДокумента(
    МакетДвоичныеДанные, Неопределено);

// Инициализация печатной формы
ПечатнаяФорма = УправлениеПечатью.ИнициализироватьПечатнуюФорму(
    Неопределено, Неопределено, Макет);

// Заполнение шапки
УправлениеПечатью.ПрисоединитьОбластьИЗаполнитьПараметры(
    ПечатнаяФорма, ОбластьШапки, ДанныеШапки);

// Заполнение коллекции (табличной части)
УправлениеПечатью.ПрисоединитьИЗаполнитьКоллекцию(
    ПечатнаяФорма, ОбластьСтроки, МассивСтрок);

// Формирование файла во временное хранилище
Адрес = УправлениеПечатью.СформироватьДокумент(ПечатнаяФорма);
```

### Клиентская часть (открытие документа)

```bsl
// Вариант 1: Через БСП (предпочтительно)
ФайловаяСистемаКлиент.ОткрытьФайл(Адрес, , "ПриказЕЛМА.docx");

// Вариант 2: Стандартная функция 1С (для совместимости)
ПолучитьФайл(Адрес, "ПриказЕЛМА.docx", Истина);

// Реализованный код с обработкой ошибок:
Попытка
    ФайловаяСистемаКлиент.ОткрытьФайл(Адрес, , "ПриказЕЛМА.docx");
Исключение
    ПолучитьФайл(Адрес, "ПриказЕЛМА.docx", Истина);
КонецПопытки;
```

## Проверка кода

Код проверен инструментами:
- `read_lints` - ошибок не найдено
- `syntaxcheck` - замечаний по критичным ошибкам нет

Предупреждения линтера:
- Использование устаревшего метода `ПодробноеПредставлениеОшибки` (оставлено для совместимости)
- Дублирование строковых литералов (исправлено)

