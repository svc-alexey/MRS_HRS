# Отчет о реализации интеграции 1С:ERP ↔ Oracle Simphony POS

**Дата:** 30.10.2025  
**Версия:** 1.1  
**Статус:** Базовая логика реализована, архитектура оптимизирована

---

## 📝 Изменения в версии 1.1 (30.10.2025)

**Оптимизация архитектуры согласно замечаниям заказчика:**

1. ✅ **Убрано дублирование MajorGroup/FamilyGroup** - коды берутся из ГАУ номенклатуры через запрос
2. ✅ **Используется существующий реквизит `Префикс`** в плане обмена вместо нового КодSimphony
3. ✅ **URL сервиса** - используется константа `MRS_URLСервисаSimphony`, дублирование убрано
4. ✅ **hierStrucId vs RVC** - уточнена архитектура (hierStrucId=1, RVC из Префикса)
5. ✅ **Упрощены формы** - убраны избыточные поля M|F групп

**Готово к внедрению:** Архитектура согласована с заказчиком

---

## 📋 Что реализовано

### ✅ 1. Общие модули

#### 1.1. MRS_ИнтеграцияSimphonyСервер (Серверный модуль)

**Файл:** `CommonModules/MRS_ИнтеграцияSimphonyСервер/Ext/Module.bsl`

**Реализованные функции:**

**Регламентные процедуры:**
- ✅ `ОчиститьИсториюСинхронизации()` - очистка истории старше 30 дней
- ✅ `ВыполнитьАвтоматическуюВыгрузку()` - автоматическая выгрузка из очереди
- ✅ `СинхронизироватьСправочники()` - синхронизация RVC, Major/Family Groups

**Работа с позициями меню:**
- ✅ `ВыгрузитьПозициюВSimphony(Позиция, КассовыйУзел)` - выгрузка одной позиции
- ✅ `ВыгрузитьПакетПозиций(МассивПозиций, КассовыйУзел)` - пакетная выгрузка
- ✅ `СформироватьЗапросПозицииМеню(Позиция, КассовыйУзел)` - формирование JSON
- ✅ `ВалидироватьПозициюМеню(Позиция, КассовыйУзел)` - валидация перед выгрузкой

**Работа с очередью:**
- ✅ `ДобавитьВОчередьВыгрузки(Позиция, Операция, КассовыйУзел)`
- ✅ `ОбработатьОшибкуВыгрузки(Позиция, КассовыйУзел, КодОшибки, Сообщение)`
- ✅ `УдалитьИзОчереди(Позиция, КассовыйУзел)`

**Работа с API:**
- ✅ `ОтправитьЗапросAPI(Метод, Endpoint, ТелоJSON, Заголовки)` - HTTP запросы
- ✅ `ПарсироватьОтветJSON(HTTPОтвет)` - парсинг JSON ответов
- ✅ `СформироватьЗаголовки(ИмяПользователя, CorrelationId)` - HTTP заголовки

**Синхронизация справочников:**
- ✅ `СинхронизироватьRVCИерархию()` - синхронизация кассовых узлов
- ✅ `СинхронизироватьMajorGroups()` - синхронизация Major Groups
- ✅ `СинхронизироватьFamilyGroups()` - синхронизация Family Groups

**Вспомогательные функции:**
- ✅ `ПолучитьЦенуНоменклатуры(Номенклатура, КассовыйУзел)` - получение цены
- ✅ `ПолучитьКодSimphonyУзла(КассовыйУзел)` - получение hierStrucId
- ✅ `ЗаписатьВИсториюСинхронизации(...)` - запись в историю

---

#### 1.2. MRS_ИнтеграцияSimphonyКлиентСервер (Клиент-серверный модуль)

**Файл:** `CommonModules/MRS_ИнтеграцияSimphonyКлиентСервер/Ext/Module.bsl`

**Реализованные функции:**

**Валидация:**
- ✅ `ВалидироватьДиапазонMajorGroup(КодMajorGroup)` - проверка диапазона 1000000-4999999
- ✅ `ВалидироватьFamilyGroup(КодFamilyGroup)` - проверка > 0
- ✅ `СформироватьТекстОшибкиВалидации(МассивОшибок)` - форматирование ошибок

**Представления статусов:**
- ✅ `ПолучитьПредставлениеСтатуса(Статус)` - текстовое представление
- ✅ `ПолучитьЦветСтатуса(Статус)` - цвет для UI

**Работа с URL:**
- ✅ `РазобратьURL(URL)` - парсинг URL (протокол, сервер, порт, путь)

**Форматирование:**
- ✅ `ФорматироватьДлительность(ДлительностьМс)` - форматирование времени
- ✅ `ФорматироватьHTTPСтатус(HTTPСтатус)` - описание HTTP кодов

**Проверка прав:**
- ✅ `ЭтоАдминистратор()` - проверка прав администратора

---

#### 1.3. MRS_ИнтеграцияSimphonyКлиент (Клиентский модуль)

**Файл:** `CommonModules/MRS_ИнтеграцияSimphonyКлиент/Ext/Module.bsl`

**Реализованные функции:**

- ✅ `ОткрытьФормуИсторииСинхронизации(ПозицияМеню)` - открытие истории
- ✅ `ПоказатьСообщениеОбОшибке(ТекстОшибки)` - вывод ошибок
- ✅ `ОбновитьСтатусНаФорме(Форма)` - обновление UI
- ✅ `ПодтвердитьДействие(Текст, ОбработчикЗавершения)` - диалоги
- ✅ `ПоказатьИнформацию(Текст)` - уведомления

---

### ✅ 2. Модули объектов

#### 2.1. Справочник питМеню - Модуль объекта

**Файл:** `Catalogs/питМеню/Ext/ObjectModule.bsl`

**Реализованные обработчики:**
- ✅ `ПриЗаписи(Отказ)` - постановка в очередь при изменении (закомментирован до добавления реквизитов)
- ✅ `ПередУдалением(Отказ)` - постановка на удаление в Simphony (закомментирован)
- ✅ `ПолучитьКассовыйУзелДляПозиции()` - определение кассового узла

---

### ✅ 3. Команды справочника питМеню

#### 3.1. Команда "Управление очередью Simphony"

**Файл:** `Catalogs/питМеню/Commands/MRS_УправлениеОчередьюSimphony/Ext/CommandModule.bsl`

- ✅ Открывает форму `MRS_ФормаУправленияОчередью`

#### 3.2. Команда "Мониторинг синхронизации Simphony"

**Файл:** `Catalogs/питМеню/Commands/MRS_МониторингСинхронизацииSimphony/Ext/CommandModule.bsl`

- ✅ Открывает форму `MRS_ФормаМониторинга`

---

## ⚠️ Что требует доработки в конфигураторе

### 🔴 КРИТИЧНО: Добавление реквизитов

Без добавления реквизитов функциональность работать НЕ БУДЕТ!

#### 1. Справочник `питМеню`

Необходимо добавить следующие реквизиты:

| Имя реквизита | Тип | Длина/Разрядность | Обязательность |
|---------------|-----|-------------------|----------------|
| `КодSimphony` | Строка | 50 | Нет |
| `СтатусСинхронизацииSimphony` | ПеречислениеСсылка.MRS_СтатусыСинхронизацииSimphony | - | Нет |

**Примечание:** Коды `MajorGroup` и `FamilyGroup` берутся из ГАУ номенклатуры через запрос, дублирование не требуется.

**Инструкция:**
1. Открыть конфигуратор 1С
2. Перейти в Справочники → питМеню
3. Добавить реквизиты (правой кнопкой → Добавить → Реквизит)
4. Указать имя, тип и параметры согласно таблице
5. Сохранить изменения

---

#### 2. ПланОбмена `питУдаленныеКассы`

**Реквизиты уже существуют:**
- `ВидЦен` - используется для получения цены номенклатуры
- `Префикс` - используется как RVC код (код точки продаж) для Simphony

**Дополнительных реквизитов добавлять НЕ НУЖНО.**

**Важно:** Заполните реквизит `Префикс` для каждого кассового узла - это RVC код из Simphony.

---

#### 3. Справочник `ГруппыАналитическогоУчетаНоменклатуры`

Необходимо добавить дополнительные сведения (или реквизиты):

| Имя | Тип | Длина/Разрядность |
|-----|-----|-------------------|
| `MRS_КодMajorGroup` | Число | 10, 0 |
| `MRS_КодFamilyGroup` | Число | 10, 0 |

**Инструкция:**
1. Открыть конфигуратор 1С
2. Перейти в Справочники → ГруппыАналитическогоУчетаНоменклатуры
3. Добавить дополнительные сведения или реквизиты
4. Сохранить изменения

**Важно:** Эти коды должны соответствовать кодам в Simphony:
- **MajorGroup диапазоны:**
  - 1000000-1999999: FOOD (Еда)
  - 2000000-2999999: ALC (Алкоголь)
  - 3000000-3999999: N/ALC (Безалкогольные напитки)
  - 4000000-4999999: OTHER (Прочее)
- **FamilyGroup:** любое число > 0

---

### 🟡 РЕКОМЕНДУЕТСЯ: Доработка форм

Формы созданы, но требуют заполнения элементами управления:

#### 1. Форма элемента `питМеню.ФормаЭлемента`

Необходимо добавить:
- Поле `КодSimphony` (только для чтения)
- Поле `СтатусСинхронизацииSimphony` с цветовым индикатором
- Гиперссылку "История синхронизации"
- Кнопку "Выгрузить в Simphony" (для администраторов)

**Примечание:** Поля `MajorGroup` и `FamilyGroup` не нужны, так как они берутся из ГАУ номенклатуры.

#### 2. Форма списка `питМеню.ФормаСписка`

Необходимо добавить:
- Колонку `СтатусСинхронизацииSimphony` с условным оформлением
- Колонку `КодSimphony`
- Команду "Выгрузить выбранные в Simphony"
- Команду "Создать документ установки цен"
- Условное оформление:
  - 🟢 Выгружено - зеленый
  - 🟡 ВОчереди - желтый/оранжевый
  - 🟠 Ошибка - оранжевый
  - 🔴 ТребуетВнимания - красный

#### 3. Форма `MRS_ФормаМониторинга`

Форма создана, но пустая. Необходимо добавить:
- Декорации с метриками (Общее количество, Выгружено, В очереди, С ошибками)
- Таблицу топ-10 позиций с ошибками
- Кнопки управления (Обновить, Синхронизировать справочники)

#### 4. Форма `MRS_ФормаУправленияОчередью`

Форма создана, но пустая. Необходимо добавить:
- Таблицу очереди с колонками (Позиция, Узел, Операция, Статус, Попыток, Ошибка)
- Кнопки управления (Обновить, Очистить, Сбросить счетчик, Принудительная выгрузка)

---

### 🟢 ОПЦИОНАЛЬНО: Настройки

#### 1. Установка URL сервиса

Установить значение константы `MRS_URLСервисаSimphony`:
```
https://simphony-api.example.com/api/v1
```

#### 2. Настройка регламентных заданий

Три регламентных задания созданы, но требуют включения:

| Задание | Расписание | Статус |
|---------|-----------|--------|
| `MRS_ВыгрузкаМенюВSimphony` | Каждые 15 минут | Включить |
| `MRS_ОчисткаИсторииСинхронизацииSimphony` | Ежедневно в 03:00 | Включить |
| `MRS_СинхронизироватьСправочники` | Ежедневно в 02:00 | Включить |

**Инструкция:**
1. Открыть конфигуратор 1С
2. Перейти в Общие → Регламентные задания
3. Для каждого задания установить расписание и включить

---

## 📝 Инструкция по активации

### Шаг 1: Добавление реквизитов (ОБЯЗАТЕЛЬНО)

1. Добавить реквизиты в `питМеню`, `питУдаленныеКассы`, `ГруппыАналитическогоУчетаНоменклатуры`
2. Обновить конфигурацию БД
3. Снять комментарии в модуле объекта `питМеню` (файл `Catalogs/питМеню/Ext/ObjectModule.bsl`)

### Шаг 2: Настройка констант

1. Установить значение константы `MRS_URLСервисаSimphony`

### Шаг 3: Заполнение классификатора ГАУ

1. Открыть справочник `ГруппыАналитическогоУчетаНоменклатуры`
2. Для групп 1-го уровня заполнить `MRS_КодMajorGroup` (например, 1000001 для "Еда")
3. Для групп 2-го уровня заполнить `MRS_КодFamilyGroup` (например, 100 для "Горячие блюда")

### Шаг 4: Настройка кассовых узлов

1. Открыть план обмена `питУдаленныеКассы`
2. Для каждого узла заполнить `Префикс` (RVC код из Simphony - код точки продаж)
3. Проверить заполненность `ВидЦен`

**⚠️ ВАЖНО - Уточнение по hierStrucId и RVC:**
- **`hierStrucId`** в API запросе = **1** (константа, позиции создаются глобально)
- **`Префикс`** в плане обмена = **RVC код** (код точки продаж, например "001", "002")

**📌 Текущая архитектура API Simphony:**
- В API **пока НЕТ реквизита** для конкретной точки продажи (RVC)
- Позиции меню создаются **глобально** для всей системы Simphony
- `Префикс` (RVC код) подготовлен для **будущего использования**, когда функционал будет добавлен в API
- Функция `ПолучитьRVCКодУзла()` уже реализована и готова к использованию

### Шаг 5: Включение регламентных заданий

1. Включить и настроить расписание всех трех регламентных заданий

### Шаг 6: Доработка форм (рекомендуется)

1. Доработать формы согласно спецификации выше

## 📊 Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                     1С:ERP 2.5                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐      ┌────────────────────────────┐      │
│  │ питМеню      │      │  MRS_Интеграция            │      │
│  │ (позиции)    │─────▶│  SimphonyСервер            │      │
│  └──────────────┘      │  (бизнес-логика)           │      │
│                        └────────────────────────────┘      │
│           │                         │                       │
│           │                         │                       │
│           ▼                         ▼                       │
│  ┌──────────────┐      ┌────────────────────────────┐      │
│  │ Очередь      │      │  История                   │      │
│  │ выгрузки     │      │  синхронизации             │      │
│  └──────────────┘      └────────────────────────────┘      │
│                                                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ REST API (JSON)
                           │ PUT /menu-item
                           │ POST /menu-items
                           │ DELETE /menu-item
                           │
┌──────────────────────────▼──────────────────────────────────┐
│                 Oracle Simphony POS                         │
│                                                             │
│  ┌──────────────┐      ┌────────────────────────────┐      │
│  │ Menu Items   │      │  Major/Family Groups       │      │
│  │ (MENU_ITEM_  │      │  (справочники)             │      │
│  │  MASTER)     │      │                            │      │
│  └──────────────┘      └────────────────────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 Техническая информация

### Используемые технологии

- 1С:Предприятие 8.3.24
- REST API (HTTP/HTTPS)
- JSON для обмена данными
- Регламентные задания для фоновой обработки

### Структура данных

**Основные объекты:**
- `питМеню` - позиции меню
- `питУдаленныеКассы` - кассовые узлы
- `ГруппыАналитическогоУчетаНоменклатуры` - классификатор с кодами Simphony
- `MRS_ОчередьВыгрузкиМенюSimphony` - очередь операций
- `MRS_ИсторияСинхронизацииМенюSimphony` - история всех операций
- `MRS_СтатусыСинхронизацииSimphony` - перечисление статусов

---

## ✅ Чек-лист готовности

### Обязательные пункты

- [ ] Добавлены реквизиты в `питМеню`
- [ ] Добавлены реквизиты в `питУдаленныеКассы`
- [ ] Добавлены реквизиты в `ГруппыАналитическогоУчетаНоменклатуры`
- [ ] Заполнены коды MajorGroup/FamilyGroup в ГАУ
- [ ] Заполнены КодSimphony в кассовых узлах
- [ ] Установлен URL сервиса Simphony
- [ ] Включены регламентные задания
- [ ] Сняты комментарии в модуле объекта `питМеню`

### Рекомендуемые пункты

- [ ] Доработаны формы элемента и списка `питМеню`
- [ ] Реализована форма мониторинга
- [ ] Реализована форма управления очередью
- [ ] Проведено тестирование ручной выгрузки
- [ ] Проведено тестирование автоматической выгрузки
- [ ] Проверена обработка ошибок

---

**Дата создания отчета:** 29.10.2025  
**Версия:** 1.0  
**Разработчик:** AI Assistant (Senior 1C Developer)

