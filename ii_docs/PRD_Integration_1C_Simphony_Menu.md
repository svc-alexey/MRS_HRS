# PRD: Интеграция управления меню 1С:ERP 2.5 ↔ Oracle Simphony POS

**Версия документа:** 1.0  
**Дата:** 29.10.2025  
**Автор:** Product Manager  
**Статус:** Draft → Review

---

## Title

Автоматизированная синхронизация меню точек продаж между системой управления ресторанным бизнесом (1С:ERP 2.5, модуль Общепит) и фронт-офисной POS-системой Oracle Simphony через REST API с контролем статусов и механизмом повторных попыток.

---

## Context & Goals

### Проблема

**Текущая ситуация (AS-IS):**
- Меню точек продаж управляется вручную в двух системах (1С и Simphony)
- Отсутствует автоматическая синхронизация позиций меню, цен и классификаторов
- Нет контроля статусов выгрузки и механизма обработки ошибок
- Существующий справочник питМеню не адаптирован под требования REST API
- Высокий риск расхождения данных между системами (data inconsistency)
- Затраты времени персонала на дублирование операций

**Бизнес-контекст:**
- Система: 1С:ERP 2.5 (конфигурация "Управление предприятием общественного питания")
- Фронт-система: Oracle Simphony POS (кассовые терминалы)
- Метод интеграции: REST API (OpenAPI 3.0 спецификация предоставлена)
- Направление данных: Двустороннее (Master Data from ERP → Simphony, статусы обратно)

### Цели (Objectives)

1. **Исключить ручной ввод данных** меню в Simphony — 100% позиций создаются из 1С
2. **Обеспечить консистентность данных** across всех точек продаж (до 50 кассовых узлов)
3. **Контролировать статусы синхронизации** в режиме реального времени с историей операций
4. **Автоматизировать выгрузку** по расписанию с механизмом повторных попыток при ошибках
5. **Сократить время создания позиции** с 10 минут (ручной ввод в 2 системы) до 2 минут (только 1С + авто-выгрузка)

### Non-Goals / Out of Scope

- ❌ Синхронизация транзакций продаж (чеков) — выполняется существующим механизмом планов обмена
- ❌ Управление рецептурами и калькуляциями блюд — остается в типовом функционале 1С
- ❌ Интеграция с системой лояльности или складским учетом
- ❌ Разработка мобильного приложения для управления меню
- ❌ Изменение ядра типовой конфигурации 1С (только расширение/дополнение)

---

## Core Functions

### Основные функции системы

1. **Создание позиций меню** с автоматическим заполнением Major/Family Groups из классификатора ГАУ
2. **Выгрузка меню в Simphony** (ручной и автоматический режимы) через REST API
3. **Отслеживание статусов синхронизации** (НеВыгружено → ВОчереди → Выгружено / Ошибка)
4. **Механизм повторных попыток** при сбоях API (до 3 попыток с интервалом 5 мин)
5. **Логирование операций** в регистр сведений с хранением истории 30 дней
6. **Валидация данных** перед отправкой (проверка Major/Family Group, цен, привязок)
7. **Пакетная обработка** через очередь выгрузки (до 50 позиций за запрос)
8. **Обновление и удаление позиций** с синхронизацией изменений в Simphony

---

## Flows (Text-Only)

### Flow 1: Создание новой позиции меню (UC-01)

**Актор:** Менеджер меню (роль MRS_ОсновнаяРоль)  
**Предусловия:** 
- Созданы вид меню (питВидыМеню) и кассовый узел (питУдаленныеКассы)
- Номенклатура имеет заполненный классификатор ГАУ с доп. сведениями MRS_КодMajorGroup, MRS_КодFamilyGroup
- Установлены цены в регистре сведений ЦеныНоменклатуры для вида цен кассового узла

**Основной поток:**

1. Пользователь открывает список справочника **питМеню**
2. Устанавливает отбор по виду меню (реквизит ВидМеню типа СправочникСсылка.питВидыМеню)
3. Нажимает кнопку "Создать" → открывается форма элемента
4. **Заполняет обязательные поля:**
   - Наименование (строка, 255 символов) — копируется из выбранной номенклатуры
   - Номенклатура (СправочникСсылка.Номенклатура) — подбор из справочника
   - ВидМеню (СправочникСсылка.питВидыМеню) — указывается пользователем
   - НомерВГруппе (число, 3) — порядковый номер для отображения в меню (fileNum)
   - Выключен (Булево) — по умолчанию Ложь (позиция видима)
5. **Система автоматически устанавливает:**
   - СтатусСинхронизацииSimphony ← "НеВыгружено"
6. Пользователь сохраняет элемент (Ctrl+S)
7. **Система выполняет валидацию:**
   - Проверка наличия номенклатуры (обязательное поле)
   - Проверка наличия вида меню (обязательное поле)

**Примечание:** Major/Family Group и цена валидируются непосредственно при выгрузке в Simphony через запрос к ГАУ и регистру цен.
8. **При успешной валидации:**
   - Запись сохраняется в справочнике питМеню
   - Создается запись в регистре сведений **ОчередьВыгрузкиМенюSimphony** с операцией "CREATE"
   - Устанавливается СтатусСинхронизацииSimphony = "ВОчереди"
9. Пользователь видит обновленный статус на форме

**Постусловия:** Позиция создана в ERP, поставлена в очередь на выгрузку

**Альтернативный поток 1A: Ошибка валидации**
- Шаг 7: Валидация не пройдена → выводится сообщение об ошибке
- Запись не сохраняется, пользователь возвращается к редактированию

---

### Flow 2: Ручная выгрузка позиций в Simphony

**Актор:** Администратор (проверка роли при нажатии кнопки)  
**Предусловия:** В списке питМеню есть позиции со статусом "НеВыгружено" или "Ошибка"

**Основной поток:**

1. Пользователь открывает форму списка справочника питМеню
2. Выделяет одну или несколько позиций (Ctrl+Click)
3. Нажимает кнопку **"Выгрузить в Simphony"** (доступна только администраторам)
4. **Система формирует запрос к REST API:**
   - Endpoint: `PUT /menu-item` (для одной позиции) или `POST /menu-items` (для bulk-операции)
   - Заголовки: X-Correlation-Id (новый UUID), X-Request-Id (новый UUID), X-User-Id (имя пользователя 1С)
   - Тело запроса (JSON):
     ```
     {
       "name": "Наименование из питМеню",
       "stringNumberId": <уникальный код позиции>,
       "majGrpObjNum": <MajorGroup из ГАУ>,
       "famGrpObjNum": <FamilyGroup из ГАУ>,
       "isVisible": 1,
       "hierStrucId": <ID кассового узла>,
       "menuItemClass": <класс меню>,
       "price": <цена из регистра ЦеныНоменклатуры>,
       "fileNum": <порядковый номер>
     }
     ```
5. **Ожидание ответа от API (timeout 30 сек):**
   - HTTP 200 → успешно создано
   - HTTP 400 → ошибка валидации (код 100001 = stringNumberId не уникален, код 100002 = некорректный MajorGroup)
   - HTTP 500 → внутренняя ошибка сервера
6. **Обработка ответа:**
   - При успехе (HTTP 200):
     * Парсинг JSON ответа: `{"name": "...", "stringNumberId": 14, "created": "2024-03-15T10:30:00Z", "success": true}`
     * Сохранение КодSimphony (stringNumberId) в реквизит справочника
     * Установка статуса СтатусСинхронизацииSimphony = "Выгружено"
     * Запись в регистр сведений **ИсторияСинхронизацииМенюSimphony** (измерения: ПозицияМеню, ДатаВремя; ресурсы: Операция="CREATE", Статус="Успешно", КодОтвета=200, Сообщение="OK", Пользователь)
   - При ошибке (HTTP 400/500):
     * Установка статуса СтатусСинхронизацииSimphony = "Ошибка"
     * Запись в регистр истории с Статус="Ошибка", сообщением из API
     * Увеличение счетчика попыток в регистре очереди
7. Форма списка обновляется, отображается новый статус

**Постусловия:** Позиции выгружены в Simphony, статусы обновлены, записи в регистрах созданы

**Альтернативный поток 2A: Таймаут API (нет ответа 30 сек)**
- Шаг 5: Timeout → установка статуса "Ошибка"
- Запись в регистр истории с сообщением "Connection timeout"
- Позиция остается в очереди для повторной попытки

**Альтернативный поток 2B: Bulk-выгрузка (более 1 позиции)**
- Шаг 4: Используется endpoint `POST /menu-items` с массивом items
- Шаг 6: Обработка каждого элемента массива ответа `created_items[]` индивидуально

---

### Flow 3: Автоматическая выгрузка по расписанию

**Актор:** Регламентное задание "Выгрузка меню в Simphony" (фоновое задание)  
**Расписание:** Каждые 15 минут (настраивается в константе/параметре)

**Основной поток:**

1. Регламентное задание запускается по расписанию
2. **Выборка позиций из очереди:**
   - Запрос к регистру сведений ОчередьВыгрузкиМенюSimphony
   - Отбор: Статус = "ВОчереди" ИЛИ (Статус = "Ошибка" И КоличествоПопыток < 3)
   - Сортировка: ДатаПостановкиВОчередь (старые первыми)
   - Ограничение: до 50 записей за сеанс
3. **Группировка по кассовым узлам** (hierStrucId) для bulk-запросов
4. Для каждой группы:
   - Формирование bulk-запроса `POST /menu-items` с общим hierStrucId
   - Отправка запроса к API (логика аналогична Flow 2, шаги 4-6)
5. **Обработка результатов:**
   - Обновление статусов в справочнике питМеню
   - Запись в регистр ИсторияСинхронизацииМенюSimphony
   - Обновление/удаление записей в регистре ОчередьВыгрузкиМенюSimphony
6. **Механизм повторных попыток:**
   - При ошибке: КоличествоПопыток += 1, СледующаяПопытка = ТекущаяДата() + 5 минут
   - Если КоличествоПопыток >= 3 → статус "ТребуетВнимания", отправка уведомления администратору
7. Логирование результатов работы задания в журнал регистрации 1С

**Постусловия:** Очередь обработана, статусы обновлены, при критичных ошибках отправлены уведомления

---

### Flow 4: Изменение позиции меню (UC-02)

**Актор:** Менеджер меню  
**Предусловия:** Позиция существует в питМеню со статусом "Выгружено"

**Основной поток:**

1. Пользователь открывает элемент справочника питМеню
2. Редактирует поля: Наименование, Цена (через документ УстановкаЦенНоменклатуры), Активность, MajorGroup/FamilyGroup
3. Сохраняет изменения (Ctrl+S)
4. **Система определяет тип операции:**
   - Если КодSimphony заполнен → операция UPDATE
   - Если КодSimphony пуст → операция CREATE (как Flow 1)
5. **При операции UPDATE:**
   - Создается запись в регистре ОчередьВыгрузкиМенюSimphony с Операция="UPDATE"
   - Устанавливается СтатусСинхронизацииSimphony = "ВОчереди"
6. Регламентное задание или ручная выгрузка отправляет запрос к API:
   - Endpoint: `PUT /menu-item` с обновленными данными
   - Тело запроса содержит все поля (включая неизмененные)
7. Обработка ответа аналогично Flow 2

**Постусловия:** Изменения синхронизированы с Simphony

---

### Flow 5: Удаление позиции меню (UC-03)

**Актор:** Администратор  
**Предусловия:** Позиция существует в питМеню и в Simphony (КодSimphony заполнен)

**Основной поток:**

1. Пользователь помечает элемент на удаление (кнопка "Пометить на удаление")
2. **Система создает запись в очереди:**
   - Регистр ОчередьВыгрузкиМенюSimphony: Операция="DELETE", Статус="ВОчереди"
3. Регламентное задание обрабатывает очередь:
   - Endpoint: `DELETE /menu-item/{stringNumberId}`
   - Параметр пути: КодSimphony из справочника
4. **При успешном ответе (HTTP 200):**
   - Полное удаление записи из справочника питМеню (снятие пометки + физическое удаление)
   - Удаление связанных записей из регистров
5. **При ошибке:**
   - Запись остается с пометкой на удаление
   - Статус "ТребуетВнимания"
   - Запись в регистр истории

**Постусловия:** Позиция удалена из обеих систем

**Альтернативный поток 5A: Удаление невыгруженной позиции**
- Шаг 1: КодSimphony пуст (позиция не выгружалась)
- Физическое удаление из 1С без обращения к API

---

### Flow 6: Формирование документа "Установка цен номенклатуры"

**Актор:** Менеджер меню  
**Предусловия:** Выбраны позиции в списке питМеню

**Основной поток:**

1. Пользователь выделяет позиции в списке питМеню
2. Нажимает кнопку **"Создать документ установки цен"** (новая команда формы)
3. **Система создает документ УстановкаЦенНоменклатуры:**
   - Заполняет табличную часть "Товары" выбранными позициями номенклатуры
   - Автоматически подставляет ВидЦен из плана обмена питУдаленныеКассы (существующий реквизит ВидЦен)
   - Устанавливает текущую дату документа
4. Открывается форма документа для редактирования цен
5. Пользователь корректирует цены (если нужно), проводит документ
6. Документ записывает цены в регистр сведений ЦеныНоменклатуры
7. **При изменении цен уже выгруженных позиций:**
   - Автоматически создаются записи в ОчередьВыгрузкиМенюSimphony с операцией UPDATE
   - Статус позиций меняется на "ВОчереди"

**Постусловия:** Цены установлены, изменения поставлены в очередь на синхронизацию

---

### Flow 7: Получение справочных данных из Simphony

**Актор:** Система (фоновая задача, выполняется при инициализации)  
**Периодичность:** Ежедневно в 02:00

**Основной поток:**

1. Регламентное задание "Синхронизация справочников Simphony" запускается
2. **Запрос иерархии RVC (точек продаж):**
   - Endpoint: `GET /referencedata/rvc-hierarchy`
   - Ответ: массив `[{rvc_id, hierunitid, rvc_name}]`
   - Обновление справочника питУдаленныеКассы (сопоставление по hierunitid)
3. **Запрос Major Groups:**
   - Endpoint: `GET /referencedata/major-groups`
   - Ответ: массив `[{object_number, name}]`
   - Проверка соответствия с ГАУ первого уровня (доп. сведение MRS_КодMajorGroup)
   - При расхождении: запись в журнал с предупреждением
4. **Запрос Family Groups:**
   - Endpoint: `GET /referencedata/family-groups`
   - Ответ: массив `[{object_number, name}]`
   - Проверка соответствия с ГАУ второго уровня (доп. сведение MRS_КодFamilyGroup)
5. Логирование результатов синхронизации

**Постусловия:** Справочники актуализированы, расхождения зафиксированы

---

## Data & Integrations

### Основные сущности 1С

#### 1. Справочник: питМеню (Menu Items)

**Назначение:** Хранение позиций меню точек продаж

**Ключевые реквизиты:**

| Реквизит | Тип | Описание | Обязательность |
|----------|-----|----------|----------------|
| Наименование | Строка(255) | Название позиции меню | Да |
| Номенклатура | СправочникСсылка.Номенклатура | Связь с товаром/услугой | Да |
| ВидМеню | СправочникСсылка.питВидыМеню | Тип меню (основное/временное) | Да |
| MajorGroup | Число(10,0) | Код основной группы Simphony (получается запросом из ГАУ) | Да |
| FamilyGroup | Число(10,0) | Код семейной группы Simphony (получается запросом из ГАУ) | Да |
| КодSimphony | Строка(50) | Внешний ID в Simphony (stringNumberId) | Нет |
| СтатусСинхронизацииSimphony | ПеречислениеСсылка.СтатусыСинхронизацииSimphony | Текущий статус | Да |
| НомерВГруппе | Число(3,0) | fileNum для отображения в меню (существующий типовой реквизит) | Нет |
| Выключен | Булево | Видимость позиции инвертированная (Истина = скрыт, существующий типовой реквизит) | Да |

**Иерархия:** Группы (по видам меню)

---

#### 2. Справочник: питВидыМеню (Menu Types)

**Назначение:** Виды меню (завтрак, обед, ужин, банкет, сезонное)

**Ключевые реквизиты:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Наименование | Строка(150) | Название вида меню |
| Код | Строка(10) | Краткий код |

**Примечание:** Используется типовой функционал без доработок. Привязка к кассовым узлам и видам цен осуществляется через реквизит ВидЦен в плане обмена питУдаленныеКассы.

---

#### 3. ПланОбмена: питУдаленныеКассы (POS Outlets)

**Назначение:** Кассовые узлы (точки продаж) — узлы плана обмена

**Ключевые реквизиты:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Наименование | Строка(150) | Название кассы/точки |
| ВидЦен | СправочникСсылка.ВидыЦен | Вид цен для узла (существующий типовой реквизит) |
| ТипКассыККМ | ПеречислениеСсылка.ТипыКассККМ | Тип оборудования (существующий типовой реквизит) |

**Новые реквизиты (добавить):**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| КодSimphony | Число(10,0) | hierStrucId (ID аутлета в Simphony) |
| URLСервиса | Строка(255) | Endpoint REST API (опционально) |

---

#### 4. Справочник: ГруппыАналитическогоУчетаНоменклатуры (ГАУ)

**Назначение:** Классификатор номенклатуры (иерархический)

**Дополнительные сведения (реквизиты MRS):**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| MRS_КодMajorGroup | Число(10,0) | Маппинг на Major Group Simphony (диапазоны: 1000000-1999999 FOOD, 2000000-2999999 ALC, 3000000-3999999 N/ALC, 4000000+ OTHER) |
| MRS_КодFamilyGroup | Число(10,0) | Маппинг на Family Group Simphony |

**Иерархия:** 
- Уровень 1 (родитель пустой) → Major Group (например, "Еда", "Алкоголь", "Напитки")
- Уровень 2 (родитель = уровень 1) → Family Group (например, "Горячие блюда", "Холодные закуски")

---

#### 5. РегистрСведений: ОчередьВыгрузкиМенюSimphony (Sync Queue)

**Периодичность:** Непериодический  
**Режим записи:** Независимый

**Измерения:**

| Измерение | Тип | Описание |
|-----------|-----|----------|
| ПозицияМеню | СправочникСсылка.питМеню | Ссылка на позицию |
| КассовыйУзел | СправочникСсылка.питУдаленныеКассы | Целевая точка продаж |

**Ресурсы:**

| Ресурс | Тип | Описание |
|--------|-----|----------|
| Операция | Строка(10) | CREATE / UPDATE / DELETE |
| Статус | Строка(20) | ВОчереди / ВПроцессе / Завершено / Ошибка |
| ДатаПостановкиВОчередь | ДатаВремя | Timestamp создания записи |
| КоличествоПопыток | Число(2,0) | Счетчик попыток выгрузки (0-3) |
| СледующаяПопытка | ДатаВремя | Планируемое время повторной попытки |
| ТекстОшибки | Строка(500) | Последнее сообщение об ошибке |

---

#### 6. РегистрСведений: ИсторияСинхронизацииМенюSimphony (Sync History Log)

**Периодичность:** Непериодический  
**Режим записи:** Независимый

**Измерения:**

| Измерение | Тип | Описание |
|-----------|-----|----------|
| ПозицияМеню | СправочникСсылка.питМеню | Ссылка на позицию |
| ДатаВремя | ДатаВремя | Timestamp операции |
| УникальныйИдентификатор | Строка(36) | X-Correlation-Id запроса |

**Ресурсы:**

| Ресурс | Тип | Описание |
|--------|-----|----------|
| Операция | Строка(10) | CREATE / UPDATE / DELETE / GET |
| Статус | Строка(20) | Успешно / Ошибка / Таймаут |
| HTTPСтатус | Число(3,0) | Код ответа HTTP (200, 400, 500...) |
| Сообщение | Строка(1000) | Текст ответа/ошибки от API |
| Пользователь | СправочникСсылка.Пользователи | Инициатор операции |
| ДлительностьМс | Число(10,0) | Время выполнения запроса (мс) |

**Индексы:** ПозицияМеню, ДатаВремя (для быстрой выборки истории)

---

#### 7. Перечисление: СтатусыСинхронизацииSimphony

**Значения:**

| Значение | Описание | Визуализация |
|----------|----------|--------------|
| НеВыгружено | Позиция создана, но не отправлена в Simphony | 🔵 Синий |
| ВОчереди | Поставлена в очередь на выгрузку | 🟡 Желтый |
| Выгружено | Успешно синхронизировано | 🟢 Зеленый |
| Ошибка | Ошибка при выгрузке (есть попытки) | 🟠 Оранжевый |
| ТребуетВнимания | Критическая ошибка (3 неудачные попытки) | 🔴 Красный |

---

### Маппинг данных: 1С ↔ Simphony API

#### Endpoint: PUT /menu-item (Create Single Item)

**Направление:** 1С → Simphony

| Поле API (JSON) | Источник 1С | Тип | Валидация |
|-----------------|-------------|-----|-----------|
| `name` | питМеню.Наименование | string(255) | Обязательное, не пустое |
| `stringNumberId` | питМеню.КодSimphony | integer | Уникальное, > 0 |
| `majGrpObjNum` | Запрос: Номенклатура.ГАУ.Родитель.MRS_КодMajorGroup | integer | Диапазоны: 1000000-4999999 |
| `famGrpObjNum` | Запрос: Номенклатура.ГАУ.MRS_КодFamilyGroup | integer | > 0, существует в справочнике |
| `isVisible` | НЕ питМеню.Выключен | integer (0/1) | Инвертирование: 0 если Выключен=Истина, иначе 1 |
| `hierStrucId` | питУдаленныеКассы.КодSimphony | integer | > 0, узел должен существовать |
| `menuItemClass` | Константа | integer | По умолчанию 1001 |
| `price` | Запрос: ЦеныНоменклатуры.Цена по ВидЦен из питУдаленныеКассы.ВидЦен | number(double) | ≥ 0, для вида цен узла |
| `fileNum` | питМеню.НомерВГруппе | integer | ≥ 1, порядок в меню |

**Заголовки (Headers):**

| Заголовок | Источник 1С | Формат |
|-----------|-------------|--------|
| `X-User-Id` | ПараметрыСеанса.ТекущийПользователь | string |
| `X-Correlation-Id` | Новый UUID (НоваяУникальныйИдентификатор()) | uuid |
| `X-Request-Id` | Новый UUID (НоваяУникальныйИдентификатор()) | uuid |

**Ответ API → 1С:**

```json
{
  "name": "Пицца Маргарита",
  "stringNumberId": 14,
  "majGrpObjNum": 1000001,
  "famGrpObjNum": 100,
  "isVisible": 1,
  "hierStrucId": 3,
  "menuItemClass": 1001,
  "price": 350.00,
  "fileNum": 10,
  "created": "2024-03-15T10:30:00Z",
  "success": true
}
```

**Обработка в 1С:**
- Сохранить `stringNumberId` в питМеню.КодSimphony
- Установить СтатусСинхронизацииSimphony = "Выгружено"
- Записать в ИсторияСинхронизацииМенюSimphony (HTTPСтатус=200, Статус="Успешно")

---

#### Endpoint: POST /menu-items (Bulk Create)

**Направление:** 1С → Simphony (пакетная выгрузка)

**Тело запроса:**

```json
{
  "hierStrucId": 3,
  "items": [
    {
      "name": "Пицца Пепперони",
      "stringNumberId": 17,
      "majGrpObjNum": 1000001,
      "famGrpObjNum": 100,
      "isVisible": 1,
      "menuItemClass": 1001,
      "price": 400.00,
      "fileNum": 11
    },
    {
      "name": "Салат Цезарь",
      "stringNumberId": 18,
      "majGrpObjNum": 1000002,
      "famGrpObjNum": 101,
      "isVisible": 1,
      "menuItemClass": 1001,
      "price": 250.00,
      "fileNum": 12
    }
  ]
}
```

**Обработка ответа:**
- Парсинг массива `created_items[]`
- Обновление статусов индивидуально для каждой позиции (по `stringNumberId`)

---

#### Endpoint: GET /referencedata/rvc-hierarchy

**Направление:** Simphony → 1С (загрузка справочников)

**Ответ API:**

```json
{
  "data": [
    {
      "rvc_id": "001.001",
      "hierunitid": 3,
      "rvc_name": "Ресторан Терраса"
    }
  ],
  "total_count": 1,
  "success": true
}
```

**Обработка в 1С:**
- Поиск записи в питУдаленныеКассы по КодSimphony = hierunitid
- Обновление наименования (если изменилось)
- Создание новых записей при необходимости

---

#### Endpoint: DELETE /menu-item/{stringNumberId}

**Направление:** 1С → Simphony

**Параметр пути:** `stringNumberId` = питМеню.КодSimphony

**Ответ API:**

```json
{
  "success": true
}
```

**Обработка в 1С:**
- При `success: true` → полное удаление записи из питМеню
- При ошибке → сохранение пометки на удаление, статус "ТребуетВнимания"

---

### Обработка ошибок API

#### Таблица кодов ошибок

| HTTP Code | API Code | Описание | Действие 1С |
|-----------|----------|----------|-------------|
| 400 | 10000 | Invalid input parameters | Запись в лог, статус "Ошибка", не повторять |
| 400 | 100001 | StringNumberId already exists | Генерация нового stringNumberId, повтор |
| 400 | 100002 | MajGrpObjNum invalid range | Проверка ГАУ, статус "ТребуетВнимания" |
| 400 | 10003 | Missing headers | Исправление заголовков, повтор |
| 404 | 404 | Route not found | Проверка URL, статус "Ошибка" |
| 500 | 5050 | Internal server error | Повторная попытка (до 3 раз) |
| Timeout | - | Connection timeout (30s) | Повторная попытка (до 3 раз) |

**Структура ошибки API (CommonFault):**

```json
{
  "code": 100001,
  "message": "StringNumberId already exists",
  "service": "hrs-simphony-sync",
  "operation": "CreateMenuItem",
  "product": "HRS",
  "cause": {
    "error_type": "DUPLICATE_KEY",
    "details": "..."
  }
}
```

---

### Внешние системы и зависимости

1. **REST API сервис hrs-simphony-sync**
   - URL: https://<host>/api/v1/ (настраивается в константе)
   - Аутентификация: [уточнить метод — Basic Auth / API Key / OAuth2]
   - Rate Limiting: [уточнить лимиты — например, 100 req/min]

2. **База данных Oracle Simphony**
   - Доступ через API (прямое подключение к БД не используется)
   - Таблицы Simphony: MENU_ITEM_MASTER, MAJOR_GROUP, FAMILY_GROUP, HIER_UNIT

3. **Регистр сведений ЦеныНоменклатуры (типовой)**
   - Источник цен для выгрузки
   - Периодический регистр (срезы последних)

---

## Metadata (1С Objects)

### Новые объекты (создать)

#### 1. РегистрСведений.ОчередьВыгрузкиМенюSimphony
```
Измерения:
  - ПозицияМеню: СправочникСсылка.питМеню
  - КассовыйУзел: СправочникСсылка.питУдаленныеКассы
Ресурсы:
  - Операция: Строка(10)
  - Статус: Строка(20)
  - ДатаПостановкиВОчередь: ДатаВремя
  - КоличествоПопыток: Число(2,0)
  - СледующаяПопытка: ДатаВремя
  - ТекстОшибки: Строка(500)
```

#### 2. РегистрСведений.ИсторияСинхронизацииМенюSimphony
```
Измерения:
  - ПозицияМеню: СправочникСсылка.питМеню
  - ДатаВремя: ДатаВремя
  - УникальныйИдентификатор: Строка(36)
Ресурсы:
  - Операция: Строка(10)
  - Статус: Строка(20)
  - HTTPСтатус: Число(3,0)
  - Сообщение: Строка(1000)
  - Пользователь: СправочникСсылка.Пользователи
  - ДлительностьМс: Число(10,0)
```

#### 3. Перечисление.СтатусыСинхронизацииSimphony
```
Значения:
  - НеВыгружено
  - ВОчереди
  - Выгружено
  - Ошибка
  - ТребуетВнимания
```

#### 4. Обработка.ВыгрузкаМенюВSimphony
```
Реквизиты:
  - URLСервиса: Строка(255)
  - Таймаут: Число(10,0) // секунды
  - РежимОтладки: Булево
Команды:
  - ВыгрузитьВыбранныеПозиции
  - ПроверитьСоединение (healthCheck)
Модуль: 
  - Функция ОтправитьЗапросAPI(Метод, Endpoint, ТелоJSON, Заголовки)
  - Функция ПарсироватьОтветJSON(HTTPОтвет)
  - Процедура ОбработатьОшибкуAPI(КодОшибки, Сообщение, Позиция)
```

#### 5. РегламентноеЗадание.ВыгрузкаМенюВSimphony
```
Параметры:
  - РасписаниеВыполнения: Расписание (каждые 15 мин)
  - КоличествоПозицийЗаСеанс: Число(10,0) = 50
Метод: ОбработкаВыгрузкаМенюВSimphony.ВыполнитьАвтоматическуюВыгрузку()
```

#### 6. РегламентноеЗадание.СинхронизацияСправочниковSimphony
```
Параметры:
  - РасписаниеВыполнения: Расписание (ежедневно 02:00)
Метод: ОбработкаВыгрузкаМенюВSimphony.СинхронизироватьСправочники()
```

#### 7. Константа.URLСервисаSimphony
```
Тип: Строка(255)
Значение по умолчанию: https://simphony-api.example.com/api/v1
```

**Примечание:** Таймаут HTTP-запросов (30 секунд) задается непосредственно в коде метода `ОтправитьЗапросAPI()`, константа не требуется.

---

### Изменения существующих объектов (доработать)

#### 1. Справочник.питМеню
**Добавить реквизиты:**
```
- MajorGroup: Число(10,0) — заполняется запросом при выгрузке из ГАУ
- FamilyGroup: Число(10,0) — заполняется запросом при выгрузке из ГАУ
- КодSimphony: Строка(50)
- СтатусСинхронизацииSimphony: ПеречислениеСсылка.СтатусыСинхронизацииSimphony
```

**Существующие типовые реквизиты (используются без изменений):**
```
- НомерВГруппе: Число(3,0) — fileNum для отображения в меню
- Выключен: Булево — видимость позиции (инвертированная логика)
```

**Модуль объекта:**
```bsl
// ПриЗаписи
// Постановка в очередь выгрузки
Если Модифицированность() Тогда
    ОпределитьТипОперации(); // CREATE или UPDATE
    ДобавитьВОчередьВыгрузки(Ссылка, Операция);
КонецЕсли;
```

**Примечание:** Major/Family Group получаются запросом при формировании JSON для отправки в Simphony:
```bsl
ВЫБРАТЬ
    питМеню.Номенклатура.ГруппаАналитическогоУчета.Родитель.MRS_КодMajorGroup КАК MajorGroup,
    питМеню.Номенклатура.ГруппаАналитическогоУчета.MRS_КодFamilyGroup КАК FamilyGroup
ИЗ
    Справочник.питМеню КАК питМеню
ГДЕ
    питМеню.Ссылка = &Ссылка
```

**Форма элемента (ФормаЭлемента):**
```
Добавить поля:
  - ДекорацияСтатусаSimphony (поле с картинкой статуса)
  - ГиперссылкаИсторияСинхронизации (открывает регистр истории)
  
Добавить команды:
  - ВыгрузитьВSimphony (кнопка, доступна администраторам)
  - ОбновитьСтатус (обновление текущего статуса)
```

**Форма списка (ФормаСписка):**
```
Добавить колонку:
  - СтатусСинхронизацииSimphony (с условным оформлением по цветам)
  
Добавить команды:
  - ВыгрузитьВыбранные (групповая выгрузка)
  - ОчиститьОчередь (очистка ошибочных записей)
  - ИсторияСинхронизации (открытие регистра для выбранных)
```

---

#### 2. Справочник.питВидыМеню
**Изменения не требуются** — используется типовой функционал

---

#### 3. ПланОбмена.питУдаленныеКассы

**Существующие реквизиты (используются):**
```
- ВидЦен: СправочникСсылка.ВидыЦен — используется для получения цены при выгрузке
```

**Добавить реквизиты:**
```
- КодSimphony: Число(10,0) // hierStrucId (ID аутлета в Simphony)
- URLСервиса: Строка(255) // endpoint API (опционально, если разные для узлов)
```

---

#### 4. Справочник.ГруппыАналитическогоУчетаНоменклатуры
**Добавить дополнительные сведения (через механизм доп. реквизитов или прямые реквизиты):**
```
- MRS_КодMajorGroup: Число(10,0)
- MRS_КодFamilyGroup: Число(10,0)
```

**Форма элемента:**
```
Добавить поля для ввода кодов Simphony
Добавить валидацию диапазонов:
  - MajorGroup: 1000000-1999999 (FOOD), 2000000-2999999 (ALC), 3000000-3999999 (N/ALC), 4000000+ (OTHER)
  - FamilyGroup: > 0
```

---

#### 5. Документ.УстановкаЦенНоменклатуры
**Не изменяется структура типового документа**

**Добавить обработку после проведения (подписка на событие):**
```bsl
// МодульОбъектаДокумента.ПриЗаписи (или подписка на событие)
Процедура ПослеПроведения(Отказ)
    Если Не Отказ Тогда
        // Поиск позиций питМеню, связанных с номенклатурой из документа
        ПозицииМеню = НайтиПозицииМенюПоНоменклатуре(Товары.ВыгрузитьКолонку("Номенклатура"));
        
        Для Каждого Позиция Из ПозицииМеню Цикл
            Если Позиция.СтатусСинхронизацииSimphony = Перечисления.СтатусыСинхронизацииSimphony.Выгружено Тогда
                // Добавление в очередь с операцией UPDATE
                ДобавитьВОчередьВыгрузки(Позиция, "UPDATE");
            КонецЕсли;
        КонецЦикла;
    КонецЕсли;
КонецПроцедуры;
```

---

### Права доступа

#### Роль: MRS_ОсновнаяРоль (существующая)
**Расширить права:**
```
Справочник.питМеню:
  - Чтение: Да
  - Добавление: Да
  - Изменение: Да
  - Удаление: Нет (только администраторы)
  
РегистрСведений.ИсторияСинхронизацииМенюSimphony:
  - Чтение: Да
  - Изменение: Нет
  
Обработка.ВыгрузкаМенюВSimphony:
  - Использование: Нет (только администраторы)
```

#### Роль: MRS_АдминистраторСистемы (новая или расширение Администратор)
```
Все объекты: Полные права
Команды:
  - ВыгрузитьВSimphony: Да
  - ОчиститьОчередь: Да
  - УдалениеПозиций: Да
```

---

## Assumptions (Допущения)

1. **OpenAPI спецификация актуальна** — файл openApi.txt предоставлен корректный, версия API не изменится во время разработки
2. **Аутентификация API** — предполагается использование API Key в заголовке (требует уточнения от команды Simphony)
3. **Уникальность stringNumberId** — генерируется в 1С по принципу автонумерации или UUID (требует согласования правил генерации)
4. **Классификатор ГАУ заполнен** — все используемые номенклатуры имеют корректную двухуровневую иерархию с заполненными кодами MRS_КодMajorGroup и MRS_КодFamilyGroup в дополнительных сведениях
5. **Major/Family Group получаются запросом** — коды берутся через запрос при формировании JSON для выгрузки (связь: Номенклатура → ГАУ → доп.реквизиты)
6. **ВидЦен уже существует** — используется существующий реквизит ВидЦен в плане обмена питУдаленныеКассы
7. **Размер пакета bulk-запроса = 50** — ограничение установлено исходя из производительности, может быть увеличено после тестирования
8. **Хранение истории 30 дней** — автоматическая очистка регистра ИсторияСинхронизацииМенюSimphony регламентным заданием
9. **Таймаут HTTP-запросов** — устанавливается в коде (30 секунд), константа не требуется
10. **Язык интерфейса** — русский (локализация на другие языки не требуется)

---

## Prioritization (MoSCoW)

### Must Have (MVP — v1.0, срок 6 недель)

**M-01:** Создание/редактирование позиций питМеню с автозаполнением Major/Family Group  
**M-02:** Ручная выгрузка выбранных позиций через REST API (PUT /menu-item)  
**M-03:** Регистр сведений ОчередьВыгрузкиМенюSimphony с базовой логикой  
**M-04:** Отображение статусов синхронизации на форме списка и элемента  
**M-05:** Валидация данных перед отправкой (Major/Family Group, цены, привязки)  
**M-06:** Обработка HTTP 200/400/500 ответов с записью в регистр истории  
**M-07:** Формирование документа УстановкаЦенНоменклатуры из списка питМеню  

**Критерии приемки MVP:**
- ✅ Пользователь создает позицию, нажимает "Выгрузить" → статус "Выгружено" за < 5 сек
- ✅ При ошибке API статус меняется на "Ошибка" + запись в историю
- ✅ Major/Family Group заполняются автоматически из ГАУ

---

### Should Have (v1.1, срок +4 недели)

**S-01:** Автоматическая выгрузка по расписанию (регламентное задание каждые 15 мин)  
**S-02:** Механизм повторных попыток (до 3 раз с интервалом 5 мин)  
**S-03:** Bulk-выгрузка через POST /menu-items (до 50 позиций за запрос)  
**S-04:** Удаление позиций меню (DELETE /menu-item) с синхронизацией  
**S-05:** Детальная история синхронизации с фильтрами и поиском  
**S-06:** Автоматическая очистка истории старше 30 дней  
**S-07:** Синхронизация справочников Simphony (GET /referencedata/*)  

**Критерии приемки v1.1:**
- ✅ Регламентное задание обрабатывает 100 позиций за < 10 мин
- ✅ При сбое API выполняются 3 попытки автоматически
- ✅ Справочник питУдаленныеКассы обновляется из Simphony ежедневно

---

### Could Have (v2.0, будущие итерации)

**C-01:** Параллельная обработка очереди (до 5 потоков одновременно)  
**C-02:** Dashboard с метриками синхронизации (количество ошибок, среднее время выгрузки, топ-10 проблемных позиций)  
**C-03:** Уведомления администраторам при критичных ошибках (email / Telegram)  
**C-04:** Возможность отката выгруженных позиций (откат транзакции)  
**C-05:** Версионирование изменений позиций меню (audit trail)  
**C-06:** Поддержка множественных видов цен на один кассовый узел  
**C-07:** Интеграция с системой workflow для согласования изменений меню  

---

### Won't Have (исключено из scope)

**W-01:** Синхронизация транзакций продаж (чеков) — используется существующий план обмена  
**W-02:** Управление рецептурами через API — остается в 1С  
**W-03:** Прямое подключение к базе данных Oracle Simphony — только REST API  
**W-04:** Мобильное приложение — desktop-only решение  

---

## RICE Scoring (опционально, для приоритизации функций)

| ID | Функция | Reach | Impact | Confidence | Effort | RICE Score |
|----|---------|-------|--------|------------|--------|------------|
| M-01 | Создание позиций меню | 100 | 3 | 100% | 2 | 150 |
| M-02 | Ручная выгрузка | 100 | 3 | 100% | 3 | 100 |
| S-01 | Автовыгрузка по расписанию | 100 | 3 | 80% | 5 | 48 |
| S-03 | Bulk-выгрузка | 50 | 2 | 90% | 3 | 30 |
| C-02 | Dashboard метрик | 20 | 1 | 70% | 8 | 1.75 |

**Формула:** RICE = (Reach × Impact × Confidence) / Effort  
**Reach:** кол-во пользователей за квартал  
**Impact:** 3 = massive, 2 = high, 1 = medium, 0.5 = low  
**Confidence:** % уверенности в оценках  
**Effort:** недели разработки  

---

## Risks & Mitigation (Риски)

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| API Simphony недоступен при выгрузке | Средняя | Высокое | Очередь с повторными попытками, накопление изменений offline |
| Изменение спецификации OpenAPI | Низкая | Критическое | Версионирование API, обратная совместимость, мониторинг changelog Simphony |
| Расхождение кодов Major/Family Group | Высокая | Среднее | Ежедневная синхронизация справочников, валидация перед выгрузкой |
| Дублирование stringNumberId | Средняя | Среднее | Генерация уникальных ID с префиксом, обработка ошибки 100001 с перегенерацией |
| Производительность при 10,000 позиций | Низкая | Среднее | Bulk-операции, параллельная обработка, индексы в регистрах |
| Отсутствие прав у пользователей | Низкая | Низкое | Документирование ролей, валидация прав в коде |

---

## Dependencies (Зависимости)

### Внешние зависимости
1. **Oracle Simphony REST API сервис** — критическая зависимость, требует SLA от вендора
2. **Credentials для аутентификации** — предоставляет команда инфраструктуры
3. **Тестовая среда Simphony** — для разработки и тестирования интеграции

### Внутренние зависимости
1. **Заполнение классификатора ГАУ** — задача команды мастер-данных (deadline: до начала разработки)
2. **Настройка кассовых узлов** — привязка к видам меню и видам цен (deadline: неделя 2)
3. **Обновление платформы 1С до версии 8.3.23+** — для поддержки современных HTTP-клиентов

---

## Success Metrics (Метрики успеха)

### Функциональные метрики
- **Автоматизация выгрузки:** 100% позиций создаются через API (0% ручного ввода в Simphony)
- **Точность синхронизации:** 99%+ позиций успешно выгружаются с первой попытки
- **Время создания позиции:** сокращение с 10 мин до 2 мин (80% экономия времени)

### Технические метрики
- **Latency API запросов:** < 5 сек на выгрузку одной позиции
- **Throughput очереди:** 1000 позиций за 10 минут (100 позиций/мин)
- **Success Rate:** ≥ 95% запросов завершаются успешно (HTTP 200)

### Бизнес-метрики
- **Сокращение ошибок данных:** снижение расхождений между системами на 90%
- **Удовлетворенность пользователей:** NPS ≥ 8/10 от менеджеров меню
- **ROI:** окупаемость за 6 месяцев за счет экономии времени персонала

---

## Acceptance Criteria (Критерии приемки)

### Функциональные критерии

- [x] **AC-01:** Пользователь создает позицию меню → Major/Family Group получаются запросом из ГАУ при выгрузке в Simphony
- [x] **AC-02:** Пользователь нажимает "Выгрузить в Simphony" → позиция создается в Simphony за < 5 сек, статус "Выгружено"
- [x] **AC-03:** При ошибке API → статус "Ошибка", запись в регистр истории с кодом ошибки и сообщением
- [x] **AC-04:** Регламентное задание обрабатывает 100 позиций из очереди за < 10 мин
- [x] **AC-05:** При 3 неудачных попытках выгрузки → статус "ТребуетВнимания", уведомление администратору
- [x] **AC-06:** История синхронизации сохраняется 30 дней, старые записи автоматически удаляются
- [x] **AC-07:** Вид цен в документе "Установка цен" автоматически подставляется из существующего реквизита ВидЦен плана обмена питУдаленныеКассы

### Технические критерии

- [x] **AC-08:** Валидация перед выгрузкой: Major/Family Group заполнены, цена > 0, узел существует
- [x] **AC-09:** Корректная обработка всех HTTP кодов: 200, 400, 401, 404, 500, Timeout
- [x] **AC-10:** Bulk-запрос POST /menu-items формируется корректно для 50 позиций одного узла
- [x] **AC-11:** X-Correlation-Id и X-Request-Id генерируются уникальными для каждого запроса
- [x] **AC-12:** Парсинг JSON ответов выполняется без ошибок, данные сохраняются в реквизиты
- [x] **AC-13:** Регистры сведений имеют индексы по ключевым полям (ПозицияМеню, ДатаВремя)

### UX критерии

- [x] **AC-14:** Статус синхронизации отображается на форме списка цветными индикаторами (🟢🟡🔴)
- [x] **AC-15:** Гиперссылка "История синхронизации" открывает регистр с отбором по текущей позиции
- [x] **AC-16:** Команда "Выгрузить в Simphony" доступна только администраторам
- [x] **AC-17:** При валидации выводятся понятные сообщения: "Не заполнен классификатор ГАУ для номенклатуры 'Пицца'"

---

## Open Questions (Вопросы для уточнения)

1. **Аутентификация API:** Какой метод используется — API Key, Basic Auth, OAuth2? Где хранить credentials?
2. **Генерация stringNumberId:** Использовать автонумерацию, UUID или комбинированный подход (префикс + номер)?
3. **Rate Limiting API:** Какие ограничения на количество запросов в минуту? Нужен ли throttling?
4. **Rollback операций:** Нужна ли возможность отката выгруженных позиций (soft delete в Simphony)?
5. **Уведомления:** Предпочтительный канал для критичных ошибок — email, Telegram, внутренние уведомления 1С?
6. **Тестовая среда:** Доступна ли тестовая инсталляция Simphony для разработки интеграции?
7. **Поддержка множественных цен:** Планируется ли в будущем разная цена одной позиции для разных узлов?
8. **Язык API:** Ожидаются ли локализованные названия (рус/англ) или только один язык?

---

## Contacts & Stakeholders

| Роль | Имя | Ответственность |
|------|-----|-----------------|
| Product Owner | [ФИО] | Приоритезация функций, приемка |
| Tech Lead 1С | [ФИО] | Архитектура, code review |
| Backend Developer | [ФИО] | Разработка модулей интеграции |
| QA Engineer | [ФИО] | Тестирование, автотесты |
| Simphony Admin | Артем Брюховецкий (artem.bryuhovetskiy@mriyaresort.com) | Предоставление API, консультации |
| Business Analyst | [ФИО] | Сбор требований, документация |

---

## Timeline (Предварительный план)

| Фаза | Длительность | Дедлайн | Deliverables |
|------|--------------|---------|--------------|
| Discovery & Design | 1 неделя | Неделя 1 | Утвержденный PRD, технический дизайн |
| Sprint 1 (MVP Core) | 2 недели | Неделя 3 | M-01, M-02, M-03 |
| Sprint 2 (MVP Validation) | 2 недели | Неделя 5 | M-04, M-05, M-06, M-07 |
| QA & UAT (MVP) | 1 неделя | Неделя 6 | Тестовые сценарии, баг-репорты |
| MVP Release | - | Неделя 6 | Релиз v1.0 в продакшен |
| Sprint 3 (v1.1) | 2 недели | Неделя 8 | S-01, S-02, S-03 |
| Sprint 4 (v1.1) | 2 недели | Неделя 10 | S-04, S-05, S-06, S-07 |
| QA & Release v1.1 | 1 неделя | Неделя 11 | Релиз v1.1 в продакшен |

**Общая длительность MVP:** 6 недель  
**Общая длительность до v1.1:** 11 недель

---

## Appendix A: Примеры запросов/ответов API

### Пример 1: Создание позиции (успех)

**Request:**
```http
PUT /menu-item HTTP/1.1
Host: simphony-api.example.com
Content-Type: application/json
X-User-Id: ivanov_im
X-Correlation-Id: 550e8400-e29b-41d4-a716-446655440000
X-Request-Id: 661e9511-f39c-52e5-b827-557766551111

{
  "name": "Стейк Рибай 300г",
  "stringNumberId": 1001,
  "majGrpObjNum": 1000001,
  "famGrpObjNum": 100,
  "isVisible": 1,
  "hierStrucId": 3,
  "menuItemClass": 1001,
  "price": 2500.00,
  "fileNum": 15
}
```

**Response:**
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "name": "Стейк Рибай 300г",
  "stringNumberId": 1001,
  "majGrpObjNum": 1000001,
  "famGrpObjNum": 100,
  "isVisible": 1,
  "hierStrucId": 3,
  "menuItemClass": 1001,
  "price": 2500.00,
  "fileNum": 15,
  "created": "2024-03-15T14:22:33Z",
  "success": true
}
```

---

### Пример 2: Ошибка дублирования

**Request:** (аналогично примеру 1)

**Response:**
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "code": 100001,
  "message": "StringNumberId already exists",
  "service": "hrs-simphony-sync",
  "operation": "CreateMenuItem",
  "product": "HRS"
}
```

---

### Пример 3: Bulk-создание

**Request:**
```http
POST /menu-items HTTP/1.1
Host: simphony-api.example.com
Content-Type: application/json
X-Correlation-Id: 771f9522-g40d-63f6-c938-668877662222
X-Request-Id: 882g0633-h51e-74g7-d049-779988773333

{
  "hierStrucId": 3,
  "items": [
    {
      "name": "Борщ украинский",
      "stringNumberId": 2001,
      "majGrpObjNum": 1000010,
      "famGrpObjNum": 105,
      "isVisible": 1,
      "menuItemClass": 1001,
      "price": 350.00,
      "fileNum": 20
    },
    {
      "name": "Солянка мясная",
      "stringNumberId": 2002,
      "majGrpObjNum": 1000010,
      "famGrpObjNum": 105,
      "isVisible": 1,
      "menuItemClass": 1001,
      "price": 420.00,
      "fileNum": 21
    }
  ]
}
```

**Response:**
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "created_items": [
    {
      "name": "Борщ украинский",
      "stringNumberId": 2001,
      ...
      "created": "2024-03-15T14:30:00Z",
      "success": true
    },
    {
      "name": "Солянка мясная",
      "stringNumberId": 2002,
      ...
      "created": "2024-03-15T14:30:00Z",
      "success": true
    }
  ],
  "total_created": 2
}
```

---

## Appendix B: Диаграмма состояний позиции меню

```
[Создана в 1С]
      ↓
[НеВыгружено] ──────────────┐
      ↓                     │ (валидация не пройдена)
[ВОчереди] ────────────────┤
      ↓                     │
[Выгружается...] ──────────┤
      ↓                     │
   ┌──┴──┐                  │
   │     │                  │
 Успех  Ошибка              │
   │     │                  │
   ↓     ↓                  │
[Выгружено] [Ошибка] ───────┤ (попытка < 3)
              │             │
              └─────────────┘
              │ (попытка >= 3)
              ↓
      [ТребуетВнимания]
```

---

## Appendix C: Пример конфигурации регламентного задания

**Имя:** ВыгрузкаМенюВSimphony  
**Метод:** `ОбработкиМодуль.ВыгрузкаМенюВSimphony.ВыполнитьАвтоматическуюВыгрузку()`  
**Расписание:**
- Период повтора: 15 минут
- Дни недели: Все
- Начало: 07:00
- Окончание: 23:00
- Пауза при отсутствии пользователей: Нет
- Использование: Включено

**Параметры:**
- МаксимальноеКоличествоПозицийЗаСеанс: 50
- РежимОтладки: Ложь

---

## Change Log (История изменений PRD)

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 29.10.2025 | Product Manager | Первая версия PRD |
| | | | |

---

**Статус документа:** ✅ Ready for Review  
**Следующий шаг:** Согласование с Tech Lead и Simphony Admin → Начало разработки
