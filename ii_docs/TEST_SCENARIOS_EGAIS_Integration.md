# Тестовые сценарии: Интеграция ЕГАИС 1С-Simphony

**Версия:** 1.0  
**Дата:** 05.02.2026  
**Назначение:** Сценарии тестирования интеграции обмена марками ЕГАИС

---

## 1. Подготовка к тестированию

### 1.1. Требования к тестовой среде

- ✅ Доступ к тестовой базе 1С
- ✅ Доступ к тестовой базе Simphony Fiscal DB
- ✅ Настроен кассовый узел с виде цен
- ✅ Создан вид меню, связанный с кассовым узлом

### 1.2. Подготовка тестовых данных

Перед началом тестирования создать:

1. **Тестовая номенклатура "Водка Тестовая 0.5л"**
   - АлкогольнаяПродукция = Истина
   - АлкогольнаяПродукцияВоВскрытойТаре = Ложь
   - ОбъемДал = 0.05
   - ЕдиницаХранения = "дал"

2. **Тестовая номенклатура "Коньяк разливной"**
   - АлкогольнаяПродукция = Истина
   - АлкогольнаяПродукцияВоВскрытойТаре = Истина
   - ОбъемДал = 0.1
   - ЕдиницаХранения = "дал"

3. **Тестовая номенклатура "Кока-Кола 0.5л"**
   - АлкогольнаяПродукция = Ложь

4. **Штрихкоды для "Водка Тестовая 0.5л"**
   - 4601234567890
   - 4601234567906
   - 4601234567913

---

## 2. Модульные тесты

### Тест 2.1: Функция `ЭтоАлкогольнаяПродукция()`

#### Цель
Проверить корректность определения алкогольной продукции.

#### Тестовые данные

| Номенклатура | АлкогольнаяПродукция | ВоВскрытойТаре | Ожидаемый результат |
|--------------|----------------------|----------------|---------------------|
| Водка Тестовая | Истина | Ложь | **Истина** |
| Коньяк разливной | Истина | Истина | **Ложь** |
| Кока-Кола | Ложь | - | **Ложь** |

#### Шаги выполнения

1. Открыть консоль запросов в 1С
2. Выполнить для каждой позиции:
   ```bsl
   РезультатВодка = MRS_ИнтеграцияSimphonyСервер.ЭтоАлкогольнаяПродукция(ПозицияМенюВодка);
   Сообщить(РезультатВодка); // Ожидается: Истина
   
   РезультатКоньяк = MRS_ИнтеграцияSimphonyСервер.ЭтоАлкогольнаяПродукция(ПозицияМенюКоньяк);
   Сообщить(РезультатКоньяк); // Ожидается: Ложь
   
   РезультатКола = MRS_ИнтеграцияSimphonyСервер.ЭтоАлкогольнаяПродукция(ПозицияМенюКола);
   Сообщить(РезультатКола); // Ожидается: Ложь
   ```

#### Критерии успеха
- ✅ Все результаты соответствуют ожидаемым значениям
- ✅ Нет ошибок выполнения

---

### Тест 2.2: Функция `ВалидироватьДанныеЕГАИС()`

#### Цель
Проверить корректность валидации данных ЕГАИС.

#### Тестовые данные

| Сценарий | ObjNum | ОбъемДал | ЕдиницаИзмерения | Ожидаемый результат |
|----------|--------|----------|------------------|---------------------|
| Все заполнено | 123456 | 0.05 | "дал" | Валидна = Истина |
| Нет ObjNum | 0 | 0.05 | "дал" | Валидна = Ложь, Ошибки: "Не заполнен MRS_КодSimphony" |
| Нет ОбъемДал | 123456 | 0 | "дал" | Валидна = Ложь, Ошибки: "ОбъемДал должен быть больше 0" |
| Нет ЕдиницаИзмерения | 123456 | 0.05 | "" | Валидна = Ложь, Ошибки: "Не заполнена ЕдиницаХранения" |

#### Шаги выполнения

1. Создать 4 тестовые позиции меню с различными комбинациями заполнения реквизитов
2. Для каждой позиции выполнить:
   ```bsl
   Результат = MRS_ИнтеграцияSimphonyСервер.ВалидироватьДанныеЕГАИС(Позиция);
   Сообщить("Валидна: " + Результат.Валидна);
   Сообщить("Ошибки: " + СтрСоединить(Результат.Ошибки, ", "));
   ```

#### Критерии успеха
- ✅ Все результаты валидации соответствуют ожидаемым
- ✅ Тексты ошибок корректны и понятны

---

### Тест 2.3: Функция `ВычислитьРазницуШтрихкодов()`

#### Цель
Проверить корректность вычисления расхождений штрихкодов.

#### Тестовые данные

| Штрихкоды в Simphony | Штрихкоды в 1С | Ожидаемо на добавление | Ожидаемо на удаление |
|---------------------|----------------|------------------------|----------------------|
| [A, B, C] | [B, C, D] | [D] | [A] |
| [] | [A, B] | [A, B] | [] |
| [A, B] | [] | [] | [A, B] |
| [A, B, C] | [A, B, C] | [] | [] |

#### Шаги выполнения

1. В консоли запросов выполнить:
   ```bsl
   ШтрихкодыSimphony = Новый Массив;
   ШтрихкодыSimphony.Добавить("4601234567890"); // A
   ШтрихкодыSimphony.Добавить("4601234567906"); // B
   ШтрихкодыSimphony.Добавить("4601234567913"); // C
   
   Штрихкоды1С = Новый Массив;
   Штрихкоды1С.Добавить("4601234567906"); // B
   Штрихкоды1С.Добавить("4601234567913"); // C
   Штрихкоды1С.Добавить("4601234567920"); // D
   
   Результат = MRS_ИнтеграцияSimphonyСервер.ВычислитьРазницуШтрихкодов(ШтрихкодыSimphony, Штрихкоды1С);
   
   Сообщить("На добавление: " + СтрСоединить(Результат.НаДобавление, ", "));
   Сообщить("На удаление: " + СтрСоединить(Результат.НаУдаление, ", "));
   ```

#### Критерии успеха
- ✅ Для всех тестовых данных вычисление корректно
- ✅ Нет дубликатов в результатах

---

## 3. Функциональные тесты

### Тест 3.1: Выгрузка новой алкогольной позиции

#### Цель
Проверить полный цикл выгрузки новой алкогольной позиции с синхронизацией ЕГАИС.

#### Предусловия
- Создана позиция меню "Водка Тестовая 0.5л"
- Номенклатура правильно настроена (см. раздел 1.2)
- Добавлены 3 штрихкода в регистр ШтрихкодыНоменклатуры
- Позиция еще не выгружалась в Simphony

#### Шаги выполнения

1. Открыть форму списка справочника "питМеню"
2. Выбрать тестовую позицию "Водка Тестовая 0.5л"
3. Нажать кнопку "Выгрузить меню"
4. Выбрать кассовый узел для выгрузки
5. Дождаться завершения выгрузки
6. Открыть регистр "MRS_ИсторияСинхронизацииМенюSimphony"
7. Найти записи для данной позиции (последние 3 записи)

#### Ожидаемый результат

**Запись 1 (CREATE):**
- Операция: CREATE
- Статус: Выгружено
- HTTPСтатус: 200
- Сообщение: "OK" или "Успешно выгружено"

**Запись 2 (EGAIS_UPDATE):**
- Операция: EGAIS_UPDATE
- Статус: Выгружено
- HTTPСтатус: 200
- Сообщение: "ЕГАИС: Атрибуты обновлены"

**Запись 3 (EGAIS_BARCODES):**
- Операция: EGAIS_BARCODES
- Статус: Выгружено
- HTTPСтатус: 0
- Сообщение: "Добавлено: 3, Удалено: 0. Штрихкоды синхронизированы"

#### Проверка в Simphony

1. Открыть Simphony Fiscal DB API
2. Выполнить GET запрос: `/rvc/{rvcId}/egais/menuitems/egais`
3. Найти позицию по objnum
4. Проверить ЕГАИС-атрибуты:
   - objnum = MRS_КодSimphony
   - volume = 0.05
   - unit = "дал"
5. Выполнить GET запрос: `/rvc/{rvcId}/egais/barcodes/{objnum}`
6. Проверить наличие 3 штрихкодов

#### Критерии успеха
- ✅ Позиция успешно выгружена в Simphony
- ✅ В истории синхронизации 3 записи с корректными данными
- ✅ ЕГАИС-атрибуты корректно переданы в Simphony
- ✅ Все 3 штрихкода добавлены в Simphony

---

### Тест 3.2: Обновление штрихкодов существующей позиции

#### Цель
Проверить синхронизацию при изменении штрихкодов.

#### Предусловия
- Позиция "Водка Тестовая 0.5л" уже выгружена (тест 3.1 выполнен)
- В Simphony 3 штрихкода: [A, B, C]

#### Шаги выполнения

1. Открыть регистр "ШтрихкодыНоменклатуры"
2. Для номенклатуры "Водка Тестовая 0.5л":
   - Добавить 2 новых штрихкода: [D, E]
   - Удалить 1 старый штрихкод: [A]
3. Сохранить изменения
4. Открыть форму списка справочника "питМеню"
5. Выбрать позицию "Водка Тестовая 0.5л"
6. Нажать кнопку "Выгрузить меню"
7. Дождаться завершения выгрузки
8. Открыть регистр "MRS_ИсторияСинхронизацииМенюSimphony"
9. Найти последние записи для данной позиции

#### Ожидаемый результат

**Запись 1 (UPDATE):**
- Операция: UPDATE
- Статус: Выгружено
- HTTPСтатус: 200

**Запись 2 (EGAIS_UPDATE):**
- Операция: EGAIS_UPDATE
- Статус: Выгружено
- HTTPСтатус: 200

**Запись 3 (EGAIS_BARCODES):**
- Операция: EGAIS_BARCODES
- Статус: Выгружено
- Сообщение: "Добавлено: 2, Удалено: 1. Штрихкоды синхронизированы"

#### Проверка в Simphony

1. Выполнить GET запрос: `/rvc/{rvcId}/egais/barcodes/{objnum}`
2. Проверить, что в Simphony теперь 4 штрихкода: [B, C, D, E]
3. Убедиться, что штрихкод [A] удален

#### Критерии успеха
- ✅ Штрихкоды синхронизированы корректно
- ✅ В Simphony добавлены 2 новых штрихкода
- ✅ Из Simphony удален 1 устаревший штрихкод
- ✅ Общее количество штрихкодов в Simphony = 4

---

### Тест 3.3: Выгрузка неалкогольной позиции

#### Цель
Проверить, что неалкогольные позиции не попадают в обмен с ЕГАИС.

#### Предусловия
- Создана позиция меню "Кока-Кола 0.5л"
- Номенклатура имеет АлкогольнаяПродукция = Ложь
- Позиция еще не выгружалась

#### Шаги выполнения

1. Выбрать позицию "Кока-Кола 0.5л"
2. Нажать кнопку "Выгрузить меню"
3. Дождаться завершения выгрузки
4. Открыть регистр "MRS_ИсторияСинхронизацииМенюSimphony"
5. Найти записи для данной позиции

#### Ожидаемый результат

**Запись 1 (CREATE):**
- Операция: CREATE
- Статус: Выгружено
- HTTPСтатус: 200

**Записи EGAIS_UPDATE и EGAIS_BARCODES:**
- ❌ Отсутствуют

#### Критерии успеха
- ✅ Позиция успешно выгружена в Simphony
- ✅ В истории синхронизации только 1 запись с операцией CREATE
- ✅ Нет записей с операциями EGAIS_UPDATE или EGAIS_BARCODES

---

### Тест 3.4: Ошибка валидации ЕГАИС

#### Цель
Проверить обработку ошибок валидации данных ЕГАИС.

#### Предусловия
- Создана позиция меню "Вино Тестовое 0.75л"
- Номенклатура:
  - АлкогольнаяПродукция = Истина
  - АлкогольнаяПродукцияВоВскрытойТаре = Ложь
  - ОбъемДал = **НЕ заполнен** (нулевое значение)
  - ЕдиницаХранения = "дал"

#### Шаги выполнения

1. Выбрать позицию "Вино Тестовое 0.75л"
2. Нажать кнопку "Выгрузить меню"
3. Дождаться завершения выгрузки
4. Открыть регистр "MRS_ИсторияСинхронизацииМенюSimphony"
5. Найти записи для данной позиции

#### Ожидаемый результат

**Запись 1 (CREATE):**
- Операция: CREATE
- Статус: Выгружено
- HTTPСтатус: 200
- Сообщение: "OK"

**Запись 2 (EGAIS_UPDATE):**
- Операция: EGAIS_UPDATE
- Статус: **Ошибка**
- HTTPСтатус: 0
- Сообщение: "ЕГАИС: Ошибка валидации - Не заполнен реквизит ОбъемДал в карточке номенклатуры"

**Запись EGAIS_BARCODES:**
- ❌ Отсутствует (синхронизация штрихкодов не выполняется при ошибке валидации)

#### Критерии успеха
- ✅ Основная выгрузка позиции успешна (CREATE - Выгружено)
- ✅ Ошибка ЕГАИС не блокирует основную выгрузку
- ✅ Ошибка валидации зафиксирована в истории с понятным сообщением
- ✅ Позиция создана в Simphony, но без ЕГАИС-атрибутов

---

### Тест 3.5: Ошибка API ЕГАИС (HTTP 502)

#### Цель
Проверить обработку недоступности EGAIS сервиса.

#### Предусловия
- EGAIS сервис временно недоступен (имитировать отключением)
- Создана позиция меню "Водка Тестовая 2 0.5л" с корректными данными

#### Шаги выполнения

1. Имитировать недоступность EGAIS сервиса (отключить или настроить firewall)
2. Выбрать позицию "Водка Тестовая 2 0.5л"
3. Нажать кнопку "Выгрузить меню"
4. Дождаться завершения выгрузки
5. Открыть регистр "MRS_ИсторияСинхронизацииМенюSimphony"

#### Ожидаемый результат

**Запись 1 (CREATE):**
- Операция: CREATE
- Статус: Выгружено
- HTTPСтатус: 200

**Запись 2 (EGAIS_UPDATE):**
- Операция: EGAIS_UPDATE
- Статус: **Ошибка**
- HTTPСтатус: 502 или 503
- Сообщение: "ЕГАИС HTTP 502: ..." или "ЕГАИС: Ошибка соединения..."

#### Критерии успеха
- ✅ Основная выгрузка позиции успешна
- ✅ Ошибка ЕГАИС не блокирует основную выгрузку
- ✅ Ошибка API зафиксирована в истории с HTTP статусом
- ✅ Позиция создана в Simphony без ЕГАИС-атрибутов

---

## 4. Граничные случаи

### Тест 4.1: Позиция без штрихкодов

#### Цель
Проверить синхронизацию позиции, у которой нет штрихкодов в 1С.

#### Предусловия
- Создана позиция меню "Водка без штрихкодов 0.5л"
- Номенклатура правильно настроена
- В регистре ШтрихкодыНоменклатуры **нет штрихкодов** для этой номенклатуры

#### Шаги выполнения

1. Выбрать позицию "Водка без штрихкодов 0.5л"
2. Нажать кнопку "Выгрузить меню"
3. Дождаться завершения выгрузки
4. Проверить историю синхронизации

#### Ожидаемый результат

**Запись EGAIS_BARCODES:**
- Операция: EGAIS_BARCODES
- Статус: Выгружено
- Сообщение: "Добавлено: 0, Удалено: 0. Штрихкоды синхронизированы"

#### Критерии успеха
- ✅ Выгрузка выполнена без ошибок
- ✅ ЕГАИС-атрибуты обновлены
- ✅ Синхронизация штрихкодов завершена (хотя штрихкодов нет)
- ✅ В Simphony у позиции нет штрихкодов

---

### Тест 4.2: Пустой список штрихкодов в Simphony (HTTP 404)

#### Цель
Проверить обработку HTTP 404 при GET запросе штрихкодов (новая позиция в ЕГАИС).

#### Предусловия
- Позиция выгружена в Simphony, но штрихкоды еще не добавлялись в ЕГАИС
- В 1С есть штрихкоды для этой позиции

#### Ожидаемое поведение
- GET запрос вернет HTTP 404
- Система должна интерпретировать это как пустой список штрихкодов
- Все штрихкоды из 1С должны быть добавлены

#### Критерии успеха
- ✅ HTTP 404 обработан корректно (без ошибки)
- ✅ Все штрихкоды из 1С добавлены в Simphony
- ✅ Сообщение: "Добавлено: N, Удалено: 0"

---

### Тест 4.3: Алкоголь во вскрытой таре

#### Цель
Проверить, что алкоголь во вскрытой таре не синхронизируется с ЕГАИС.

#### Предусловия
- Создана позиция меню "Коньяк разливной"
- Номенклатура:
  - АлкогольнаяПродукция = Истина
  - АлкогольнаяПродукцияВоВскрытойТаре = **Истина**

#### Шаги выполнения

1. Выбрать позицию "Коньяк разливной"
2. Нажать кнопку "Выгрузить меню"
3. Дождаться завершения выгрузки
4. Проверить историю синхронизации

#### Ожидаемый результат

**Запись 1 (CREATE):**
- Операция: CREATE
- Статус: Выгружено
- HTTPСтатус: 200

**Записи EGAIS_UPDATE и EGAIS_BARCODES:**
- ❌ Отсутствуют

#### Критерии успеха
- ✅ Позиция выгружена в Simphony
- ✅ Нет записей с операциями ЕГАИС
- ✅ Функция ЭтоАлкогольнаяПродукция() вернула Ложь

---

## 5. Чек-лист финальной приемки

### 5.1. Функциональность

- [ ] Все модульные тесты (2.1-2.3) пройдены успешно
- [ ] Все функциональные тесты (3.1-3.5) пройдены успешно
- [ ] Все граничные случаи (4.1-4.3) обработаны корректно
- [ ] Интеграция работает для алкогольных позиций
- [ ] Неалкогольные позиции выгружаются без изменений
- [ ] Алкоголь во вскрытой таре не синхронизируется

### 5.2. Логирование

- [ ] Операция EGAIS_UPDATE логируется корректно
- [ ] Операция EGAIS_BARCODES логируется корректно
- [ ] Ошибки валидации записываются в историю
- [ ] Ошибки API записываются в историю с HTTP статусами
- [ ] Сообщения понятны и информативны

### 5.3. Обработка ошибок

- [ ] Ошибки ЕГАИС не блокируют основную выгрузку
- [ ] HTTP 400 обрабатывается корректно
- [ ] HTTP 404 обрабатывается корректно (пустой список штрихкодов)
- [ ] HTTP 502/503 обрабатываются корректно
- [ ] Ошибки соединения обрабатываются корректно

### 5.4. Синхронизация штрихкодов

- [ ] Добавление новых штрихкодов работает (batch POST)
- [ ] Удаление устаревших штрихкодов работает (DELETE)
- [ ] Двусторонняя синхронизация корректна
- [ ] Позиции без штрихкодов обрабатываются корректно
- [ ] HTTP 404 при GET штрихкодов обрабатывается как пустой список

### 5.5. Производительность

- [ ] Выгрузка одной позиции занимает не более 5 секунд
- [ ] Batch добавление штрихкодов быстрее, чем по одному
- [ ] Нет задержек при синхронизации неалкогольных позиций

### 5.6. Документация

- [ ] Инструкция для администраторов создана
- [ ] Все функции содержат комментарии
- [ ] Тестовые сценарии описаны
- [ ] Известные ограничения задокументированы

---

## 6. Отчет о результатах тестирования

### 6.1. Шаблон отчета

**Дата тестирования:** [дата]  
**Тестировщик:** [ФИО]  
**Версия 1С:** [версия]  
**Версия Simphony:** [версия]

#### Результаты модульных тестов

| Тест | Статус | Примечания |
|------|--------|------------|
| 2.1 ЭтоАлкогольнаяПродукция | ✅ / ❌ | |
| 2.2 ВалидироватьДанныеЕГАИС | ✅ / ❌ | |
| 2.3 ВычислитьРазницуШтрихкодов | ✅ / ❌ | |

#### Результаты функциональных тестов

| Тест | Статус | Примечания |
|------|--------|------------|
| 3.1 Выгрузка новой алкогольной позиции | ✅ / ❌ | |
| 3.2 Обновление штрихкодов | ✅ / ❌ | |
| 3.3 Выгрузка неалкогольной позиции | ✅ / ❌ | |
| 3.4 Ошибка валидации | ✅ / ❌ | |
| 3.5 Ошибка API (HTTP 502) | ✅ / ❌ | |

#### Результаты тестирования граничных случаев

| Тест | Статус | Примечания |
|------|--------|------------|
| 4.1 Позиция без штрихкодов | ✅ / ❌ | |
| 4.2 HTTP 404 при GET штрихкодов | ✅ / ❌ | |
| 4.3 Алкоголь во вскрытой таре | ✅ / ❌ | |

#### Выявленные проблемы

| № | Описание | Критичность | Статус |
|---|----------|-------------|--------|
| 1 | | | |

#### Заключение

[ ] Интеграция готова к внедрению в продуктивную среду  
[ ] Требуются доработки (указать в разделе "Выявленные проблемы")

---

**Конец документа**
