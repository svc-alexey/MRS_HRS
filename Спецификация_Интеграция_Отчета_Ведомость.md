# Спецификация: Интеграция отчета "Ведомость по товарам на складах" в форму обработки "МРС_АРМ_Закрытия_смены"

## Контекст и цели

### Проблема
Форма обработки "МРС_АРМ_Закрытия_смены" используется для закрытия смен и сверки данных между фронт-системой (TNG/Micros) и 1С. В процессе работы пользователю необходимо просматривать остатки товаров на складах для контроля и анализа.

### Цель
Добавить возможность открытия отчета "Ведомость по товарам на складах" (Reports/ВедомостьПоТоварамНаСкладах1) непосредственно из формы обработки с автоматической передачей контекстных данных (период, склад).

### Выгоды
- Ускорение работы пользователя — не нужно вручную открывать отчет и заполнять параметры
- Контекстная передача данных — период и склад заполняются автоматически из обработки
- Единая точка входа для операций закрытия смены

---

## Часть 1. Анализ существующей структуры

### 1.1. Форма обработки MRS_АРМ_Закрытия_смены

**Путь:** `DataProcessors/MRS_АРМ_Закрытия_смены/Forms/Форма`

#### Ключевые элементы формы:

| Элемент | Тип | Путь данных | Назначение |
|---------|-----|-------------|------------|
| НачалоПериода | Поле ввода | Объект.НачалоПериода | Начало периода для загрузки/сверки |
| КонецПериода | Поле ввода | Объект.КонецПериода | Окончание периода для загрузки/сверки |
| ФронтСистема | Поле ввода | Объект.ФронтСистема | Выбор фронт-системы (TNG/Micros) |
| ПараметрыКасс | Таблица | Объект.ПараметрыКасс | Список касс с флагами использования |

**Структура таблицы ПараметрыКасс:**
- Использовать (Булево)
- КассаККМ (СправочникСсылка.КассыККМ)
- ФронтСистема (ПеречислениеСсылка.ПЛ_ТипыФронтСистем)
- КодТочкиПродаж (Строка)
- НаименованиеТочкиПродаж (Строка)

#### Текущие закладки формы:
1. **Отчет сверки ФРОНТ - 1С** — показывает результат сверки чеков
2. **Выпуски блюд** — динамический список документов питВыпускБлюд
3. **Ведомость по складам** — пустая закладка с полем ВедомостьОтчет (ТабличныйДокумент)

#### Существующие команды:
- Загрузить (загрузка чеков)
- Сверить (сверка чеков)
- УстановитьДаты (выбор периода)
- УстановитьФлажки / СнятьФлажки (управление таблицей касс)

### 1.2. Отчет ВедомостьПоТоварамНаСкладах1

**Путь:** `Reports/ВедомостьПоТоварамНаСкладах1`

#### Структура отчета:

| Компонент | Описание |
|-----------|----------|
| Тип | Отчет на основе СКД (схема компоновки данных) |
| Основная схема | Template.ОсновнаяСхемаКомпоновкиДанных |
| Источник данных | Регистр накопления.ТоварыНаСкладах (остатки и обороты) |

#### Ключевые параметры/отборы отчета:

| Параметр/Отбор | Тип | Описание |
|----------------|-----|----------|
| Период | СтандартныйПериод | Период для расчета остатков |
| Склад | СправочникСсылка.Склады | Отбор по складу |
| Номенклатура | СправочникСсылка.Номенклатура | Отбор по номенклатуре |
| Помещение | СправочникСсылка.СкладскиеПомещения | Отбор по помещению склада |
| СегментНоменклатуры | СправочникСсылка.СегментыНоменклатуры | Отбор по сегменту |
| ПересчетТоваров | ДокументСсылка.ПересчетТоваров | Отбор по документу пересчета |

#### Ключевые поля отчета:
- Номенклатура
- Характеристика
- Склад
- Помещение
- Количество (остаток)
- Количество (приход)
- Количество (расход)
- Суммы по различным измерениям (вес, объем)

#### Обработчики отчета (ObjectModule.bsl):

```
ОпределитьНастройкиФормы() — настройка формы отчета
ПриСозданииНаСервере() — обработка параметров при открытии
ПередЗагрузкойНастроекВКомпоновщик() — модификация настроек
ПриКомпоновкеРезультата() — формирование отчета
```

---

## Часть 2. Архитектурное решение

### 2.1. Варианты реализации

#### Вариант 1: Открытие отчета в отдельной форме (РЕКОМЕНДУЕТСЯ)

**Преимущества:**
- Полный функционал стандартной формы отчета (настройки, варианты, экспорт)
- Возможность детальной настройки пользователем
- Соответствие стандартным паттернам 1С
- Не требует доработки формы обработки

**Недостатки:**
- Отчет открывается в новом окне
- Нет автоматического обновления при изменении параметров в обработке

**Реализация:**
- Добавить кнопку на закладку "Ведомость по складам"
- При нажатии открывать форму отчета через ОткрытьФорму()
- Передавать параметры отбора через структуру ПараметрыФормы

#### Вариант 2: Встраивание отчета в форму обработки

**Преимущества:**
- Отчет отображается внутри формы обработки
- Визуально интегрированное решение
- Один интерфейс для работы

**Недостатки:**
- Сложность реализации (управление жизненным циклом отчета)
- Ограниченный функционал (нет стандартных кнопок формы отчета)
- Требует значительных доработок модуля формы
- Риски при обновлении платформы

**Реализация:**
- Программное формирование отчета на сервере
- Вывод результата в поле ВедомостьОтчет
- Необходимость управления настройками СКД вручную

### 2.2. Выбранное решение: Вариант 1

**Обоснование:**
1. Минимальные трудозатраты на реализацию
2. Стандартный подход, используемый в конфигурации (см. примеры в УстановкаЦенНоменклатуры)
3. Максимальная функциональность для пользователя
4. Простота поддержки и модификации

---

## Часть 3. Детальная спецификация

### 3.1. Изменения в форме обработки (Form.xml)

#### 3.1.1. Добавить кнопку на закладку "Ведомость"

**Расположение:** Внутри `<Page name="Ведомость" id="277">`

**Добавить перед элементом:** `<SpreadSheetDocumentField name="ВедомостьОтчет">`

```xml
<Button name="ОткрытьВедомость" id="300">
	<Type>UsualButton</Type>
	<CommandName>Form.Command.ОткрытьВедомость</CommandName>
	<BackColor>style:ButtonColor</BackColor>
	<Title>
		<v8:item>
			<v8:lang>ru</v8:lang>
			<v8:content>Открыть ведомость по товарам на складах</v8:content>
		</v8:item>
	</Title>
	<ExtendedTooltip name="ОткрытьВедомостьРасширеннаяПодсказка" id="301"/>
</Button>
```

#### 3.1.2. Добавить команду формы

**Расположение:** В секции `<Commands>` (после команды "СравнитьСБазой")

```xml
<Command name="ОткрытьВедомость" id="15">
	<Title>
		<v8:item>
			<v8:lang>ru</v8:lang>
			<v8:content>Открыть ведомость</v8:content>
		</v8:item>
	</Title>
	<ToolTip>
		<v8:item>
			<v8:lang>ru</v8:lang>
			<v8:content>Открыть отчет "Ведомость по товарам на складах"</v8:content>
		</v8:item>
	</ToolTip>
	<Picture>
		<xr:Ref>StdPicture.Report</xr:Ref>
		<xr:LoadTransparent>true</xr:LoadTransparent>
	</Picture>
	<Action>ОткрытьВедомость</Action>
	<Representation>TextPicture</Representation>
</Command>
```

### 3.2. Изменения в модуле формы (Module.bsl)

#### 3.2.1. Добавить обработчик команды в секцию #Область ОбработчикиКомандФормы

**Расположение:** После процедуры `УстановитьФлажки()`

```bsl
&НаКлиенте
Процедура ОткрытьВедомость(Команда)
	
	// Проверка заполнения периода
	Если НЕ ЗначениеЗаполнено(Объект.НачалоПериода) ИЛИ НЕ ЗначениеЗаполнено(Объект.КонецПериода) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Необходимо заполнить период");
		Возврат;
	КонецЕсли;
	
	// Определение склада из выбранных касс
	МассивСкладов = ПолучитьСкладыПоКассам();
	
	Если МассивСкладов.Количество() = 0 Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не выбрано ни одной кассы. Установите флажки в таблице касс.");
		Возврат;
	КонецЕсли;
	
	// Формирование параметров отчета
	ПараметрыОтчета = ПодготовитьПараметрыОтчетаВедомость(МассивСкладов);
	
	// Открытие формы отчета
	ОткрытьФорму("Отчет.ВедомостьПоТоварамНаСкладах1.Форма", ПараметрыОтчета, ЭтотОбъект, Новый УникальныйИдентификатор);
	
КонецПроцедуры
```

#### 3.2.2. Добавить вспомогательные функции в секцию #Область СлужебныеПроцедурыИФункции

**Расположение:** После процедуры `ОбновитьФлажки()`

```bsl
&НаСервере
Функция ПолучитьСкладыПоКассам()
	
	МассивСкладов = Новый Массив;
	
	Для Каждого СтрокаКассы Из Объект.ПараметрыКасс Цикл
		
		Если НЕ СтрокаКассы.Использовать Тогда
			Продолжить;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаКассы.КассаККМ) Тогда
			Продолжить;
		КонецЕсли;
		
		// Получаем склад, связанный с кассой ККМ
		Склад = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаКассы.КассаККМ, "Склад");
		
		Если ЗначениеЗаполнено(Склад) И МассивСкладов.Найти(Склад) = Неопределено Тогда
			МассивСкладов.Добавить(Склад);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат МассивСкладов;
	
КонецФункции

&НаСервере
Функция ПодготовитьПараметрыОтчетаВедомость(МассивСкладов)
	
	ПараметрыФормы = Новый Структура;
	
	// Формирование структуры отбора
	Отбор = Новый Структура;
	
	// Период
	СтандартныйПериод = Новый СтандартныйПериод;
	СтандартныйПериод.ДатаНачала = Объект.НачалоПериода;
	СтандартныйПериод.ДатаОкончания = Объект.КонецПериода;
	СтандартныйПериод.Вариант = ВариантСтандартногоПериода.Произвольный;
	
	// Склад (если выбран один склад - передаем его, если несколько - список)
	Если МассивСкладов.Количество() = 1 Тогда
		Отбор.Вставить("Склад", МассивСкладов[0]);
	ИначеЕсли МассивСкладов.Количество() > 1 Тогда
		СписокСкладов = Новый СписокЗначений;
		СписокСкладов.ЗагрузитьЗначения(МассивСкладов);
		Отбор.Вставить("Склад", СписокСкладов);
	КонецЕсли;
	
	ПараметрыФормы.Вставить("Отбор", Отбор);
	ПараметрыФормы.Вставить("КлючНазначенияИспользования", "ВедомостьПоТоварамНаСкладах");
	ПараметрыФормы.Вставить("СформироватьПриОткрытии", Истина);
	
	Возврат ПараметрыФормы;
	
КонецФункции
```

### 3.3. Логика работы

#### Последовательность действий при нажатии кнопки:

1. **Валидация данных:**
   - Проверка заполнения НачалоПериода и КонецПериода
   - Проверка выбора хотя бы одной кассы (флаг Использовать = Истина)

2. **Определение складов:**
   - Обход таблицы ПараметрыКасс
   - Для каждой отмеченной кассы получение связанного склада через `КассаККМ.Склад`
   - Формирование массива уникальных складов

3. **Подготовка параметров отчета:**
   - Формирование СтандартныйПериод из НачалоПериода/КонецПериода
   - Если выбран 1 склад → передать как значение
   - Если выбрано несколько → передать как СписокЗначений
   - Установка флага СформироватьПриОткрытии = Истина

4. **Открытие формы отчета:**
   - Вызов ОткрытьФорму() с полным именем "Отчет.ВедомостьПоТоварамНаСкладах1.Форма"
   - Передача ПараметрыФормы со структурой Отбор
   - Открытие с новым УникальныйИдентификатор (новое окно)

### 3.4. Схема взаимодействия

```
┌─────────────────────────────────────────┐
│  Форма обработки МРС_АРМ_Закрытия_смены │
│                                         │
│  ┌─────────────┐  ┌──────────────────┐ │
│  │ НачалоПериода│  │  КонецПериода   │ │
│  └─────────────┘  └──────────────────┘ │
│                                         │
│  ┌─────────────────────────────────────┐│
│  │ Таблица: ПараметрыКасс              ││
│  │ [✓] Касса1 → Склад1                 ││
│  │ [✓] Касса2 → Склад1                 ││
│  │ [ ] Касса3 → Склад2                 ││
│  └─────────────────────────────────────┘│
│                                         │
│  ┌─────────────────────────────────────┐│
│  │ [Открыть ведомость по товарам]      ││
│  └─────────────────────────────────────┘│
└─────────────────────────────────────────┘
                    ↓
        ┌───────────────────────┐
        │ Клик по кнопке         │
        └───────────────────────┘
                    ↓
        ┌───────────────────────┐
        │ Проверка периода      │
        └───────────────────────┘
                    ↓
        ┌───────────────────────┐
        │ Сбор складов из касс  │
        │ Результат: [Склад1]   │
        └───────────────────────┘
                    ↓
        ┌───────────────────────┐
        │ Формирование Отбор    │
        │ - Период: 01.01-31.01 │
        │ - Склад: Склад1       │
        └───────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│ Форма отчета ВедомостьПоТоварамНаСкладах│
│                                         │
│ Период: [01.01.2026] - [31.01.2026]    │
│ Склад:  [Склад1                    ▼]  │
│                                         │
│ ┌─────────────────────────────────────┐│
│ │        [Сформировать отчет]         ││
│ └─────────────────────────────────────┘│
│                                         │
│ ┌─────────────────────────────────────┐│
│ │  Табличный документ с результатами  ││
│ │  Номенклатура | Склад | Количество  ││
│ │  ...          | ...   | ...         ││
│ └─────────────────────────────────────┘│
└─────────────────────────────────────────┘
```

### 3.5. Альтернативное расположение кнопки

**Вариант А (рекомендуется):** На закладке "Ведомость по складам"
- Логичное размещение — пользователь на нужной закладке
- Визуально понятно назначение кнопки

**Вариант Б:** В шапке формы рядом с кнопками "Загрузить" и "Сверить"
- Быстрый доступ из любой закладки
- Требует добавления кнопки в группу "Кнопки"

**Вариант В:** В командной панели закладки "Ведомость по складам"
- Стандартное расположение для команд, связанных с закладкой
- Экономия места на форме

---

## Часть 4. Связь с метаданными

### 4.1. Используемые объекты метаданных

| Объект | Путь | Назначение |
|--------|------|------------|
| Справочник.КассыККМ | Catalogs/КассыККМ | Источник касс для определения складов |
| Справочник.Склады | Catalogs/Склады | Отбор по складам в отчете |
| Перечисление.ПЛ_ТипыФронтСистем | Enums/ПЛ_ТипыФронтСистем | Фильтр фронт-системы |
| Отчет.ВедомостьПоТоварамНаСкладах1 | Reports/ВедомостьПоТоварамНаСкладах1 | Целевой отчет |
| Обработка.MRS_АРМ_Закрытия_смены | DataProcessors/MRS_АРМ_Закрытия_смены | Исходная форма |

### 4.2. Связь Касса → Склад

**Предположение:** У справочника КассыККМ есть реквизит "Склад" типа СправочникСсылка.Склады

**Проверка:** Необходимо проверить наличие этого реквизита:
- Если реквизит существует → использовать напрямую
- Если реквизит отсутствует → искать связь через другие объекты (например, через регистр сведений)

**Альтернативный путь (если прямой связи нет):**
```bsl
// Поиск склада через регистр сведений или другие связи
СкладКассы = Неопределено;

// Проверка через регистр
Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	РегистрСвязейКассыСклады.Склад КАК Склад
|ИЗ
|	РегистрСведений.РегистрСвязейКассыСклады КАК РегистрСвязейКассыСклады
|ГДЕ
|	РегистрСвязейКассыСклады.Касса = &Касса";
Запрос.УстановитьПараметр("Касса", СтрокаКассы.КассаККМ);
РезультатЗапроса = Запрос.Выполнить();
Если НЕ РезультатЗапроса.Пустой() Тогда
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	СкладКассы = Выборка.Склад;
КонецЕсли;
```

---

## Часть 5. Возможные риски и ограничения

### 5.1. Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Отсутствие связи Касса→Склад | Средняя | Высокое | Предварительная проверка метаданных. Реализация альтернативного способа определения склада |
| Множественные склады на одну кассу | Низкая | Среднее | Передача списка складов в отчет вместо единичного значения |
| Длительное формирование отчета | Средняя | Низкое | Флаг СформироватьПриОткрытии можно убрать, пользователь сам нажмет "Сформировать" |
| Права доступа на отчет | Низкая | Среднее | Проверка прав через ОбщегоНазначения.ДоступноЧтениеОбъекта() перед открытием |

### 5.2. Ограничения

1. **Период:**
   - Отчет использует период для расчета остатков/оборотов
   - Если период в обработке не заполнен → отчет не откроется

2. **Склады:**
   - Если не выбрано ни одной кассы → невозможно определить склад
   - Отчет может открыться без отбора по складу (показать все склады)

3. **Производительность:**
   - Отчет на больших данных может формироваться долго
   - Рекомендуется всегда передавать отбор по складу

4. **Множественность:**
   - Если выбрано много касс с разными складами → отчет покажет данные по всем складам
   - Пользователь может изменить отбор в форме отчета

### 5.3. Дополнительные улучшения (вне текущей задачи)

1. **Интерактивность:**
   - Добавить возможность обновления отчета при изменении параметров в обработке
   - Требует двустороннюю связь между формами (сложно)

2. **Встраивание:**
   - Встроить отчет непосредственно в закладку "Ведомость"
   - Требует ручного управления СКД и значительных доработок

3. **Контекстное меню:**
   - Добавить команду в контекстное меню таблицы ПараметрыКасс
   - "Открыть ведомость по складу выбранной кассы"

4. **Навигация:**
   - Из отчета "Ведомость" добавить переход к документам (двойной клик на строке)

---

## Часть 6. Тестирование

### 6.1. Сценарии тестирования

#### Сценарий 1: Базовый сценарий
1. Открыть форму обработки МРС_АРМ_Закрытия_смены
2. Заполнить НачалоПериода = 01.02.2026
3. Заполнить КонецПериода = 28.02.2026
4. Установить флаг Использовать для одной кассы
5. Перейти на закладку "Ведомость по складам"
6. Нажать кнопку "Открыть ведомость по товарам на складах"

**Ожидаемый результат:**
- Открывается форма отчета ВедомостьПоТоварамНаСкладах1
- В отчете установлен период 01.02.2026 - 28.02.2026
- В отборе установлен склад, связанный с выбранной кассой
- Отчет автоматически сформирован (флаг СформироватьПриОткрытии)

#### Сценарий 2: Множественные кассы с одним складом
1. Открыть форму обработки
2. Заполнить период
3. Установить флаги для двух касс, связанных с одним складом
4. Нажать кнопку открытия отчета

**Ожидаемый результат:**
- Отчет открывается с отбором по одному складу
- Данные показаны корректно

#### Сценарий 3: Множественные кассы с разными складами
1. Открыть форму обработки
2. Заполнить период
3. Установить флаги для касс, связанных с разными складами
4. Нажать кнопку открытия отчета

**Ожидаемый результат:**
- Отчет открывается с отбором по списку складов
- В отборе видны все выбранные склады
- Данные показаны по всем складам

#### Сценарий 4: Не заполнен период
1. Открыть форму обработки
2. НЕ заполнять период
3. Установить флаг для одной кассы
4. Нажать кнопку открытия отчета

**Ожидаемый результат:**
- Выводится сообщение "Необходимо заполнить период"
- Отчет НЕ открывается

#### Сценарий 5: Не выбрано ни одной кассы
1. Открыть форму обработки
2. Заполнить период
3. НЕ устанавливать флаги для касс
4. Нажать кнопку открытия отчета

**Ожидаемый результат:**
- Выводится сообщение "Не выбрано ни одной кассы..."
- Отчет НЕ открывается

#### Сценарий 6: Изменение параметров в отчете
1. Открыть отчет через обработку
2. В форме отчета изменить период
3. В форме отчета добавить отбор по номенклатуре
4. Сформировать отчет

**Ожидаемый результат:**
- Изменения применяются корректно
- Отчет формируется с новыми параметрами
- Исходная обработка не затронута

### 6.2. Проверка метаданных перед реализацией

**Обязательные проверки:**

1. **Справочник КассыККМ:**
   - Проверить наличие реквизита "Склад"
   - Тип реквизита: СправочникСсылка.Склады
   - Если отсутствует — найти альтернативный способ связи

2. **Отчет ВедомостьПоТоварамНаСкладах1:**
   - Проверить параметры схемы компоновки
   - Убедиться, что есть параметры/отборы Период и Склад
   - Проверить, что форма отчета корректно обрабатывает параметры

3. **Права доступа:**
   - Убедиться, что пользователи имеют права на чтение отчета
   - Проверить ролевую модель доступа

---

## Часть 7. Файлы для изменения

### Список файлов:

| № | Файл | Тип изменения | Описание |
|---|------|---------------|----------|
| 1 | DataProcessors/MRS_АРМ_Закрытия_смены/Forms/Форма/Ext/Form.xml | Изменение | Добавление кнопки и команды |
| 2 | DataProcessors/MRS_АРМ_Закрытия_смены/Forms/Форма/Ext/Form/Module.bsl | Изменение | Добавление обработчиков и функций |

### Примерные строки изменений:

- **Form.xml:** +20 строк (кнопка + команда)
- **Module.bsl:** +80 строк (3 новые процедуры/функции)

---

## Часть 8. Рекомендации по реализации

### 8.1. Последовательность действий

1. **Подготовка (5-10 мин):**
   - Проверить метаданные КассыККМ (наличие реквизита Склад)
   - Проверить параметры отчета ВедомостьПоТоварамНаСкладах1
   - Сделать резервную копию файлов формы обработки

2. **Изменение Form.xml (10 мин):**
   - Добавить команду ОткрытьВедомость
   - Добавить кнопку на закладку "Ведомость"
   - Сохранить изменения

3. **Изменение Module.bsl (20-30 мин):**
   - Добавить процедуру ОткрытьВедомость()
   - Добавить функцию ПолучитьСкладыПоКассам()
   - Добавить функцию ПодготовитьПараметрыОтчетаВедомость()
   - Сохранить изменения

4. **Тестирование (20-30 мин):**
   - Выполнить все сценарии из Части 6.1
   - Проверить работу на тестовой базе
   - Проверить сообщения об ошибках

5. **Финализация (10 мин):**
   - Проверить код на соответствие стандартам (отступы, комментарии)
   - Запустить проверку конфигурации (Ctrl+Shift+V в Конфигураторе)
   - Зафиксировать изменения в системе контроля версий

### 8.2. Потенциальные проблемы

| Проблема | Решение |
|----------|---------|
| Реквизит Склад не найден в КассыККМ | Использовать альтернативный способ: запрос к регистру сведений или анализ связанных объектов |
| Отчет открывается без параметров | Проверить правильность формирования структуры Отбор. Убедиться, что имена ключей соответствуют именам параметров/полей в СКД |
| СформироватьПриОткрытии не работает | Убрать этот параметр, пользователь сформирует отчет вручную |
| Ошибка "Поле Период не найдено" | В СКД может использоваться другое имя для периода. Проверить схему компоновки отчета |

### 8.3. Оптимизации

**Кэширование складов:**
Если таблица ПараметрыКасс большая, можно кэшировать соответствие Касса→Склад:

```bsl
&НаСервере
Функция ПолучитьСкладыПоКассам()
	
	МассивКасс = Новый Массив;
	Для Каждого СтрокаКассы Из Объект.ПараметрыКасс Цикл
		Если СтрокаКассы.Использовать И ЗначениеЗаполнено(СтрокаКассы.КассаККМ) Тогда
			МассивКасс.Добавить(СтрокаКассы.КассаККМ);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивКасс.Количество() = 0 Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	// Пакетное получение складов одним запросом
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КассыККМ.Склад КАК Склад
	|ИЗ
	|	Справочник.КассыККМ КАК КассыККМ
	|ГДЕ
	|	КассыККМ.Ссылка В(&МассивКасс)
	|	И КассыККМ.Склад <> ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)";
	Запрос.УстановитьПараметр("МассивКасс", МассивКасс);
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Склад");
	
КонецФункции
```

**Проверка прав доступа:**
```bsl
&НаКлиенте
Процедура ОткрытьВедомость(Команда)
	
	// ... существующие проверки ...
	
	// Проверка прав на отчет
	Если НЕ ПроверитьПраваНаОтчет() Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Недостаточно прав для просмотра отчета");
		Возврат;
	КонецЕсли;
	
	// ... остальной код ...
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПроверитьПраваНаОтчет()
	
	Возврат ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьПоТоварамНаСкладах1);
	
КонецФункции
```

---

## Часть 9. Итоговая сводка

### Ключевые решения:

1. **Способ интеграции:** Открытие отчета в отдельной форме через ОткрытьФорму()
2. **Передача параметров:** Структура Отбор с полями Период (СтандартныйПериод) и Склад (значение или список)
3. **Определение складов:** Через реквизит Склад справочника КассыККМ
4. **Расположение кнопки:** На закладке "Ведомость по складам"
5. **Валидация:** Обязательные проверки периода и выбора касс

### Преимущества решения:

- ✅ Минимальные изменения в конфигурации
- ✅ Стандартный подход, используемый в типовых конфигурациях
- ✅ Полная функциональность формы отчета (настройки, варианты, экспорт)
- ✅ Контекстная передача данных из обработки
- ✅ Простота поддержки и расширения
- ✅ Возможность доработки отчета без изменения обработки

### Оценка трудозатраты:

- **Анализ и подготовка:** 30-40 минут
- **Реализация:** 40-50 минут
- **Тестирование:** 30-40 минут
- **Документирование:** 20-30 минут

**Итого:** 2-2.5 часа (включая проверку метаданных и отладку)

---

## Заключение

Предложенное решение обеспечивает простую и эффективную интеграцию отчета "Ведомость по товарам на складах" в форму обработки "МРС_АРМ_Закрытия_смены". Решение основано на стандартных паттернах 1С, минимизирует изменения в конфигурации и обеспечивает максимальную функциональность для пользователя.

Реализация потребует изменения двух файлов (Form.xml и Module.bsl) с добавлением ~100 строк кода. Риски минимальны, все потенциальные проблемы имеют четкие пути решения.

После реализации пользователи смогут быстро открывать отчет с автоматически подставленными параметрами (период и склад), что ускорит процесс закрытия смены и контроля остатков на складах.
