# PRD: Справочник MRS_КлассыМеню (упрощенная реализация)

**Версия:** 1.0  
**Дата:** 19.01.2026  
**Статус:** Ready for Implementation

---

## 1. Краткое описание

Дополнить существующий справочник `MRS_КлассыМеню` функционалом определения класса меню для Simphony на основе гибких условий **без использования перечислений**. Все настройки выполняются через табличную часть с условиями, где администратор выбирает поля через ПолеКомпоновкиДанных.

---

## 2. Контекст и цели

### Проблема (AS-IS)

- В функции `ПолучитьКлассМенюПозиции()` модуля `MRS_ИнтеграцияSimphonyСервер` (строки 1680-1687) отсутствует логика определения `menuItemClass`
- Значение `menuItemClass` жестко закодировано константой 1001 в коде (строка 769)
- API Simphony требует разные значения `menuItemClass` в зависимости от характеристик товара
- Невозможно гибко управлять классами меню без изменения кода

### Цели (TO-BE)

1. Создать механизм гибкого определения класса меню через настраиваемые условия
2. Не использовать перечисления (упрощенный подход)
3. Использовать ПолеКомпоновкиДанных для выбора полей выборки
4. Обеспечить приоритизацию правил
5. Интегрировать в существующий процесс выгрузки

### Non-goals

- ❌ Создание перечислений
- ❌ Сложные списки выбора с фильтрацией
- ❌ Логика ИЛИ между условиями (только И)
- ❌ История применения классов

---

## 3. Структура данных

### 3.1. Справочник MRS_КлассыМеню (дополнения)

**Текущее состояние:**
- ✅ Реквизит `КодКлассаСимфони`: Число(5, 0)
- ✅ Реквизит `Описание`: Строка неограниченная
- ✅ Табличная часть `Условия`: пустая

**Что добавить:**

#### Реквизиты шапки:

| Имя | Тип | Значение по умолчанию | Описание |
|---|---|---|---|
| `ПриоритетПрименения` | Число(5, 0) | 100 | Порядок проверки классов (меньше = выше приоритет) |

#### Реквизиты табличной части Условия:

| Имя | Тип | Обязательность | Описание |
|---|---|---|---|
| `ВидУсловия` | Строка(100) | Да | Путь к полю компоновки (например, "СтавкаНДС", "МернаяЕдиницаИзмерения") |
| `Оператор` | Строка(50) | Да | Оператор сравнения: "Равно", "НеРавно", "Больше", "Меньше", "Содержит", "Заполнено" и т.д. |
| `Значение` | Характеристика | Зависит от оператора | Универсальное поле для хранения числа/строки/булево/ссылки |

**Типы для Характеристики Значение:**
- Строка(150)
- Число(15, 2)
- Булево
- СправочникСсылка.Номенклатура
- СправочникСсылка.УпаковкиЕдиницыИзмерения
- СправочникСсылка.ГруппыАналитическогоУчетаНоменклатуры

---

## 4. Форма элемента справочника

### 4.1. Основная информация (шапка)

- **Наименование** (автоматическое поле)
- **КодКлассаСимфони** (число, подсказка: "Код класса меню в Simphony API")
- **ПриоритетПрименения** (число, подсказка: "Чем меньше число, тем выше приоритет")
- **Описание** (многострочное текстовое поле)

### 4.2. Табличная часть "Условия"

**Колонки:**

1. **ВидУсловия** — ПолеКомпоновкиДанных
   - Схема компоновки создается программно в `ПриСозданииНаСервере()`
   - Доступные поля:
     - СтавкаНДС (Число)
     - МернаяЕдиницаИзмерения (Булево)
     - СвободнаяЦена (Булево)
     - ЕдиницаИзмерения (СправочникСсылка)
     - Номенклатура (СправочникСсылка)
   - Сохраняется как строка с путем к полю

2. **Оператор** — ПолеВыбора
   - СписокВыбора инициализируется в `ПриСозданииНаСервере()`
   - Доступные значения:
     - "Равно"
     - "НеРавно"
     - "Больше"
     - "БольшеИлиРавно"
     - "Меньше"
     - "МеньшеИлиРавно"
     - "Содержит"
     - "НеСодержит"
     - "Заполнено"
     - "НеЗаполнено"

3. **Значение** — ПолеВвода
   - Тип: Характеристика (универсальное поле)
   - Может содержать число, строку, булево или ссылку
   - Не обязательно для операторов "Заполнено" и "НеЗаполнено"

### 4.3. Код формы (ПриСозданииНаСервере)

```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Создание схемы компоновки данных для выбора полей
	СоздатьСхемуКомпоновки();
	
	// Заполнение списка выбора для операторов
	ЗаполнитьСписокОператоров();
	
КонецПроцедуры

&НаСервере
Процедура СоздатьСхемуКомпоновки()
	
	СхемаКД = Новый СхемаКомпоновкиДанных;
	
	// Набор данных
	НаборДанных = СхемаКД.НаборыДанных.Добавить(Тип("НаборДанныхОбъектСхемыКомпоновкиДанных"));
	НаборДанных.Имя = "НаборДанных1";
	
	// Добавляем поля
	
	// СтавкаНДС
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "СтавкаНДС";
	Поле.ТипЗначения = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2));
	Поле.Заголовок = "Ставка НДС";
	
	// МернаяЕдиницаИзмерения
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "МернаяЕдиницаИзмерения";
	Поле.ТипЗначения = Новый ОписаниеТипов("Булево");
	Поле.Заголовок = "Мерная единица измерения";
	
	// СвободнаяЦена
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "СвободнаяЦена";
	Поле.ТипЗначения = Новый ОписаниеТипов("Булево");
	Поле.Заголовок = "Свободная цена";
	
	// ЕдиницаИзмерения
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "ЕдиницаИзмерения";
	Поле.ТипЗначения = Новый ОписаниеТипов("СправочникСсылка.УпаковкиЕдиницыИзмерения");
	Поле.Заголовок = "Единица измерения";
	
	// Номенклатура
	Поле = НаборДанных.Поля.Добавить(Тип("ПолеНаборДанныхСхемыКомпоновкиДанных"));
	Поле.Поле = "Номенклатура";
	Поле.ТипЗначения = Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
	Поле.Заголовок = "Номенклатура";
	
	// Сохраняем схему в реквизите формы
	АдресСхемыКД = ПоместитьВоВременноеХранилище(СхемаКД, УникальныйИдентификатор);
	
	// Устанавливаем схему для поля компоновки в табличной части
	Элементы.УсловияВидУсловия.ДоступныеТипы = Новый СхемаКомпоновкиДанных;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСписокОператоров()
	
	СписокОператоров = Элементы.УсловияОператор.СписокВыбора;
	СписокОператоров.Очистить();
	
	СписокОператоров.Добавить("Равно");
	СписокОператоров.Добавить("НеРавно");
	СписокОператоров.Добавить("Больше");
	СписокОператоров.Добавить("БольшеИлиРавно");
	СписокОператоров.Добавить("Меньше");
	СписокОператоров.Добавить("МеньшеИлиРавно");
	СписокОператоров.Добавить("Содержит");
	СписокОператоров.Добавить("НеСодержит");
	СписокОператоров.Добавить("Заполнено");
	СписокОператоров.Добавить("НеЗаполнено");
	
КонецПроцедуры
```

---

## 5. Модуль объекта справочника

### 5.1. Валидация (ПередЗаписью)

```bsl
Процедура ПередЗаписью(Отказ)
	
	// Проверка уникальности КодКлассаСимфони
	Если ЗначениеЗаполнено(КодКлассаСимфони) Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	1 КАК Поле1
			|ИЗ
			|	Справочник.MRS_КлассыМеню КАК КлассыМеню
			|ГДЕ
			|	КлассыМеню.КодКлассаСимфони = &КодКлассаСимфони
			|	И КлассыМеню.Ссылка <> &ТекущаяСсылка";
		
		Запрос.УстановитьПараметр("КодКлассаСимфони", КодКлассаСимфони);
		Запрос.УстановитьПараметр("ТекущаяСсылка", Ссылка);
		
		Если НЕ Запрос.Выполнить().Пустой() Тогда
			ТекстСообщения = "Код класса Симфони должен быть уникальным!";
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "КодКлассаСимфони", , Отказ);
		КонецЕсли;
		
	КонецЕсли;
	
	// Проверка заполнения реквизитов ТЧ Условия
	НомерСтроки = 0;
	Для Каждого СтрокаУсловия Из Условия Цикл
		
		НомерСтроки = НомерСтроки + 1;
		ПрефиксПути = "Объект.Условия[" + Формат(НомерСтроки - 1, "ЧГ=0") + "].";
		
		Если НЕ ЗначениеЗаполнено(СтрокаУсловия.ВидУсловия) Тогда
			ТекстСообщения = СтрШаблон("Не заполнен Вид Условия в строке %1", НомерСтроки);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , ПрефиксПути + "ВидУсловия", , Отказ);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаУсловия.Оператор) Тогда
			ТекстСообщения = СтрШаблон("Не заполнен Оператор в строке %1", НомерСтроки);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , ПрефиксПути + "Оператор", , Отказ);
		КонецЕсли;
		
		// Для операторов "Заполнено" и "НеЗаполнено" значение не требуется
		Если НЕ ЗначениеЗаполнено(СтрокаУсловия.Значение) 
			И СтрокаУсловия.Оператор <> "Заполнено" 
			И СтрокаУсловия.Оператор <> "НеЗаполнено" Тогда
			ТекстСообщения = СтрШаблон("Не заполнено Значение в строке %1", НомерСтроки);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , ПрефиксПути + "Значение", , Отказ);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры
```

---

## 6. Модуль менеджера справочника

### 6.1. Функция определения класса меню

```bsl
// Определяет класс меню по данным позиции
//
// Параметры:
//  ДанныеПозиции - Структура - данные позиции меню для проверки условий
//    * СтавкаНДС - Число
//    * МернаяЕдиницаИзмерения - Булево
//    * СвободнаяЦена - Булево
//    * ЕдиницаИзмерения - СправочникСсылка.УпаковкиЕдиницыИзмерения
//    * Номенклатура - СправочникСсылка.Номенклатура
//    * Наименование - Строка (для сообщений об ошибке)
//
// Возвращаемое значение:
//  Число - код класса меню для Simphony
//
Функция ОпределитьКлассМенюПоДанным(ДанныеПозиции) Экспорт
	
	// Получаем все элементы справочника, упорядоченные по приоритету
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КлассыМеню.Ссылка КАК Ссылка,
		|	КлассыМеню.КодКлассаСимфони КАК КодКлассаСимфони,
		|	КлассыМеню.Наименование КАК Наименование
		|ИЗ
		|	Справочник.MRS_КлассыМеню КАК КлассыМеню
		|ГДЕ
		|	НЕ КлассыМеню.ПометкаУдаления
		|
		|УПОРЯДОЧИТЬ ПО
		|	КлассыМеню.ПриоритетПрименения";
	
	ВыборкаКлассов = Запрос.Выполнить().Выбрать();
	
	// Проверяем каждый класс по порядку приоритета
	Пока ВыборкаКлассов.Следующий() Цикл
		
		// Проверяем все условия для текущего класса
		Если ПроверитьВсеУсловияКласса(ВыборкаКлассов.Ссылка, ДанныеПозиции) Тогда
			Возврат ВыборкаКлассов.КодКлассаСимфони;
		КонецЕсли;
		
	КонецЦикла;
	
	// Если ни один класс не подошел - ошибка
	НаименованиеПозиции = "";
	Если ДанныеПозиции.Свойство("Наименование", НаименованиеПозиции) Тогда
		ТекстОшибки = СтрШаблон(
			"Не удалось определить класс меню для позиции ""%1"". Проверьте настройки справочника MRS_КлассыМеню.",
			НаименованиеПозиции
		);
	Иначе
		ТекстОшибки = "Не удалось определить класс меню. Проверьте настройки справочника MRS_КлассыМеню.";
	КонецЕсли;
	
	ВызватьИсключение ТекстОшибки;
	
КонецФункции

// Проверяет все условия для конкретного класса меню
//
// Параметры:
//  СсылкаКласса - СправочникСсылка.MRS_КлассыМеню
//  ДанныеПозиции - Структура
//
// Возвращаемое значение:
//  Булево - Истина, если ВСЕ условия выполнены
//
Функция ПроверитьВсеУсловияКласса(СсылкаКласса, ДанныеПозиции)
	
	// Получаем все условия для класса
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Условия.ВидУсловия КАК ВидУсловия,
		|	Условия.Оператор КАК Оператор,
		|	Условия.Значение КАК Значение
		|ИЗ
		|	Справочник.MRS_КлассыМеню.Условия КАК Условия
		|ГДЕ
		|	Условия.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаКласса);
	
	ВыборкаУсловий = Запрос.Выполнить().Выбрать();
	
	// Если нет условий - класс подходит всегда (для класса по умолчанию)
	Если ВыборкаУсловий.Количество() = 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Проверяем каждое условие (логика И - все должны быть истиной)
	Пока ВыборкаУсловий.Следующий() Цикл
		
		// Получаем значение поля из данных позиции
		Если НЕ ДанныеПозиции.Свойство(ВыборкаУсловий.ВидУсловия) Тогда
			// Если поле не найдено - условие не выполнено
			Возврат Ложь;
		КонецЕсли;
		
		ЗначениеПоля = ДанныеПозиции[ВыборкаУсловий.ВидУсловия];
		
		// Выполняем сравнение
		Если НЕ ВыполнитьСравнение(ЗначениеПоля, ВыборкаУсловий.Оператор, ВыборкаУсловий.Значение) Тогда
			// Если хотя бы одно условие не выполнено - класс не подходит
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	// Все условия выполнены
	Возврат Истина;
	
КонецФункции

// Выполняет сравнение значения с эталоном по заданному оператору
//
// Параметры:
//  ЗначениеПоля - Произвольный - значение из данных позиции
//  Оператор - Строка - оператор сравнения
//  ЗначениеУсловия - Произвольный - эталонное значение из условия
//
// Возвращаемое значение:
//  Булево - результат сравнения
//
Функция ВыполнитьСравнение(ЗначениеПоля, Оператор, ЗначениеУсловия)
	
	Если Оператор = "Равно" Тогда
		Возврат ЗначениеПоля = ЗначениеУсловия;
		
	ИначеЕсли Оператор = "НеРавно" Тогда
		Возврат ЗначениеПоля <> ЗначениеУсловия;
		
	ИначеЕсли Оператор = "Больше" Тогда
		Возврат ЗначениеПоля > ЗначениеУсловия;
		
	ИначеЕсли Оператор = "БольшеИлиРавно" Тогда
		Возврат ЗначениеПоля >= ЗначениеУсловия;
		
	ИначеЕсли Оператор = "Меньше" Тогда
		Возврат ЗначениеПоля < ЗначениеУсловия;
		
	ИначеЕсли Оператор = "МеньшеИлиРавно" Тогда
		Возврат ЗначениеПоля <= ЗначениеУсловия;
		
	ИначеЕсли Оператор = "Содержит" Тогда
		Попытка
			Возврат СтрНайти(Строка(ЗначениеПоля), Строка(ЗначениеУсловия)) > 0;
		Исключение
			Возврат Ложь;
		КонецПопытки;
		
	ИначеЕсли Оператор = "НеСодержит" Тогда
		Попытка
			Возврат СтрНайти(Строка(ЗначениеПоля), Строка(ЗначениеУсловия)) = 0;
		Исключение
			Возврат Ложь;
		КонецПопытки;
		
	ИначеЕсли Оператор = "Заполнено" Тогда
		Возврат ЗначениеЗаполнено(ЗначениеПоля);
		
	ИначеЕсли Оператор = "НеЗаполнено" Тогда
		Возврат НЕ ЗначениеЗаполнено(ЗначениеПоля);
		
	Иначе
		ВызватьИсключение СтрШаблон("Неизвестный оператор сравнения: ""%1""", Оператор);
		
	КонецЕсли;
	
КонецФункции
```

---

## 7. Интеграция с модулем MRS_ИнтеграцияSimphonyСервер

### 7.1. Обновление функции ПолучитьКлассМенюПозиции()

**Текущий код (строки 1680-1687):**
```bsl
Функция ПолучитьКлассМенюПозиции(Выборка) Экспорт
	
	// проверить 
	//ЭтоМернаяЕдиница = Справочники.УпаковкиЕдиницыИзмерения.ЭтоМернаяЕдиница(Выборка.ЕдиницаИзмерения);
	//СтавкаНДС = Выборка.MRS_СтавкаНДС;
	
	//Выборка.НоменклатурапитПродажаПоСвободнойЦене
КонецФункции
```

**Новый код:**
```bsl
Функция ПолучитьКлассМенюПозиции(Выборка) Экспорт
	
	// Вычисляем признак мерной единицы
	ЭтоМернаяЕдиница = Справочники.УпаковкиЕдиницыИзмерения.ЭтоМернаяЕдиница(Выборка.ЕдиницаИзмерения);
	
	// Формируем структуру данных для проверки условий
	ДанныеПозиции = Новый Структура;
	ДанныеПозиции.Вставить("СтавкаНДС", Выборка.MRS_СтавкаНДС);
	ДанныеПозиции.Вставить("МернаяЕдиницаИзмерения", ЭтоМернаяЕдиница);
	ДанныеПозиции.Вставить("СвободнаяЦена", Выборка.НоменклатурапитПродажаПоСвободнойЦене);
	ДанныеПозиции.Вставить("ЕдиницаИзмерения", Выборка.ЕдиницаИзмерения);
	ДанныеПозиции.Вставить("Номенклатура", Выборка.Номенклатура);
	ДанныеПозиции.Вставить("Наименование", Выборка.Наименование); // Для сообщений об ошибке
	
	// Получаем класс меню через менеджер справочника
	Попытка
		КлассМеню = Справочники.MRS_КлассыМеню.ОпределитьКлассМенюПоДанным(ДанныеПозиции);
		Возврат КлассМеню;
	Исключение
		ТекстОшибки = СтрШаблон(
			"Не удалось определить класс меню для позиции ""%1"". %2",
			Выборка.Наименование,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())
		);
		ВызватьИсключение ТекстОшибки;
	КонецПопытки;
	
КонецФункции
```

---

## 8. Предопределенный элемент

**Создать в конфигурации:**

**Имя предопределенного:** `ПоУмолчанию`

**Свойства:**
- Наименование: "По умолчанию"
- КодКлассаСимфони: 1001
- ПриоритетПрименения: 999
- Описание: "Класс меню по умолчанию, используется если ни один другой класс не подошел"

**Табличная часть Условия:** _пустая_ (без условий)

---

## 9. Примеры настройки классов

### Пример 1: Алкоголь мерный с НДС 20%

**Элемент справочника:**
- Наименование: "Алкоголь мерный НДС 20%"
- КодКлассаСимфони: 1002
- ПриоритетПрименения: 10
- Описание: "Алкогольная продукция с мерной единицей измерения и ставкой НДС 20%"

**Табличная часть Условия:**

| ВидУсловия | Оператор | Значение |
|---|---|---|
| МернаяЕдиницаИзмерения | Равно | Истина |
| СтавкаНДС | Равно | 20 |

---

### Пример 2: Товары со свободной ценой

**Элемент справочника:**
- Наименование: "Свободная цена"
- КодКлассаСимфони: 1003
- ПриоритетПрименения: 20
- Описание: "Товары с произвольной ценой, устанавливаемой кассиром"

**Табличная часть Условия:**

| ВидУсловия | Оператор | Значение |
|---|---|---|
| СвободнаяЦена | Равно | Истина |

---

### Пример 3: Товары с НДС больше 10%

**Элемент справочника:**
- Наименование: "НДС выше 10%"
- КодКлассаСимфони: 1004
- ПриоритетПрименения: 30

**Табличная часть Условия:**

| ВидУсловия | Оператор | Значение |
|---|---|---|
| СтавкаНДС | Больше | 10 |

---

## 10. Доступные поля для условий

| Имя поля (ВидУсловия) | Тип данных | Источник | Описание |
|---|---|---|---|
| СтавкаНДС | Число | Выборка.MRS_СтавкаНДС | Ставка НДС позиции меню |
| МернаяЕдиницаИзмерения | Булево | Вычисляется функцией | Признак мерной единицы измерения |
| СвободнаяЦена | Булево | Выборка.НоменклатурапитПродажаПоСвободнойЦене | Признак свободной цены |
| ЕдиницаИзмерения | Ссылка | Выборка.ЕдиницаИзмерения | Единица измерения позиции |
| Номенклатура | Ссылка | Выборка.Номенклатура | Номенклатура позиции |

**Расширяемость:** Список может дополняться новыми полями путем:
1. Добавления поля в структуру `ДанныеПозиции` в функции `ПолучитьКлассМенюПозиции()`
2. Добавления поля в схему компоновки в форме элемента

---

## 11. Поддерживаемые операторы

| Оператор | Применимость | Пример использования |
|---|---|---|
| Равно | Все типы | СтавкаНДС = 20 |
| НеРавно | Все типы | МернаяЕдиницаИзмерения <> Истина |
| Больше | Число | СтавкаНДС > 10 |
| БольшеИлиРавно | Число | СтавкаНДС >= 10 |
| Меньше | Число | СтавкаНДС < 20 |
| МеньшеИлиРавно | Число | СтавкаНДС <= 20 |
| Содержит | Строка | Наименование содержит "Водка" |
| НеСодержит | Строка | Наименование не содержит "Пиво" |
| Заполнено | Все типы | ЕдиницаИзмерения заполнена |
| НеЗаполнено | Все типы | ЕдиницаИзмерения не заполнена |

---

## 12. Логика работы

### Алгоритм определения класса меню:

1. **Получение классов:** Выбираются все элементы справочника `MRS_КлассыМеню`, упорядоченные по `ПриоритетПрименения` (ASC)

2. **Проверка условий:** Для каждого класса последовательно:
   - Читается табличная часть `Условия`
   - Для каждого условия:
     - Извлекается значение поля из `ДанныеПозиции` по `ВидУсловия`
     - Выполняется сравнение по `Оператор` с `Значение`
   - Если **ВСЕ** условия выполнены (логика И) → возвращается `КодКлассаСимфони`

3. **Fallback:** Если ни один класс не подошел → генерируется исключение

4. **Класс по умолчанию:** Предопределенный элемент без условий с низким приоритетом (999) срабатывает если ничего не подошло

---

## 13. Тестовые сценарии

### Сценарий 1: Определение класса для мерного алкоголя

**Дано:**
- Позиция: Водка 0,5л
- МернаяЕдиницаИзмерения = Истина
- СтавкаНДС = 20
- В справочнике есть класс 1002 с приоритетом 10 и условиями:
  - МернаяЕдиницаИзмерения = Истина
  - СтавкаНДС = 20

**Ожидаемый результат:** Возвращается 1002

---

### Сценарий 2: Определение класса по умолчанию

**Дано:**
- Позиция: Хлеб
- МернаяЕдиницаИзмерения = Ложь
- СтавкаНДС = 10
- Ни один специфичный класс не подходит
- Есть предопределенный элемент "ПоУмолчанию" (код 1001, приоритет 999) без условий

**Ожидаемый результат:** Возвращается 1001

---

### Сценарий 3: Приоритет классов

**Дано:**
- Позиция: Коньяк
- МернаяЕдиницаИзмерения = Истина
- СтавкаНДС = 20
- Класс A (приоритет 10): МернаяЕдиницаИзмерения = Истина
- Класс B (приоритет 20): МернаяЕдиницаИзмерения = Истина И СтавкаНДС = 20

**Ожидаемый результат:** Возвращается класс A (проверяется первым)

---

## 14. План реализации

### Этап 1: Метаданные справочника
- [ ] Добавить реквизит `ПриоритетПрименения` к справочнику
- [ ] Добавить реквизиты в ТЧ `Условия`: `ВидУсловия`, `Оператор`, `Значение`

### Этап 2: Модуль объекта
- [ ] Реализовать процедуру `ПередЗаписью()` с валидацией

### Этап 3: Модуль менеджера
- [ ] Реализовать функцию `ОпределитьКлассМенюПоДанным()`
- [ ] Реализовать функцию `ПроверитьВсеУсловияКласса()`
- [ ] Реализовать функцию `ВыполнитьСравнение()`

### Этап 4: Форма элемента
- [ ] Создать форму элемента
- [ ] Реализовать процедуру `СоздатьСхемуКомпоновки()`
- [ ] Реализовать процедуру `ЗаполнитьСписокОператоров()`

### Этап 5: Предопределенные элементы
- [ ] Создать предопределенный элемент `ПоУмолчанию`

### Этап 6: Интеграция
- [ ] Обновить функцию `ПолучитьКлассМенюПозиции()` в модуле `MRS_ИнтеграцияSimphonyСервер`

### Этап 7: Тестирование
- [ ] Создать тестовые классы меню
- [ ] Протестировать определение класса для разных типов позиций
- [ ] Проверить приоритизацию
- [ ] Проверить класс по умолчанию

---

## 15. Преимущества упрощенного подхода

✅ **Нет перечислений** — меньше объектов метаданных  
✅ **Гибкость** — легко добавлять новые поля без изменения конфигурации  
✅ **Удобство** — ПолеКомпоновкиДанных для выбора полей  
✅ **Читаемость** — понятные строковые значения  
✅ **Простота** — меньше кода, проще поддержка  

⚠️ **Недостаток:** Нет защиты от опечаток в именах полей (но это решается схемой компоновки)

---

## 16. Зависимости

### Существующие объекты:
- `Справочник.УпаковкиЕдиницыИзмерения` + функция `.ЭтоМернаяЕдиница()`
- `Справочник.питМеню` + реквизиты
- `Справочник.Номенклатура`
- `ОбщийМодуль.MRS_ИнтеграцияSimphonyСервер`

### Новые объекты:
- Дополнения к `Справочник.MRS_КлассыМеню`
- Модуль объекта справочника
- Модуль менеджера справочника
- Форма элемента справочника
- Предопределенный элемент

---

**Документ готов к реализации.**
