////////////////////////////////////////////////////////////////////////////////
// Форма документа "Установка цен номенклатуры"
//
// Интеграция с ЕЛМА:
//   - Отправка документа в систему ЕЛМА для согласования
//   - Отображение статуса процесса согласования
//   - Автоматическое открытие формы параметров приказа при проведении
//
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//>> Швецов. ERP-XXXX. 19.11.25. Интеграция с ЕЛМА
	
	// Инициализация интеграции с ЕЛМА через общий модуль
	MRS_ИнтеграцияЕЛМАКлиентСервер.ПриСозданииНаСервере(ЭтотОбъект, Отказ, СтандартнаяОбработка);
	
	//<<
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Обновление видимости элементов интеграции ЕЛМА
	ОбновитьВидимостьЭлементовЕЛМА();
	
	// Подключение автообновления статуса если документ в процессе согласования
	Если ЗначениеЗаполнено(УИДЕЛМА) И ТребуетсяАвтообновлениеСтатусаЕЛМА() Тогда
		ПодключитьОбработчикОжидания("Подключаемый_ОбновитьСтатусЕЛМА", 30);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	//>> Швецов. ERP-XXXX. 19.11.25. Интеграция с ЕЛМА
	
	// Проверка необходимости отправки в ЕЛМА при проведении
	Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		
		// Проверяем, требуется ли отправка в ЕЛМА
		Если MRS_ИнтеграцияЕЛМАСервер.ТребуетсяОтправкаВЕЛМА(ТекущийОбъект) Тогда
			
			// Проверка, не отправлялся ли документ ранее
			СтатусДокумента = MRS_ИнтеграцияЕЛМАСервер.ПолучитьСтатусДокумента(Объект.Ссылка);
			
			// Если документ новый или был отклонен, нужна отправка
			Если СтатусДокумента = Неопределено 
				ИЛИ СтатусДокумента.Статус = Перечисления.MRS_СтатусыСинхронизацииЕЛМА.Отклонен Тогда
				
				// Документ будет отправлен после проведения через форму параметров
				ПараметрыЗаписи.Вставить("ТребуетсяОткрытьФормуПараметровЕЛМА", Истина);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	//<<
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	//>> Швецов. ERP-XXXX. 19.11.25. Интеграция с ЕЛМА
	
	// Если после записи нужно открыть форму параметров ЕЛМА
	Если ПараметрыЗаписи.Свойство("ТребуетсяОткрытьФормуПараметровЕЛМА") 
		И ПараметрыЗаписи.ТребуетсяОткрытьФормуПараметровЕЛМА Тогда
		
		// Открываем форму параметров приказа
		ОткрытьФормуПараметровПриказаЕЛМА();
		
	КонецЕсли;
	
	//<<
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Подключаемый_КомандаОтправитьВЕЛМА(Команда)
	
	// Вызов клиентского модуля интеграции ЕЛМА
	MRS_ИнтеграцияЕЛМАКлиент.КомандаОтправитьВЕЛМА(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомандаОбновитьСтатусЕЛМА(Команда)
	
	// Вызов клиентского модуля интеграции ЕЛМА
	MRS_ИнтеграцияЕЛМАКлиент.КомандаОбновитьСтатусЕЛМА(ЭтотОбъект);
	
	// Обновление видимости элементов
	ОбновитьВидимостьЭлементовЕЛМА();
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПоказатьИсториюЕЛМА(Команда)
	
	// Открытие журнала интеграции ЕЛМА
	MRS_ИнтеграцияЕЛМАКлиент.ПоказатьИсториюИнтеграцииЕЛМА(Объект.Ссылка);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ИнтеграцияЕЛМА

&НаКлиенте
Процедура ОбновитьВидимостьЭлементовЕЛМА()
	
	// Обновление видимости и доступности элементов формы
	// В будущем можно добавить логику управления видимостью кнопок и групп
	
КонецПроцедуры

&НаКлиенте
Функция ТребуетсяАвтообновлениеСтатусаЕЛМА()
	
	// Проверка, нужно ли автоматически обновлять статус
	// Используем клиент-серверный модуль
	
	Возврат Ложь; // Пока отключено, можно включить позже
	
КонецФункции

&НаКлиенте
Процедура ОткрытьФормуПараметровПриказаЕЛМА()
	
	// Проверка, что документ записан
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		ПоказатьПредупреждение(, "Документ не записан");
		Возврат;
	КонецЕсли;
	
	// Открытие формы параметров приказа
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ДокументСсылка", Объект.Ссылка);
	
	ОповещениеОЗакрытии = Новый ОписаниеОповещения("ПослеВыбораПараметровПриказаЕЛМА", ЭтотОбъект);
	
	ОткрытьФорму(
		"ОбщаяФорма.MRS_ФормаПараметровПриказаЕЛМА",
		ПараметрыФормы,
		ЭтотОбъект,
		,
		,
		,
		ОповещениеОЗакрытии,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораПараметровПриказаЕЛМА(РезультатВыбора, ДополнительныеПараметры) Экспорт
	
	Если РезультатВыбора = Неопределено Тогда
		// Пользователь отменил отправку
		ПоказатьПредупреждение(, "Отправка в ЕЛМА отменена");
		Возврат;
	КонецЕсли;
	
	// Отправка документа в ЕЛМА
	Попытка
		
		Успех = ПоставитьДокументВОчередьЕЛМАНаСервере(РезультатВыбора);
		
		Если Успех Тогда
			
			ПоказатьОповещениеПользователя(
				"Документ отправлен в ЕЛМА",
				,
				"Документ поставлен в очередь на отправку в систему ЕЛМА для согласования",
				БиблиотекаКартинок.Информация32);
			
			// Обновление статуса на форме
			ЗагрузитьСтатусДокументаЕЛМАНаСервере();
			ОбновитьВидимостьЭлементовЕЛМА();
			
			// Подключение автообновления статуса
			ПодключитьОбработчикОжидания("Подключаемый_ОбновитьСтатусЕЛМА", 30);
			
		Иначе
			
			ПоказатьПредупреждение(, "Не удалось отправить документ в ЕЛМА. Подробности см. в журнале регистрации.");
			
		КонецЕсли;
		
	Исключение
		
		ПоказатьПредупреждение(, "Ошибка отправки документа в ЕЛМА: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Функция ПоставитьДокументВОчередьЕЛМАНаСервере(Знач ПараметрыПриказа)
	
	Возврат MRS_ИнтеграцияЕЛМАСервер.ПоставитьДокументВОчередьЕЛМА(Объект.Ссылка, ПараметрыПриказа);
	
КонецФункции

&НаСервере
Процедура ЗагрузитьСтатусДокументаЕЛМАНаСервере()
	
	// Загрузка статуса через клиент-серверный модуль
	MRS_ИнтеграцияЕЛМАКлиентСервер.ЗагрузитьСтатусДокумента(ЭтотОбъект);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

