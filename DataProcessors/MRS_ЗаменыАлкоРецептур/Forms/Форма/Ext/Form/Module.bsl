#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Инициализация значений по умолчанию
	ТолькоБезСоответствий = Истина;
		
КонецПроцедуры

&НаСервере
Процедура ПредзаполнитьСвязиРецептурНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	// Ищем пары рецептур через дополнительные реквизиты
	Запрос = Новый Запрос;
	
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтарыеРецептуры.Ссылка КАК СтараяРецептура,
		|	СтарыеРецептуры.Значение КАК НомерНовойРецептуры,
		|	СтарыеРецептуры.Ссылка.Наименование КАК НаименованиеСтарой,
		|	СтарыеРецептуры.Ссылка.Номер КАК НомерСтарой,
		|	СтарыеРецептуры.Ссылка.Подразделение КАК Подразделение
		|ИЗ
		|	Документ.питРецептура.ДополнительныеРеквизиты КАК СтарыеРецептуры
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.MRS_НеАктуальныеРецептуры КАК Неактуальные
		|		ПО СтарыеРецептуры.Ссылка = Неактуальные.Рецептура
		|ГДЕ
		|	СтарыеРецептуры.Свойство.Наименование = ""MRS_НоваяРецептура""
		|	И НЕ СтарыеРецептуры.Ссылка.ПометкаУдаления
		|	И СтарыеРецептуры.Ссылка В
		|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|				питРецептураИнгредиенты.Ссылка КАК Ссылка
		|			ИЗ
		|				Документ.питРецептура.Ингредиенты КАК питРецептураИнгредиенты
		|			ГДЕ
		|				питРецептураИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
		|				И питРецептураИнгредиенты.Номенклатура.АлкогольнаяПродукция)
		|	И НЕ СтарыеРецептуры.Ссылка.Наименование ПОДОБНО ""%_mrs%""
		|	И НЕ СтарыеРецептуры.Ссылка.Номенклатура.питПродажаПоСвободнойЦене
		|	И Неактуальные.Рецептура ЕСТЬ NULL
		|	&ГАУ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтарой";
	
	Если ЗначениеЗаполнено(ГАУ) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ГАУ","И СтарыеРецептуры.Ссылка.Номенклатура.ГруппаАналитическогоУчета = &ГАУ
		|			ИЛИ Неактуальные.Рецептура.Номенклатура.ГруппаАналитическогоУчета = &ГАУ");
		Запрос.УстановитьПараметр("ГАУ", ГАУ);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ГАУ","");
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	// Очищаем таблицу рецептур
	Рецептуры.Очистить();
	
	Пока Выборка.Следующий() Цикл
		
		СтрокаРецептуры = Рецептуры.Добавить();
		
		СтрокаРецептуры.РецептураСтарая = Выборка.СтараяРецептура;
		СтрокаРецептуры.НомерСтарой = Выборка.НомерСтарой;
		СтрокаРецептуры.Подразделение = Выборка.Подразделение;
		
		// Ищем новую рецептуру по номеру
		НоваяРецептура = Неопределено;
		НомерНовойРецептуры = СокрЛП(Выборка.НомерНовойРецептуры);
		
		Если НЕ ПустаяСтрока(НомерНовойРецептуры) Тогда
			ЗапросНовой = Новый Запрос;
			ЗапросНовой.Текст = 
				"ВЫБРАТЬ
				|	питРецептура.Ссылка КАК Ссылка,
				|	питРецептура.Наименование КАК Наименование,
				|	питРецептура.Номер КАК Номер
				|ИЗ
				|	Документ.питРецептура КАК питРецептура
				|ГДЕ
				|	питРецептура.Номер = &НомерНовойРецептуры
				|	И питРецептура.ДатаКонца = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
				|	И НЕ питРецептура.ПометкаУдаления";
			ЗапросНовой.УстановитьПараметр("НомерНовойРецептуры", НомерНовойРецептуры);
			
			РезультатЗапросаНовой = ЗапросНовой.Выполнить();
			ВыборкаНовой = РезультатЗапросаНовой.Выбрать();
			
			Если ВыборкаНовой.Следующий() Тогда
				НоваяРецептура = ВыборкаНовой.Ссылка;
			КонецЕсли;
		КонецЕсли;
		
		СтрокаРецептуры.РецептураНовая = НоваяРецептура;  
		Если ЗначениеЗаполнено(НоваяРецептура) Тогда
			СтрокаРецептуры.РецептураНоваяНомер = НоваяРецептура.Номер;
		Иначе
			СтрокаРецептуры.РецептураНоваяНомер = "";
		КонецЕсли;
		
		// Заполняем номенклатуру из старой рецептуры
		СписокСтаройНоменклатуры = Новый СписокЗначений;
		СписокСтаройНоменклатурыКод = Новый СписокЗначений;
		СписокНовойНоменклатуры = Новый СписокЗначений;
		СписокНовойНоменклатурыКод = Новый СписокЗначений;
		
		// Получаем ингредиенты старой рецептуры
		СтараяРецептураОбъект = Выборка.СтараяРецептура.ПолучитьОбъект();
		Для Каждого СтрокаИнгредиенты Из СтараяРецептураОбъект.Ингредиенты Цикл
			Если СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукция И СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
				СписокСтаройНоменклатуры.Добавить(СтрокаИнгредиенты.Номенклатура);
				СписокСтаройНоменклатурыКод.Добавить(СтрокаИнгредиенты.Номенклатура.Код);
			КонецЕсли;
		КонецЦикла;
		
		// Получаем ингредиенты новой рецептуры
		Если ЗначениеЗаполнено(НоваяРецептура) Тогда
			НоваяРецептураОбъект = НоваяРецептура.ПолучитьОбъект();
			Для Каждого СтрокаИнгредиенты Из НоваяРецептураОбъект.Ингредиенты Цикл
				Если СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукция Тогда
					СписокНовойНоменклатуры.Добавить(СтрокаИнгредиенты.Номенклатура);
					СписокНовойНоменклатурыКод.Добавить(СтрокаИнгредиенты.Номенклатура.Код);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		СтрокаРецептуры.НоменклатураСтарая = СписокСтаройНоменклатуры;
		СтрокаРецептуры.НоменклатураСтараяКод = СписокСтаройНоменклатурыКод;
		СтрокаРецептуры.НоменклатураНовая = СписокНовойНоменклатуры;
		СтрокаРецептуры.НоваяНоменклатураКод = СписокНовойНоменклатурыКод;
		
		// Статус - пустой, ошибки заполним позже при необходимости
		СтрокаРецептуры.СтрокаОшибки = "";
		
	КонецЦикла;
	
	// Выводим информацию о предзаполнении
	Если Рецептуры.Количество() > 0 Тогда
		Сообщить("Предзаполнено связей рецептур: " + Рецептуры.Количество());
	Иначе
		Сообщить("Связи рецептур не найдены. Используйте кнопку ""Получить рецептуры"" для создания новых.");
	КонецЕсли;
	
	ОбновитьДеревоРецептурНаСервере();
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПредзаполнение(Команда)
	
	ПредзаполнитьСвязиРецептурНаСервере(); 
	
КонецПроцедуры

#КонецОбласти

#Область Загрузка_Excel

&НаСервере
Процедура СоздатьНоменклатуруНаСервере()
	
	Запрос = Новый Запрос;

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПЛ_СоответствиеСФронтСистемами.Объект КАК НоменклатураВоВскрытойТаре,
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК КодКнопки,
	|	ПЛ_СоответствиеСФронтСистемами.Объект.Код КАК НоменклатураВоВскрытойТареКОД
	|ПОМЕСТИТЬ ВТ_Вскрытая
	|ИЗ
	|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.ТипОбъекта = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ПЛ_ТипыОбъектовФронтСистем.Номенклатура)
	|	И ПЛ_СоответствиеСФронтСистемами.ФронтСистема В(&ФронтСистема)
	|	И ПЛ_СоответствиеСФронтСистемами.Объект.АлкогольнаяПродукцияВоВскрытойТаре
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.ВидНоменклатуры В (&ВидНоменклатуры)
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.ВидАлкогольнойПродукции.Наименование ПОДОБНО &Наименование
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.Наименование ПОДОБНО &НаименованиеНеиспользовать
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СерийнаяНоменклатура,
	|	Номенклатура.Код КАК СерийнаяНоменклатураКод,
	|	ВТ_Вскрытая.НоменклатураВоВскрытойТаре КАК НоменклатураВоВскрытойТаре,
	|	ВТ_Вскрытая.КодКнопки КАК КодКнопки,
	|	ВТ_Вскрытая.НоменклатураВоВскрытойТареКОД КАК НоменклатураВоВскрытойТареКОД
	|ПОМЕСТИТЬ ВТ_Серийная
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Вскрытая КАК ВТ_Вскрытая
	|		ПО Номенклатура.ПЛ_НоменклатураВоВскрытойТаре = ВТ_Вскрытая.НоменклатураВоВскрытойТаре
	|ГДЕ
	|	Номенклатура.АлкогольнаяПродукция
	|	И НЕ Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
	|	И Номенклатура.ВидАлкогольнойПродукции.ВидЛицензии <> &ВидЛицензии
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Серийная.КодКнопки КАК КодКнопки,
	|	ВТ_Серийная.НоменклатураВоВскрытойТаре КАК НоменклатураВоВскрытойТаре,
	|	ВТ_Серийная.НоменклатураВоВскрытойТареКОД КАК НоменклатураВоВскрытойТареКОД,
	|	ВТ_Серийная.НоменклатураВоВскрытойТаре.Наименование КАК ИмяВскрытой,
	|	ВТ_Серийная.СерийнаяНоменклатураКод КАК СерийнаяНоменклатураКод,
	|	ВТ_Серийная.СерийнаяНоменклатура КАК СерийнаяНоменклатура,
	|	ВТ_Серийная.СерийнаяНоменклатура.Наименование КАК СерийнаяНоменклатураНаименование,
	|	ВТ_Серийная.СерийнаяНоменклатура.ОбъемДАЛ КАК ОбъемДАЛ,
	|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) КАК ВНаличииОстаток
	|ИЗ
	|	ВТ_Серийная КАК ВТ_Серийная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(&Дата) КАК ТоварыНаСкладахОстатки
	|		ПО (ВТ_Серийная.СерийнаяНоменклатура = ТоварыНаСкладахОстатки.Номенклатура)";

	// Установка значений параметров
	Запрос.УстановитьПараметр("ФронтСистема", Перечисления.ПЛ_ТипыФронтСистем.Micros);
	Запрос.УстановитьПараметр("НаименованиеНеиспользовать", "%не использовать%");
	Запрос.УстановитьПараметр("Наименование", "%ПИВ%");
	Запрос.УстановитьПараметр("Дата", ТекущаяДатаСеанса());
	// Параметр "ВидНоменклатуры" (Список значений)
	Параметр = Новый СписокЗначений;
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));// Готовая алкогольная продукция с ФСМ (помарочно) (Справочники.ВидыНоменклатуры)
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));// Готовая алкогольная продукция с ФСМ (Справочники.ВидыНоменклатуры)
	Запрос.УстановитьПараметр("ВидНоменклатуры", Параметр);
	Запрос.УстановитьПараметр("ВидЛицензии", Перечисления.ВидыЛицензийАлкогольнойПродукции.Пиво);
	РезультатЗапроса = Запрос.Выполнить();
	
	ТЗДляГруппировки = Новый ТаблицаЗначений;
	ТЗДляГруппировки.Колонки.Добавить("Наименование");
	ТЗДляГруппировки.Колонки.Добавить("ОбъемДАЛ", Новый ОписаниеТипов("Число"));
	ТЗДляГруппировки.Колонки.Добавить("НовоеНаименование");
	ТЗДляГруппировки.Колонки.Добавить("КодыСтаройНоменклатуры", Новый ОписаниеТипов("Строка"));
	ТЗДляГруппировки.Колонки.Добавить("КодыВскрытойНоменклатуры", Новый ОписаниеТипов("Строка"));
	ТЗДляГруппировки.Колонки.Добавить("ЕстьОстаток", Новый ОписаниеТипов("Булево"));
	ТЗДляГруппировки.Колонки.Добавить("ОбъектДляКопирования", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	
	Индекс = Новый Соответствие;
	СоответствиеСтараяКВскрытой = Новый Соответствие;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	// Создаем дополнительную структуру для номенклатуры без остатков
	ТЗДляОбновления = Новый ТаблицаЗначений;
	ТЗДляОбновления.Колонки.Добавить("СерийнаяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗДляОбновления.Колонки.Добавить("НоменклатураВоВскрытойТаре", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));

	Пока Выборка.Следующий() Цикл
		
		СоответствиеСтараяКВскрытой.Вставить(Выборка.СерийнаяНоменклатура, Выборка.НоменклатураВоВскрытойТаре);
		
		// Если остатка нет, добавляем в таблицу для обновления
		Если Выборка.ВНаличииОстаток = 0 Тогда
			СтрокаДляОбновления = ТЗДляОбновления.Добавить();
			СтрокаДляОбновления.СерийнаяНоменклатура = Выборка.СерийнаяНоменклатура;
			СтрокаДляОбновления.НоменклатураВоВскрытойТаре = Выборка.НоменклатураВоВскрытойТаре;
		Иначе
			// Обрабатываем номенклатуру с остатками как было раньше
			Если Выборка.ИмяВскрытой = NULL Тогда
				ИсходноеНаименование = Выборка.СерийнаяНоменклатураНаименование;
			Иначе
				ИсходноеНаименование = Выборка.ИмяВскрытой;
			КонецЕсли;
			
			Добавка = " [mrs]";
			МаксДлина = 150;
			МаксДлинаОсновной = МаксДлина - СтрДлина(Добавка);
			
			Если СтрДлина(ИсходноеНаименование) > МаксДлинаОсновной Тогда
				ИсходноеНаименование = Лев(ИсходноеНаименование, МаксДлинаОсновной);
			КонецЕсли;
			
			НовоеНаименование = ИсходноеНаименование + Добавка;
			
			НайденнаяСтрока = Индекс[НовоеНаименование];
			
			Если НайденнаяСтрока = Неопределено Тогда
				НайденнаяСтрока = ТЗДляГруппировки.Добавить();
				НайденнаяСтрока.НовоеНаименование = НовоеНаименование;
				НайденнаяСтрока.ОбъемДАЛ = Выборка.ОбъемДАЛ;
				НайденнаяСтрока.КодыСтаройНоменклатуры = "";
				НайденнаяСтрока.КодыВскрытойНоменклатуры = "";
				НайденнаяСтрока.ЕстьОстаток = Ложь;
				НайденнаяСтрока.ОбъектДляКопирования = Выборка.СерийнаяНоменклатура;
				Индекс.Вставить(НовоеНаименование, НайденнаяСтрока);
			КонецЕсли;
			
			// Агрегируем данные
			Если СтрНайти(НайденнаяСтрока.КодыСтаройНоменклатуры, Выборка.СерийнаяНоменклатураКод) = 0 Тогда
				НайденнаяСтрока.КодыСтаройНоменклатуры = ?(ПустаяСтрока(НайденнаяСтрока.КодыСтаройНоменклатуры),
					Выборка.СерийнаяНоменклатураКод,
					НайденнаяСтрока.КодыСтаройНоменклатуры + ";" + Выборка.СерийнаяНоменклатураКод);
			КонецЕсли;
			
			Если Выборка.КодКнопки <> NULL И СтрНайти(НайденнаяСтрока.КодыВскрытойНоменклатуры, Выборка.КодКнопки) = 0 Тогда
				НайденнаяСтрока.КодыВскрытойНоменклатуры = ?(ПустаяСтрока(НайденнаяСтрока.КодыВскрытойНоменклатуры),
					Выборка.КодКнопки,
					НайденнаяСтрока.КодыВскрытойНоменклатуры + ";" + Выборка.КодКнопки);
			КонецЕсли;
			
			Если Выборка.ВНаличииОстаток > 0 Тогда
				НайденнаяСтрока.ЕстьОстаток = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;

	// Сначала скорректируем все наименования
	Для Каждого СтрокаГруппы Из ТЗДляГруппировки Цикл
		СтрокаГруппы.НовоеНаименование = СкорректироватьНаименованиеПоОбъему(СтрокаГруппы.НовоеНаименование, СтрокаГруппы.ОбъемДАЛ);
	КонецЦикла;

	ЕдиницаИзмеренияЛитр = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("112");
	ЕдиницаИзмеренияШтуки = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("796"); 
	ЕдиницаИзмеренияМиллиЛитр = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("111");
	
	// Оптимизация: одним запросом найдем всю существующую номенклатуру по наименованию
	МассивНовыхНаименований = ТЗДляГруппировки.ВыгрузитьКолонку("НовоеНаименование");
	
	ЗапросПоиска = Новый Запрос;
	ЗапросПоиска.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК НоменклатураНоваяСсылка,
		|	Номенклатура.Код КАК НоменклатураНоваяКод,
		|	Номенклатура.Наименование КАК Наименование
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Наименование В(&МассивНаименований)";
	ЗапросПоиска.УстановитьПараметр("МассивНаименований", МассивНовыхНаименований);
	ТаблицаСуществующих = ЗапросПоиска.Выполнить().Выгрузить();
	
	СоответствиеСуществующих = Новый Соответствие;
	Для Каждого Строка Из ТаблицаСуществующих Цикл
		СоответствиеСуществующих.Вставить(Строка.Наименование, Новый Структура("Ссылка, Код", Строка.НоменклатураНоваяСсылка, Строка.НоменклатураНоваяКод));
	КонецЦикла;
	
	// ДОПОЛНИТЕЛЬНО: поиск уже созданной номенклатуры с тегом [mrs] для избежания дубликатов
	ЗапросУжеСозданных = Новый Запрос;
	ЗапросУжеСозданных.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК НоменклатураНоваяСсылка,
		|	Номенклатура.Код КАК НоменклатураНоваяКод,
		|	Номенклатура.Наименование КАК Наименование
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Наименование ПОДОБНО ""%[mrs]%""";
	
	ТаблицаУжеСозданных = ЗапросУжеСозданных.Выполнить().Выгрузить();
	
	// Дополняем соответствие уже созданными номенклатурами
	Для Каждого Строка Из ТаблицаУжеСозданных Цикл
		Если СоответствиеСуществующих[Строка.Наименование] = Неопределено Тогда
			СоответствиеСуществующих.Вставить(Строка.Наименование, Новый Структура("Ссылка, Код", Строка.НоменклатураНоваяСсылка, Строка.НоменклатураНоваяКод));
		КонецЕсли;
	КонецЦикла;
	
	// Выводим информацию о найденной существующей номенклатуре
	КоличествоСуществующей = СоответствиеСуществующих.Количество();
	Если КоличествоСуществующей > 0 Тогда
		Сообщить("Найдено уже существующей номенклатуры: " + КоличествоСуществующей + " из " + ТЗДляГруппировки.Количество() + ". Она не будет создаваться повторно.");
	КонецЕсли;

    // Оптимизация: одним запросом получим ссылки на старую номенклатуру
	УникальныеСтарыеКоды = Новый Соответствие;
	Для Каждого СтрокаГруппы Из ТЗДляГруппировки Цикл
		МассивКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");
		Для Каждого Код Из МассивКодов Цикл
			УникальныеСтарыеКоды.Вставить(Код, Истина);
		КонецЦикла;
	КонецЦикла;
	
	МассивКодовДляЗапроса = Новый Массив;
	Для Каждого Элемент Из УникальныеСтарыеКоды Цикл
		МассивКодовДляЗапроса.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	ЗапросСтарыхСсылок = Новый Запрос("ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Код КАК Код
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Код В (&Коды)");
	ЗапросСтарыхСсылок.УстановитьПараметр("Коды", МассивКодовДляЗапроса);
	ТаблицаСтарыхСсылок = ЗапросСтарыхСсылок.Выполнить().Выгрузить();
	
	СоответствиеСтарыхСсылок = Новый Соответствие;
	Для Каждого Строка Из ТаблицаСтарыхСсылок Цикл
		СоответствиеСтарыхСсылок.Вставить(Строка.Код, Строка.Ссылка);
	КонецЦикла;
	
	ТЗ_ЗаписиВРегистр = Новый ТаблицаЗначений;
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("СтараяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("НоваяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("ВскрытаяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));	
	// Создаем номенклатуру небольшими пакетами для избежания блокировок
	РазмерПакета = 10; // Обрабатываем по 10 элементов за раз
	ВсегоСтрок = ТЗДляГруппировки.Количество();
	КоличествоПакетов = Цел(ВсегоСтрок / РазмерПакета) + ?(ВсегоСтрок % РазмерПакета = 0, 0, 1);
	
	Сообщить("Начинаем создание номенклатуры. Всего к обработке: " + ВсегоСтрок + " элементов в " + КоличествоПакетов + " пакетах.");
	
	ОбщееКоличествоСозданных = 0;
	ОбщееКоличествоПропущенных = 0;
	
	Для НомерПакета = 0 По КоличествоПакетов - 1 Цикл
		
		НачальныйИндекс = НомерПакета * РазмерПакета;
		КонечныйИндекс = Мин((НомерПакета + 1) * РазмерПакета - 1, ВсегоСтрок - 1);
		
		КоличествоСозданныхВПакете = 0;
		КоличествоПропущенныхВПакете = 0;
		
		// Таблица записей только для текущего пакета
		ТЗ_ЗаписиВРегистрПакет = ТЗ_ЗаписиВРегистр.СкопироватьКолонки();
		
		НачатьТранзакцию();
		
		Попытка
		
			Для Индекс = НачальныйИндекс По КонечныйИндекс Цикл
				
				СтрокаГруппы = ТЗДляГруппировки[Индекс];
				
				СуществующаяНоменклатура = СоответствиеСуществующих[СтрокаГруппы.НовоеНаименование];
			
				Если СуществующаяНоменклатура = Неопределено Тогда
					
					КоличествоСозданныхВПакете = КоличествоСозданныхВПакете + 1;
					
					ОбъектСтарая = СтрокаГруппы.ОбъектДляКопирования.ПолучитьОбъект();
					
					НоваяНоменклатураОбъект = Справочники.Номенклатура.СоздатьЭлемент();
					
					НоваяНоменклатураОбъект.ОбменДанными.Загрузка = Истина;
					
					ЗаполнитьЗначенияСвойств(НоваяНоменклатураОбъект, ОбъектСтарая,,"Владелец, питВыгружатьВРБК, Код");
					
					НоваяНоменклатураОбъект.Наименование = СтрокаГруппы.НовоеНаименование;
					НоваяНоменклатураОбъект.НаименованиеПолное = СтрокаГруппы.НовоеНаименование;
					НоваяНоменклатураОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияЛитр.Ссылка;
					НоваяНоменклатураОбъект.ИспользоватьУпаковки = Истина;
					НоваяНоменклатураОбъект.НаборУпаковок = Справочники.НаборыУпаковок.ИндивидуальныйДляНоменклатуры;
					НоваяНоменклатураОбъект.Записать();
					
					УпаковкаОбъект = Справочники.УпаковкиЕдиницыИзмерения.СоздатьЭлемент();
					УпаковкаОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияШтуки;
					УпаковкаОбъект.ТипИзмеряемойВеличины = Перечисления.ТипыИзмеряемыхВеличин.Упаковка;
					УпаковкаОбъект.ТипУпаковки = Перечисления.ТипыУпаковокНоменклатуры.Конечная;
					УпаковкаОбъект.Числитель = НоваяНоменклатураОбъект.ОбъемДАЛ * 10;
					УпаковкаОбъект.Знаменатель = 1;
					УпаковкаОбъект.Владелец = НоваяНоменклатураОбъект.Ссылка;
					УпаковкаОбъект.Наименование = ЕдиницаИзмеренияШтуки.Наименование + " (" + СТРОКА(НоваяНоменклатураОбъект.ОбъемДАЛ * 10) + " " + ЕдиницаИзмеренияЛитр.Наименование + ")";
					УпаковкаОбъект.ОбменДанными.Загрузка = Истина;
					УпаковкаОбъект.Записать();
					
					НоваяНоменклатураОбъектДляОбновления = НоваяНоменклатураОбъект.Ссылка.ПолучитьОбъект();
					НоваяНоменклатураОбъектДляОбновления.ОбменДанными.Загрузка = Истина;
					НоваяНоменклатураОбъектДляОбновления.ЕдиницаДляОтчетов = УпаковкаОбъект.Ссылка;
					НоваяНоменклатураОбъектДляОбновления.КоэффициентЕдиницыДляОтчетов = НоваяНоменклатураОбъект.ОбъемДАЛ *10;
					
					НоваяНоменклатураОбъектДляОбновления.Записать();
					
					ДанныеНоменклатуры = Новый Структура();
					ДанныеНоменклатуры.Вставить("Номенклатура",                        НоваяНоменклатураОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("ЕмкостьПотребительскойУпаковки",      НоваяНоменклатураОбъект.ОбъемДАЛ * 10000);
					ДанныеНоменклатуры.Вставить("КоличествоВПотребительскойУпаковке",  НоваяНоменклатураОбъект.ОбъемДАЛ * 10);
					ДанныеНоменклатуры.Вставить("ВариантЧастичногоВыбытия",            Перечисления.ВариантыУчетаЧастичногоВыбытияИС.ТекущаяНоменклатура);
					ДанныеНоменклатуры.Вставить("ВариантИспользованияЕдиницыХранения", Перечисления.ВариантыИспользованияЕдиницыХраненияИС.ЗаданУпаковками);
					ДанныеНоменклатуры.Вставить("ПотребительскаяУпаковка",             УпаковкаОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("УпаковкаЧастичногоВыбытия",           ЕдиницаИзмеренияМиллиЛитр);
			
					РегистрыСведений.ОписаниеНоменклатурыИС.УстановитьОписание(ДанныеНоменклатуры);
					
					МассивСтарыхКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");

					Для Каждого Код Из МассивСтарыхКодов Цикл
						СсылкаНаСтарую = СоответствиеСтарыхСсылок[Код];
						Если СсылкаНаСтарую = Неопределено Тогда
							Продолжить;
						КонецЕсли;

						ВскрытаяСсылка = СоответствиеСтараяКВскрытой[СсылкаНаСтарую];
						
						НоваяСтрокаРегистра = ТЗ_ЗаписиВРегистрПакет.Добавить();
						НоваяСтрокаРегистра.СтараяНоменклатура = СсылкаНаСтарую;
						НоваяСтрокаРегистра.НоваяНоменклатура = НоваяНоменклатураОбъект.Ссылка;
						НоваяСтрокаРегистра.ВскрытаяНоменклатура = ВскрытаяСсылка;					
					КонецЦикла;
					 
				Иначе
					
					КоличествоПропущенныхВПакете = КоличествоПропущенныхВПакете + 1;
					
					СсылкаНаНовуюНоменклатуру = СуществующаяНоменклатура.Ссылка;
					
					ОбъектНовойНоменклатуры = СсылкаНаНовуюНоменклатуру.ПолучитьОбъект();
					ОбъектНовойНоменклатуры.ОбменДанными.Загрузка = Истина;
					
					ОбъектНовойНоменклатуры.Записать();
					
					МассивСтарыхКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");
					Для Каждого Код Из МассивСтарыхКодов Цикл
						СсылкаНаСтарую = СоответствиеСтарыхСсылок[Код];
						Если СсылкаНаСтарую = Неопределено Тогда
							Продолжить;
						КонецЕсли;

						ВскрытаяСсылка = СоответствиеСтараяКВскрытой[СсылкаНаСтарую];
						
						НоваяСтрокаРегистра = ТЗ_ЗаписиВРегистрПакет.Добавить();
						НоваяСтрокаРегистра.СтараяНоменклатура = СсылкаНаСтарую;
						НоваяСтрокаРегистра.НоваяНоменклатура = СсылкаНаНовуюНоменклатуру;
						НоваяСтрокаРегистра.ВскрытаяНоменклатура = ВскрытаяСсылка;
						
					КонецЦикла;
				
				КонецЕсли;
			
			КонецЦикла;

			ЗафиксироватьТранзакцию();
		
		Исключение
			// В случае ошибки откатываем транзакцию
			ОтменитьТранзакцию();
			Сообщить("Ошибка при создании номенклатуры (пакет " + (НомерПакета + 1) + " из " + КоличествоПакетов + "): " + ОписаниеОшибки());
			ВызватьИсключение "Ошибка при создании номенклатуры: " + ОписаниеОшибки();
		КонецПопытки;
		
		// Промежуточная запись в регистр после каждого пакета для возможности восстановления
		Если ТЗ_ЗаписиВРегистрПакет.Количество() > 0 Тогда
			
			// Записываем каждую запись отдельно через МенеджерЗаписи (избегаем дубликатов)
			Для Каждого СтрокаПакета Из ТЗ_ЗаписиВРегистрПакет Цикл
				
				МенеджерЗаписи = РегистрыСведений.MRS_СоответствиеСтаройНовойНоменклатуры.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.СтараяНоменклатура = СтрокаПакета.СтараяНоменклатура;
				МенеджерЗаписи.НоваяНоменклатура = СтрокаПакета.НоваяНоменклатура;
				МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаПакета.ВскрытаяНоменклатура; 
				МенеджерЗаписи.Записать();
				
			КонецЦикла;
			
			// Добавляем записи пакета в основную таблицу
			Для Каждого СтрокаПакета Из ТЗ_ЗаписиВРегистрПакет Цикл
				НоваяСтрокаОсновной = ТЗ_ЗаписиВРегистр.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрокаОсновной, СтрокаПакета);
			КонецЦикла;
			
		КонецЕсли;
		
		// Обновляем общую статистику
		ОбщееКоличествоСозданных = ОбщееКоличествоСозданных + КоличествоСозданныхВПакете;
		ОбщееКоличествоПропущенных = ОбщееКоличествоПропущенных + КоличествоПропущенныхВПакете;
		
		// Выводим детальный прогресс
		Процент = Окр((НомерПакета + 1) / КоличествоПакетов * 100, 0);
		СообщениеОПрогрессе = "Пакет " + (НомерПакета + 1) + "/" + КоличествоПакетов + " (" + Процент + "%): ";
		СообщениеОПрогрессе = СообщениеОПрогрессе + "создано " + КоличествоСозданныхВПакете + ", пропущено " + КоличествоПропущенныхВПакете;
		СообщениеОПрогрессе = СообщениеОПрогрессе + ". Итого: создано " + ОбщееКоличествоСозданных + ", пропущено " + ОбщееКоличествоПропущенных;
		Сообщить(СообщениеОПрогрессе);
		
	КонецЦикла;
	
	// Финальная проверка и запись оставшихся данных в регистр
	Сообщить("Итого записей в регистре соответствий будет записано: " + ТЗ_ЗаписиВРегистр.Количество());

	// Итоговое сообщение
	Сообщить("=== СОЗДАНИЕ НОМЕНКЛАТУРЫ ЗАВЕРШЕНО ===");
	Сообщить("Всего обработано: " + ВсегоСтрок + " элементов");
	Сообщить("Создано новых: " + ОбщееКоличествоСозданных);
	Сообщить("Пропущено (уже существовали): " + ОбщееКоличествоПропущенных);
	Сообщить("Записей в регистре соответствий: " + ТЗ_ЗаписиВРегистр.Количество());
	
	// Обработка номенклатуры без остатков - изменяем единицу хранения на литры и создаем упаковку
	Если ТЗДляОбновления.Количество() > 0 Тогда
		
		// Обрабатываем номенклатуру без остатков пакетами
		РазмерПакетаОбновления = 5; // Меньший размер пакета для операций обновления
		ВсегоСтрокОбновления = ТЗДляОбновления.Количество();
		КоличествоПакетовОбновления = Цел(ВсегоСтрокОбновления / РазмерПакетаОбновления) + ?(ВсегоСтрокОбновления % РазмерПакетаОбновления = 0, 0, 1);
		
		Для НомерПакетаОбновления = 0 По КоличествоПакетовОбновления - 1 Цикл
			
			НачальныйИндексОбновления = НомерПакетаОбновления * РазмерПакетаОбновления;
			КонечныйИндексОбновления = Мин((НомерПакетаОбновления + 1) * РазмерПакетаОбновления - 1, ВсегоСтрокОбновления - 1);
			
			НачатьТранзакцию();
			
			Попытка
				
				Для ИндексОбновления = НачальныйИндексОбновления По КонечныйИндексОбновления Цикл
					
					СтрокаДляОбновления = ТЗДляОбновления[ИндексОбновления];
					
					НоменклатураОбъект = СтрокаДляОбновления.СерийнаяНоменклатура.ПолучитьОбъект();
					
					// Изменяем единицу хранения остатков на литры
					НоменклатураОбъект.ЕдиницаХраненияОстатков = ЕдиницаИзмеренияЛитр.Ссылка;
					НоменклатураОбъект.ОбменДанными.Загрузка = Истина;
					// Записываем изменения
					НоменклатураОбъект.Записать();
					
					// Создаем упаковку
					УпаковкаОбъект = Справочники.УпаковкиЕдиницыИзмерения.СоздатьЭлемент();
					УпаковкаОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияШтуки;
					УпаковкаОбъект.ТипИзмеряемойВеличины = Перечисления.ТипыИзмеряемыхВеличин.Упаковка;
					УпаковкаОбъект.ТипУпаковки = Перечисления.ТипыУпаковокНоменклатуры.Конечная;
					УпаковкаОбъект.Числитель = НоменклатураОбъект.ОбъемДАЛ * 10;
					УпаковкаОбъект.Знаменатель = 1;
					УпаковкаОбъект.Владелец = НоменклатураОбъект.Ссылка;
					УпаковкаОбъект.Наименование = ЕдиницаИзмеренияШтуки.Наименование + " (" + СТРОКА(НоменклатураОбъект.ОбъемДАЛ * 10) + " " + ЕдиницаИзмеренияЛитр.Наименование + ")";
					УпаковкаОбъект.ОбменДанными.Загрузка = Истина;
					УпаковкаОбъект.Записать();
					
					// Обновляем номенклатуру с новой упаковкой
					НоменклатураОбъектДляОбновления = НоменклатураОбъект.Ссылка.ПолучитьОбъект();
					НоменклатураОбъектДляОбновления.ОбменДанными.Загрузка = Истина;
					НоменклатураОбъектДляОбновления.ЕдиницаДляОтчетов = УпаковкаОбъект.Ссылка;
					НоменклатураОбъектДляОбновления.КоэффициентЕдиницыДляОтчетов = НоменклатураОбъект.ОбъемДАЛ *10;
					НоменклатураОбъектДляОбновления.Записать();
					
					// Создаем описание для ИС
					ДанныеНоменклатуры = Новый Структура();
					ДанныеНоменклатуры.Вставить("Номенклатура", НоменклатураОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("ЕмкостьПотребительскойУпаковки", НоменклатураОбъект.ОбъемДАЛ * 10000);
					ДанныеНоменклатуры.Вставить("КоличествоВПотребительскойУпаковке", НоменклатураОбъект.ОбъемДАЛ * 10);
					ДанныеНоменклатуры.Вставить("ВариантЧастичногоВыбытия", Перечисления.ВариантыУчетаЧастичногоВыбытияИС.ТекущаяНоменклатура);
					ДанныеНоменклатуры.Вставить("ВариантИспользованияЕдиницыХранения", Перечисления.ВариантыИспользованияЕдиницыХраненияИС.ЗаданУпаковками);
					ДанныеНоменклатуры.Вставить("ПотребительскаяУпаковка", УпаковкаОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("УпаковкаЧастичногоВыбытия", ЕдиницаИзмеренияМиллиЛитр);
					
					РегистрыСведений.ОписаниеНоменклатурыИС.УстановитьОписание(ДанныеНоменклатуры);
					
				КонецЦикла;
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				// В случае ошибки откатываем транзакцию
				ОтменитьТранзакцию();
				Сообщить("Ошибка при обновлении номенклатуры без остатков (пакет " + (НомерПакетаОбновления + 1) + " из " + КоличествоПакетовОбновления + "): " + ОписаниеОшибки());
				ВызватьИсключение "Ошибка при обновлении номенклатуры без остатков: " + ОписаниеОшибки();
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьНоменклатуру(Команда)
	СоздатьНоменклатуруНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПолучитьРецептурыНаСервере()
	
	лТекст = "ВЫБРАТЬ
	         |	питРецептураИнгредиенты.Ссылка КАК Ссылка,
	         |	питРецептураИнгредиенты.Ссылка.Номер КАК Номер
	         |ИЗ
	         |	Документ.питРецептура.Ингредиенты КАК питРецептураИнгредиенты
	         |ГДЕ
	         |	питРецептураИнгредиенты.Ссылка.ДатаКонца = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	         |	И НЕ питРецептураИнгредиенты.Ссылка.ПометкаУдаления
	         |	И питРецептураИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
	         |	И питРецептураИнгредиенты.Номенклатура.АлкогольнаяПродукция
	         |	И НЕ питРецептураИнгредиенты.Ссылка.Номенклатура.питПродажаПоСвободнойЦене
	         |	И НЕ питРецептураИнгредиенты.Ссылка.Наименование ПОДОБНО ""%_mrs%""
	         |
	         |СГРУППИРОВАТЬ ПО
	         |	питРецептураИнгредиенты.Ссылка,
	         |	питРецептураИнгредиенты.Ссылка.Номер";

	лЗапрос = Новый Запрос(лТекст);
 
	РезультатЗапроса = лЗапрос.Выполнить();
	ТаблицаРецептов = РезультатЗапроса.Выгрузить();
	
	ВсегоРецептов = ТаблицаРецептов.Количество();
	Если ВсегоРецептов = 0 Тогда
		Сообщить("Рецептуры для обработки не найдены.");
		Возврат;
	КонецЕсли;
	
	// Настройки пакетной обработки
	РазмерПакета = 5; // Обрабатываем по 5 рецептур за раз для избежания переполнения tempdb
	КоличествоПакетов = Цел(ВсегоРецептов / РазмерПакета) + ?(ВсегоРецептов % РазмерПакета = 0, 0, 1);
	
	Сообщить("Начинаем обработку рецептур. Всего к обработке: " + ВсегоРецептов + " рецептур в " + КоличествоПакетов + " пакетах.");
	
	ОбщееКоличествоОбработанных = 0;
	ОбщееКоличествоОшибок = 0;
	
	// Обработка пакетами
	Для НомерПакета = 0 По КоличествоПакетов - 1 Цикл
		
		НачальныйИндекс = НомерПакета * РазмерПакета;
		КонечныйИндекс = Мин((НомерПакета + 1) * РазмерПакета - 1, ВсегоРецептов - 1);
		
		КоличествоОбработанныхВПакете = 0;
		КоличествоОшибокВПакете = 0;
		
		// Обрабатываем каждый пакет в отдельной транзакции
		НачатьТранзакцию();
		
		Попытка
			
			Для Индекс = НачальныйИндекс По КонечныйИндекс Цикл
				
				СтрокаТаблицы = ТаблицаРецептов[Индекс];
				
				Попытка
					
					СтрокаРецептуры = Рецептуры.Добавить();	
					
					СтрокаРецептуры.РецептураСтарая = СтрокаТаблицы.Ссылка;
					СтрокаРецептуры.НомерСтарой = СтрокаТаблицы.Номер;
					
					ТекРецептура = СтрокаТаблицы.Ссылка.ПолучитьОбъект();
					
					СписокНоменклатуры = Новый СписокЗначений;
					СписокНоменклатурыКоды = Новый СписокЗначений;
				
					Для Каждого СтрокаИнгредиенты Из ТекРецептура.Ингредиенты Цикл
						
						Если СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукция И СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
						
							СписокНоменклатуры.Добавить(СтрокаИнгредиенты.Номенклатура);	
							СписокНоменклатурыКоды.Добавить(СтрокаИнгредиенты.Номенклатура.Код);
							
						КонецЕсли;
						
					КонецЦикла;
					
					СтрокаРецептуры.НоменклатураСтарая = СписокНоменклатуры; 
					СтрокаРецептуры.НоменклатураСтараяКод = СписокНоменклатурыКоды;
					СтрокаРецептуры.Подразделение = ТекРецептура.Подразделение;
					
					СтруктураВозврата = НоваяРецептура(ТекРецептура);
					
					СтрокаРецептуры.НоменклатураНовая = СтруктураВозврата.СписокНовойНоменклатуры;
					СтрокаРецептуры.НоваяНоменклатураКод = СтруктураВозврата.СписокНовойНоменклатурыКод;
					СтрокаРецептуры.РецептураНовая = СтруктураВозврата.Документ;
					СтрокаРецептуры.РецептураНоваяНомер = СтруктураВозврата.НомерРецептуры;
					СтрокаРецептуры.СтрокаОшибки = СтруктураВозврата.ТекстОшибки;
					
					КоличествоОбработанныхВПакете = КоличествоОбработанныхВПакете + 1;
					
				Исключение
					
					// Логируем ошибку для конкретной рецептуры, но продолжаем обработку
					ТекстОшибкиРецептуры = "Ошибка при обработке рецептуры " + СтрокаТаблицы.Ссылка + ": " + ОписаниеОшибки();
					
					// Добавляем строку с ошибкой
					СтрокаРецептуры = Рецептуры.Добавить();
					СтрокаРецептуры.РецептураСтарая = СтрокаТаблицы.Ссылка;
					СтрокаРецептуры.НомерСтарой = СтрокаТаблицы.Номер;
					СтрокаРецептуры.СтрокаОшибки = ТекстОшибкиРецептуры;
					
					КоличествоОшибокВПакете = КоличествоОшибокВПакете + 1;
					
				КонецПопытки;
				
			КонецЦикла;
			
			// Фиксируем транзакцию для успешного пакета
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			// В случае критической ошибки пакета откатываем транзакцию
			ОтменитьТранзакцию();
			
			ТекстОшибки = "Критическая ошибка при обработке пакета " + (НомерПакета + 1) + " из " + КоличествоПакетов + ": " + ОписаниеОшибки();
			Сообщить(ТекстОшибки);
			
			// Добавляем информацию об ошибке для всех рецептур пакета
			Для Индекс = НачальныйИндекс По КонечныйИндекс Цикл
				СтрокаТаблицы = ТаблицаРецептов[Индекс];
				СтрокаРецептуры = Рецептуры.Добавить();
				СтрокаРецептуры.РецептураСтарая = СтрокаТаблицы.Ссылка;
				СтрокаРецептуры.НомерСтарой = СтрокаТаблицы.Номер;
				СтрокаРецептуры.СтрокаОшибки = "Пакет не обработан: " + ТекстОшибки;
			КонецЦикла;
			
			КоличествоОшибокВПакете = КонечныйИндекс - НачальныйИндекс + 1;
			
		КонецПопытки;
		
		// Обновляем общую статистику
		ОбщееКоличествоОбработанных = ОбщееКоличествоОбработанных + КоличествоОбработанныхВПакете;
		ОбщееКоличествоОшибок = ОбщееКоличествоОшибок + КоличествоОшибокВПакете;
		
		// Выводим прогресс обработки
		Процент = Окр((НомерПакета + 1) / КоличествоПакетов * 100, 0);
		СообщениеОПрогрессе = "Пакет " + (НомерПакета + 1) + "/" + КоличествоПакетов + " (" + Процент + "%): ";
		СообщениеОПрогрессе = СообщениеОПрогрессе + "обработано " + КоличествоОбработанныхВПакете + ", ошибок " + КоличествоОшибокВПакете;
		СообщениеОПрогрессе = СообщениеОПрогрессе + ". Итого: обработано " + ОбщееКоличествоОбработанных + ", ошибок " + ОбщееКоличествоОшибок;
		Сообщить(СообщениеОПрогрессе);
		
	КонецЦикла;
	
	// Итоговое сообщение
	Сообщить("=== ОБРАБОТКА РЕЦЕПТУР ЗАВЕРШЕНА ===");
	Сообщить("Всего рецептур: " + ВсегоРецептов);
	Сообщить("Успешно обработано: " + ОбщееКоличествоОбработанных);
	Сообщить("Ошибок: " + ОбщееКоличествоОшибок);
	
	ОбновитьДеревоРецептурНаСервере();
	
КонецПроцедуры

&НаСервере
Функция НоваяРецептура(РецептураИсходная)
	
	
		СтруктураВозврата =  Новый Структура;
		СписокНовойНоменклатуры = Новый СписокЗначений;
		СписокНовойНоменклатурыКод = Новый СписокЗначений;
		НовДок = Неопределено;		
		ТекстОшибки = "";
		
		СвойствоДопРеквиз = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("MRS_НоваяРецептура");
		ЗначениеСвойства = СокрЛП(УправлениеСвойствами.ЗначениеСвойства(РецептураИсходная.Ссылка, СвойствоДопРеквиз));
		
		Запрос = Новый Запрос;
		Запрос.Текст = " ВЫБРАТЬ
		                |	питРецептура.Ссылка КАК Ссылка
		                |ИЗ
		                |	Документ.питРецептура КАК питРецептура
		                |ГДЕ
		                |	питРецептура.Номер = &Номер
		                |	И питРецептура.ДатаКонца = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		                |			И НЕ питРецептура.ПометкаУдаления";
		
		Запрос.УстановитьПараметр("Номер", ЗначениеСвойства);
		
		РезультатЗапроса = Запрос.Выполнить().Выбрать();
		
		Пока РезультатЗапроса.Следующий() Цикл
			
			НовДокСсылка = РезультатЗапроса.Ссылка;
			НовДок = НовДокСсылка.ПолучитьОбъект();	
			
		КонецЦикла;
		
		Если НовДок <> Неопределено Тогда
			// Новый документ уже найден, используем его
		Иначе
			
			НовДок = РецептураИсходная.Скопировать();    
			НовДок.Дата        = ТекущаяДатаСеанса();
			НовДок.ДатаНачала  = КонецДня(ТекущаяДатаСеанса()) + 1;
			НовДок.ДатаКонца   =  Дата(1,1,1);
			НовДок.Комментарий = РецептураИсходная.Комментарий + Символы.ПС + "Создан обработкой для перевода в серийный алкоголь";
			НовДок.Наименование = НовДок.Наименование + " [_mrs]";
	
		КонецЕсли;
			
		// Рекурсивно создадим или заполним уже созданными рецептурами
		// табчасть ингридиенты для вложенных рецептур
		
		// Оптимизация: соберем все номенклатуры для одного запроса
		МассивВскрытыхНоменклатур = Новый Массив;
		Для Каждого СтрокаИнгредиенты ИЗ НовДок.Ингредиенты Цикл
			Если СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукция и СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
				МассивВскрытыхНоменклатур.Добавить(СтрокаИнгредиенты.Номенклатура);
			КонецЕсли;
		КонецЦикла;
		
		СоответствияНоменклатуры = Новый Соответствие;
		Если МассивВскрытыхНоменклатур.Количество() > 0 Тогда
			ЗапросСоответствий = Новый Запрос;
			ЗапросСоответствий.Текст = 
				"ВЫБРАТЬ
				|	MRS_СоответствиеСтаройНовойНоменклатуры.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура,
				|	MRS_СоответствиеСтаройНовойНоменклатуры.НоваяНоменклатура КАК НоваяНоменклатура,
				|	MRS_СоответствиеСтаройНовойНоменклатуры.НоваяНоменклатура.Код КАК НоваяНоменклатураКод
				|ИЗ
				|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК MRS_СоответствиеСтаройНовойНоменклатуры
				|ГДЕ
				|	MRS_СоответствиеСтаройНовойНоменклатуры.ВскрытаяНоменклатура В(&МассивВскрытыхНоменклатур)";
			
			ЗапросСоответствий.УстановитьПараметр("МассивВскрытыхНоменклатур", МассивВскрытыхНоменклатур);
			
			ТаблицаСоответствий = ЗапросСоответствий.Выполнить().Выгрузить();
			Для Каждого СтрокаСоответствия Из ТаблицаСоответствий Цикл
				СоответствияНоменклатуры.Вставить(СтрокаСоответствия.ВскрытаяНоменклатура, СтрокаСоответствия);
			КонецЦикла;
		КонецЕсли;

		Для Каждого СтрокаИнгредиенты ИЗ НовДок.Ингредиенты Цикл
			Если СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукция и СтрокаИнгредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
				
				Соответствие = СоответствияНоменклатуры[СтрокаИнгредиенты.Номенклатура];
				
				Если Соответствие <> Неопределено Тогда
					
					СтрокаИнгредиенты.Номенклатура = Соответствие.НоваяНоменклатура;
					СписокНовойНоменклатуры.Добавить(Соответствие.НоваяНоменклатура);
					СписокНовойНоменклатурыКод.Добавить(Соответствие.НоваяНоменклатураКод);
					
					Попытка 
						     						
						НовДок.Записать();
						СтруктураВозврата.Вставить("Документ", НовДок.Ссылка);
						СтруктураВозврата.Вставить("НомерРецептуры", НовДок.Номер); 
						
						РецептураИсходная.ДатаКонца = КонецДня(ТекущаяДатаСеанса());
						РецептураИсходная.Записать();
					Исключение
						
						СтрокаСообщенияОбОшибке = НСтр("ru = 'Не удалось записать новый документ по Рецептуре:%1.
						|Описание ошибки: %2'");
						
						ТекстОшибки = ТекстОшибки + Символы.ПС + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(СтрокаСообщенияОбОшибке,
								РецептураИсходная.Ссылка,
							КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
					КонецПопытки;

				Иначе
					
					СтрокаСообщенияОбОшибке = НСтр("ru = 'Не найдено соответствие в регистре MRS_СоответствиеСтаройНовойНоменклатуры для номенклатуры: %1 (Код: %2).
					|Исходная рецептура: %3'");
					
					ТекстОшибки = ТекстОшибки + Символы.ПС + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(СтрокаСообщенияОбОшибке,
							СтрокаИнгредиенты.Номенклатура,
							СтрокаИнгредиенты.Номенклатура.Код,
							РецептураИсходная.Ссылка);
          	        
				КонецЕсли;
				
			КонецЕсли;
		КонецЦикла;
		
	
		СтруктураВозврата.Вставить("СписокНовойНоменклатуры", СписокНовойНоменклатуры);
		СтруктураВозврата.Вставить("СписокНовойНоменклатурыКод", СписокНовойНоменклатурыКод);
		СтруктураВозврата.Вставить("ТекстОшибки", ТекстОшибки);
		
		Если СтруктураВозврата.Свойство("Документ") Тогда
		
		#Область MRS_РецептНовая
						
			ТЗ=Новый ТаблицаЗначений;
		    ТЗ.Колонки.Добавить("Свойство", Новый ОписаниеТипов("ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения"));
		    ТЗ.Колонки.Добавить("Значение");
		    НовСтр=ТЗ.Добавить();
		    НовСтр.Свойство=ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("MRS_НоваяРецептура");
		    НовСтр.Значение = НовДок.Номер;
			УправлениеСвойствами.ЗаписатьСвойстваУОбъекта(РецептураИсходная.Ссылка,ТЗ);     
			
		#КонецОбласти
		
		//#Область MRS_РецептСтарая
		//	
		//	ТЗ=Новый ТаблицаЗначений;
		//    ТЗ.Колонки.Добавить("Свойство", Новый ОписаниеТипов("ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения"));
		//    ТЗ.Колонки.Добавить("Значение");
		//    НовСтр=ТЗ.Добавить();
		//    НовСтр.Свойство=ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("MRS_СтараяРецептура");
		//    НовСтр.Значение = РецептураИсходная.Номер;
		//	УправлениеСвойствами.ЗаписатьСвойстваУОбъекта(НовДок.Ссылка,ТЗ);
		//	
		//#КонецОбласти
		КонецЕсли;

		
		 Если НЕ СтруктураВозврата.Свойство("Документ") Тогда
			
			СтруктураВозврата.Вставить("Документ", Неопределено);
			
		КонецЕсли;
		
		Если НЕ СтруктураВозврата.Свойство("НомерРецептуры") Тогда
			
			СтруктураВозврата.Вставить("НомерРецептуры", Неопределено);	
			
		КонецЕсли;

			
		Возврат СтруктураВозврата;
		
КонецФункции

&НаКлиенте
Процедура ПолучитьРецептуры(Команда)
	ПолучитьРецептурыНаСервере();
КонецПроцедуры

&НаСервере
Процедура СоздатьсборкиНаСервере()
	
	/////////////////////////////////////////////////////////////
	// поиск замены
	лТекст = "
		|ВЫБРАТЬ
		|	НоменклатураДополнительныеРеквизиты.Свойство КАК Свойство,
		|	НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|ИЗ
		|	Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|ГДЕ
		|	НоменклатураДополнительныеРеквизиты.Свойство = &Свойство
		|	И НоменклатураДополнительныеРеквизиты.Ссылка = &Ссылка
		|";

	лЗапрос = Новый Запрос(лТекст);

	// Присвоение значений переменным параметров.
	Свойство = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("MRS_НоменклатураНовая"); // MRS_НоменклатураНовая ()

	// Установка параметров.
	лЗапрос.УстановитьПараметр("Свойство", Свойство);
	лЗапрос.УстановитьПараметр("Ссылка", Номенклатура);

	лВыборка = лЗапрос.Выполнить().Выбрать();

	Пока лВыборка.Следующий() Цикл

		ЗначениеДопРеквиз =  СтрЗаменить(лВыборка.Значение, ";","");
	
	КонецЦикла;

	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Ссылка,
		|	УпаковкиЕдиницыИзмерения.Ссылка КАК Упаковка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
		|		ПО (Номенклатура.Ссылка = УпаковкиЕдиницыИзмерения.Владелец)
		|ГДЕ
		|	Номенклатура.Код В (&Код)
		|";
	
	 
	Запрос.УстановитьПараметр("Код", ЗначениеДопРеквиз);
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Пока Результат.Следующий() Цикл
		
		НоменклатураЗамены = Результат.Ссылка;
		УпаковкаНоменклатуры =  Результат.Упаковка;
		
	КонецЦикла;
	//////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////
	//Создаем комплектацию
		лТекст = "
		|ВЫБРАТЬ
		|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладахОстатки.Серия КАК Серия,
		|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
		|	ТоварыНаСкладахОстатки.Склад.ПЛ_Организация КАК Организация,
		|	ТоварыНаСкладахОстатки.Склад КАК Склад,
		|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
		|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(&Дата, Номенклатура = &Номенклатура) КАК ТоварыНаСкладахОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
		|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура
		|				И ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
		|ИТОГИ
		|	СУММА(ВНаличииОстаток)
		|ПО
		|	Склад
		|";


	лЗапрос = Новый Запрос(лТекст);

	// Установка параметров.
	лЗапрос.УстановитьПараметр("Дата", Новый Граница(КонецДня(Период), ВидГраницы.Включая));
	лЗапрос.УстановитьПараметр("Номенклатура", Номенклатура);
	лЗапрос.УстановитьПараметр("Склад", Склад);
	
	ВыборкаСклад = лЗапрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаСклад.Следующий() Цикл
		
		Если ВыборкаСклад.ВНаличииОстаток > 0 Тогда
		
			ДокументСборки = Документы.СборкаТоваров.СоздатьДокумент();
		    ДокументСборки.Комментарий				= "#Документ создан обработкой комплектации в литражную номенклатуру.";
			ДокументСборки.Организация				= ?(ЗначениеЗаполнено(ВыборкаСклад.Организация), ВыборкаСклад.Организация, Справочники.Организации.ПустаяСсылка());
			ДокументСборки.Склад					= ВыборкаСклад.Склад;
			ДокументСборки.Дата						= ТекущаяДатаСеанса();
	        ДокументСборки.ХозяйственнаяОперация	= Перечисления.ХозяйственныеОперации.СборкаТоваров;
			ДокументСборки.Номенклатура				= НоменклатураЗамены;
			ДокументСборки.Ответственный			= ПараметрыСеанса.ТекущийПользователь;
			ДокументСборки.Статус					= Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
			ДокументСборки.СборкаПодДеятельность	= Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
			ДокументСборки.ВариантПриемкиТоваров	= Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;
			ДокументСборки.КоличествоУпаковок		= ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.Упаковка					= УпаковкаНоменклатуры; 
			ДокументСборки.Количество				= ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.СтатусУказанияСерий		= 4;
			
			СтрокаТЧТовары = ДокументСборки.Товары.Добавить();
			
			СтрокаТЧТовары.Номенклатура				= Номенклатура;
			СтрокаТЧТовары.Количество				= ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.КоличествоУпаковок		= ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.СтатусУказанияСерий		= 4; 
			
			ВыборкаСерия = ВыборкаСклад.Выбрать();
			
			Пока ВыборкаСерия.Следующий() Цикл
				
				СтрокаСерии = ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура	= ВыборкаСерия.Номенклатура;
				СтрокаСерии.Серия			= ВыборкаСерия.Серия;
				СтрокаСерии.Количество		= 1;
				
				СтрокаСерии	= ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура	= НоменклатураЗамены;
				СтрокаСерии.Количество		= НоменклатураЗамены.ОбъемДАЛ * 10;
				СтрокаСерии.Серия			= ВыборкаСерия.Серия;
				
				ШтрихкодОбъект = ВыборкаСерия.Штрихкод.ПолучитьОбъект();
				ШтрихкодОбъект.Номенклатура = НоменклатураЗамены;
				ШтрихкодОбъект.Упаковка 	= УпаковкаНоменклатуры;
				ШтрихкодОбъект.Записать();
			КонецЦикла;
			
			ДокументСборки.Записать(РежимЗаписиДокумента.Запись);
			СтрокаДокументы = ТаблицаСборок.Добавить();
			СтрокаДокументы.ДокументыСборки = ДокументСборки.Ссылка;
			
		КонецЕсли;
		
	КонецЦикла;
	
	лТекст = "
	|ВЫБРАТЬ
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
	|ИЗ
	|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект
	|";

	лЗапрос = Новый Запрос(лТекст);

	// Установка параметров.
	лЗапрос.УстановитьПараметр("Объект", Номенклатура.ПЛ_НоменклатураВоВскрытойТаре.Ссылка);


	лВыборка = лЗапрос.Выполнить().Выбрать();

	Пока лВыборка.Следующий() Цикл
		
		Набор = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
		Набор.Отбор.Код.Установить(лВыборка.Код);
		Набор.Прочитать();
		
		Для Каждого Запись из Набор Цикл
			
			Запись.НоменклатураАлкоголь = НоменклатураЗамены;
			
		КонецЦикла;
		
		Набор.Записать();
		
	КонецЦикла;
	
	
КонецПроцедуры

&НаКлиенте
Процедура Создатьсборки(Команда)
	СоздатьсборкиНаСервере();
КонецПроцедуры

#КонецОбласти

#Область Дерево_рецептур

&НаКлиенте
Процедура ОбновитьДеревоРецептур(Команда)
	
	ПредзаполнитьСвязиРецептурНаСервере(); 
КонецПроцедуры

&НаСервере
Процедура ОбновитьДеревоРецептурНаСервере()
	
	ДеревоРецептур.ПолучитьЭлементы().Очистить();
	
	Если Рецептуры.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Определяем статус каждой рецептуры перед фильтрацией
	ОпределитьСтатусыРецептур();
	
	// 1. Собираем все рецептуры для одного запроса
	ВсеРецептуры = Новый Массив;
	Для Каждого СтрокаПары Из Рецептуры Цикл
		Если ЗначениеЗаполнено(СтрокаПары.РецептураСтарая) Тогда
			ВсеРецептуры.Добавить(СтрокаПары.РецептураСтарая);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтрокаПары.РецептураНовая) Тогда
			ВсеРецептуры.Добавить(СтрокаПары.РецептураНовая);
		КонецЕсли;
	КонецЦикла;
	
	Если ВсеРецептуры.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// 2. Получаем все данные одним запросом
	ТЗИнгредиентов = ПолучитьИнгредиентыДляДерева(ВсеРецептуры);
	
	// 3. Строим дерево с учетом фильтрации
	Для Каждого СтрокаПары Из Рецептуры Цикл
		
		// Проверяем фильтр
		СтатусРецептуры = ОпределитьСтатусРецептуры(СтрокаПары);
		
		// Проверяем все фильтры
		Если ТолькоБезСоответствий И (СтатусРецептуры = "Полностью заменена") Тогда
			Продолжить; // Пропускаем полностью замененные рецептуры
		КонецЕсли;
		
		Если ТолькоНеСозданные И НЕ (СтатусРецептуры = "Не создана") Тогда
			Продолжить; // Пропускаем созданные рецептуры
		КонецЕсли;
		
		Если ТолькоЧастичноЗамененные И НЕ (СтатусРецептуры = "Частично заменена") Тогда
			Продолжить; // Пропускаем нечастично замененные рецептуры
		КонецЕсли;
		
		// --- СТАРАЯ РЕЦЕПТУРА ---
		Если ЗначениеЗаполнено(СтрокаПары.РецептураСтарая) Тогда
			УзелСтарой = ДеревоРецептур.ПолучитьЭлементы().Добавить();
			УзелСтарой.Наименование = "СТАРАЯ: " + СтрокаПары.РецептураСтарая;
			УзелСтарой.РецептураСсылка = СтрокаПары.РецептураСтарая;
			УзелСтарой.ТипУзла = "СтараяРецептура";
			УзелСтарой.СтатусСоответствия = СтатусРецептуры;
			ЗаполнитьУзелИнгредиентами(УзелСтарой, СтрокаПары.РецептураСтарая, ТЗИнгредиентов, Истина);
		КонецЕсли;
		
		// --- НОВАЯ РEЦЕПТУРА ---
		Если ЗначениеЗаполнено(СтрокаПары.РецептураНовая) Тогда
			УзелНовой = ДеревоРецептур.ПолучитьЭлементы().Добавить();
			УзелНовой.Наименование = "НОВАЯ: " + СтрокаПары.РецептураНовая;
			УзелНовой.РецептураСсылка = СтрокаПары.РецептураНовая;
			УзелНовой.ТипУзла = "НоваяРецептура";
			УзелНовой.СтатусСоответствия = СтатусРецептуры;
			ЗаполнитьУзелИнгредиентами(УзелНовой, СтрокаПары.РецептураНовая, ТЗИнгредиентов, Ложь);
		Иначе
			УзелНовой = ДеревоРецептур.ПолучитьЭлементы().Добавить();
			УзелНовой.Наименование = "НОВАЯ: (не создана)";
			УзелНовой.РецептураСсылка = "НОВАЯ: (не создана)";
			УзелНовой.ТипУзла = "НоваяРецептура";
			УзелНовой.СтатусСоответствия = "Не создана";
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьИнгредиентыДляДерева(ВсеРецептуры)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Ингредиенты.Ссылка КАК Рецептура,
	|	Ингредиенты.Номенклатура КАК Номенклатура,
	|	Ингредиенты.Количество КАК Количество,
	|	Ингредиенты.Номенклатура.Наименование КАК НоменклатураНаименование
	|ПОМЕСТИТЬ ВТ_Ингредиенты
	|ИЗ
	|	Документ.питРецептура.Ингредиенты КАК Ингредиенты
	|ГДЕ
	|	Ингредиенты.Ссылка В(&ВсеРецептуры)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТ_Ингредиенты.Рецептура КАК Рецептура,
	|	ВТ_Ингредиенты.Номенклатура КАК Номенклатура,
	|	ВТ_Ингредиенты.Количество КАК Количество,
	|	ВТ_Ингредиенты.НоменклатураНаименование КАК Наименование,
	|	СоответствияИзРегистра.НоваяНоменклатура КАК НоваяНоменклатура,
	|	СоответствияИзРегистра.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура,
	|	ВЫБОР
	|		КОГДА ВТ_Ингредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоВскрытаяТара
	|ИЗ
	|	ВТ_Ингредиенты КАК ВТ_Ингредиенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК СоответствияИзРегистра
	|		ПО (ВТ_Ингредиенты.Номенклатура = СоответствияИзРегистра.ВскрытаяНоменклатура
	|				ИЛИ ВТ_Ингредиенты.Номенклатура = СоответствияИзРегистра.НоваяНоменклатура)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Наименование";
	
	Запрос.УстановитьПараметр("ВсеРецептуры", ВсеРецептуры);
	
	Результат = Запрос.Выполнить().Выгрузить();
	Результат.Индексы.Добавить("Рецептура");
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура ЗаполнитьУзелИнгредиентами(УзелРецептуры, СсылкаНаРецептуру, ТЗИнгредиентов, ЭтоСтараяРецептура)
	
	Отбор = Новый Структура("Рецептура", СсылкаНаРецептуру);
	НайденныеИнгредиенты = ТЗИнгредиентов.НайтиСтроки(Отбор);
	
	Для Каждого СтрокаИнгредиента Из НайденныеИнгредиенты Цикл
		УзелИнгредиента = УзелРецептуры.ПолучитьЭлементы().Добавить();
		УзелИнгредиента.Наименование = СтрокаИнгредиента.Наименование;
		УзелИнгредиента.Количество = СтрокаИнгредиента.Количество;
		//УзелИнгредиента.РецептураСсылка = СсылкаНаРецептуру;
		
		Если ЭтоСтараяРецептура Тогда
			УзелИнгредиента.ТипУзла = "Ингредиент";
			УзелИнгредиента.СтараяНоменклатура = СтрокаИнгредиента.Номенклатура;
			УзелИнгредиента.НоваяНоменклатура = СтрокаИнгредиента.НоваяНоменклатура;
			
			Если СтрокаИнгредиента.ЭтоВскрытаяТара Тогда
				Если ЗначениеЗаполнено(СтрокаИнгредиента.НоваяНоменклатура) Тогда
					УзелИнгредиента.СтатусСоответствия = "Есть соответствие";
				Иначе
					УзелИнгредиента.СтатусСоответствия = "Нет соответствия";
				КонецЕсли;
			Иначе
				УзелИнгредиента.СтатусСоответствия = "Не алкоголь";
			КонецЕсли;
		Иначе // Это новая рецептура
			УзелИнгредиента.ТипУзла = "ИнгредиентНовый";
			УзелИнгредиента.СтараяНоменклатура = СтрокаИнгредиента.ВскрытаяНоменклатура;
			УзелИнгредиента.НоваяНоменклатура = СтрокаИнгредиента.Номенклатура;
			
			Если НЕ СтрокаИнгредиента.ЭтоВскрытаяТара Тогда // Это серийный алкоголь
				Если ЗначениеЗаполнено(СтрокаИнгредиента.ВскрытаяНоменклатура) Тогда
					УзелИнгредиента.СтатусСоответствия = "Заменён";
				Иначе
					УзелИнгредиента.СтатусСоответствия = "Новый";
				КонецЕсли;
			Иначе
				УзелИнгредиента.СтатусСоответствия = "Не алкоголь";
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ТолькоБезСоответствийПриИзменении(Элемент)
	// Применяем фильтрацию в зависимости от установленного флажка
	ОбновитьДеревоРецептурНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ДеревоРецептурНоваяНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ДеревоРецептур.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Обновляем статус соответствия
	Если ЗначениеЗаполнено(ТекущиеДанные.НоваяНоменклатура) Тогда
		ТекущиеДанные.СтатусСоответствия = "Есть соответствие";
	Иначе
		ТекущиеДанные.СтатусСоответствия = "Нет соответствия";
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьИзмененияВРецептурах(Команда)
	СохранитьИзмененияВРецептурахНаСервере();
КонецПроцедуры

&НаСервере
Процедура СохранитьИзмененияВРецептурахНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);

	// Собираем все изменения из дерева
	ТаблицаИзменений = Новый ТаблицаЗначений;
	ТаблицаИзменений.Колонки.Добавить("ВскрытаяНоменклатура");
	ТаблицаИзменений.Колонки.Добавить("НоваяНоменклатура");
	ТаблицаИзменений.Колонки.Добавить("РецептураСсылка");
	
	Для Каждого УзелРецептуры Из ДеревоРецептур.ПолучитьЭлементы() Цикл
		
		Для Каждого УзелИнгредиента Из УзелРецептуры.ПолучитьЭлементы() Цикл
			
			Если ЗначениеЗаполнено(УзелИнгредиента.НоваяНоменклатура) 
				И УзелИнгредиента.ТипУзла = "Ингредиент" Тогда
				
				СтрокаИзменения = ТаблицаИзменений.Добавить();
				СтрокаИзменения.ВскрытаяНоменклатура = УзелИнгредиента.СтараяНоменклатура;
				СтрокаИзменения.НоваяНоменклатура = УзелИнгредиента.НоваяНоменклатура;
				СтрокаИзменения.РецептураСсылка = УзелИнгредиента.РецептураСсылка;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если ТаблицаИзменений.Количество() = 0 Тогда
		Сообщить("Нет изменений для сохранения");
		Возврат;
	КонецЕсли;
	
	НачатьТранзакцию();
	
	Попытка
		
		КоличествоОбновленных = 0;
		КоличествоСозданных = 0;
		
		// Сохраняем соответствия в регистр сведений
		Для Каждого СтрокаИзменения Из ТаблицаИзменений Цикл
			
			МенеджерЗаписи = РегистрыСведений.MRS_СоответствиеСтаройНовойНоменклатуры.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаИзменения.ВскрытаяНоменклатура;
			МенеджерЗаписи.Прочитать();
			
			Если МенеджерЗаписи.Выбран() Тогда
				МенеджерЗаписи.НоваяНоменклатура = СтрокаИзменения.НоваяНоменклатура;
				МенеджерЗаписи.Записать();
				КоличествоОбновленных = КоличествоОбновленных + 1;
			Иначе
				// Если записи нет, создадим новую (но это маловероятно)
				МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаИзменения.ВскрытаяНоменклатура;
				МенеджерЗаписи.НоваяНоменклатура = СтрокаИзменения.НоваяНоменклатура;
				МенеджерЗаписи.Записать();
				КоличествоСозданных = КоличествоСозданных + 1;
			КонецЕсли;
			
		КонецЦикла;
		
		// Теперь обновляем существующие рецептуры
		Для Каждого СтрокаИзменения Из ТаблицаИзменений Цикл
			
			РецептураОбъект = СтрокаИзменения.РецептураСсылка.ПолучитьОбъект();
			
			Для Каждого СтрокаИнгредиента Из РецептураОбъект.Ингредиенты Цикл
				
				Если СтрокаИнгредиента.Номенклатура = СтрокаИзменения.ВскрытаяНоменклатура Тогда
					СтрокаИнгредиента.Номенклатура = СтрокаИзменения.НоваяНоменклатура;
				КонецЕсли;
				
			КонецЦикла;
			
			РецептураОбъект.Записать();
			
		КонецЦикла;
		
		Сообщить("Изменения сохранены успешно! Обновлено соответствий: " + КоличествоОбновленных + ", создано: " + КоличествоСозданных);
		
		// Обновляем дерево
		ОбновитьДеревоРецептурНаСервере();
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		Сообщить("Ошибка при сохранении изменений: " + ОписаниеОшибки());
		
	КонецПопытки;
	
	УстановитьПривилегированныйРежим(Ложь);

КонецПроцедуры

&НаСервере
Процедура ОпределитьСтатусыРецептур()
	
	// Определяем статус каждой рецептуры в таблице
	Для Каждого СтрокаРецептуры Из Рецептуры Цикл
		СтрокаРецептуры.СтатусРецептуры = ОпределитьСтатусРецептуры(СтрокаРецептуры);
	КонецЦикла
	
КонецПроцедуры

&НаСервере
Функция ОпределитьСтатусРецептуры(СтрокаРецептуры)
	
	// Если новая рецептура не создана
	Если НЕ ЗначениеЗаполнено(СтрокаРецептуры.РецептураНовая) Тогда
		Возврат "Не создана";
	КонецЕсли;
	
	// Проверяем соответствие ингредиентов
	Если НЕ ЗначениеЗаполнено(СтрокаРецептуры.РецептураСтарая) Тогда
		Возврат "Ошибка";
	КонецЕсли;
	
	// Получаем списки вскрытой номенклатуры старой и новой
	СтараяНоменклатура = ПолучитьСписокВскрытойНоменклатуры(СтрокаРецептуры.РецептураСтарая);
	НоваяНоменклатура = ПолучитьСписокСерийнойНоменклатуры(СтрокаРецептуры.РецептураНовая);
	
	Если СтараяНоменклатура.Количество() = 0 Тогда
		Возврат "Нет алкоголя";
	КонецЕсли;
	
	// Проверяем, сколько позиций заменено
	КоличествоСтарых = СтараяНоменклатура.Количество();
	КоличествоЗамененных = 0;
	
	Если СтараяНоменклатура.Количество() > 0 Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Соответствия.ВскрытаяНоменклатура) КАК КоличествоЗамененных
			|ИЗ
			|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК Соответствия
			|ГДЕ
			|	Соответствия.ВскрытаяНоменклатура В (&ВскрытыеНоменклатуры)";
		
		Запрос.УстановитьПараметр("ВскрытыеНоменклатуры", СтараяНоменклатура.ВыгрузитьЗначения());
		
		Результат = Запрос.Выполнить().Выгрузить();
		Если Результат.Количество() > 0 Тогда
			КоличествоЗамененных = Результат[0].КоличествоЗамененных;
		КонецЕсли;
	КонецЕсли;
	
	// Определяем статус
	Если КоличествоЗамененных = 0 Тогда
		Возврат "Не заменена";
	ИначеЕсли КоличествоЗамененных = КоличествоСтарых Тогда
		Возврат "Полностью заменена";
	Иначе
		Возврат "Частично заменена";
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ПолучитьСписокВскрытойНоменклатуры(РецептураСсылка)
	
	СписокНоменклатуры = Новый СписокЗначений;
	
	Если НЕ ЗначениеЗаполнено(РецептураСсылка) Тогда
		Возврат СписокНоменклатуры;
	КонецЕсли;
	
	РецептураОбъект = РецептураСсылка.ПолучитьОбъект();
	
	Для Каждого СтрокаИнгредиента Из РецептураОбъект.Ингредиенты Цикл
		Если СтрокаИнгредиента.Номенклатура.АлкогольнаяПродукция И СтрокаИнгредиента.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
			СписокНоменклатуры.Добавить(СтрокаИнгредиента.Номенклатура);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СписокНоменклатуры;
	
КонецФункции

&НаСервере
Функция ПолучитьСписокСерийнойНоменклатуры(РецептураСсылка)
	
	СписокНоменклатуры = Новый СписокЗначений;
	
	Если НЕ ЗначениеЗаполнено(РецептураСсылка) Тогда
		Возврат СписокНоменклатуры;
	КонецЕсли;
	
	РецептураОбъект = РецептураСсылка.ПолучитьОбъект();
	
	Для Каждого СтрокаИнгредиента Из РецептураОбъект.Ингредиенты Цикл
		Если СтрокаИнгредиента.Номенклатура.АлкогольнаяПродукция И НЕ СтрокаИнгредиента.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре Тогда
			СписокНоменклатуры.Добавить(СтрокаИнгредиента.Номенклатура);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СписокНоменклатуры;
	
КонецФункции

&НаКлиенте
Процедура ФильтрыПриИзменении(Элемент)
	// Обновляем список при изменении любого фильтра
	ОбновитьДеревоРецептурНаСервере();
КонецПроцедуры
#КонецОбласти

&НаКлиенте
Процедура ПоказатьПозицииБезЗамен(Команда)
	
	// Вызываем процедуру показа позиций, которая заполняет ТаблицаПозицийБезЗамен
	ПоказатьПозицииБезЗаменНаСервере();      
	
	
	// Переходим на страницу с таблицей позиций без замен
	Элементы.Страницы.ТекущаяСтраница = Элементы.ПозицииБезЗамен;
КонецПроцедуры

&НаСервере
Процедура ПоказатьПозицииБезЗаменНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Ингредиенты.Номенклатура КАК Номенклатура,
		|	Ингредиенты.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	Ингредиенты.Номенклатура.Код КАК КодНоменклатуры,
		|	Ингредиенты.Ссылка КАК Рецептура,
		|	ВЫРАЗИТЬ(Ингредиенты.Ссылка.Наименование КАК СТРОКА(250)) КАК НаименованиеРецептуры,
		|	Ингредиенты.Ссылка.Номер КАК НомерРецептуры
		|ИЗ
		|	Документ.питРецептура.Ингредиенты КАК Ингредиенты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК Соответствия
		|		ПО Ингредиенты.Номенклатура = Соответствия.ВскрытаяНоменклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.MRS_НеАктуальныеРецептуры КАК Неактуальные
		|		ПО Ингредиенты.Ссылка = Неактуальные.Рецептура
		|ГДЕ
		|	Ингредиенты.Номенклатура.АлкогольнаяПродукция
		|	И Ингредиенты.Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
		|	И НЕ Ингредиенты.Ссылка.ПометкаУдаления
		|	И НЕ Ингредиенты.Ссылка.Наименование ПОДОБНО ""%_mrs%""
		|	И Соответствия.ВскрытаяНоменклатура ЕСТЬ NULL
		|	И НЕ Ингредиенты.Номенклатура.ВидНоменклатуры В (&ВидНоменклатуры)
		|	И НЕ Ингредиенты.Ссылка.Номенклатура.питПродажаПоСвободнойЦене
		|	И Неактуальные.Рецептура ЕСТЬ NULL
		|	&ГАУ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НаименованиеНоменклатуры,
		|	НаименованиеРецептуры";
	
	Если ЗначениеЗаполнено(ГАУ) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ГАУ","И Ингредиенты.Ссылка.Номенклатура.ГруппаАналитическогоУчета = &ГАУ
		|			ИЛИ Неактуальные.Рецептура.Номенклатура.ГруппаАналитическогоУчета = &ГАУ"); 		
		Запрос.УстановитьПараметр("ГАУ", ГАУ);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ГАУ","");
	КонецЕсли;
	
	Параметр = Новый СписокЗначений;
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));// Готовая алкогольная продукция с ФСМ (помарочно) (Справочники.ВидыНоменклатуры)
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));// Готовая алкогольная продукция с ФСМ (Справочники.ВидыНоменклатуры)
	Запрос.УстановитьПараметр("ВидНоменклатуры", Параметр);

	РезультатЗапроса = Запрос.Выполнить();
	
	ДеревоПозицийБезЗамен.ПолучитьЭлементы().Очистить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Сообщить("Отлично! Все алкогольные позиции имеют замены.");
		Возврат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	СоответствиеНоменклатурыИУзла = Новый Соответствие;
	КоличествоУникальныхПозиций = 0;
	
	Пока Выборка.Следующий() Цикл
		
		РодительскийУзел = СоответствиеНоменклатурыИУзла[Выборка.Номенклатура];
		
		Если РодительскийУзел = Неопределено Тогда
			КоличествоУникальныхПозиций = КоличествоУникальныхПозиций + 1;
			РодительскийУзел = ДеревоПозицийБезЗамен.ПолучитьЭлементы().Добавить();
			РодительскийУзел.Номенклатура = Выборка.Номенклатура;
			СоответствиеНоменклатурыИУзла.Вставить(Выборка.Номенклатура, РодительскийУзел);
		КонецЕсли;
		
		ДочернийУзел = РодительскийУзел.ПолучитьЭлементы().Добавить();
		ДочернийУзел.Рецептура = Выборка.Рецептура;
		
	КонецЦикла;
	
	ТекстСообщения = "Найдено алкогольных позиций без замен: " + Выборка.Количество() + " записей";
	ТекстСообщения = ТекстСообщения + " (" + КоличествоУникальныхПозиций + " уникальных позиций)";
	Сообщить(ТекстСообщения);
	Сообщить("Данные загружены в таблицу на странице 'Позиции без замен'");
	
	// Теперь для каждой уникальной номенклатуры получим автозамену
	СписокНоменклатуры = Новый СписокЗначений;
	Для Каждого СтрокаДерева Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
		СписокНоменклатуры.Добавить(СтрокаДерева.Номенклатура);
	КонецЦикла;
	
	Если СписокНоменклатуры.Количество() > 0 Тогда
		
		// Сначала получим количество вариантов для каждой номенклатуры
		ЗапросКоличества = Новый Запрос;
		ЗапросКоличества.Текст = 
			"ВЫБРАТЬ
			|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре КАК НоменклатураИсточник,
			|	КОЛИЧЕСТВО(*) КАК КоличествоВариантов
			|ИЗ
			|	Справочник.Номенклатура КАК Номенклатура
			|ГДЕ
			|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре В (&СписокНоменклатуры)
			|
			|СГРУППИРОВАТЬ ПО
			|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре";
		
		ЗапросКоличества.УстановитьПараметр("СписокНоменклатуры", СписокНоменклатуры);
		РезультатКоличества = ЗапросКоличества.Выполнить().Выгрузить();
		
		// Создадим соответствие для хранения количества вариантов
		СоответствиеКоличества = Новый Соответствие;
		Для Каждого СтрокаКоличества Из РезультатКоличества Цикл
			СоответствиеКоличества.Вставить(СтрокаКоличества.НоменклатураИсточник, СтрокаКоличества.КоличествоВариантов);
		КонецЦикла;
		
		// Теперь получим только те автозамены, где есть единственный вариант
		ЗапросАвтозамены = Новый Запрос;
		ЗапросАвтозамены.Текст = 
			"ВЫБРАТЬ
			|	Номенклатура.Ссылка КАК АвтоЗамена,
			|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре КАК НоменклатураИсточник
			|ИЗ
			|	Справочник.Номенклатура КАК Номенклатура
			|ГДЕ
			|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре В (&СписокНоменклатуры)";
		
		ЗапросАвтозамены.УстановитьПараметр("СписокНоменклатуры", СписокНоменклатуры);
		РезультатАвтозамены = ЗапросАвтозамены.Выполнить().Выгрузить();
		
		// Создадим соответствие для автозамен только с единственным вариантом
		СоответствиеАвтозамен = Новый Соответствие;
		Для Каждого СтрокаРезультата Из РезультатАвтозамены Цикл
			КоличествоВариантов = СоответствиеКоличества.Получить(СтрокаРезультата.НоменклатураИсточник);
			Если КоличествоВариантов = 1 Тогда
				// Подставляем автозамену только если найден единственный вариант
				СоответствиеАвтозамен.Вставить(СтрокаРезультата.НоменклатураИсточник, СтрокаРезультата.АвтоЗамена);
			КонецЕсли;
		КонецЦикла;
		
		// Подставляем автозамены
		Для Каждого СтрокаДерева Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
			АвтоЗамена = СоответствиеАвтозамен.Получить(СтрокаДерева.Номенклатура);
			Если АвтоЗамена <> Неопределено Тогда
				СтрокаДерева.АвтоЗамена = АвтоЗамена;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаСервере
Функция ПолучитьВариантыАвтозамены(Знач НоменклатураИсточник)
	
	Если не ЗначениеЗаполнено(НоменклатураИсточник) Тогда
		Возврат Новый СписокЗначений;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Ссылка,
		|	Номенклатура.Наименование КАК Наименование,
		|	Номенклатура.Код КАК Код
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.ПЛ_НоменклатураВоВскрытойТаре = &НоменклатураИсточник
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура.Наименование";
	
	Запрос.УстановитьПараметр("НоменклатураИсточник", НоменклатураИсточник);
	
	Результат = Запрос.Выполнить();
	СписокВариантов = Новый СписокЗначений;
	
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			ПредставлениеВарианта = Выборка.Наименование;
			Если НЕ ПустаяСтрока(Выборка.Код) Тогда
				ПредставлениеВарианта = ПредставлениеВарианта + " (" + Выборка.Код + ")";
			КонецЕсли;
			СписокВариантов.Добавить(Выборка.Ссылка, ПредставлениеВарианта);
		КонецЦикла;
	КонецЕсли;
	
	Возврат СписокВариантов;
	
КонецФункции

&НаКлиенте
Процедура ДеревоПозицийБезЗаменАвтоЗаменаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.ДеревоПозицийБезЗамен.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Получаем список вариантов автозамены для текущей номенклатуры
	СписокВариантов = ПолучитьВариантыАвтозамены(ТекущиеДанные.Номенклатура);
	
	Если СписокВариантов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Для данной номенклатуры не найдено вариантов автозамены");
		Возврат;
	ИначеЕсли СписокВариантов.Количество() = 1 Тогда
		// Если найден единственный вариант, подставляем его сразу
		ТекущиеДанные.АвтоЗамена = СписокВариантов[0].Значение;
		Возврат;
	КонецЕсли;
	
	// Преобразуем список вариантов в массив для ДанныеВыбора
	МассивВариантов = Новый Массив;
	Для Каждого Элемент Из СписокВариантов Цикл
		МассивВариантов.Добавить(Элемент.Значение);
	КонецЦикла;
	
	// Устанавливаем данные выбора
	ДанныеВыбора = Новый СписокЗначений;
	ДанныеВыбора.ЗагрузитьЗначения(МассивВариантов);
	
	// Если найдено несколько вариантов, показываем диалог выбора
	СписокВариантов.ПоказатьВыборЭлемента(
		Новый ОписаниеОповещения("ДеревоПозицийБезЗаменАвтоЗаменаНачалоВыбораЗавершение", ЭтотОбъект, ТекущиеДанные),
		"Выберите вариант автозамены:",
		ТекущиеДанные.АвтоЗамена);
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоПозицийБезЗаменАвтоЗаменаНачалоВыбораЗавершение(ВыбранныйЭлемент, ТекущиеДанные) Экспорт
	
	Если ВыбранныйЭлемент <> Неопределено Тогда
		ТекущиеДанные.АвтоЗамена = ВыбранныйЭлемент.Значение;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоПозицийБезЗаменАвтоЗаменаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.ДеревоПозицийБезЗамен.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Получаем список вариантов автозамены для текущей номенклатуры
	СписокВариантов = ПолучитьВариантыАвтозамены(ТекущиеДанные.Номенклатура);
	
	Если СписокВариантов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Для данной номенклатуры не найдено вариантов автозамены");
		Возврат;
	ИначеЕсли СписокВариантов.Количество() = 1 Тогда
		// Если найден единственный вариант, подставляем его сразу
		ТекущиеДанные.АвтоЗамена = СписокВариантов[0].Значение;
		Возврат;
	КонецЕсли;
	
	// Если найдено несколько вариантов, показываем диалог выбора
	СписокВариантов.ПоказатьВыборЭлемента(
		Новый ОписаниеОповещения("ДеревоПозицийБезЗаменАвтоЗаменаОбработкаВыбораЗавершение", ЭтотОбъект, ТекущиеДанные),
		"Выберите вариант автозамены:",
		ТекущиеДанные.АвтоЗамена);
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоПозицийБезЗаменАвтоЗаменаОбработкаВыбораЗавершение(ВыбранныйЭлемент, ТекущиеДанные) Экспорт
	
	Если ВыбранныйЭлемент <> Неопределено Тогда
		ТекущиеДанные.АвтоЗамена = ВыбранныйЭлемент.Значение;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьЗамены(Команда)
	СохранитьЗаменыНаСервере();
КонецПроцедуры

&НаСервере
Процедура СохранитьЗаменыНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	// Шаг 1: Сбор указанных пользователем замен
	// Ключ: СтараяНоменклатура, Значение: НоваяНоменклатура (Замена)
	КартаЗамен = Новый Соответствие;
	Для Каждого СтрокаДерева Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
		Если ЗначениеЗаполнено(СтрокаДерева.РучнаяЗамена) Тогда
			КартаЗамен.Вставить(СтрокаДерева.Номенклатура, СтрокаДерева.РучнаяЗамена);
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 2: Применение замен ко всем строкам с соответствующей номенклатурой
	Если КартаЗамен.Количество() > 0 Тогда
		Для Каждого СтрокаДерева Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
			Если НЕ ЗначениеЗаполнено(СтрокаДерева.РучнаяЗамена) Тогда
				ЗаменаДляТекущей = КартаЗамен[СтрокаДерева.Номенклатура];
				Если ЗаменаДляТекущей <> Неопределено Тогда
					СтрокаДерева.РучнаяЗамена = ЗаменаДляТекущей;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Шаг 3: Сохранение всех заполненных замен в регистр
	КоличествоОбновлено = 0;
	КоличествоСоздано = 0;

	Для Каждого СтрокаДерева Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
		
		ЗаменаДляСохранения = Неопределено;
		Если ЗначениеЗаполнено(СтрокаДерева.РучнаяЗамена) Тогда
			ЗаменаДляСохранения = СтрокаДерева.РучнаяЗамена;
		ИначеЕсли ЗначениеЗаполнено(СтрокаДерева.АвтоЗамена) Тогда
			ЗаменаДляСохранения = СтрокаДерева.АвтоЗамена;
		КонецЕсли;
		
		Если ЗаменаДляСохранения <> Неопределено Тогда
			
			Попытка
				МенеджерЗаписи = РегистрыСведений.MRS_СоответствиеСтаройНовойНоменклатуры.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаДерева.Номенклатура;
				МенеджерЗаписи.Прочитать();
				
				Если МенеджерЗаписи.Выбран() Тогда
					МенеджерЗаписи.НоваяНоменклатура = ЗаменаДляСохранения;
					МенеджерЗаписи.Записать();
					КоличествоОбновлено = КоличествоОбновлено + 1;
				Иначе
					МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаДерева.Номенклатура;
					МенеджерЗаписи.НоваяНоменклатура = ЗаменаДляСохранения;
					МенеджерЗаписи.Записать();
					КоличествоСоздано = КоличествоСоздано + 1;
				КонецЕсли;
			Исключение
				Сообщить("Не удалось записать соответствие для номенклатуры " + СтрокаДерева.Номенклатура + ". Ошибка: " + ОписаниеОшибки());
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоСоздано > 0 Или КоличествоОбновлено > 0 Тогда
		Сообщить("Успешно сохранено. Создано: " + КоличествоСоздано + ", обновлено: " + КоличествоОбновлено + ".");
		// Обновляем таблицу, чтобы убрать уже обработанные позиции
		ПоказатьПозицииБезЗаменНаСервере();
	Иначе
		Сообщить("Не было указано ни одной замены для сохранения.");
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаСервереБезКонтекста
Функция СкорректироватьНаименованиеПоОбъему(Наименование, ОбъемДАЛ)
	
	// 1. Проверяем, есть ли уже объем в наименовании.
	// Используем широкий список вариантов, чтобы поймать разные форматы.
	МассивВариантовОбъема = Новый Массив;
	МассивВариантовОбъема.Добавить("0.375"); МассивВариантовОбъема.Добавить("0,375"); МассивВариантовОбъема.Добавить("0.375л"); МассивВариантовОбъема.Добавить("0,375л"); МассивВариантовОбъема.Добавить("0.375L"); МассивВариантовОбъема.Добавить("0,375L");
	МассивВариантовОбъема.Добавить("0.5"); МассивВариантовОбъема.Добавить("0,5"); МассивВариантовОбъема.Добавить("0.5л"); МассивВариантовОбъема.Добавить("0,5л"); МассивВариантовОбъема.Добавить("0.5L"); МассивВариантовОбъема.Добавить("0,5L");
	МассивВариантовОбъема.Добавить("0.7л"); МассивВариантовОбъема.Добавить("0,7"); МассивВариантовОбъема.Добавить("0,7л"); МассивВариантовОбъема.Добавить("0.7L"); МассивВариантовОбъема.Добавить("0,7L");
	МассивВариантовОбъема.Добавить("0.75л"); МассивВариантовОбъема.Добавить("0,75"); МассивВариантовОбъема.Добавить("0,75л"); МассивВариантовОбъема.Добавить("0.75L"); МассивВариантовОбъема.Добавить("0,75L");
	МассивВариантовОбъема.Добавить("1л"); МассивВариантовОбъема.Добавить("1L");
	МассивВариантовОбъема.Добавить("1,5л"); МассивВариантовОбъема.Добавить("1,5"); МассивВариантовОбъема.Добавить("1.5"); МассивВариантовОбъема.Добавить("1.5л"); МассивВариантовОбъема.Добавить("1,5L"); МассивВариантовОбъема.Добавить("1.5L");


	НаименованиеНРег = НРег(Наименование);
	Для Каждого Вариант Из МассивВариантовОбъема Цикл
		Если СтрНайти(НаименованиеНРег, НРег(Вариант)) > 0 Тогда
			// Объем уже есть, ничего не делаем.
			Возврат Наименование;
		КонецЕсли;
	КонецЦикла;
	
	// 2. Объем не найден, нужно его добавить.
	// Формируем строку с новым, каноничным объемом.
	НовыйОбъемСтрока = "";
	Если ОбъемДАЛ > 0 Тогда
		ОбъемВЛитрах = ОбъемДАЛ * 10;
		ФорматнаяСтрокаОбъема = Формат(ОбъемВЛитрах, "ЧДЦ=3; ЧРД=,");
		Пока Прав(ФорматнаяСтрокаОбъема, 1) = "0" И СтрДлина(ФорматнаяСтрокаОбъема) > 1 Цикл
			ФорматнаяСтрокаОбъема = Лев(ФорматнаяСтрокаОбъема, СтрДлина(ФорматнаяСтрокаОбъема) - 1);
		КонецЦикла;
		Если Прав(ФорматнаяСтрокаОбъема, 1) = "," Тогда
			ФорматнаяСтрокаОбъема = Лев(ФорматнаяСтрокаОбъема, СтрДлина(ФорматнаяСтрокаОбъема) - 1);
		КонецЕсли;
		НовыйОбъемСтрока = " " + ФорматнаяСтрокаОбъема + "л";
	КонецЕсли;

	Если ПустаяСтрока(НовыйОбъемСтрока) Тогда
		// Объем нулевой или не удалось сформировать строку, ничего не добавляем.
		Возврат Наименование;
	КонецЕсли;

	// 3. Ищем тег [mrs...], чтобы вставить объем перед ним.
	ПозицияТега = СтрНайти(Наименование, "[mrs");
	
	Результат = "";
	Если ПозицияТега > 0 Тогда
		// Тег найден, вставляем объем перед ним.
		ОсноваНаименования = СокрП(Лев(Наименование, ПозицияТега - 1));
		ТегМРС = Сред(Наименование, ПозицияТега);
		Результат = ОсноваНаименования + НовыйОбъемСтрока + " " + ТегМРС;
	Иначе
		// Тег не найден, добавляем объем в конец.
		Результат = СокрП(Наименование) + НовыйОбъемСтрока;
	КонецЕсли;

	// 4. Проверяем и корректируем длину.
	МаксДлина = 150;
	Если СтрДлина(Результат) > МаксДлина Тогда
		// В данном случае просто обрезаем, т.к. логика сложного восстановления не требуется
		Результат = Лев(Результат, МаксДлина);
	КонецЕсли;

	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОбновитьРецептурыПоСвязям(Команда)
	
	ОбновитьРецептурыПоСвязямНаСервере(); 
КонецПроцедуры

&НаСервере
Процедура ОбновитьРецептурыПоСвязямНаСервере()
	   
	УстановитьПривилегированныйРежим(Истина);
	ПредзаполнитьСвязиРецептурНаСервере();
	
	Если Рецептуры.Количество() = 0 Тогда
		Сообщить("Связанные рецептуры для обновления не найдены.");
		Возврат;
	КонецЕсли;
	
	счетчикОбновленоСоздано = 0;
	счетчикОшибок = 0;
	
	Для Каждого СтрокаРецептуры Из Рецептуры Цикл
		
		Статус = ОпределитьСтатусРецептуры(СтрокаРецептуры);
		
		Если Статус = "Частично заменена" ИЛИ Статус = "Не заменена" ИЛИ Статус = "Не создана" Тогда
			
			Если ЕстьЗаменыДляСтаройРецептуры(СтрокаРецептуры.РецептураСтарая) Тогда
				СтруктураВозврата = НоваяРецептура(СтрокаРецептуры.РецептураСтарая.ПолучитьОбъект());
				Если ЗначениеЗаполнено(СтруктураВозврата.Документ) Тогда
					счетчикОбновленоСоздано = счетчикОбновленоСоздано + 1;
				Иначе
					счетчикОшибок = счетчикОшибок + 1;
					Сообщить("Ошибка обработки рецептуры " + СтрокаРецептуры.РецептураСтарая + ": " + СтруктураВозврата.ТекстОшибки);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Сообщить("Обработка завершена. Обновлено/создано: " + счетчикОбновленоСоздано + ", Ошибок: " + счетчикОшибок);
	
	ПредзаполнитьСвязиРецептурНаСервере();
	ОбновитьДеревоРецептурНаСервере();
	   
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаСервере
Функция ЕстьЗаменыДляСтаройРецептуры(СтараяРецептураСсылка)
	
	СписокВскрытойНоменклатуры = ПолучитьСписокВскрытойНоменклатуры(СтараяРецептураСсылка);
	
	Если СписокВскрытойНоменклатуры.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	1
		|ИЗ
		|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК Соответствия
		|ГДЕ
		|	Соответствия.ВскрытаяНоменклатура В (&ВскрытыеНоменклатуры)";
	
	Запрос.УстановитьПараметр("ВскрытыеНоменклатуры", СписокВскрытойНоменклатуры.ВыгрузитьЗначения());
	
	Результат = Запрос.Выполнить();
	
	Возврат НЕ Результат.Пустой();
	
КонецФункции

&НаКлиенте
Процедура ОтключитьВыбранныеРецептуры(Команда)
	
	ОтключитьВыбранныеРецептурыНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ОтключитьВыбранныеРецептурыНаСервере()
	
	СписокРецептурКОтключению = Новый Массив;
	Для Каждого УзелРецептуры Из ДеревоРецептур.ПолучитьЭлементы() Цикл
		Если УзелРецептуры.Отключить И ЗначениеЗаполнено(УзелРецептуры.РецептураСсылка) Тогда
			СписокРецептурКОтключению.Добавить(УзелРецептуры.РецептураСсылка);
		КонецЕсли;
	КонецЦикла;
	
	Если СписокРецептурКОтключению.Количество() > 0 Тогда
		ОтключитьСписокРецептурНаСервере(СписокРецептурКОтключению);
		ОбновитьДеревоРецептурНаСервере();
	Иначе
		Сообщить("Не выбрано ни одной рецептуры для отключения.");
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтключитьНеактуальныеРецептуры(Команда)
	
	ОтключитьНеактуальныеРецептурыНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ОтключитьНеактуальныеРецептурыНаСервере()
	
	СписокРецептурКОтключению = Новый Массив;
	УникальныеРецептуры = Новый Соответствие;
	
	Для Каждого УзелНоменклатуры Из ДеревоПозицийБезЗамен.ПолучитьЭлементы() Цикл
		Для Каждого УзелРецептуры Из УзелНоменклатуры.ПолучитьЭлементы() Цикл
			
			Если УзелРецептуры.Отключить Или УзелНоменклатуры.Отключить Тогда
				Если ЗначениеЗаполнено(УзелРецептуры.Рецептура) И УникальныеРецептуры[УзелРецептуры.Рецептура] = Неопределено Тогда
					СписокРецептурКОтключению.Добавить(УзелРецептуры.Рецептура);
					УникальныеРецептуры.Вставить(УзелРецептуры.Рецептура, Истина);
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;
	
	Если СписокРецептурКОтключению.Количество() > 0 Тогда
		ОтключитьСписокРецептурНаСервере(СписокРецептурКОтключению);
		ПоказатьПозицииБезЗаменНаСервере();
	Иначе
		Сообщить("Не выбрано ни одной рецептуры для отключения.");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОтключитьСписокРецептурНаСервере(СписокРецептур)
	
	УстановитьПривилегированныйРежим(Истина);
	
	КоличествоОтключенных = 0;
	ДатаОтключения = ТекущаяДатаСеанса();
	
	Для Каждого РецептураСсылка Из СписокРецептур Цикл
		
		НачатьТранзакцию();
		Попытка
			
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить("Документ.питРецептура");
			ЭлементБлокировки.УстановитьЗначение("Ссылка", РецептураСсылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			Блокировка.Заблокировать();
			
			РецептураОбъект = РецептураСсылка.ПолучитьОбъект();
			
			Если РецептураОбъект.ДатаКонца = Дата(1,1,1) Тогда
				
				РецептураОбъект.ДатаКонца = ДатаОтключения;
				РецептураОбъект.Записать();
				
				// Проверяем, что это старая рецептура, прежде чем делать запись в регистр
				Если СтрНайти(РецептураОбъект.Наименование, "_mrs") = 0 Тогда
					МенеджерЗаписи = РегистрыСведений.MRS_НеАктуальныеРецептуры.СоздатьМенеджерЗаписи();
					МенеджерЗаписи.Пользователь = ПараметрыСеанса.ТекущийПользователь;
					МенеджерЗаписи.Рецептура = РецептураСсылка;
					МенеджерЗаписи.ДатаВремяДействия = ТекущаяДатаСеанса();
					МенеджерЗаписи.Записать();
				КонецЕсли;
				
				КоличествоОтключенных = КоличествоОтключенных + 1;
				
			КонецЕсли;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			ОтменитьТранзакцию();
			Сообщить("Не удалось отключить рецептуру " + РецептураСсылка + ". Ошибка: " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;
	
	Если КоличествоОтключенных > 0 Тогда
		Сообщить("Успешно отключено рецептур: " + КоличествоОтключенных);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоПозицийБезЗаменОтключитьПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ДеревоПозицийБезЗамен.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	РодительУзла = ТекущиеДанные.ПолучитьРодителя();
	
	// Если родитель - это не ДанныеФормыЭлементДерева, значит это корневой узел
	// (его родитель - сама коллекция)
	Если НЕ ТипЗнч(РодительУзла) = Тип("ДанныеФормыЭлементДерева") Тогда // Это родительский узел (номенклатура)
		Для Каждого ДочернийУзел Из ТекущиеДанные.ПолучитьЭлементы() Цикл
			ДочернийУзел.Отключить = ТекущиеДанные.Отключить;
		КонецЦикла;
	Иначе // Если это дочерний узел (рецептура)
		Родитель = РодительУзла;
		Если НЕ ТекущиеДанные.Отключить Тогда
			Родитель.Отключить = Ложь;
		Иначе
			ВсеВключены = Истина;
			Для Каждого ДочернийУзел Из Родитель.ПолучитьЭлементы() Цикл
				Если НЕ ДочернийУзел.Отключить Тогда
					ВсеВключены = Ложь;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если ВсеВключены Тогда
				Родитель.Отключить = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры