#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	ЗагрузитьПараметрыФормы();
	ОбновитьПараметрыСпискаВыпусков();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ФронтСистемаПриИзменении(Элемент)
	
	ОбновитьФорму();
	
КонецПроцедуры

&НаКлиенте
Процедура ВсеОтклоненияПриИзменении(Элемент)
	
	ОбновитьФлажки("ВсеОтклонения");
	
КонецПроцедуры

&НаКлиенте
Процедура ОтклоненияПоСуммеПриИзменении(Элемент)
	
	ОбновитьФлажки("ОтклоненияПоСумме");
	
КонецПроцедуры

&НаКлиенте
Процедура ЧекНеНайденПриИзменении(Элемент)
	
	ОбновитьФлажки("ЧекНеНайден");
	
КонецПроцедуры

&НаКлиенте
Процедура ЧекиАлкогольПриИзменении(Элемент)
	
	ОбновитьФлажки("ЧекиАлкоголь");
	
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураНеЗаполненаПриИзменении(Элемент)
	
	ОбновитьФлажки("НоменклатураНеЗаполнена");
	
КонецПроцедуры

&НаКлиенте
Процедура ИнтервалОтбораДатаПриИзменении(Элемент)
	
	MRS_ИнтервалОтбора.Вариант = ВариантСтандартногоПериода.ПроизвольныйПериод;
	НачалоПериода = MRS_ИнтервалОтбора.ДатаНачала;
	КонецПериода   = MRS_ИнтервалОтбора.КонецПериода;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сверить(Команда)
	
	СверитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура Загрузить(Команда)
	
	ЗагрузитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьДаты(Команда)
	
	ОбработчикОповещения = Новый ОписаниеОповещения("ИнтервалОтбораПриИзмененииЗавершение", ЭтотОбъект);
	Диалог = Новый ДиалогРедактированияСтандартногоПериода;
	Диалог.Период = MRS_ИнтервалОтбора;
	Диалог.Показать(ОбработчикОповещения);
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьФлажки(Команда)
	
	Для Каждого СтрокаТаблицы Из Объект.ПараметрыКасс Цикл
		СтрокаТаблицы.Использовать = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьФлажки(Команда)
	
	Для Каждого СтрокаТаблицы Из Объект.ПараметрыКасс Цикл
		СтрокаТаблицы.Использовать = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура НачалоПериодаПриИзменении(Элемент)
	 MRS_ИнтервалОтбора.ДатаНачала = Объект.НачалоПериода;
	 ОбновитьПараметрыСпискаВыпусков();
КонецПроцедуры

&НаКлиенте
Процедура КонецПериодаПриИзменении(Элемент)
	MRS_ИнтервалОтбора.ДатаОкончания = Объект.КонецПериода;
	ОбновитьПараметрыСпискаВыпусков();
КонецПроцедуры

&НаКлиенте
Процедура ПараметрыКассИспользоватьПриИзменении(Элемент)
	ОбновитьПараметрыСпискаВыпусков();
КонецПроцедуры

&НаКлиенте
Процедура СформироватьВедомость(Команда)
	// Проверка заполнения периода
	Если НЕ ЗначениеЗаполнено(Объект.НачалоПериода) ИЛИ НЕ ЗначениеЗаполнено(Объект.КонецПериода) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Необходимо заполнить период");
		Возврат;
	КонецЕсли;
	
	// Проверка выбора касс
	ЕстьИспользуемыеКассы = Ложь;
	Для Каждого СтрокаКассы Из Объект.ПараметрыКасс Цикл
		
		Если СтрокаКассы.Использовать Тогда
			ЕстьИспользуемыеКассы = Истина;
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ ЕстьИспользуемыеКассы Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не выбрано ни одной кассы. Установите флажки в таблице касс.");
		Возврат;
	КонецЕсли;
	
	// Формирование отчета на сервере
	СформироватьОтчетНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВедомостьОтчетОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	
	СтандартнаяОбработка = Ложь;
	ОбработатьРасшифровку(Расшифровка);
	
КонецПроцедуры

&НаКлиенте
Процедура ВедомостьОтчетОбработкаДополнительнойРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	
	СтандартнаяОбработка = Ложь;
	ОбработатьРасшифровку(Расшифровка);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтчетСверкаОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	
	СтандартнаяОбработка = Ложь;
	ОбработатьРасшифровку(Расшифровка);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтчетСверкаОбработкаДополнительнойРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	
	СтандартнаяОбработка = Ложь;
	ОбработатьРасшифровку(Расшифровка);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьРасшифровку(Расшифровка)
	
	Данные = ДанныеЭлементаРасшифровки(Расшифровка);
	
	Если Данные = Неопределено Или ТипЗнч(Данные) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	// Поиск первого ссылочного значения в полях расшифровки
	Для Каждого КлючЗначение Из Данные Цикл
		
		ЗначениеПоля = КлючЗначение.Значение;
		
		Если ЗначениеПоля <> Неопределено Тогда
			
			ТипЗначения = ТипЗнч(ЗначениеПоля);
			
			Если ОбщегоНазначенияКлиент.ЭтоСсылка(ТипЗначения) Тогда
				ПоказатьЗначение(, ЗначениеПоля);
				Прервать;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура СверитьНаСервере()
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("ВсеОтклонения",           ВсеОтклонения);
	СтруктураОтбора.Вставить("ЧекНеНайден",             ЧекНеНайден);
	СтруктураОтбора.Вставить("ЧекиАлкоголь",            ЧекиАлкоголь);
	СтруктураОтбора.Вставить("ОтклоненияПоСумме",       ОтклоненияПоСумме);
	СтруктураОтбора.Вставить("НоменклатураНеЗаполнена", НоменклатураНеЗаполнена);
	
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ПолучитьОтчетСверки(СтруктураОтбора, УникальныйИдентификатор);
	ЗначениеВРеквизитФормы(ОбработкаОбъект, "Объект");
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьПараметрыФормы()
	
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ЗагрузитьПараметрыФормы();
	ЗначениеВРеквизитФормы(ОбработкаОбъект, "Объект");

	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьНаСервере()
	
	Обработка = РеквизитФормыВЗначение("Объект");
	Обработка.ВыполнитьЗагрузкуДанных();
	
КонецПроцедуры

&НаКлиенте
Процедура ИнтервалОтбораПриИзмененииЗавершение(Период, ДополнительныеПараметры) Экспорт
	
	Если Период = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	MRS_ИнтервалОтбора = Период;
	Объект.НачалоПериода = MRS_ИнтервалОтбора.ДатаНачала;
	Объект.КонецПериода  = MRS_ИнтервалОтбора.ДатаОкончания;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьФорму()
	
	ЗагрузитьПараметрыФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьФлажки(ИмяТекущегоФлажка)
	
	Если ЭтотОбъект[ИмяТекущегоФлажка] Тогда
		
		// Список всех флажков
		МассивФлажков = Новый Массив;
		МассивФлажков.Добавить("ОтклоненияПоСумме");
		МассивФлажков.Добавить("ЧекНеНайден");
		МассивФлажков.Добавить("ЧекиАлкоголь");
		МассивФлажков.Добавить("НоменклатураНеЗаполнена");
		
		Если ИмяТекущегоФлажка = "ВсеОтклонения" Тогда
			
			Для Каждого ИмяФлажка Из МассивФлажков Цикл
				ЭтотОбъект[ИмяФлажка] = Ложь;
			КонецЦикла;
			
		Иначе
			
			ЭтотОбъект.ВсеОтклонения = Ложь;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СформироватьОтчетНаСервере()
	
	// Получение складов из выбранных касс
	МассивСкладов = ПолучитьСкладыПоКассам();
	
	Если МассивСкладов.Количество() = 0 Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не удалось определить склады по выбранным кассам");
		Возврат;
	КонецЕсли;
	
	// Получение схемы компоновки данных из отчета
	СхемаКомпоновкиДанных = Отчеты.ВедомостьПоТоварамНаСкладах.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	
	Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	// Формирование стандартного периода
	СтандартныйПериод = Новый СтандартныйПериод;
	СтандартныйПериод.ДатаНачала = Объект.НачалоПериода;
	СтандартныйПериод.ДатаОкончания = Объект.КонецПериода;
	
	// Установка параметра "Период" если он есть в настройках
	ПараметрПериод = Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
	Если ПараметрПериод <> Неопределено Тогда
		ПараметрПериод.Значение = СтандартныйПериод;
		ПараметрПериод.Использование = Истина;
	КонецЕсли;
	
	// Добавление отбора по складу
	ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Склад");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	ЭлементОтбора.ПравоеЗначение = МассивСкладов;
	ЭлементОтбора.Использование = Истина;
	
	ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных; 
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;	
	Макет = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки, , Тип("ГенераторМакетаКомпоновкиДанных"));
	Макет.ЗначенияПараметров.ТекущаяДата.Значение = ТекущаяДатаСеанса();
	
	// Создание процессора компоновки данных
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(Макет, , ДанныеРасшифровки, Истина);
	
	// Очистка документа результата
	ВедомостьОтчет.Очистить();
	
	// Создание процессора вывода результата
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ВедомостьОтчет);
	
	// Вывод результата
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
	// Сохранение данных расшифровки во временное хранилище
	АдресДанныхРасшифровки = ПоместитьВоВременноеХранилище(ДанныеРасшифровки, УникальныйИдентификатор);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСкладыПоКассам()
	
	МассивКасс = Новый Массив;
	
	Для Каждого СтрокаКассы Из Объект.ПараметрыКасс Цикл
		
		Если СтрокаКассы.Использовать И ЗначениеЗаполнено(СтрокаКассы.КассаККМ) Тогда
			МассивКасс.Добавить(СтрокаКассы.КассаККМ);
		КонецЕсли;
		
	КонецЦикла;
	
	Если МассивКасс.Количество() = 0 Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	// Пакетное получение складов через SSL функцию
	СоответствиеСкладов = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(МассивКасс, "Склад");
	
	МассивСкладов = Новый Массив;
	КэшСкладов = Новый Соответствие;
	
	Для Каждого КлючЗначение Из СоответствиеСкладов Цикл
		
		Склад = КлючЗначение.Значение;
		
		Если ЗначениеЗаполнено(Склад) И КэшСкладов.Получить(Склад) = Неопределено Тогда
			МассивСкладов.Добавить(Склад);
			КэшСкладов.Вставить(Склад, Истина);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат МассивСкладов;
	
КонецФункции

&НаСервере
Процедура ОбновитьПараметрыСпискаВыпусков()
	
	// Определение периода для фильтрации
	Если ЗначениеЗаполнено(Объект.НачалоПериода) И ЗначениеЗаполнено(Объект.КонецПериода) Тогда
		НачалоПериода = Объект.НачалоПериода;
		КонецПериода = Объект.КонецПериода;
	Иначе
		// Если период не задан, используем текущий месяц
		НачалоПериода = НачалоМесяца(ТекущаяДатаСеанса());
		КонецПериода = КонецМесяца(ТекущаяДатаСеанса());
	КонецЕсли;
	
	// Получение складов из выбранных касс
	МассивСкладов = ПолучитьСкладыПоКассам();
	
	// Установка периода
	// Удаление старой группы отбора по периоду (если существует)
	ОбщегоНазначенияКлиентСервер.УдалитьЭлементыГруппыОтбораДинамическогоСписка(
		СписокВыпуски,
		,
		"Период");
	
	// Создание группы отбора для периода с типом "И"
	ГруппаПериод = ОбщегоНазначенияКлиентСервер.СоздатьГруппуЭлементовОтбора(
		СписокВыпуски.Отбор.Элементы,
		"Период",
		ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИ);
	ГруппаПериод.Использование = Истина;
	
	// Добавление условия "БольшеИлиРавно"
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(
		ГруппаПериод,
		"Дата",
		НачалоПериода,
		ВидСравненияКомпоновкиДанных.БольшеИлиРавно,
		,
		Истина);
	
	// Добавление условия "МеньшеИлиРавно"
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(
		ГруппаПериод,
		"Дата",
		КонецПериода,
		ВидСравненияКомпоновкиДанных.МеньшеИлиРавно,
		,
		Истина);	
	
	// Установка складов
	Если МассивСкладов.Количество() > 0 Тогда
		
		ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(
			СписокВыпуски,
			"Склад",
			МассивСкладов,
			ВидСравненияКомпоновкиДанных.ВСписке,
			,
			Истина);
		
	Иначе
		
		// Если кассы не выбраны, удаляем отбор по складам
		ОбщегоНазначенияКлиентСервер.УдалитьЭлементыГруппыОтбораДинамическогоСписка(
			СписокВыпуски,
			"Склад");
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ДанныеЭлементаРасшифровки(Знач Расшифровка)
	
	Если НЕ ЗначениеЗаполнено(АдресДанныхРасшифровки) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		ДанныеРасшифровки = ПолучитьИзВременногоХранилища(АдресДанныхРасшифровки);
		
		Если ДанныеРасшифровки = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		ЭлементРасшифровки = ДанныеРасшифровки.Элементы[Расшифровка];
		
		Если ЭлементРасшифровки = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		// Извлечение полей расшифровки в структуру для передачи клиенту
		Результат = Новый Структура;
		
		Для Каждого Поле Из ЭлементРасшифровки.ПолучитьПоля() Цикл
			Результат.Вставить(Поле.Поле, Поле.Значение);
		КонецЦикла;
		
		Возврат Результат;
		
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

#КонецОбласти