#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Выполняет загрузку данных из фронт-системы (TNG или Micros) за указанный период.
// Использует реквизиты объекта обработки: ФронтСистема, НачалоПериода, КонецПериода, ПараметрыКасс, НомерЧека.
//
Процедура ВыполнитьЗагрузкуДанных() Экспорт
	
	Если ФронтСистема = Перечисления.ПЛ_ТипыФронтСистем.TNG Тогда
		
		MRS_МенеджерОбменаTNG.ВыполнитьЗагрузкуДанныхTNG(
			ФронтСистема,
			НачалоПериода,
			КонецПериода,
			ПараметрыКасс,
			НомерЧека);
		
	ИначеЕсли ФронтСистема = Перечисления.ПЛ_ТипыФронтСистем.Micros Тогда
		
		MRS_МенеджерОбменаMicros.ВыполнитьЗагрузкуДанныхMicros(
			ФронтСистема,
			НачалоПериода,
			КонецПериода,
			ПараметрыКасс,
			НомерЧека);
		
	Иначе
		
		ВызватьИсключение СтрШаблон("Неподдерживаемый тип фронт-системы: %1", ФронтСистема);
		
	КонецЕсли;
		
КонецПроцедуры

// Формирует отчет сверки данных между фронт-системой и 1С.
// Результат помещается в реквизит ОтчетСверка.
//
// Параметры:
//  СтруктураОтбора - Структура - структура с параметрами отбора:
//   * ВсеОтклонения - Булево - показать все типы отклонений
//   * ЧекНеНайден - Булево - показать чеки, не найденные в 1С
//   * ЧекиАлкоголь - Булево - показать чеки с алкоголем (только для Micros)
//   * ОтклоненияПоСумме - Булево - показать отклонения по суммам
//   * НоменклатураНеЗаполнена - Булево - показать позиции с незаполненной номенклатурой
//  УникальныйИдентификаторФормы - УникальныйИдентификатор - идентификатор формы для временного хранилища
//
Процедура ПолучитьОтчетСверки(СтруктураОтбора, УникальныйИдентификаторФормы) Экспорт
	
	Отчет = Отчеты.MRS_ПродажиФронтСистем.Создать();
	
	Если ФронтСистема = Перечисления.ПЛ_ТипыФронтСистем.TNG Тогда
		
		// TNG
		СхемаКомпоновкиДанных = Отчет.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
		
		ТаблицаДанных = MRS_МенеджерОбменаTNG.ВыполнитьПолучениеДанныхTNG(
			ФронтСистема,
			НачалоПериода,
			КонецПериода,
			ПараметрыКасс,
			НомерЧека);
		
		ВнешнийНаборДанных = Новый Структура("ТаблицаЗначений", ТаблицаДанных);
		
		Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
		
		ДобавитьОтборыВОтчет(Настройки, СтруктураОтбора, ФронтСистема);
		
	Иначе
		
		СхемаКомпоновкиДанных = Отчет.ПолучитьМакет("СхемаКомпоновкиMicros");
		
		ТаблицаЗначенийMicros = MRS_МенеджерОбменаMicros.ВыполнитьПолучениеДанныхMicros(
			ФронтСистема,
			НачалоПериода,
			КонецПериода,
			ПараметрыКасс,
			НомерЧека);
		
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ТЗ.MRS_IDOracleЧекОбщепита КАК MRS_IDOracleЧекОбщепита,
		|	ТЗ.НОМЕРТОЧКИПРОДАЖORACLE КАК НОМЕРТОЧКИПРОДАЖORACLE
		|ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	&ТЗ КАК ТЗ
		|ГДЕ
		|	ТЗ.MRS_IDOracleЧекОбщепита <> 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсходныеДанные.MRS_IDOracleЧекОбщепита КАК MRS_IDOracleЧекОбщепита
		|ПОМЕСТИТЬ ЧекиПоИД
		|ИЗ
		|	ИсходныеДанные КАК ИсходныеДанные
		|СГРУППИРОВАТЬ ПО
		|	ИсходныеДанные.MRS_IDOracleЧекОбщепита
		|ИМЕЮЩИЕ
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ВЫРАЗИТЬ(ИсходныеДанные.НОМЕРТОЧКИПРОДАЖORACLE КАК СТРОКА(5))) > 1
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЧекиПоИД.MRS_IDOracleЧекОбщепита КАК MRS_IDOracleЧекОбщепита
		|ИЗ
		|	ЧекиПоИД КАК ЧекиПоИД";
		
		Запрос.Параметры.Вставить("ТЗ", ТаблицаЗначенийMicros);
		
		Результат = Запрос.Выполнить();
		РезультатВыгрузка = Результат.Выгрузить();
		МассивОбъединенныхИД = РезультатВыгрузка.ВыгрузитьКолонку("MRS_IDOracleЧекОбщепита");
		
		ТаблицаЗначенийMicros.Колонки.Добавить("Объединен", Новый ОписаниеТипов("Булево"));
		
		Для Каждого Строка Из ТаблицаЗначенийMicros Цикл
			
			Строка.Объединен = (МассивОбъединенныхИД.Найти(Строка.MRS_IDOracleЧекОбщепита) <> Неопределено);
			
		КонецЦикла;
		
		ВнешнийНаборДанных = Новый Структура("ТаблицаЗначенийMicros", ТаблицаЗначенийMicros);
		
		Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
		
		ДобавитьОтборыВОтчет(Настройки, СтруктураОтбора, ФронтСистема);
		
	КонецЕсли;
	
	ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных; 
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;	
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
	
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных; 
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, ВнешнийНаборДанных, ДанныеРасшифровки, Истина);
	
	ОтчетСверка.Очистить();
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент; 
	ПроцессорВывода.УстановитьДокумент(ОтчетСверка); 
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
	
КонецПроцедуры

// Загружает список касс ККМ в табличную часть ПараметрыКасс.
// Заполняет ТЧ обработки кассами ККМ с привязкой к фронт-системам на основе регистра сведений
// ПЛ_СоответствиеСФронтСистемами.
//
// Используются реквизиты объекта обработки:
//  ФронтСистема - ПеречислениеСсылка.ПЛ_ТипыФронтСистем - фильтр по типу фронт-системы (если не заполнен, загружаются TNG и Micros)
//  ПараметрыКасс - ТабличнаяЧасть - заполняется данными о кассах
//
Процедура ЗагрузитьПараметрыФормы() Экспорт
	
	ПараметрыКасс.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЛОЖЬ КАК Использовать,
	|	КассыККМ.Ссылка КАК КассаККМ,
	|	ПЛ_СоответствиеСФронтСистемами.ФронтСистема КАК ФронтСистема,
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК КодТочкиПродаж,
	|	ПЛ_СоответствиеСФронтСистемами.НаименованиеКнопки КАК НаименованиеТочкиПродаж
	|ИЗ
	|	Справочник.КассыККМ КАК КассыККМ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|		ПО КассыККМ.Ссылка = ПЛ_СоответствиеСФронтСистемами.Объект
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.ФронтСистема В(&ФронтСистема)
	|
	|УПОРЯДОЧИТЬ ПО
	|	КассаККМ";
	
	ФронтСистемаМассив = Новый Массив;
	ФронтСистемаМассив.Добавить(Перечисления.ПЛ_ТипыФронтСистем.TNG);
	ФронтСистемаМассив.Добавить(Перечисления.ПЛ_ТипыФронтСистем.Micros);
	
	Если ЗначениеЗаполнено(ФронтСистема) Тогда
		
		Запрос.УстановитьПараметр("ФронтСистема", ФронтСистема);
		
	Иначе
		
		Запрос.УстановитьПараметр("ФронтСистема", ФронтСистемаМассив);
		
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ПараметрыКасс.Загрузить(РезультатЗапроса.Выгрузить());
		
	КонецЕсли;
	
КонецПроцедуры

// Формирует ведомость по товарам на складах с отрицательными остатками.
// Результат помещается в реквизит ВедомостьОтчет.
//
// Параметры:
//  МассивСкладов - Массив из СправочникСсылка.Склады - склады для отбора
//  УникальныйИдентификаторФормы - УникальныйИдентификатор - идентификатор формы для временного хранилища
//
// Возвращаемое значение:
//  Строка - адрес данных расшифровки во временном хранилище
//
Функция СформироватьВедомость(МассивСкладов, УникальныйИдентификаторФормы) Экспорт
	
	// Получение схемы компоновки данных из отчета
	СхемаКомпоновкиДанных = Отчеты.ВедомостьПоТоварамНаСкладах.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	
	// Используем копию настроек для многопользовательской среды
	Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	// Формирование стандартного периода (используется конец периода)
	СтандартныйПериод = Новый СтандартныйПериод;
	СтандартныйПериод.ДатаНачала = КонецПериода;
	СтандартныйПериод.ДатаОкончания = КонецПериода;
	
	// Установка параметра "Период" если он есть в настройках
	ПараметрПериод = Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
	
	Если ПараметрПериод <> Неопределено Тогда
		
		ПараметрПериод.Значение = СтандартныйПериод;
		ПараметрПериод.Использование = Истина;
		
	КонецЕсли;
	
	// Добавление отбора по складу
	ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Склад");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	ЭлементОтбора.ПравоеЗначение = МассивСкладов;
	ЭлементОтбора.Использование = Истина;
	
	// Добавление отбора по количеству остатка меньше 0
	ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("КонечныйОстаток");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Меньше;
	ЭлементОтбора.ПравоеЗначение = 0;
	ЭлементОтбора.Использование = Истина;
	
	ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	Макет = КомпоновщикМакета.Выполнить(
		СхемаКомпоновкиДанных,
		Настройки,
		ДанныеРасшифровки,
		,
		Тип("ГенераторМакетаКомпоновкиДанных"));
	Макет.ЗначенияПараметров.ТекущаяДата.Значение = ТекущаяДатаСеанса();
	
	// Создание процессора компоновки данных
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(Макет, , ДанныеРасшифровки, Истина);
	
	// Очистка документа результата
	ВедомостьОтчет.Очистить();
	
	// Создание процессора вывода результата
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ВедомостьОтчет);
	
	// Вывод результата
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
	// Сохранение данных расшифровки во временное хранилище
	АдресДанныхРасшифровки = ПоместитьВоВременноеХранилище(ДанныеРасшифровки, УникальныйИдентификаторФормы);
	
	Возврат АдресДанныхРасшифровки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Добавляет отборы в настройки компоновки данных отчета сверки.
//
// Параметры:
//  Настройки - НастройкиКомпоновкиДанных - настройки компоновки данных
//  СтруктураОтбора - Структура - структура с параметрами отбора
//  ФронтСистема - ПеречислениеСсылка.ПЛ_ТипыФронтСистем - тип фронт-системы
//
Процедура ДобавитьОтборыВОтчет(Настройки, СтруктураОтбора, ФронтСистема)

	ЕстьАктивныеОтборы = СтруктураОтбора.ВсеОтклонения
		Или СтруктураОтбора.ЧекНеНайден
		Или СтруктураОтбора.ЧекиАлкоголь
		Или СтруктураОтбора.ОтклоненияПоСумме
		Или СтруктураОтбора.НоменклатураНеЗаполнена;
	
	Если НЕ ЕстьАктивныеОтборы Тогда
		Возврат;
	КонецЕсли;
	
	// Создаем группу с типом "ИЛИ" для комбинирования условий
	ГруппаОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаОтбора.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	ГруппаОтбора.Использование = Истина;
	
	Если СтруктураОтбора.ВсеОтклонения Тогда
		
		ДобавитьВсеОтборыОтклонений(ГруппаОтбора, ФронтСистема);
		
	Иначе
		
		ДобавитьИндивидуальныеОтборы(ГруппаОтбора, СтруктураОтбора, ФронтСистема);
		
	КонецЕсли;
	
КонецПроцедуры

// Добавляет все отборы для поиска отклонений.
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//  ФронтСистема - ПеречислениеСсылка.ПЛ_ТипыФронтСистем - тип фронт-системы
//
Процедура ДобавитьВсеОтборыОтклонений(ГруппаОтбора, ФронтСистема)

	ДобавитьОтборЧекНеНайден(ГруппаОтбора);
	ДобавитьОтборНоменклатураНеЗаполнена(ГруппаОтбора);
	ДобавитьОтборАлкоголь(ГруппаОтбора, ФронтСистема);
	ДобавитьОтборОтклоненияПоСумме(ГруппаОтбора);
	
КонецПроцедуры

// Добавляет индивидуальные отборы согласно структуре отбора.
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//  СтруктураОтбора - Структура - структура с параметрами отбора
//  ФронтСистема - ПеречислениеСсылка.ПЛ_ТипыФронтСистем - тип фронт-системы
//
Процедура ДобавитьИндивидуальныеОтборы(ГруппаОтбора, СтруктураОтбора, ФронтСистема)

	Если СтруктураОтбора.ЧекНеНайден Тогда
		
		ДобавитьОтборЧекНеНайден(ГруппаОтбора);
		
	КонецЕсли;
	
	Если СтруктураОтбора.ЧекиАлкоголь Тогда
		
		ДобавитьОтборАлкоголь(ГруппаОтбора, ФронтСистема);
		
	КонецЕсли;
	
	Если СтруктураОтбора.ОтклоненияПоСумме Тогда
		
		ДобавитьОтборОтклоненияПоСумме(ГруппаОтбора);
		
	КонецЕсли;
	
	Если СтруктураОтбора.НоменклатураНеЗаполнена Тогда
		
		ДобавитьОтборНоменклатураНеЗаполнена(ГруппаОтбора);
		
	КонецЕсли;
	
КонецПроцедуры

// Добавляет отбор "Чек не найден".
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//
Процедура ДобавитьОтборЧекНеНайден(ГруппаОтбора)

	ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ЧекОбщепита");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.НеЗаполнено;
	ЭлементОтбора.Использование = Истина;
	
КонецПроцедуры

// Добавляет отбор "Номенклатура не заполнена".
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//
Процедура ДобавитьОтборНоменклатураНеЗаполнена(ГруппаОтбора)

	ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("НоменклатураЧекОбщепита");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.НеЗаполнено;
	ЭлементОтбора.Использование = Истина;
	
КонецПроцедуры

// Добавляет отбор "Чеки с алкоголем" (только для Micros).
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//  ФронтСистема - ПеречислениеСсылка.ПЛ_ТипыФронтСистем - тип фронт-системы
//
Процедура ДобавитьОтборАлкоголь(ГруппаОтбора, ФронтСистема)

	Если ФронтСистема = Перечисления.ПЛ_ТипыФронтСистем.TNG Тогда
		Возврат;
	КонецЕсли;
	
	ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("НоменклатураАлкогольВЛитрах");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение = Истина;
	ЭлементОтбора.Использование = Истина;
	
КонецПроцедуры

// Добавляет отбор "Отклонения по сумме".
//
// Параметры:
//  ГруппаОтбора - ГруппаЭлементовОтбораКомпоновкиДанных - группа отбора
//
Процедура ДобавитьОтборОтклоненияПоСумме(ГруппаОтбора)

	ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("РазницаСумм");
	ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ЭлементОтбора.ПравоеЗначение = 0;
	ЭлементОтбора.Использование = Истина;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли