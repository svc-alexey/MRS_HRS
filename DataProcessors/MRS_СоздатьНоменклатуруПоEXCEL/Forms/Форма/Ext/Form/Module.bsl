&НаСервере
Процедура СоздатьсборкиНаСервере()
	
	// Определение режима работы: обработка одной номенклатуры или массовая обработка всего регистра
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		
		// Режим 1: Обработка одной номенклатуры
		ОбработатьОднуНоменклатуру();
		
	Иначе
		
		// Режим 2: Массовая обработка всего регистра
		ОбработатьВсеЗаписиРегистра();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработка одной номенклатуры (Режим 1)
Процедура ОбработатьОднуНоменклатуру()
	
	// Шаг 1: Поиск записи в регистре MRS_СоответствиеСтаройНовойНоменклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	МассивСоответствий.СтараяНоменклатура КАК СтараяНоменклатура,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|ГДЕ
	|	(МассивСоответствий.СтараяНоменклатура = &Номенклатура
	|		ИЛИ МассивСоответствий.ВскрытаяНоменклатура = &Номенклатура)
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		// Определение сценария
		Если ЗначениеЗаполнено(Выборка.СтараяНоменклатура) Тогда
			
			// Сценарий 1А: Замена с остатками
			ОбработатьЗаменуСОстатками(Выборка.СтараяНоменклатура, Выборка.НоваяНоменклатура);
			
		ИначеЕсли ЗначениеЗаполнено(Выборка.ВскрытаяНоменклатура) Тогда
			
			// Сценарий 1Б: Только обновление соответствий
			ОбновитьСоответствияСФронтСистемами(Выборка.ВскрытаяНоменклатура, Выборка.НоваяНоменклатура);
			
		Иначе
			
			// Некорректные данные в регистре
			
		КонецЕсли;
		
	Иначе
		
		Сообщить("Для выбранной номенклатуры """ + Строка(Номенклатура) + """ не найдена запись в регистре MRS_СоответствиеСтаройНовойНоменклатуры!");
		
	КонецЕсли;
	
КонецПроцедуры

// Массовая обработка всего регистра (Режим 2)
Процедура ОбработатьВсеЗаписиРегистра()
	
	// Выборка всех записей из регистра MRS_СоответствиеСтаройНовойНоменклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	МассивСоответствий.СтараяНоменклатура КАК СтараяНоменклатура,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|ГДЕ
	|	МассивСоответствий.НоваяНоменклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если ЗначениеЗаполнено(Выборка.СтараяНоменклатура) Тогда
			
			// Сценарий: Замена с остатками
			ОбработатьЗаменуСОстатками(Выборка.СтараяНоменклатура, Выборка.НоваяНоменклатура);
			
		ИначеЕсли ЗначениеЗаполнено(Выборка.ВскрытаяНоменклатура) и НЕ ТолькоБезСоответствий Тогда
			
			// Сценарий: Только обновление соответствий
			ОбновитьСоответствияСФронтСистемами(Выборка.ВскрытаяНоменклатура, Выборка.НоваяНоменклатура);
			
		Иначе
			
			// Некорректные данные в регистре - пропускаем
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Обработка замены номенклатуры с остатками (Сценарий 1А)
//
// Параметры:
//  СтараяНоменклатура - СправочникСсылка.Номенклатура - Номенклатура, подлежащая замене
//  НоваяНоменклатура - СправочникСсылка.Номенклатура - Целевая номенклатура для замены
//
Процедура ОбработатьЗаменуСОстатками(СтараяНоменклатура, НоваяНоменклатура)
	
	// Получение упаковки новой номенклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	УпаковкиЕдиницыИзмерения.Ссылка КАК Упаковка
	|ИЗ
	|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
	|ГДЕ
	|	УпаковкиЕдиницыИзмерения.Владелец = &НоваяНоменклатура
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НоваяНоменклатура", НоваяНоменклатура);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ВыборкаУпаковки = Результат.Выбрать();
	ВыборкаУпаковки.Следующий();
	УпаковкаНоменклатуры = ВыборкаУпаковки.Упаковка;
	
	//////////////////////////////////////////////////////////////////////
	
	// Шаг 2: Запрос остатков по складам с группировкой
	ТекстЗапросаОстатков = "ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Серия КАК Серия,
	|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
	|	ТоварыНаСкладахОстатки.Склад.ПЛ_Организация КАК Организация,
	|	ТоварыНаСкладахОстатки.Склад КАК Склад,
	|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&Дата,
	|			Номенклатура = &Номенклатура
	|			И Номенклатура.ВидНоменклатуры <> &ИсключитьДиапазон
	|			И Склад <> &ИсключаемыеСклады
	|			#УсловиеСклад#
	|			) КАК ТоварыНаСкладахОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
	|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
	|ИТОГИ
	|	СУММА(ВНаличииОстаток)
	|ПО
	|	Склад";

	// Учет параметра Склад
	Если ЗначениеЗаполнено(Склад) Тогда
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", " И Склад = &Склад");
		
	Иначе
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", "");
		
	КонецЕсли;
	
	ЗапросОстатков = Новый Запрос(ТекстЗапросаОстатков);
	ЗапросОстатков.УстановитьПараметр("ИсключитьДиапазон", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));// Готовая алкогольная продукция с ФСМ (Справочники.ВидыНоменклатуры)
	ЗапросОстатков.УстановитьПараметр("ИсключаемыеСклады", Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817")));// 505 Склад алкогольной продукции Винодельни_М.ПРО (МРИЯ.ПРО ООО) (Справочники.Склады)
	ЗапросОстатков.УстановитьПараметр("Дата", Новый Граница(?(ЗначениеЗаполнено(Период), КонецДня(Период), КонецДня(ТекущаяДатаСеанса())), ВидГраницы.Включая));
	ЗапросОстатков.УстановитьПараметр("Номенклатура", СтараяНоменклатура);
	
	Если ЗначениеЗаполнено(Склад) Тогда
		
		ЗапросОстатков.УстановитьПараметр("Склад", Склад);
		
	КонецЕсли;
	
	ВыборкаСклад = ЗапросОстатков.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	// Шаг 3: Создание отдельного документа сборки для каждого склада
	Пока ВыборкаСклад.Следующий() Цикл
		
		Если ВыборкаСклад.ВНаличииОстаток > 0 Тогда
			
			ДокументСборки = Документы.СборкаТоваров.СоздатьДокумент();
			ДокументСборки.Комментарий = "#Документ создан обработкой комплектации в литражную номенклатуру.";
			ДокументСборки.Организация = ?(ЗначениеЗаполнено(ВыборкаСклад.Организация), ВыборкаСклад.Организация, Справочники.Организации.ПустаяСсылка());
			ДокументСборки.Склад = ВыборкаСклад.Склад;
			ДокументСборки.Дата = ТекущаяДатаСеанса();
			ДокументСборки.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров;
			ДокументСборки.Номенклатура = НоваяНоменклатура;
			ДокументСборки.Ответственный = ПараметрыСеанса.ТекущийПользователь;
			ДокументСборки.Статус = Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
			ДокументСборки.СборкаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
			ДокументСборки.ВариантПриемкиТоваров = Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;
			ДокументСборки.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.Упаковка = УпаковкаНоменклатуры;
			ДокументСборки.Количество = ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.СтатусУказанияСерий = 4;
			
			СтрокаТЧТовары = ДокументСборки.Товары.Добавить();
			СтрокаТЧТовары.Номенклатура = СтараяНоменклатура;
			СтрокаТЧТовары.Количество = ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.СтатусУказанияСерий = 4;
			
			ВыборкаСерия = ВыборкаСклад.Выбрать();
			
			Пока ВыборкаСерия.Следующий() Цикл
				
				СтрокаСерии = ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура = ВыборкаСерия.Номенклатура;
				СтрокаСерии.Серия = ВыборкаСерия.Серия;
				СтрокаСерии.Количество = 1;
				
				СтрокаСерии = ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура = НоваяНоменклатура;
				СтрокаСерии.Количество = НоваяНоменклатура.ОбъемДАЛ * 10;
				СтрокаСерии.Серия = ВыборкаСерия.Серия;
				
				// Замена номенклатуры в штрихкодах
				Если ЗначениеЗаполнено(ВыборкаСерия.Штрихкод) Тогда
					
					ШтрихкодОбъект = ВыборкаСерия.Штрихкод.ПолучитьОбъект();
					ШтрихкодОбъект.Номенклатура = НоваяНоменклатура;
					ШтрихкодОбъект.Упаковка = УпаковкаНоменклатуры;
					ШтрихкодОбъект.Записать();
					
				КонецЕсли;
				
			КонецЦикла;
			
			ДокументСборки.Записать(РежимЗаписиДокумента.Запись);
			СтрокаДокументы = ТаблицаСборок.Добавить();
			СтрокаДокументы.ДокументыСборки = ДокументСборки.Ссылка;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ ТолькоБезСоответствий Тогда
		// Шаг 4: Обновление регистра ПЛ_СоответствиеСФронтСистемами
		ОбновитьСоответствияСФронтСистемами(СтараяНоменклатура.ПЛ_НоменклатураВоВскрытойТаре.Ссылка, НоваяНоменклатура);
	КонецЕсли;
КонецПроцедуры

// Обновление соответствий с фронт-системами
//
// Параметры:
//  ОбъектДляПоиска - СправочникСсылка.Номенклатура - Объект для поиска в регистре ПЛ_СоответствиеСФронтСистемами
//  НоваяНоменклатура - СправочникСсылка.Номенклатура - Целевая номенклатура для установки в НоменклатураАлкоголь
//
Процедура ОбновитьСоответствияСФронтСистемами(ОбъектДляПоиска, НоваяНоменклатура)
	
	Если НЕ ЗначениеЗаполнено(ОбъектДляПоиска) Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
	|ИЗ
	|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Объект", ОбъектДляПоиска);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Набор = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
		Набор.Отбор.Код.Установить(Выборка.Код);
		Набор.Прочитать();
		
		Для Каждого Запись Из Набор Цикл
			
			Запись.НоменклатураАлкоголь = НоваяНоменклатура;
			
		КонецЦикла;
		
		Набор.Записать();
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Создатьсборки(Команда)
	СоздатьсборкиНаСервере();
КонецПроцедуры

// ============================================================================
// Процедуры для многопоточной обработки
// ============================================================================

// Формирует и выполняет запрос для выборки данных из регистра соответствий
//
// Параметры:
//  ПараметрыОтбора - Структура - параметры для отбора данных:
//   * Склад - СправочникСсылка.Склады - склад для обработки (необязательный)
//   * Номенклатура - СправочникСсылка.Номенклатура - конкретная номенклатура (необязательный)
//
// Возвращаемое значение:
//  РезультатЗапроса - результат запроса для обхода в многопоточном режиме
//
&НаСервере
Функция ПолучитьДанныеДляОбработки(ПараметрыОтбора = Неопределено)
	
	Запрос = Новый Запрос;

Запрос.Текст =
"ВЫБРАТЬ
|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
|	ТоварыНаСкладахОстатки.Серия КАК Серия,
|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
|	ВЫБОР
|		КОГДА ТоварыНаСкладахОстатки.Склад.ПЛ_Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
|			ТОГДА АкцизныеМаркиЕГАИС.ОрганизацияЕГАИС.Контрагент
|		ИНАЧЕ ТоварыНаСкладахОстатки.Склад.ПЛ_Организация
|	КОНЕЦ КАК Организация,
|	ТоварыНаСкладахОстатки.Склад КАК Склад,
|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
|ИЗ
|	РегистрНакопления.ТоварыНаСкладах.Остатки(
|			&Дата,
|			Номенклатура.ВидНоменклатуры В (&ВидыНом)
|				И Склад <> &ИсключаемыеСклады
|				И Номенклатура.ЕдиницаИзмерения.Код <> ""112"") КАК ТоварыНаСкладахОстатки
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК АкцизныеМаркиЕГАИС
|		ПО (ТоварыНаСкладахОстатки.Серия.Номер = АкцизныеМаркиЕГАИС.АкцизнаяМарка.ЗначениеШтрихкода)
|ГДЕ
|	АкцизныеМаркиЕГАИС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ВНаличии)
|
|УПОРЯДОЧИТЬ ПО
|	Организация,
|	Склад,
|	Номенклатура";

Запрос.УстановитьПараметр("Дата", Дата(2025, 12, 24, 0, 26, 18));
Запрос.УстановитьПараметр("ИсключаемыеСклады", Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817")));// 505 Склад алкогольной продукции Винодельни_М.ПРО (МРИЯ.ПРО ООО) (Справочники.Склады)
Параметр = Новый СписокЗначений;
Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("7DA4E742-B389-11E9-80DF-000C29589659")));
Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));
Запрос.УстановитьПараметр("ВидыНом", Параметр);
ТаблицаДанныхКОбработке = Запрос.Выполнить().Выгрузить();	
	
КонецФункции


//
&НаСервере
Функция ОбработатьЗаписьДанных(ПараметрыОбработки)

	Запрос.Текст =
	"ВЫБРАТЬ
	|	МассивСоответствий.СтараяНоменклатура КАК СтараяНоменклатура,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|ГДЕ
	|	(МассивСоответствий.СтараяНоменклатура.ВидНоменклатуры В (&ВидыНоменклатуры)
	|			ИЛИ МассивСоответствий.СтараяНоменклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|			и МассивСоответствий.НоваяНоменклатура.ВидНоменклатуры В (&ВидыНоменклатуры))";
	
	Параметр = Новый СписокЗначений;
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("7DA4E742-B389-11E9-80DF-000C29589659")));
	Запрос.УстановитьПараметр("ВидыНоменклатуры", Параметр);
	
	
	

ПериодОбработки = Новый Граница(КонецДня(ТекущаяДатаСеанса()), ВидГраницы.Включая);
СкладОбработки = НЕОПРЕДЕЛЕНО;
ТолькоБезСоответствийОбработки = Ложь;

СтараяНоменклатура = ЭлементКоллекции.СтараяНоменклатура;
НоваяНоменклатура = ЭлементКоллекции.НоваяНоменклатура;
ВскрытаяНоменклатура = ЭлементКоллекции.ВскрытаяНоменклатура;

Если ЗначениеЗаполнено(СтараяНоменклатура) Тогда
	
	// Получение упаковки новой номенклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	УпаковкиЕдиницыИзмерения.Ссылка КАК Упаковка
	|ИЗ
	|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
	|ГДЕ
	|	УпаковкиЕдиницыИзмерения.Владелец = &НоваяНоменклатура
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НоваяНоменклатура", НоваяНоменклатура);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаУпаковки = Результат.Выбрать();
	ВыборкаУпаковки.Следующий();
	УпаковкаНоменклатуры = ВыборкаУпаковки.Упаковка;
	
	// Запрос остатков по складам с группировкой
	ТекстЗапросаОстатков = "ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Серия КАК Серия,
	|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
	|	ВЫБОР
	|		КОГДА ТоварыНаСкладахОстатки.Склад.ПЛ_Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА АкцизныеМаркиЕГАИС.ОрганизацияЕГАИС.Контрагент
	|		ИНАЧЕ ТоварыНаСкладахОстатки.Склад.ПЛ_Организация
	|	КОНЕЦ  КАК Организация,
	|	ТоварыНаСкладахОстатки.Склад КАК Склад,
	|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&Дата,
	|			Номенклатура = &Номенклатура
	|			И Номенклатура.ВидНоменклатуры <> &ИсключитьДиапазон
	|			И Склад <> &ИсключаемыеСклады
	|			#УсловиеСклад#
	|			) КАК ТоварыНаСкладахОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
	|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК АкцизныеМаркиЕГАИС
	|		ПО (ТоварыНаСкладахОстатки.Серия.Номер = АкцизныеМаркиЕГАИС.АкцизнаяМарка.ЗначениеШтрихкода)
	|ГДЕ
	|	АкцизныеМаркиЕГАИС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ВНаличии)
	|ИТОГИ
	|	СУММА(ВНаличииОстаток)
	|ПО
	|	Организация,
	|	Склад";
	
	// Учет параметра Склад
	Если ЗначениеЗаполнено(СкладОбработки) Тогда
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", " И Склад = &Склад");
		
	Иначе
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", "");
		
	КонецЕсли;
	
	ЗапросОстатков = Новый Запрос(ТекстЗапросаОстатков);
	ЗапросОстатков.УстановитьПараметр("ИсключитьДиапазон", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));
	ЗапросОстатков.УстановитьПараметр("ИсключаемыеСклады", Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817")));
	ЗапросОстатков.УстановитьПараметр("Дата", ПериодОбработки);
	ЗапросОстатков.УстановитьПараметр("Номенклатура", СтараяНоменклатура);
	
	Если ЗначениеЗаполнено(СкладОбработки) Тогда
		
		ЗапросОстатков.УстановитьПараметр("Склад", СкладОбработки);
		
	КонецЕсли;
	
	ВыборкаОрганизация = ЗапросОстатков.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаОрганизация.Следующий() Цикл
		ВыборкаСклад = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		// Создание отдельного документа сборки для каждого склада
		Пока ВыборкаСклад.Следующий() Цикл
			
			Если ВыборкаСклад.ВНаличииОстаток > 0 Тогда
				
				ДокументСборки = Документы.СборкаТоваров.СоздатьДокумент();
				ДокументСборки.Комментарий = "#Документ создан обработкой комплектации в литражную номенклатуру.";
				ДокументСборки.Организация = ?(ЗначениеЗаполнено(ВыборкаСклад.Организация), ВыборкаСклад.Организация, Справочники.Организации.ПустаяСсылка());
				ДокументСборки.Склад = ВыборкаСклад.Склад;
				ДокументСборки.Дата = ТекущаяДатаСеанса();
				ДокументСборки.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров;
				ДокументСборки.Номенклатура = НоваяНоменклатура;
				ДокументСборки.Ответственный = ПараметрыСеанса.ТекущийПользователь;
				ДокументСборки.Статус = Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
				ДокументСборки.СборкаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
				ДокументСборки.ВариантПриемкиТоваров = Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;
				ДокументСборки.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
				ДокументСборки.Упаковка = УпаковкаНоменклатуры;
				ДокументСборки.Количество = ВыборкаСклад.ВНаличииОстаток;
				ДокументСборки.СтатусУказанияСерий = 4;
				
				СтрокаТЧТовары = ДокументСборки.Товары.Добавить();
				СтрокаТЧТовары.Номенклатура = СтараяНоменклатура;
				СтрокаТЧТовары.Количество = ВыборкаСклад.ВНаличииОстаток;
				СтрокаТЧТовары.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
				СтрокаТЧТовары.СтатусУказанияСерий = 4;
				
				ВыборкаСерия = ВыборкаСклад.Выбрать();
				
				Пока ВыборкаСерия.Следующий() Цикл
					
					СтрокаСерии = ДокументСборки.Серии.Добавить();
					СтрокаСерии.Номенклатура = ВыборкаСерия.Номенклатура;
					СтрокаСерии.Серия = ВыборкаСерия.Серия;
					СтрокаСерии.Количество = 1;
					
					СтрокаСерии = ДокументСборки.Серии.Добавить();
					СтрокаСерии.Номенклатура = НоваяНоменклатура;
					СтрокаСерии.Количество = НоваяНоменклатура.ОбъемДАЛ * 10;
					СтрокаСерии.Серия = ВыборкаСерия.Серия;
					
					// Замена номенклатуры в штрихкодах
					Если ЗначениеЗаполнено(ВыборкаСерия.Штрихкод) Тогда
						
						ШтрихкодОбъект = ВыборкаСерия.Штрихкод.ПолучитьОбъект();
						ШтрихкодОбъект.Номенклатура = НоваяНоменклатура;
						ШтрихкодОбъект.Упаковка = УпаковкаНоменклатуры;
						ШтрихкодОбъект.Записать();
						
					КонецЕсли;
					
				КонецЦикла;
				
				Попытка
				
					ДокументСборки.Записать(РежимЗаписиДокумента.Проведение);
					
					СвСтатус = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("ИдентификаторДляФормул", "MRS_ЗапретРедактирования");
	
					ДопРекиСведПустаяСсылка = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПустаяСсылка();
						
					ДопСведенияНаборЗаписей = РегистрыСведений.ДополнительныеСведения.СоздатьНаборЗаписей();
					ДопСведенияНаборЗаписей.Отбор.Объект.Установить(ДокументСборки.Ссылка);
					ДопСведенияНаборЗаписей.Отбор.Свойство.Установить(СвСтатус);
					ДопСведенияНаборЗаписей.Прочитать();
					
					Если ДопСведенияНаборЗаписей.Количество() = 0 Тогда
						НовЗапись = ДопСведенияНаборЗаписей.Добавить();
					Иначе
						НовЗапись = ДопСведенияНаборЗаписей[0];
					КонецЕсли;
					
					НовЗапись.Объект = ДокументСборки.Ссылка;
					НовЗапись.Свойство = СвСтатус;
					НовЗапись.Значение = ИСТИНА;
					
					ДопСведенияНаборЗаписей.Записать(Истина);
	
				Исключение
				 	ДокументСборки.Записать(РежимЗаписиДокумента.Запись);
				КонецПопытки;
				
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;

	Если НЕ ТолькоБезСоответствийОбработки Тогда
			
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
		|ИЗ
		|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
		|ГДЕ
		|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект
		|";
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("Объект", ВскрытаяНоменклатура);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Набор = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
			Набор.Отбор.Код.Установить(Выборка.Код);
			Набор.Прочитать();
			
			Для Каждого Запись Из Набор Цикл
				
				Запись.НоменклатураАлкоголь = НоваяНоменклатура;
				
			КонецЦикла;
			
			Набор.Записать();
			
		КонецЦикла; 
		
	КонецЕсли;
	
ИначеЕсли ЗначениеЗаполнено(ВскрытаяНоменклатура) Тогда
	
	Если НЕ ТолькоБезСоответствийОбработки Тогда
			
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
		|ИЗ
		|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
		|ГДЕ
		|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект
		|";
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.УстановитьПараметр("Объект", ВскрытаяНоменклатура);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Набор = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
			Набор.Отбор.Код.Установить(Выборка.Код);
			Набор.Прочитать();
			
			Для Каждого Запись Из Набор Цикл
				
				Запись.НоменклатураАлкоголь = НоваяНоменклатура;
				
			КонецЦикла;
			
			Набор.Записать();
			
		КонецЦикла; 
		
	КонецЕсли;	
	
КонецЕсли;
	
КонецФункции
