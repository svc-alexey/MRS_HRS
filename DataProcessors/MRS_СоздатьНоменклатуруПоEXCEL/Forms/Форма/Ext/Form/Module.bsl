&НаСервере
Процедура СоздатьсборкиНаСервере()
	
	// Определение режима работы: обработка одной номенклатуры или массовая обработка всего регистра
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		
		// Режим 1: Обработка одной номенклатуры
		ОбработатьОднуНоменклатуру();
		
	Иначе
		
		// Режим 2: Массовая обработка всего регистра
		ОбработатьВсеЗаписиРегистра();
		
	КонецЕсли;
	
КонецПроцедуры

// Обработка одной номенклатуры (Режим 1)
Процедура ОбработатьОднуНоменклатуру()
	
	// Шаг 1: Поиск записи в регистре MRS_СоответствиеСтаройНовойНоменклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	МассивСоответствий.СтараяНоменклатура КАК СтараяНоменклатура,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|ГДЕ
	|	(МассивСоответствий.СтараяНоменклатура = &Номенклатура
	|		ИЛИ МассивСоответствий.ВскрытаяНоменклатура = &Номенклатура)
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		// Определение сценария
		Если ЗначениеЗаполнено(Выборка.СтараяНоменклатура) Тогда
			
			// Сценарий 1А: Замена с остатками
			ОбработатьЗаменуСОстатками(Выборка.СтараяНоменклатура, Выборка.НоваяНоменклатура);
			
		ИначеЕсли ЗначениеЗаполнено(Выборка.ВскрытаяНоменклатура) Тогда
			
			// Сценарий 1Б: Только обновление соответствий
			ОбновитьСоответствияСФронтСистемами(Выборка.ВскрытаяНоменклатура, Выборка.НоваяНоменклатура);
			
		Иначе
			
			// Некорректные данные в регистре
			
		КонецЕсли;
		
	Иначе
		
		Сообщить("Для выбранной номенклатуры """ + Строка(Номенклатура) + """ не найдена запись в регистре MRS_СоответствиеСтаройНовойНоменклатуры!");
		
	КонецЕсли;
	
КонецПроцедуры

// Массовая обработка всего регистра (Режим 2)
Процедура ОбработатьВсеЗаписиРегистра()
	
	// Выборка всех записей из регистра MRS_СоответствиеСтаройНовойНоменклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	МассивСоответствий.СтараяНоменклатура КАК СтараяНоменклатура,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|ГДЕ
	|	МассивСоответствий.НоваяНоменклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если ЗначениеЗаполнено(Выборка.СтараяНоменклатура) Тогда
			
			// Сценарий: Замена с остатками
			ОбработатьЗаменуСОстатками(Выборка.СтараяНоменклатура, Выборка.НоваяНоменклатура);
			
		ИначеЕсли ЗначениеЗаполнено(Выборка.ВскрытаяНоменклатура) и НЕ ТолькоБезСоответствий Тогда
			
			// Сценарий: Только обновление соответствий
			ОбновитьСоответствияСФронтСистемами(Выборка.ВскрытаяНоменклатура, Выборка.НоваяНоменклатура);
			
		Иначе
			
			// Некорректные данные в регистре - пропускаем
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Обработка замены номенклатуры с остатками (Сценарий 1А)
//
// Параметры:
//  СтараяНоменклатура - СправочникСсылка.Номенклатура - Номенклатура, подлежащая замене
//  НоваяНоменклатура - СправочникСсылка.Номенклатура - Целевая номенклатура для замены
//
Процедура ОбработатьЗаменуСОстатками(СтараяНоменклатура, НоваяНоменклатура)
	
	// Получение упаковки новой номенклатуры
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	УпаковкиЕдиницыИзмерения.Ссылка КАК Упаковка
	|ИЗ
	|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
	|ГДЕ
	|	УпаковкиЕдиницыИзмерения.Владелец = &НоваяНоменклатура
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НоваяНоменклатура", НоваяНоменклатура);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ВыборкаУпаковки = Результат.Выбрать();
	ВыборкаУпаковки.Следующий();
	УпаковкаНоменклатуры = ВыборкаУпаковки.Упаковка;
	
	//////////////////////////////////////////////////////////////////////
	
	// Шаг 2: Запрос остатков по складам с группировкой
	ТекстЗапросаОстатков = "ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Серия КАК Серия,
	|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
	|	ТоварыНаСкладахОстатки.Склад.ПЛ_Организация КАК Организация,
	|	ТоварыНаСкладахОстатки.Склад КАК Склад,
	|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&Дата,
	|			Номенклатура = &Номенклатура
	|			И Номенклатура.ВидНоменклатуры <> &ИсключитьДиапазон
	|			И Склад <> &ИсключаемыеСклады
	|			#УсловиеСклад#
	|			) КАК ТоварыНаСкладахОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
	|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
	|ИТОГИ
	|	СУММА(ВНаличииОстаток)
	|ПО
	|	Склад";

	// Учет параметра Склад
	Если ЗначениеЗаполнено(Склад) Тогда
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", " И Склад = &Склад");
		
	Иначе
		
		ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, "#УсловиеСклад#", "");
		
	КонецЕсли;
	
	ЗапросОстатков = Новый Запрос(ТекстЗапросаОстатков);
	ЗапросОстатков.УстановитьПараметр("ИсключитьДиапазон", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));// Готовая алкогольная продукция с ФСМ (Справочники.ВидыНоменклатуры)
	ЗапросОстатков.УстановитьПараметр("ИсключаемыеСклады", Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817")));// 505 Склад алкогольной продукции Винодельни_М.ПРО (МРИЯ.ПРО ООО) (Справочники.Склады)
	ЗапросОстатков.УстановитьПараметр("Дата", Новый Граница(?(ЗначениеЗаполнено(Период), КонецДня(Период), КонецДня(ТекущаяДатаСеанса())), ВидГраницы.Включая));
	ЗапросОстатков.УстановитьПараметр("Номенклатура", СтараяНоменклатура);
	
	Если ЗначениеЗаполнено(Склад) Тогда
		
		ЗапросОстатков.УстановитьПараметр("Склад", Склад);
		
	КонецЕсли;
	
	ВыборкаСклад = ЗапросОстатков.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	// Шаг 3: Создание отдельного документа сборки для каждого склада
	Пока ВыборкаСклад.Следующий() Цикл
		
		Если ВыборкаСклад.ВНаличииОстаток > 0 Тогда
			
			ДокументСборки = Документы.СборкаТоваров.СоздатьДокумент();
			ДокументСборки.Комментарий = "#Документ создан обработкой комплектации в литражную номенклатуру.";
			ДокументСборки.Организация = ?(ЗначениеЗаполнено(ВыборкаСклад.Организация), ВыборкаСклад.Организация, Справочники.Организации.ПустаяСсылка());
			ДокументСборки.Склад = ВыборкаСклад.Склад;
			ДокументСборки.Дата = ТекущаяДатаСеанса();
			ДокументСборки.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров;
			ДокументСборки.Номенклатура = НоваяНоменклатура;
			ДокументСборки.Ответственный = ПараметрыСеанса.ТекущийПользователь;
			ДокументСборки.Статус = Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
			ДокументСборки.СборкаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
			ДокументСборки.ВариантПриемкиТоваров = Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;
			ДокументСборки.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.Упаковка = УпаковкаНоменклатуры;
			ДокументСборки.Количество = ВыборкаСклад.ВНаличииОстаток;
			ДокументСборки.СтатусУказанияСерий = 4;
			
			СтрокаТЧТовары = ДокументСборки.Товары.Добавить();
			СтрокаТЧТовары.Номенклатура = СтараяНоменклатура;
			СтрокаТЧТовары.Количество = ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.КоличествоУпаковок = ВыборкаСклад.ВНаличииОстаток;
			СтрокаТЧТовары.СтатусУказанияСерий = 4;
			
			ВыборкаСерия = ВыборкаСклад.Выбрать();
			
			Пока ВыборкаСерия.Следующий() Цикл
				
				СтрокаСерии = ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура = ВыборкаСерия.Номенклатура;
				СтрокаСерии.Серия = ВыборкаСерия.Серия;
				СтрокаСерии.Количество = 1;
				
				СтрокаСерии = ДокументСборки.Серии.Добавить();
				СтрокаСерии.Номенклатура = НоваяНоменклатура;
				СтрокаСерии.Количество = НоваяНоменклатура.ОбъемДАЛ * 10;
				СтрокаСерии.Серия = ВыборкаСерия.Серия;
				
				// Замена номенклатуры в штрихкодах
				Если ЗначениеЗаполнено(ВыборкаСерия.Штрихкод) Тогда
					
					ШтрихкодОбъект = ВыборкаСерия.Штрихкод.ПолучитьОбъект();
					ШтрихкодОбъект.Номенклатура = НоваяНоменклатура;
					ШтрихкодОбъект.Упаковка = УпаковкаНоменклатуры;
					ШтрихкодОбъект.Записать();
					
				КонецЕсли;
				
			КонецЦикла;
			
			ДокументСборки.Записать(РежимЗаписиДокумента.Запись);
			СтрокаДокументы = ТаблицаСборок.Добавить();
			СтрокаДокументы.ДокументыСборки = ДокументСборки.Ссылка;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если НЕ ТолькоБезСоответствий Тогда
		// Шаг 4: Обновление регистра ПЛ_СоответствиеСФронтСистемами
		ОбновитьСоответствияСФронтСистемами(СтараяНоменклатура.ПЛ_НоменклатураВоВскрытойТаре.Ссылка, НоваяНоменклатура);
	КонецЕсли;
КонецПроцедуры

// Обновление соответствий с фронт-системами
//
// Параметры:
//  ОбъектДляПоиска - СправочникСсылка.Номенклатура - Объект для поиска в регистре ПЛ_СоответствиеСФронтСистемами
//  НоваяНоменклатура - СправочникСсылка.Номенклатура - Целевая номенклатура для установки в НоменклатураАлкоголь
//
Процедура ОбновитьСоответствияСФронтСистемами(ОбъектДляПоиска, НоваяНоменклатура)
	
	Если НЕ ЗначениеЗаполнено(ОбъектДляПоиска) Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
	|ИЗ
	|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Объект", ОбъектДляПоиска);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Набор = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
		Набор.Отбор.Код.Установить(Выборка.Код);
		Набор.Прочитать();
		
		Для Каждого Запись Из Набор Цикл
			
			Запись.НоменклатураАлкоголь = НоваяНоменклатура;
			
		КонецЦикла;
		
		Набор.Записать();
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Создатьсборки(Команда)
	СоздатьсборкиНаСервере();
КонецПроцедуры

// ============================================================================
// Процедуры для многопоточной обработки
// ============================================================================

// Формирует и выполняет запрос для выборки данных из регистра соответствий
//
// Параметры:
//  ПараметрыОтбора - Структура - параметры для отбора данных:
//   * Склад - СправочникСсылка.Склады - склад для обработки (необязательный)
//   * Номенклатура - СправочникСсылка.Номенклатура - конкретная номенклатура (необязательный)
//
// Возвращаемое значение:
//  РезультатЗапроса - результат запроса для обхода в многопоточном режиме
//
&НаСервере
Функция ПолучитьДанныеДляОбработки(ПараметрыОтбора = Неопределено)
	
	Запрос = Новый Запрос;

Запрос.Текст =
"ВЫБРАТЬ
|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
|	ТоварыНаСкладахОстатки.Серия КАК Серия,
|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
|	ВЫБОР
|		КОГДА ТоварыНаСкладахОстатки.Склад.ПЛ_Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
|			ТОГДА АкцизныеМаркиЕГАИС.ОрганизацияЕГАИС.Контрагент
|		ИНАЧЕ ТоварыНаСкладахОстатки.Склад.ПЛ_Организация
|	КОНЕЦ КАК Организация,
|	ТоварыНаСкладахОстатки.Склад КАК Склад,
|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод
|ИЗ
|	РегистрНакопления.ТоварыНаСкладах.Остатки(
|			&Дата,
|			Номенклатура.ВидНоменклатуры В (&ВидыНом)
|				И Склад <> &ИсключаемыеСклады
|				И Номенклатура.ЕдиницаИзмерения.Код <> ""112"") КАК ТоварыНаСкладахОстатки
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК АкцизныеМаркиЕГАИС
|		ПО (ТоварыНаСкладахОстатки.Серия.Номер = АкцизныеМаркиЕГАИС.АкцизнаяМарка.ЗначениеШтрихкода)
|ГДЕ
|	АкцизныеМаркиЕГАИС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ВНаличии)
|
|УПОРЯДОЧИТЬ ПО
|	Организация,
|	Склад,
|	Номенклатура";

Запрос.УстановитьПараметр("Дата", Дата(2025, 12, 24, 0, 26, 18));
Запрос.УстановитьПараметр("ИсключаемыеСклады", Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817")));// 505 Склад алкогольной продукции Винодельни_М.ПРО (МРИЯ.ПРО ООО) (Справочники.Склады)
Параметр = Новый СписокЗначений;
Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("7DA4E742-B389-11E9-80DF-000C29589659")));
Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));
Запрос.УстановитьПараметр("ВидыНом", Параметр);
ТаблицаДанныхКОбработке = Запрос.Выполнить().Выгрузить();
	
	Возврат ТаблицаДанныхКОбработке;
	
КонецФункции


// Обработка записей данных с группировкой по складам
// Создает документы СборкаТоваров для конвертации остатков алкогольной продукции из штучного учета в литражный
//
// Параметры:
//  ПараметрыОбработки - Структура - параметры для обработки данных
//
// Возвращаемое значение:
//  Неопределено
//
&НаСервере
Функция ОбработатьЗаписьДанных(ПараметрыОбработки)
	
	// Шаг 1: Инициализация параметров
	ДатаОбработки = ТекущаяДатаСеанса();
	
	// UUID двух видов номенклатуры (алкоголь штучный учет)
	ВидНоменклатуры1 = Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58"));
	ВидНоменклатуры2 = Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("7DA4E742-B389-11E9-80DF-000C29589659"));
	
	// UUID исключаемого склада
	ИсключаемыйСклад = Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("5C6C3FFC-B7A6-11EB-818F-98F2B3347817"));
	
	// Шаг 2: Построение и выполнение запроса остатков с соответствиями
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК СтараяНоменклатура,
	|	ТоварыНаСкладахОстатки.Серия КАК Серия,
	|	ТоварыНаСкладахОстатки.Серия.Номер КАК СерияНомер,
	|	ВЫБОР
	|		КОГДА ТоварыНаСкладахОстатки.Склад.ПЛ_Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА АкцизныеМаркиЕГАИС.ОрганизацияЕГАИС.Контрагент
	|		ИНАЧЕ ТоварыНаСкладахОстатки.Склад.ПЛ_Организация
	|	КОНЕЦ КАК Организация,
	|	ТоварыНаСкладахОстатки.Склад КАК Склад,
	|	ТоварыНаСкладахОстатки.ВНаличииОстаток КАК Количество,
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Штрихкод,
	|	МассивСоответствий.НоваяНоменклатура КАК НоваяНоменклатура,
	|	МассивСоответствий.ВскрытаяНоменклатура КАК ВскрытаяНоменклатура
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&Дата,
	|			Номенклатура.ВидНоменклатуры В (&ВидыНоменклатуры)
	|				И Склад <> &ИсключаемыеСклады
	|				И Номенклатура.ЕдиницаИзмерения.Код <> ""112"") КАК ТоварыНаСкладахОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
	|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК АкцизныеМаркиЕГАИС
	|		ПО (ТоварыНаСкладахОстатки.Серия.Номер = АкцизныеМаркиЕГАИС.АкцизнаяМарка.ЗначениеШтрихкода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
	|		ПО (ТоварыНаСкладахОстатки.Номенклатура = МассивСоответствий.СтараяНоменклатура)
	|			И (МассивСоответствий.СтараяНоменклатура.ВидНоменклатуры В (&ВидыНоменклатуры))
	|ГДЕ
	|	АкцизныеМаркиЕГАИС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ВНаличии)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Склад,
	|	СтараяНоменклатура";
	
	СписокВидовНоменклатуры = Новый СписокЗначений;
	СписокВидовНоменклатуры.Добавить(ВидНоменклатуры1);
	СписокВидовНоменклатуры.Добавить(ВидНоменклатуры2);
	
	Запрос.УстановитьПараметр("Дата", Новый Граница(КонецДня(ДатаОбработки), ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ВидыНоменклатуры", СписокВидовНоменклатуры);
	Запрос.УстановитьПараметр("ИсключаемыеСклады", ИсключаемыйСклад);
	
	ТаблицаДанных = Запрос.Выполнить().Выгрузить();
	
	// Шаг 3: Группировка в памяти
	СтруктураГрупп = Новый Соответствие;
	
	Для Каждого СтрокаТаблицы Из ТаблицаДанных Цикл
		
		// Формирование ключа группы
		КлючГруппы = Строка(СтрокаТаблицы.СтараяНоменклатура.УникальныйИдентификатор()) + "|" + 
		             Строка(СтрокаТаблицы.Склад.УникальныйИдентификатор()) + "|" + 
		             Строка(СтрокаТаблицы.Организация.УникальныйИдентификатор()) + "|" + 
		             Строка(СтрокаТаблицы.НоваяНоменклатура.УникальныйИдентификатор());
		
		ДанныеГруппы = СтруктураГрупп.Получить(КлючГруппы);
		
		Если ДанныеГруппы = Неопределено Тогда
			
			ДанныеГруппы = Новый Структура;
			ДанныеГруппы.Вставить("СтараяНоменклатура", СтрокаТаблицы.СтараяНоменклатура);
			ДанныеГруппы.Вставить("НоваяНоменклатура", СтрокаТаблицы.НоваяНоменклатура);
			ДанныеГруппы.Вставить("ВскрытаяНоменклатура", СтрокаТаблицы.ВскрытаяНоменклатура);
			ДанныеГруппы.Вставить("Склад", СтрокаТаблицы.Склад);
			ДанныеГруппы.Вставить("Организация", СтрокаТаблицы.Организация);
			ДанныеГруппы.Вставить("ОбщееКоличество", 0);
			ДанныеГруппы.Вставить("МассивСерий", Новый Массив);
			
			СтруктураГрупп.Вставить(КлючГруппы, ДанныеГруппы);
			
		КонецЕсли;
		
		ДанныеГруппы.ОбщееКоличество = ДанныеГруппы.ОбщееКоличество + СтрокаТаблицы.Количество;
		
		СтруктураСерии = Новый Структура;
		СтруктураСерии.Вставить("Серия", СтрокаТаблицы.Серия);
		СтруктураСерии.Вставить("СерияНомер", СтрокаТаблицы.СерияНомер);
		СтруктураСерии.Вставить("Штрихкод", СтрокаТаблицы.Штрихкод);
		
		ДанныеГруппы.МассивСерий.Добавить(СтруктураСерии);
		
	КонецЦикла;
	
	// Шаг 4: Создание сборок для каждой группы
	Для Каждого ЭлементГруппы Из СтруктураГрупп Цикл
		
		ДанныеГруппы = ЭлементГруппы.Значение;
		
		Если ДанныеГруппы.ОбщееКоличество <= 0 Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		// Получение упаковки новой номенклатуры
		ЗапросУпаковки = Новый Запрос;
		ЗапросУпаковки.Текст = "
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	УпаковкиЕдиницыИзмерения.Ссылка КАК Упаковка
		|ИЗ
		|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
		|ГДЕ
		|	УпаковкиЕдиницыИзмерения.Владелец = &НоваяНоменклатура";
		
		ЗапросУпаковки.УстановитьПараметр("НоваяНоменклатура", ДанныеГруппы.НоваяНоменклатура);
		
		РезультатУпаковки = ЗапросУпаковки.Выполнить();
		
		Если РезультатУпаковки.Пустой() Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		ВыборкаУпаковки = РезультатУпаковки.Выбрать();
		ВыборкаУпаковки.Следующий();
		УпаковкаНоменклатуры = ВыборкаУпаковки.Упаковка;
		
		// Создание документа сборки
		ДокументСборки = Документы.СборкаТоваров.СоздатьДокумент();
		ДокументСборки.Комментарий = "#Документ создан обработкой комплектации в литражную номенклатуру.";
		ДокументСборки.Организация = ?(ЗначениеЗаполнено(ДанныеГруппы.Организация), ДанныеГруппы.Организация, Справочники.Организации.ПустаяСсылка());
		ДокументСборки.Склад = ДанныеГруппы.Склад;
		ДокументСборки.Дата = ДатаОбработки;
		ДокументСборки.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров;
		ДокументСборки.Номенклатура = ДанныеГруппы.НоваяНоменклатура;
		ДокументСборки.Ответственный = ПараметрыСеанса.ТекущийПользователь;
		ДокументСборки.Статус = Перечисления.СтатусыСборокТоваров.СобраноРазобрано;
		ДокументСборки.СборкаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС;
		ДокументСборки.ВариантПриемкиТоваров = Перечисления.ВариантыПриемкиТоваров.РазделенаТолькоПоНакладным;
		ДокументСборки.КоличествоУпаковок = ДанныеГруппы.ОбщееКоличество;
		ДокументСборки.Упаковка = УпаковкаНоменклатуры;
		ДокументСборки.Количество = ДанныеГруппы.ОбщееКоличество;
		ДокументСборки.СтатусУказанияСерий = 4;
		
		// Заполнение ТЧ "Товары"
		СтрокаТЧТовары = ДокументСборки.Товары.Добавить();
		СтрокаТЧТовары.Номенклатура = ДанныеГруппы.СтараяНоменклатура;
		СтрокаТЧТовары.Количество = ДанныеГруппы.ОбщееКоличество;
		СтрокаТЧТовары.КоличествоУпаковок = ДанныеГруппы.ОбщееКоличество;
		СтрокаТЧТовары.СтатусУказанияСерий = 4;
		
		// Заполнение ТЧ "Серии"
		Для Каждого ДанныеСерии Из ДанныеГруппы.МассивСерий Цикл
			
			СтрокаСерии = ДокументСборки.Серии.Добавить();
			СтрокаСерии.Номенклатура = ДанныеГруппы.СтараяНоменклатура;
			СтрокаСерии.Серия = ДанныеСерии.Серия;
			СтрокаСерии.Количество = 1;
			
			СтрокаСерии = ДокументСборки.Серии.Добавить();
			СтрокаСерии.Номенклатура = ДанныеГруппы.НоваяНоменклатура;
			СтрокаСерии.Серия = ДанныеСерии.Серия;
			СтрокаСерии.Количество = ДанныеГруппы.НоваяНоменклатура.ОбъемДАЛ * 10;
			
		КонецЦикла;
		
		// Обновление штрихкодов
		Для Каждого ДанныеСерии Из ДанныеГруппы.МассивСерий Цикл
			
			Если ЗначениеЗаполнено(ДанныеСерии.Штрихкод) Тогда
				
				ШтрихкодОбъект = ДанныеСерии.Штрихкод.ПолучитьОбъект();
				ШтрихкодОбъект.Номенклатура = ДанныеГруппы.НоваяНоменклатура;
				ШтрихкодОбъект.Упаковка = УпаковкаНоменклатуры;
				ШтрихкодОбъект.Записать();
				
			КонецЕсли;
			
		КонецЦикла;
		
		// Запись документа сборки
		Попытка
			
			ДокументСборки.Записать(РежимЗаписиДокумента.Проведение);
			
			СвойствоЗапретРедактирования = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("ИдентификаторДляФормул", "MRS_ЗапретРедактирования");
			
			НаборДополнительныхСведений = РегистрыСведений.ДополнительныеСведения.СоздатьНаборЗаписей();
			НаборДополнительныхСведений.Отбор.Объект.Установить(ДокументСборки.Ссылка);
			НаборДополнительныхСведений.Отбор.Свойство.Установить(СвойствоЗапретРедактирования);
			НаборДополнительныхСведений.Прочитать();
			
			Если НаборДополнительныхСведений.Количество() = 0 Тогда
				
				НоваяЗапись = НаборДополнительныхСведений.Добавить();
				
			Иначе
				
				НоваяЗапись = НаборДополнительныхСведений[0];
				
			КонецЕсли;
			
			НоваяЗапись.Объект = ДокументСборки.Ссылка;
			НоваяЗапись.Свойство = СвойствоЗапретРедактирования;
			НоваяЗапись.Значение = Истина;
			
			НаборДополнительныхСведений.Записать(Истина);
			
		Исключение
			
			ДокументСборки.Записать(РежимЗаписиДокумента.Запись);
			
		КонецПопытки;
		
		// Обновление соответствий с фронт-системами
		Если ЗначениеЗаполнено(ДанныеГруппы.ВскрытаяНоменклатура) Тогда
			
			ЗапросСоответствий = Новый Запрос;
			ЗапросСоответствий.Текст = "
			|ВЫБРАТЬ
			|	ПЛ_СоответствиеСФронтСистемами.Код КАК Код
			|ИЗ
			|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
			|ГДЕ
			|	ПЛ_СоответствиеСФронтСистемами.Объект = &Объект";
			
			ЗапросСоответствий.УстановитьПараметр("Объект", ДанныеГруппы.ВскрытаяНоменклатура);
			
			ВыборкаСоответствий = ЗапросСоответствий.Выполнить().Выбрать();
			
			Пока ВыборкаСоответствий.Следующий() Цикл
				
				НаборСоответствий = РегистрыСведений.ПЛ_СоответствиеСФронтСистемами.СоздатьНаборЗаписей();
				НаборСоответствий.Отбор.Код.Установить(ВыборкаСоответствий.Код);
				НаборСоответствий.Прочитать();
				
				Для Каждого ЗаписьСоответствия Из НаборСоответствий Цикл
					
					ЗаписьСоответствия.НоменклатураАлкоголь = ДанныеГруппы.НоваяНоменклатура;
					
				КонецЦикла;
				
				НаборСоответствий.Записать();
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Процедура ЗапросОстатка()

	Запрос = Новый Запрос;

Запрос.Текст =
"ВЫБРАТЬ
|	ТоварыНаСкладахОстатки.Номенклатура КАК СтараяНоменклатура,
|	ТоварыНаСкладахОстатки.Номенклатура.ПЛ_НоменклатураВоВскрытойТаре КАК НоменклатураПЛ_НоменклатураВоВскрытойТаре,
|	ТоварыНаСкладахОстатки.Номенклатура.ПЛ_НоменклатураВоВскрытойТаре.Наименование КАК ИмяВскрытой
|ИЗ
|	РегистрНакопления.ТоварыНаСкладах.Остатки(
|			&Дата,
|			Номенклатура.ВидНоменклатуры В (&ВидыНоменклатуры)
|				И Номенклатура.ЕдиницаИзмерения.Код <> ""112"") КАК ТоварыНаСкладахОстатки
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
|		ПО (ТоварыНаСкладахОстатки.Номенклатура = ШтрихкодыУпаковокТоваров.Номенклатура)
|			И (ТоварыНаСкладахОстатки.Серия.Номер = ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода)
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК АкцизныеМаркиЕГАИС
|		ПО (ТоварыНаСкладахОстатки.Серия.Номер = АкцизныеМаркиЕГАИС.АкцизнаяМарка.ЗначениеШтрихкода)
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.MRS_СоответствиеСтаройНовойНоменклатуры КАК МассивСоответствий
|		ПО (ТоварыНаСкладахОстатки.Номенклатура = МассивСоответствий.СтараяНоменклатура)
|ГДЕ
|	АкцизныеМаркиЕГАИС.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ВНаличии)
|	И АкцизныеМаркиЕГАИС.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.Реализована)
|	И ТоварыНаСкладахОстатки.ВНаличииОстаток > 0
|	И МассивСоответствий.СтараяНоменклатура ЕСТЬ NULL
|
|СГРУППИРОВАТЬ ПО
|	ТоварыНаСкладахОстатки.Номенклатура,
|	МассивСоответствий.ВскрытаяНоменклатура
|
|УПОРЯДОЧИТЬ ПО
|	СтараяНоменклатура";

Запрос.УстановитьПараметр("Дата", Дата(2025, 12, 24, 16, 17, 38));
Запрос.УстановитьПараметр("ВидыНоменклатуры", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("7DA4E742-B389-11E9-80DF-000C29589659")));// Закрытая алкогольная продукция по маркам (бутылка) (Справочники.ВидыНоменклатуры)
РезультатЗапроса = Запрос.Выполнить();

КонецПроцедуры

Процедура КодОбработки()

	Запрос = Новый Запрос;

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПЛ_СоответствиеСФронтСистемами.Объект КАК НоменклатураВоВскрытойТаре,
	|	ПЛ_СоответствиеСФронтСистемами.Код КАК КодКнопки,
	|	ПЛ_СоответствиеСФронтСистемами.Объект.Код КАК НоменклатураВоВскрытойТареКОД
	|ПОМЕСТИТЬ ВТ_Вскрытая
	|ИЗ
	|	РегистрСведений.ПЛ_СоответствиеСФронтСистемами КАК ПЛ_СоответствиеСФронтСистемами
	|ГДЕ
	|	ПЛ_СоответствиеСФронтСистемами.ТипОбъекта = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ПЛ_ТипыОбъектовФронтСистем.Номенклатура)
	|	И ПЛ_СоответствиеСФронтСистемами.ФронтСистема В(&ФронтСистема)
	|	И ПЛ_СоответствиеСФронтСистемами.Объект.АлкогольнаяПродукцияВоВскрытойТаре
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.ВидНоменклатуры В (&ВидНоменклатуры)
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.ВидАлкогольнойПродукции.Наименование ПОДОБНО &Наименование
	|	И НЕ ПЛ_СоответствиеСФронтСистемами.Объект.Наименование ПОДОБНО &НаименованиеНеиспользовать
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СерийнаяНоменклатура,
	|	Номенклатура.Код КАК СерийнаяНоменклатураКод,
	|	ВТ_Вскрытая.НоменклатураВоВскрытойТаре КАК НоменклатураВоВскрытойТаре,
	|	ВТ_Вскрытая.КодКнопки КАК КодКнопки,
	|	ВТ_Вскрытая.НоменклатураВоВскрытойТареКОД КАК НоменклатураВоВскрытойТареКОД
	|ПОМЕСТИТЬ ВТ_Серийная
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Вскрытая КАК ВТ_Вскрытая
	|		ПО Номенклатура.ПЛ_НоменклатураВоВскрытойТаре = ВТ_Вскрытая.НоменклатураВоВскрытойТаре
	|ГДЕ
	|	Номенклатура.АлкогольнаяПродукция
	|	И НЕ Номенклатура.АлкогольнаяПродукцияВоВскрытойТаре
	|	И Номенклатура.ВидАлкогольнойПродукции.ВидЛицензии <> &ВидЛицензии
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Серийная.КодКнопки КАК КодКнопки,
	|	ВТ_Серийная.НоменклатураВоВскрытойТаре КАК НоменклатураВоВскрытойТаре,
	|	ВТ_Серийная.НоменклатураВоВскрытойТареКОД КАК НоменклатураВоВскрытойТареКОД,
	|	ВТ_Серийная.НоменклатураВоВскрытойТаре.Наименование КАК ИмяВскрытой,
	|	ВТ_Серийная.СерийнаяНоменклатураКод КАК СерийнаяНоменклатураКод,
	|	ВТ_Серийная.СерийнаяНоменклатура КАК СерийнаяНоменклатура,
	|	ВТ_Серийная.СерийнаяНоменклатура.Наименование КАК СерийнаяНоменклатураНаименование,
	|	ВТ_Серийная.СерийнаяНоменклатура.ОбъемДАЛ КАК ОбъемДАЛ,
	|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) КАК ВНаличииОстаток
	|ИЗ
	|	ВТ_Серийная КАК ВТ_Серийная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(&Дата) КАК ТоварыНаСкладахОстатки
	|		ПО (ВТ_Серийная.СерийнаяНоменклатура = ТоварыНаСкладахОстатки.Номенклатура)";

	// Установка значений параметров
	Запрос.УстановитьПараметр("ФронтСистема", Перечисления.ПЛ_ТипыФронтСистем.Micros);
	Запрос.УстановитьПараметр("НаименованиеНеиспользовать", "%не использовать%");
	Запрос.УстановитьПараметр("Наименование", "%ПИВ%");
	Запрос.УстановитьПараметр("Дата", ТекущаяДатаСеанса());
	// Параметр "ВидНоменклатуры" (Список значений)
	Параметр = Новый СписокЗначений;
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("D4C02896-4114-11F0-94CB-005056A5AE58")));// Готовая алкогольная продукция с ФСМ (помарочно) (Справочники.ВидыНоменклатуры)
	Параметр.Добавить(Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("AE40B1EF-7234-11ED-825B-000C29589659")));// Готовая алкогольная продукция с ФСМ (Справочники.ВидыНоменклатуры)
	Запрос.УстановитьПараметр("ВидНоменклатуры", Параметр);
	Запрос.УстановитьПараметр("ВидЛицензии", Перечисления.ВидыЛицензийАлкогольнойПродукции.Пиво);
	РезультатЗапроса = Запрос.Выполнить();
	
	ТЗДляГруппировки = Новый ТаблицаЗначений;
	ТЗДляГруппировки.Колонки.Добавить("Наименование");
	ТЗДляГруппировки.Колонки.Добавить("ОбъемДАЛ", Новый ОписаниеТипов("Число"));
	ТЗДляГруппировки.Колонки.Добавить("НовоеНаименование");
	ТЗДляГруппировки.Колонки.Добавить("КодыСтаройНоменклатуры", Новый ОписаниеТипов("Строка"));
	ТЗДляГруппировки.Колонки.Добавить("КодыВскрытойНоменклатуры", Новый ОписаниеТипов("Строка"));
	ТЗДляГруппировки.Колонки.Добавить("ЕстьОстаток", Новый ОписаниеТипов("Булево"));
	ТЗДляГруппировки.Колонки.Добавить("ОбъектДляКопирования", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	
	Индекс = Новый Соответствие;
	СоответствиеСтараяКВскрытой = Новый Соответствие;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	// Создаем дополнительную структуру для номенклатуры без остатков
	ТЗДляОбновления = Новый ТаблицаЗначений;
	ТЗДляОбновления.Колонки.Добавить("СерийнаяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗДляОбновления.Колонки.Добавить("НоменклатураВоВскрытойТаре", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));

	Пока Выборка.Следующий() Цикл
		
		СоответствиеСтараяКВскрытой.Вставить(Выборка.СерийнаяНоменклатура, Выборка.НоменклатураВоВскрытойТаре);
		
		// Если остатка нет, добавляем в таблицу для обновления
		Если Выборка.ВНаличииОстаток = 0 Тогда
			СтрокаДляОбновления = ТЗДляОбновления.Добавить();
			СтрокаДляОбновления.СерийнаяНоменклатура = Выборка.СерийнаяНоменклатура;
			СтрокаДляОбновления.НоменклатураВоВскрытойТаре = Выборка.НоменклатураВоВскрытойТаре;
		Иначе
			// Обрабатываем номенклатуру с остатками как было раньше
			Если Выборка.ИмяВскрытой = NULL Тогда
				ИсходноеНаименование = Выборка.СерийнаяНоменклатураНаименование;
			Иначе
				ИсходноеНаименование = Выборка.ИмяВскрытой;
			КонецЕсли;
			
			Добавка = " [mrs]";
			МаксДлина = 150;
			МаксДлинаОсновной = МаксДлина - СтрДлина(Добавка);
			
			Если СтрДлина(ИсходноеНаименование) > МаксДлинаОсновной Тогда
				ИсходноеНаименование = Лев(ИсходноеНаименование, МаксДлинаОсновной);
			КонецЕсли;
			
			НовоеНаименование = ИсходноеНаименование + Добавка;
			
			НайденнаяСтрока = Индекс[НовоеНаименование];
			
			Если НайденнаяСтрока = Неопределено Тогда
				НайденнаяСтрока = ТЗДляГруппировки.Добавить();
				НайденнаяСтрока.НовоеНаименование = НовоеНаименование;
				НайденнаяСтрока.ОбъемДАЛ = Выборка.ОбъемДАЛ;
				НайденнаяСтрока.КодыСтаройНоменклатуры = "";
				НайденнаяСтрока.КодыВскрытойНоменклатуры = "";
				НайденнаяСтрока.ЕстьОстаток = Ложь;
				НайденнаяСтрока.ОбъектДляКопирования = Выборка.СерийнаяНоменклатура;
				Индекс.Вставить(НовоеНаименование, НайденнаяСтрока);
			КонецЕсли;
			
			// Агрегируем данные
			Если СтрНайти(НайденнаяСтрока.КодыСтаройНоменклатуры, Выборка.СерийнаяНоменклатураКод) = 0 Тогда
				НайденнаяСтрока.КодыСтаройНоменклатуры = ?(ПустаяСтрока(НайденнаяСтрока.КодыСтаройНоменклатуры),
					Выборка.СерийнаяНоменклатураКод,
					НайденнаяСтрока.КодыСтаройНоменклатуры + ";" + Выборка.СерийнаяНоменклатураКод);
			КонецЕсли;
			
			Если Выборка.КодКнопки <> NULL И СтрНайти(НайденнаяСтрока.КодыВскрытойНоменклатуры, Выборка.КодКнопки) = 0 Тогда
				НайденнаяСтрока.КодыВскрытойНоменклатуры = ?(ПустаяСтрока(НайденнаяСтрока.КодыВскрытойНоменклатуры),
					Выборка.КодКнопки,
					НайденнаяСтрока.КодыВскрытойНоменклатуры + ";" + Выборка.КодКнопки);
			КонецЕсли;
			
			Если Выборка.ВНаличииОстаток > 0 Тогда
				НайденнаяСтрока.ЕстьОстаток = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;

	// Сначала скорректируем все наименования
	Для Каждого СтрокаГруппы Из ТЗДляГруппировки Цикл
		СтрокаГруппы.НовоеНаименование = СкорректироватьНаименованиеПоОбъему(СтрокаГруппы.НовоеНаименование, СтрокаГруппы.ОбъемДАЛ);
	КонецЦикла;

	ЕдиницаИзмеренияЛитр = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("112");
	ЕдиницаИзмеренияШтуки = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("796"); 
	ЕдиницаИзмеренияМиллиЛитр = питОбщегоНазначения.ПолучитьБазовуюЕдиницуИзмеренияПоКоду("111");
	
	// Оптимизация: одним запросом найдем всю существующую номенклатуру по наименованию
	МассивНовыхНаименований = ТЗДляГруппировки.ВыгрузитьКолонку("НовоеНаименование");
	
	ЗапросПоиска = Новый Запрос;
	ЗапросПоиска.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК НоменклатураНоваяСсылка,
		|	Номенклатура.Код КАК НоменклатураНоваяКод,
		|	Номенклатура.Наименование КАК Наименование
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Наименование В(&МассивНаименований)";
	ЗапросПоиска.УстановитьПараметр("МассивНаименований", МассивНовыхНаименований);
	ТаблицаСуществующих = ЗапросПоиска.Выполнить().Выгрузить();
	
	СоответствиеСуществующих = Новый Соответствие;
	Для Каждого Строка Из ТаблицаСуществующих Цикл
		СоответствиеСуществующих.Вставить(Строка.Наименование, Новый Структура("Ссылка, Код", Строка.НоменклатураНоваяСсылка, Строка.НоменклатураНоваяКод));
	КонецЦикла;
	
	// ДОПОЛНИТЕЛЬНО: поиск уже созданной номенклатуры с тегом [mrs] для избежания дубликатов
	ЗапросУжеСозданных = Новый Запрос;
	ЗапросУжеСозданных.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК НоменклатураНоваяСсылка,
		|	Номенклатура.Код КАК НоменклатураНоваяКод,
		|	Номенклатура.Наименование КАК Наименование
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Наименование ПОДОБНО ""%[mrs]%""";
	
	ТаблицаУжеСозданных = ЗапросУжеСозданных.Выполнить().Выгрузить();
	
	// Дополняем соответствие уже созданными номенклатурами
	Для Каждого Строка Из ТаблицаУжеСозданных Цикл
		Если СоответствиеСуществующих[Строка.Наименование] = Неопределено Тогда
			СоответствиеСуществующих.Вставить(Строка.Наименование, Новый Структура("Ссылка, Код", Строка.НоменклатураНоваяСсылка, Строка.НоменклатураНоваяКод));
		КонецЕсли;
	КонецЦикла;
	
	// Выводим информацию о найденной существующей номенклатуре
	КоличествоСуществующей = СоответствиеСуществующих.Количество();
	Если КоличествоСуществующей > 0 Тогда
		Сообщить("Найдено уже существующей номенклатуры: " + КоличествоСуществующей + " из " + ТЗДляГруппировки.Количество() + ". Она не будет создаваться повторно.");
	КонецЕсли;

    // Оптимизация: одним запросом получим ссылки на старую номенклатуру
	УникальныеСтарыеКоды = Новый Соответствие;
	Для Каждого СтрокаГруппы Из ТЗДляГруппировки Цикл
		МассивКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");
		Для Каждого Код Из МассивКодов Цикл
			УникальныеСтарыеКоды.Вставить(Код, Истина);
		КонецЦикла;
	КонецЦикла;
	
	МассивКодовДляЗапроса = Новый Массив;
	Для Каждого Элемент Из УникальныеСтарыеКоды Цикл
		МассивКодовДляЗапроса.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	ЗапросСтарыхСсылок = Новый Запрос("ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Код КАК Код
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Код В (&Коды)");
	ЗапросСтарыхСсылок.УстановитьПараметр("Коды", МассивКодовДляЗапроса);
	ТаблицаСтарыхСсылок = ЗапросСтарыхСсылок.Выполнить().Выгрузить();
	
	СоответствиеСтарыхСсылок = Новый Соответствие;
	Для Каждого Строка Из ТаблицаСтарыхСсылок Цикл
		СоответствиеСтарыхСсылок.Вставить(Строка.Код, Строка.Ссылка);
	КонецЦикла;
	
	ТЗ_ЗаписиВРегистр = Новый ТаблицаЗначений;
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("СтараяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("НоваяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТЗ_ЗаписиВРегистр.Колонки.Добавить("ВскрытаяНоменклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));	
	// Создаем номенклатуру небольшими пакетами для избежания блокировок
	РазмерПакета = 10; // Обрабатываем по 10 элементов за раз
	ВсегоСтрок = ТЗДляГруппировки.Количество();
	КоличествоПакетов = Цел(ВсегоСтрок / РазмерПакета) + ?(ВсегоСтрок % РазмерПакета = 0, 0, 1);
	
	Сообщить("Начинаем создание номенклатуры. Всего к обработке: " + ВсегоСтрок + " элементов в " + КоличествоПакетов + " пакетах.");
	
	ОбщееКоличествоСозданных = 0;
	ОбщееКоличествоПропущенных = 0;
	
	Для НомерПакета = 0 По КоличествоПакетов - 1 Цикл
		
		НачальныйИндекс = НомерПакета * РазмерПакета;
		КонечныйИндекс = Мин((НомерПакета + 1) * РазмерПакета - 1, ВсегоСтрок - 1);
		
		КоличествоСозданныхВПакете = 0;
		КоличествоПропущенныхВПакете = 0;
		
		// Таблица записей только для текущего пакета
		ТЗ_ЗаписиВРегистрПакет = ТЗ_ЗаписиВРегистр.СкопироватьКолонки();
		
		НачатьТранзакцию();
		
		Попытка
		
			Для Индекс = НачальныйИндекс По КонечныйИндекс Цикл
				
				СтрокаГруппы = ТЗДляГруппировки[Индекс];
				
				СуществующаяНоменклатура = СоответствиеСуществующих[СтрокаГруппы.НовоеНаименование];
			
				Если СуществующаяНоменклатура = Неопределено Тогда
					
					КоличествоСозданныхВПакете = КоличествоСозданныхВПакете + 1;
					
					ОбъектСтарая = СтрокаГруппы.ОбъектДляКопирования.ПолучитьОбъект();
					
					НоваяНоменклатураОбъект = Справочники.Номенклатура.СоздатьЭлемент();
					
					НоваяНоменклатураОбъект.ОбменДанными.Загрузка = Истина;
					
					ЗаполнитьЗначенияСвойств(НоваяНоменклатураОбъект, ОбъектСтарая,,"Владелец, питВыгружатьВРБК, Код");
					
					НоваяНоменклатураОбъект.Наименование = СтрокаГруппы.НовоеНаименование;
					НоваяНоменклатураОбъект.НаименованиеПолное = СтрокаГруппы.НовоеНаименование;
					НоваяНоменклатураОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияЛитр.Ссылка;
					НоваяНоменклатураОбъект.ИспользоватьУпаковки = Истина;
					НоваяНоменклатураОбъект.НаборУпаковок = Справочники.НаборыУпаковок.ИндивидуальныйДляНоменклатуры;
					НоваяНоменклатураОбъект.Записать();
					
					УпаковкаОбъект = Справочники.УпаковкиЕдиницыИзмерения.СоздатьЭлемент();
					УпаковкаОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияШтуки;
					УпаковкаОбъект.ТипИзмеряемойВеличины = Перечисления.ТипыИзмеряемыхВеличин.Упаковка;
					УпаковкаОбъект.ТипУпаковки = Перечисления.ТипыУпаковокНоменклатуры.Конечная;
					УпаковкаОбъект.Числитель = НоваяНоменклатураОбъект.ОбъемДАЛ * 10;
					УпаковкаОбъект.Знаменатель = 1;
					УпаковкаОбъект.Владелец = НоваяНоменклатураОбъект.Ссылка;
					УпаковкаОбъект.Наименование = ЕдиницаИзмеренияШтуки.Наименование + " (" + СТРОКА(НоваяНоменклатураОбъект.ОбъемДАЛ * 10) + " " + ЕдиницаИзмеренияЛитр.Наименование + ")";
					УпаковкаОбъект.ОбменДанными.Загрузка = Истина;
					УпаковкаОбъект.Записать();
					
					НоваяНоменклатураОбъектДляОбновления = НоваяНоменклатураОбъект.Ссылка.ПолучитьОбъект();
					НоваяНоменклатураОбъектДляОбновления.ОбменДанными.Загрузка = Истина;
					НоваяНоменклатураОбъектДляОбновления.ЕдиницаДляОтчетов = УпаковкаОбъект.Ссылка;
					НоваяНоменклатураОбъектДляОбновления.КоэффициентЕдиницыДляОтчетов = НоваяНоменклатураОбъект.ОбъемДАЛ *10;
					
					НоваяНоменклатураОбъектДляОбновления.Записать();
					
					ДанныеНоменклатуры = Новый Структура();
					ДанныеНоменклатуры.Вставить("Номенклатура",                        НоваяНоменклатураОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("ЕмкостьПотребительскойУпаковки",      НоваяНоменклатураОбъект.ОбъемДАЛ * 10000);
					ДанныеНоменклатуры.Вставить("КоличествоВПотребительскойУпаковке",  НоваяНоменклатураОбъект.ОбъемДАЛ * 10);
					ДанныеНоменклатуры.Вставить("ВариантЧастичногоВыбытия",            Перечисления.ВариантыУчетаЧастичногоВыбытияИС.ТекущаяНоменклатура);
					ДанныеНоменклатуры.Вставить("ВариантИспользованияЕдиницыХранения", Перечисления.ВариантыИспользованияЕдиницыХраненияИС.ЗаданУпаковками);
					ДанныеНоменклатуры.Вставить("ПотребительскаяУпаковка",             УпаковкаОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("УпаковкаЧастичногоВыбытия",           ЕдиницаИзмеренияМиллиЛитр);
			
					РегистрыСведений.ОписаниеНоменклатурыИС.УстановитьОписание(ДанныеНоменклатуры);
					
					МассивСтарыхКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");

					Для Каждого Код Из МассивСтарыхКодов Цикл
						СсылкаНаСтарую = СоответствиеСтарыхСсылок[Код];
						Если СсылкаНаСтарую = Неопределено Тогда
							Продолжить;
						КонецЕсли;

						ВскрытаяСсылка = СоответствиеСтараяКВскрытой[СсылкаНаСтарую];
						
						НоваяСтрокаРегистра = ТЗ_ЗаписиВРегистрПакет.Добавить();
						НоваяСтрокаРегистра.СтараяНоменклатура = СсылкаНаСтарую;
						НоваяСтрокаРегистра.НоваяНоменклатура = НоваяНоменклатураОбъект.Ссылка;
						НоваяСтрокаРегистра.ВскрытаяНоменклатура = ВскрытаяСсылка;					
					КонецЦикла;
					 
				Иначе
					
					КоличествоПропущенныхВПакете = КоличествоПропущенныхВПакете + 1;
					
					СсылкаНаНовуюНоменклатуру = СуществующаяНоменклатура.Ссылка;
					
					ОбъектНовойНоменклатуры = СсылкаНаНовуюНоменклатуру.ПолучитьОбъект();
					ОбъектНовойНоменклатуры.ОбменДанными.Загрузка = Истина;
					
					ОбъектНовойНоменклатуры.Записать();
					
					МассивСтарыхКодов = СтрРазделить(СтрокаГруппы.КодыСтаройНоменклатуры, ";");
					Для Каждого Код Из МассивСтарыхКодов Цикл
						СсылкаНаСтарую = СоответствиеСтарыхСсылок[Код];
						Если СсылкаНаСтарую = Неопределено Тогда
							Продолжить;
						КонецЕсли;

						ВскрытаяСсылка = СоответствиеСтараяКВскрытой[СсылкаНаСтарую];
						
						НоваяСтрокаРегистра = ТЗ_ЗаписиВРегистрПакет.Добавить();
						НоваяСтрокаРегистра.СтараяНоменклатура = СсылкаНаСтарую;
						НоваяСтрокаРегистра.НоваяНоменклатура = СсылкаНаНовуюНоменклатуру;
						НоваяСтрокаРегистра.ВскрытаяНоменклатура = ВскрытаяСсылка;
						
					КонецЦикла;
				
				КонецЕсли;
			
			КонецЦикла;

			ЗафиксироватьТранзакцию();
		
		Исключение
			// В случае ошибки откатываем транзакцию
			ОтменитьТранзакцию();
			Сообщить("Ошибка при создании номенклатуры (пакет " + (НомерПакета + 1) + " из " + КоличествоПакетов + "): " + ОписаниеОшибки());
			ВызватьИсключение "Ошибка при создании номенклатуры: " + ОписаниеОшибки();
		КонецПопытки;
		
		// Промежуточная запись в регистр после каждого пакета для возможности восстановления
		Если ТЗ_ЗаписиВРегистрПакет.Количество() > 0 Тогда
			
			// Записываем каждую запись отдельно через МенеджерЗаписи (избегаем дубликатов)
			Для Каждого СтрокаПакета Из ТЗ_ЗаписиВРегистрПакет Цикл
				
				МенеджерЗаписи = РегистрыСведений.MRS_СоответствиеСтаройНовойНоменклатуры.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.СтараяНоменклатура = СтрокаПакета.СтараяНоменклатура;
				МенеджерЗаписи.НоваяНоменклатура = СтрокаПакета.НоваяНоменклатура;
				МенеджерЗаписи.ВскрытаяНоменклатура = СтрокаПакета.ВскрытаяНоменклатура; 
				МенеджерЗаписи.Записать();
				
			КонецЦикла;
			
			// Добавляем записи пакета в основную таблицу
			Для Каждого СтрокаПакета Из ТЗ_ЗаписиВРегистрПакет Цикл
				НоваяСтрокаОсновной = ТЗ_ЗаписиВРегистр.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрокаОсновной, СтрокаПакета);
			КонецЦикла;
			
		КонецЕсли;
		
		// Обновляем общую статистику
		ОбщееКоличествоСозданных = ОбщееКоличествоСозданных + КоличествоСозданныхВПакете;
		ОбщееКоличествоПропущенных = ОбщееКоличествоПропущенных + КоличествоПропущенныхВПакете;
		
		// Выводим детальный прогресс
		Процент = Окр((НомерПакета + 1) / КоличествоПакетов * 100, 0);
		СообщениеОПрогрессе = "Пакет " + (НомерПакета + 1) + "/" + КоличествоПакетов + " (" + Процент + "%): ";
		СообщениеОПрогрессе = СообщениеОПрогрессе + "создано " + КоличествоСозданныхВПакете + ", пропущено " + КоличествоПропущенныхВПакете;
		СообщениеОПрогрессе = СообщениеОПрогрессе + ". Итого: создано " + ОбщееКоличествоСозданных + ", пропущено " + ОбщееКоличествоПропущенных;
		Сообщить(СообщениеОПрогрессе);
		
	КонецЦикла;
	
	// Финальная проверка и запись оставшихся данных в регистр
	Сообщить("Итого записей в регистре соответствий будет записано: " + ТЗ_ЗаписиВРегистр.Количество());

	// Итоговое сообщение
	Сообщить("=== СОЗДАНИЕ НОМЕНКЛАТУРЫ ЗАВЕРШЕНО ===");
	Сообщить("Всего обработано: " + ВсегоСтрок + " элементов");
	Сообщить("Создано новых: " + ОбщееКоличествоСозданных);
	Сообщить("Пропущено (уже существовали): " + ОбщееКоличествоПропущенных);
	Сообщить("Записей в регистре соответствий: " + ТЗ_ЗаписиВРегистр.Количество());
	
	// Обработка номенклатуры без остатков - изменяем единицу хранения на литры и создаем упаковку
	Если ТЗДляОбновления.Количество() > 0 Тогда
		
		// Обрабатываем номенклатуру без остатков пакетами
		РазмерПакетаОбновления = 5; // Меньший размер пакета для операций обновления
		ВсегоСтрокОбновления = ТЗДляОбновления.Количество();
		КоличествоПакетовОбновления = Цел(ВсегоСтрокОбновления / РазмерПакетаОбновления) + ?(ВсегоСтрокОбновления % РазмерПакетаОбновления = 0, 0, 1);
		
		Для НомерПакетаОбновления = 0 По КоличествоПакетовОбновления - 1 Цикл
			
			НачальныйИндексОбновления = НомерПакетаОбновления * РазмерПакетаОбновления;
			КонечныйИндексОбновления = Мин((НомерПакетаОбновления + 1) * РазмерПакетаОбновления - 1, ВсегоСтрокОбновления - 1);
			
			НачатьТранзакцию();
			
			Попытка
				
				Для ИндексОбновления = НачальныйИндексОбновления По КонечныйИндексОбновления Цикл
					
					СтрокаДляОбновления = ТЗДляОбновления[ИндексОбновления];
					
					НоменклатураОбъект = СтрокаДляОбновления.СерийнаяНоменклатура.ПолучитьОбъект();
					
					// Изменяем единицу хранения остатков на литры
					НоменклатураОбъект.ЕдиницаХраненияОстатков = ЕдиницаИзмеренияЛитр.Ссылка;
					НоменклатураОбъект.ОбменДанными.Загрузка = Истина;
					// Записываем изменения
					НоменклатураОбъект.Записать();
					
					// Создаем упаковку
					УпаковкаОбъект = Справочники.УпаковкиЕдиницыИзмерения.СоздатьЭлемент();
					УпаковкаОбъект.ЕдиницаИзмерения = ЕдиницаИзмеренияШтуки;
					УпаковкаОбъект.ТипИзмеряемойВеличины = Перечисления.ТипыИзмеряемыхВеличин.Упаковка;
					УпаковкаОбъект.ТипУпаковки = Перечисления.ТипыУпаковокНоменклатуры.Конечная;
					УпаковкаОбъект.Числитель = НоменклатураОбъект.ОбъемДАЛ * 10;
					УпаковкаОбъект.Знаменатель = 1;
					УпаковкаОбъект.Владелец = НоменклатураОбъект.Ссылка;
					УпаковкаОбъект.Наименование = ЕдиницаИзмеренияШтуки.Наименование + " (" + СТРОКА(НоменклатураОбъект.ОбъемДАЛ * 10) + " " + ЕдиницаИзмеренияЛитр.Наименование + ")";
					УпаковкаОбъект.ОбменДанными.Загрузка = Истина;
					УпаковкаОбъект.Записать();
					
					// Обновляем номенклатуру с новой упаковкой
					НоменклатураОбъектДляОбновления = НоменклатураОбъект.Ссылка.ПолучитьОбъект();
					НоменклатураОбъектДляОбновления.ОбменДанными.Загрузка = Истина;
					НоменклатураОбъектДляОбновления.ЕдиницаДляОтчетов = УпаковкаОбъект.Ссылка;
					НоменклатураОбъектДляОбновления.КоэффициентЕдиницыДляОтчетов = НоменклатураОбъект.ОбъемДАЛ *10;
					НоменклатураОбъектДляОбновления.Записать();
					
					// Создаем описание для ИС
					ДанныеНоменклатуры = Новый Структура();
					ДанныеНоменклатуры.Вставить("Номенклатура", НоменклатураОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("ЕмкостьПотребительскойУпаковки", НоменклатураОбъект.ОбъемДАЛ * 10000);
					ДанныеНоменклатуры.Вставить("КоличествоВПотребительскойУпаковке", НоменклатураОбъект.ОбъемДАЛ * 10);
					ДанныеНоменклатуры.Вставить("ВариантЧастичногоВыбытия", Перечисления.ВариантыУчетаЧастичногоВыбытияИС.ТекущаяНоменклатура);
					ДанныеНоменклатуры.Вставить("ВариантИспользованияЕдиницыХранения", Перечисления.ВариантыИспользованияЕдиницыХраненияИС.ЗаданУпаковками);
					ДанныеНоменклатуры.Вставить("ПотребительскаяУпаковка", УпаковкаОбъект.Ссылка);
					ДанныеНоменклатуры.Вставить("УпаковкаЧастичногоВыбытия", ЕдиницаИзмеренияМиллиЛитр);
					
					РегистрыСведений.ОписаниеНоменклатурыИС.УстановитьОписание(ДанныеНоменклатуры);
					
				КонецЦикла;
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				// В случае ошибки откатываем транзакцию
				ОтменитьТранзакцию();
				Сообщить("Ошибка при обновлении номенклатуры без остатков (пакет " + (НомерПакетаОбновления + 1) + " из " + КоличествоПакетовОбновления + "): " + ОписаниеОшибки());
				ВызватьИсключение "Ошибка при обновлении номенклатуры без остатков: " + ОписаниеОшибки();
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;


КонецПроцедуры
