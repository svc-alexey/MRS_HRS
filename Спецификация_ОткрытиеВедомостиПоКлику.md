# Спецификация: Открытие отчёта «Ведомость по товарам на складах» по клику на строку ведомости

## 1. Анализ плана реализации

### 1.1. Оценка полноты плана

План в целом **корректен и достаточен** для реализации. Выявлены следующие уточнения и дополнения.

| Пункт плана | Оценка | Комментарий |
|-------------|--------|-------------|
| Замена ОбработатьРасшифровку на ОткрытьВедомостьПоРасшифровке | ✅ | Корректно |
| Клиентская процедура ОткрытьВедомостьПоРасшифровке | ✅ | Нужно уточнить: вызов ДанныеЭлементаРасшифровки — серверный, требуется обёртка |
| ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке | ⚠️ | Нужно уточнить формат Период и ФиксированныеНастройки |
| ФиксированныеНастройки — элемент 0aa40f8c... | ✅ | Элемент найден в схеме СКД, это «Детализация до регистратора» |

### 1.2. Выявленные пропуски

1. **Проверка прав доступа** — перед открытием отчёта нужно проверить `ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьПоТоварамНаСкладах1)`.
2. **Имя отчёта** — в `ObjectModule.bsl` обработки используется `Отчеты.ВедомостьПоТоварамНаСкладах` (без «1»), в конфигурации — `ВедомостьПоТоварамНаСкладах1`. Для открытия формы использовать **`Отчет.ВедомостьПоТоварамНаСкладах1.Форма`**.
3. **Обработка ошибок** — при пустых Склад/Номенклатура — сообщение пользователю, а не тихий возврат.

---

## 2. Структура параметров формы отчёта

### 2.1. Источник: код конфигурации

По коду `CommonForms\ФормаОтчета`, `Documents\УстановкаЦенНоменклатуры`, `Reports\ВедомостьПоТоварамНаСкладах1\Ext\ObjectModule.bsl`:

**Параметры при `ОткрытьФорму("Отчет.ВедомостьПоТоварамНаСкладах1.Форма", ПараметрыФормы, ...)`:**

| Ключ | Тип | Назначение |
|------|-----|------------|
| `Отбор` | Структура | Имя поля СКД → значение (ссылка, массив, СписокЗначений) |
| `Период` | СтандартныйПериод | Параметр данных СКД «Период» (опционально, см. ниже) |
| `КлючНазначенияИспользования` | Строка | Ключ для хранения варианта (напр. `"ВедомостьПоТоварамНаСкладах"`) |
| `СформироватьПриОткрытии` | Булево | Формировать отчёт сразу при открытии |
| `ФиксированныеНастройки` | ПользовательскиеНастройкиКомпоновкиДанных | Фиксированные настройки СКД (опционально) |

### 2.2. Отбор

Структура `Отбор` — соответствие «имя поля набора данных СКД» → значение:

```bsl
Отбор = Новый Структура;
Отбор.Вставить("Склад", Склад);           // СправочникСсылка.Склады
Отбор.Вставить("Номенклатура", Номенклатура);  // СправочникСсылка.Номенклатура
Если ЗначениеЗаполнено(Характеристика) Тогда
    Отбор.Вставить("Характеристика", Характеристика);
КонецЕсли;
Если ЗначениеЗаполнено(Серия) Тогда
    Отбор.Вставить("Серия", Серия);
КонецЕсли;
```

Применение: `ОтчетыСервер.УстановитьФиксированныеОтборы(ФормаПараметры.Отбор, ...)` в `ПриЗагрузкеВариантаНаСервере` формы отчёта.

### 2.3. Период

Период — параметр данных СКД, а не отбор. В форме отчёта он задаётся через настройки варианта. Передача через параметры формы:

- В типовой форме `Период` может передаваться в `Отбор` или отдельным параметром.
- В `ObjectModule` отчёта ВедомостьПоТоварамНаСкладах1 период не обрабатывается в `ПриСозданииНаСервере`.
- Рекомендация: передавать `Период` в `ПараметрыФормы.Вставить("Период", СтандартныйПериод)` и обрабатывать в `ПриСозданииНаСервере` / `ПередЗагрузкойНастроекВКомпоновщик` модуля объекта отчёта, устанавливая значение параметра «Период» в настройках компоновки.

Альтернатива: использовать `ФиксированныеНастройки` и задать параметр «Период» в `ПараметрыДанных` настроек.

### 2.4. ФиксированныеНастройки (вывод регистраторов)

Элемент «Детализация до регистратора» в схеме СКД:

- **userSettingID:** `0aa40f8c-f84d-471c-934d-a28047daeced`
- **Расположение:** `Template.xml`, `StructureItemGroup` с `GroupItemField` = «Регистратор», `use="false"` по умолчанию.

Для включения детализации до регистратора:

1. Получить схему: `Отчеты.ВедомостьПоТоварамНаСкладах1.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных")`.
2. Получить `НастройкиПоУмолчанию` схемы.
3. В `Настройки.Структура` найти элемент (рекурсивно) с `ИдентификаторПользовательскойНастройки = "0aa40f8c-f84d-471c-934d-a28047daeced"`.
4. Установить `Элемент.Использование = Истина`.
5. Сформировать `ПользовательскиеНастройкиКомпоновкиДанных` из модифицированных настроек и передать в `ФиксированныеНастройки`.

Важно: `ФиксированныеНастройки` — это `ПользовательскиеНастройкиКомпоновкиДанных`, а не `НастройкиКомпоновкиДанных`. В форме отчёта используется `КомпоновщикНастроек.ЗагрузитьФиксированныеНастройки(...)`. Нужно проверить, как формировать и передавать фиксированные настройки при программном открытии формы.

---

## 3. Имена полей расшифровки

### 3.1. Источник данных расшифровки

`ДанныеЭлементаРасшифровки(Расшифровка)` возвращает структуру, где ключи — имена полей из `ЭлементРасшифровки.ПолучитьПоля()` (поле `Поле.Поле`).

### 3.2. Схема СКД ведомости

В `СформироватьВедомость` используется схема `Отчеты.ВедомостьПоТоварамНаСкладах.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных")` (в конфигурации — `ВедомостьПоТоварамНаСкладах1`).

Поля набора данных (из `Template.xml`):

| Поле | Тип | Примечание |
|------|-----|------------|
| `Склад` | СправочникСсылка.Склады | Измерение |
| `Номенклатура` | СправочникСсылка.Номенклатура | Измерение |
| `Характеристика` | СправочникСсылка.ХарактеристикиНоменклатуры | Измерение |
| `Серия` | СправочникСсылка.СерииНоменклатуры | Измерение |
| `Регистратор` | ДокументСсылка (обобщённый) | Регистратор |
| `КонечныйОстаток` | Число | Ресурс |
| `НачальныйОстаток`, `Приход`, `Расход` | Число | Ресурсы |

### 3.3. Ожидаемые имена в расшифровке

С учётом группировки по умолчанию (Склад → Номенклатура → …) в расшифровке ожидаются:

- **Склад** — обязательно
- **Номенклатура** — обязательно
- **Характеристика** — при использовании характеристик
- **Серия** — при партионном учёте

Дополнительно могут быть: `Регистратор`, `КонечныйОстаток`, `НачальныйОстаток`, `Приход`, `Расход` и др., в зависимости от уровня расшифровки.

### 3.4. Рекомендация

В `ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке` использовать поля:

```bsl
Склад       = Данные.Свойство("Склад");
Номенклатура = Данные.Свойство("Номенклатура");
Характеристика = Данные.Свойство("Характеристика");
Серия       = Данные.Свойство("Серия");
```

Проверять заполненность только для **Склад** и **Номенклатура** — они обязательны для отбора.

---

## 4. Риски и краевые случаи

| Риск | Влияние | Рекомендация |
|------|---------|--------------|
| Пустые Склад/Номенклатура в расшифровке | Отчёт не откроется или откроется без отбора | Проверять перед открытием, при отсутствии — сообщение пользователю |
| Расшифровка с вкладки «Отчет сверки» | Обработчики общие для ВедомостьОтчет и ОтчетСверка | Ограничить логику только ВедомостьОтчет (проверка `АдресДанныхРасшифровки` или контекст) |
| `ДанныеЭлементаРасшифровки` = Неопределено | Временное хранилище очищено или неверный идентификатор | Обработать, не вызывать `ПоказатьЗначение` |
| Отсутствие прав на отчёт | Ошибка при открытии | Проверить `ПравоДоступа("Просмотр", ...)` до открытия |
| Имя отчёта ВедомостьПоТоварамНаСкладах vs ВедомостьПоТоварамНаСкладах1 | Ошибка «Объект не найден» | Использовать `Отчет.ВедомостьПоТоварамНаСкладах1.Форма` |
| Период не передан | Отчёт с периодом по умолчанию | Явно передавать `Период` в параметрах формы |
| ФиксированныеНастройки не применяются | Регистраторы не выводятся | Проверить способ передачи и загрузки в форме отчёта |

---

## 5. Итоговая спецификация для разработчика

### 5.1. Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `DataProcessors/MRS_АРМ_Закрытия_смены/Forms/Форма/Ext/Form/Module.bsl` | Обработчики расшифровки, процедура `ОткрытьВедомостьПоРасшифровке`, функция `ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке` |
| `Reports/ВедомостьПоТоварамНаСкладах1/Ext/ObjectModule.bsl` | При необходимости — обработка параметра `Период` в `ПриСозданииНаСервере` |

### 5.2. Изменения в модуле формы обработки

#### 5.2.1. Обработчики ВедомостьОтчет (строки 166–178)

**Было:**
```bsl
Процедура ВедомостьОтчетОбработкаРасшифровки(...)
    СтандартнаяОбработка = Ложь;
    ОбработатьРасшифровку(Расшифровка);
КонецПроцедуры

Процедура ВедомостьОтчетОбработкаДополнительнойРасшифровки(...)
    СтандартнаяОбработка = Ложь;
    ОбработатьРасшифровку(Расшифровка);
КонецПроцедуры
```

**Станет:**
```bsl
Процедура ВедомостьОтчетОбработкаРасшифровки(...)
    СтандартнаяОбработка = Ложь;
    ОткрытьВедомостьПоРасшифровке(Расшифровка);
КонецПроцедуры

Процедура ВедомостьОтчетОбработкаДополнительнойРасшифровки(...)
    СтандартнаяОбработка = Ложь;
    ОткрытьВедомостьПоРасшифровке(Расшифровка);
КонецПроцедуры
```

#### 5.2.2. Новая процедура ОткрытьВедомостьПоРасшифровке (клиент)

**Сигнатура:** `Процедура ОткрытьВедомостьПоРасшифровке(Расшифровка)`

**Логика:**
1. Вызвать `ДанныеЭлементаРасшифровки(Расшифровка)` (сервер).
2. Если результат = Неопределено или не Структура — выход.
3. Вызвать `ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке(Данные)` (сервер).
4. Если результат = Неопределено — выход (сообщение уже показано на сервере).
5. `ОткрытьФорму("Отчет.ВедомостьПоТоварамНаСкладах1.Форма", Результат, ЭтотОбъект, Новый УникальныйИдентификатор)`.

#### 5.2.3. Новая функция ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке (сервер)

**Сигнатура:** `Функция ПодготовитьПараметрыОткрытияВедомостиПоРасшифровке(ДанныеРасшифровки)`

**Параметры:**
- `ДанныеРасшифровки` — Структура, ключи: `Склад`, `Номенклатура`, `Характеристика`, `Серия` и др.

**Возврат:** Структура параметров формы или Неопределено при ошибке.

**Логика:**
1. Проверить `ПравоДоступа("Просмотр", Метаданные.Отчеты.ВедомостьПоТоварамНаСкладах1)`. При отсутствии — сообщение, возврат Неопределено.
2. `Склад = ДанныеРасшифровки.Свойство("Склад")`, `Номенклатура = ДанныеРасшифровки.Свойство("Номенклатура")`.
3. Если не заполнены Склад или Номенклатура — сообщение, возврат Неопределено.
4. Сформировать `Отбор` — Структура: Склад, Номенклатура; при наличии — Характеристика, Серия.
5. Сформировать `Период` — `СтандартныйПериод` с `Объект.НачалоПериода`, `Объект.КонецПериода`.
6. Сформировать `ФиксированныеНастройки` — включить элемент с `ИдентификаторПользовательскойНастройки = "0aa40f8c-f84d-471c-934d-a28047daeced"`.
7. Собрать `ПараметрыФормы`:
   - `Отбор`
   - `Период`
   - `ФиксированныеНастройки` (если удалось сформировать)
   - `КлючНазначенияИспользования` = `"ВедомостьПоТоварамНаСкладах"`
   - `СформироватьПриОткрытии` = Истина
8. Вернуть `ПараметрыФормы`.

### 5.3. Структура ПараметрыФормы

```bsl
ПараметрыФормы = Новый Структура;
ПараметрыФормы.Вставить("Отбор", Отбор);  // Структура: Склад, Номенклатура [, Характеристика, Серия]
ПараметрыФормы.Вставить("Период", СтандартныйПериод);
ПараметрыФормы.Вставить("ФиксированныеНастройки", ФиксированныеНастройки);  // ПользовательскиеНастройкиКомпоновкиДанных
ПараметрыФормы.Вставить("КлючНазначенияИспользования", "ВедомостьПоТоварамНаСкладах");
ПараметрыФормы.Вставить("СформироватьПриОткрытии", Истина);
```

### 5.4. Доработка ObjectModule отчёта (при необходимости)

Если период из параметров формы не подхватывается автоматически, в `ПриСозданииНаСервере` или `ПередЗагрузкойНастроекВКомпоновщик` добавить:

```bsl
Если Параметры.Свойство("Период") И ТипЗнч(Параметры.Период) = Тип("СтандартныйПериод") Тогда
    // Установить параметр Период в настройках компоновки
    // (конкретная реализация зависит от момента загрузки настроек)
КонецЕсли;
```

### 5.5. Обработка ошибок

- Пустые Склад/Номенклатура: `ОбщегоНазначенияКлиент.СообщитьПользователю("Для открытия ведомости необходимо выбрать строку с указанием склада и номенклатуры")`.
- Нет прав: `ОбщегоНазначенияКлиент.СообщитьПользователю("Недостаточно прав для просмотра отчёта «Ведомость по товарам на складах»")`.
- `ДанныеЭлементаРасшифровки = Неопределено`: тихий выход (данные расшифровки недоступны).

---

## 6. Проверка после реализации

1. Клик по строке ведомости с заполненными Склад и Номенклатура → открывается отчёт с отборами и детализацией до регистратора.
2. Клик по строке без Склад или Номенклатура → сообщение, отчёт не открывается.
3. Период в отчёте соответствует `Объект.НачалоПериода` и `Объект.КонецПериода`.
4. В отчёте отображаются регистраторы (детализация до регистратора).
5. Обработчики «Отчет сверки» (ОтчетСверкаОбработкаРасшифровки) продолжают использовать `ОбработатьРасшифровку` — без изменений.
