////////////////////////////////////////////////////////////////////////////////
// Модуль HTTP сервиса для приема callback от ЕЛМА
//
// Обеспечивает прием обновлений статусов процессов согласования от ЕЛМА
// в режиме реал-тайм (callback-архитектура)
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Обрабатывает callback от ЕЛМА с обновлением статуса процесса
// POST /callback
//
// Входящий JSON (RequestErp):
// {
//   "Uid_ERP": "550e8400-e29b-41d4-a716-446655440000",
//   "Uid_Elma": "262d1c28-1711-4e9d-b65c-65d8ed8c0d68",
//   "Status": "НаСогласовании|Согласован|Подписан|Отклонен|Отменен",
//   "URLProcess": "https://elma.company.ru/process/12345"
// }
//
// Исходящий JSON (ResponseERP):
// {
//   "Status": "OK|Error",
//   "Error": "",
//   "Uid_ERP": "550e8400-e29b-41d4-a716-446655440000"
// }
//
Функция ШаблонURL_callbackPOST(Запрос)
	
	ОтветСтруктура = Новый Структура("Status, Error, Uid_ERP", "Error", "", "");
	КодОтвета = 200;
	
	Попытка
		
		// 1. Чтение тела запроса
		ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
		
		Если ПустаяСтрока(ТелоЗапроса) Тогда
			
			ОтветСтруктура.Error = "Тело запроса пустое";
			КодОтвета = 400;
			
		Иначе
			
			// 2. Парсинг JSON
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
			RequestErp = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			// 3. Валидация входящих данных
			РезультатВалидации = ВалидироватьRequestErp(RequestErp);
			
			Если НЕ РезультатВалидации.Успех Тогда
				
				ОтветСтруктура.Error = РезультатВалидации.ТекстОшибки;
				Если RequestErp.Свойство("Uid_ERP") Тогда
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
				КонецЕсли;
				КодОтвета = 400;
				
			Иначе
				
				// 4. Обработка callback
				РезультатОбработки = MRS_ИнтеграцияЕЛМАСервер.ОбработатьCallbackОтЕЛМА(RequestErp, ТелоЗапроса);
				
				Если РезультатОбработки.Успех Тогда
					
					ОтветСтруктура.Status = "OK";
					ОтветСтруктура.Error = "";
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
					КодОтвета = 200;
					
				Иначе
					
					ОтветСтруктура.Status = "Error";
					ОтветСтруктура.Error = РезультатОбработки.ТекстОшибки;
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
					КодОтвета = 404; // Документ не найден
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	Исключение
		
		ОтветСтруктура.Status = "Error";
		ОтветСтруктура.Error = "Внутренняя ошибка сервера: " + КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		КодОтвета = 500;
		
		// Логирование критической ошибки
		ЗаписьЖурналаРегистрации("MRS.ЕЛМА.Callback", 
			УровеньЖурналаРегистрации.Ошибка,,, 
			"Критическая ошибка обработки callback: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
	КонецПопытки;
	
	// Формирование HTTP ответа
	Ответ = Новый HTTPСервисОтвет(КодОтвета);
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	// Сериализация ответа в JSON
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ОтветСтруктура);
	JSONОтвет = ЗаписьJSON.Закрыть();
	
	Ответ.УстановитьТелоИзСтроки(JSONОтвет, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	
	Возврат Ответ;
	
КонецФункции


Функция ШаблонURL_2_1POST(Запрос)
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	// записать в лог запрос до обработки
	СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
	СтруктураДанныхЗапроса.Вставить("Ссылка","");
	СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на создание перемещения в 1с");
	СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_1");
	СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
	СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
	СтруктураДанныхЗапроса.Вставить("Ответ","До обработки запроса");
	СтруктураДанныхЗапроса.Вставить("UIDELMA","");
	
	ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);

	СтруктураЗапроса = ПЛ_ОбменELMA.ПЛ_ПрочитатьХМЛ_в_Структуру(ТекстВходящегоЗапроса);
	
	Попытка
	
		Результат=ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_2_1(СтруктураЗапроса);
		
		Если ЗначениеЗаполнено(Результат.Ссылка) Тогда
			СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
			СтруктураДанныхЗапроса.Вставить("Ссылка",Результат.Ссылка);
			СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на создание перемещения в 1с");
			СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_1");
			СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
			СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
			СтруктураДанныхЗапроса.Вставить("Ответ",Результат.Ответ);
			СтруктураДанныхЗапроса.Вставить("UIDELMA",Результат.UIDELMA);
		
			ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		КонецЕсли;

		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
				
		Ответ = Новый HTTPСервисОтвет(400);
		
	    Ответ.УстановитьТелоИзСтроки(ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_2_1(1, ОписаниеОшибки()));
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
	КонецПопытки;

КонецФункции

Функция ШаблонURL_2_2POST(Запрос)
	
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	// записать в лог запрос до обработки
	СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
	СтруктураДанныхЗапроса.Вставить("Ссылка","");
	СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на создание заявки на закупку в 1С");
	СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_2");
	СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
	СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
	СтруктураДанныхЗапроса.Вставить("Ответ","До обработки запроса");
	СтруктураДанныхЗапроса.Вставить("UIDELMA","");
		
	ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
	
	ОбъектЗапрос = ПЛ_ОбменELMA.ПЛ_ПрочитатьХМЛ(ТекстВходящегоЗапроса);
	Если ТипЗнч(ОбъектЗапрос)=Тип("Строка") ТОгда
		РезультатОтвет=ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_2_2(1,ОбъектЗапрос);
		СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
		СтруктураДанныхЗапроса.Вставить("Ссылка","");
		СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на создание заявки на закупку в 1С");
		СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_2");
		СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
		СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
		СтруктураДанныхЗапроса.Вставить("Ответ",РезультатОтвет);
		СтруктураДанныхЗапроса.Вставить("UIDELMA","");
		
		ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		
		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(РезультатОтвет);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;

	КонецЕсли;

	Попытка
	
		Результат = ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_2_2(ОбъектЗапрос,ТекстВходящегоЗапроса);
		
		Если Не ЗначениеЗаполнено(Результат.Ссылка) Тогда     // была ошибка при разборе запроса
			СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
			СтруктураДанныхЗапроса.Вставить("Ссылка",Результат.Ссылка);
			СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на создание заявки на закупку в 1С");
			СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_2");
			СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
			СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
			СтруктураДанныхЗапроса.Вставить("Ответ",Результат.Ответ);
			СтруктураДанныхЗапроса.Вставить("UIDELMA",Результат.UIDELMA);
		
			ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		КонецЕсли;

		
		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
		Ответ = Новый HTTPСервисОтвет(400);
		
	    Ответ.УстановитьТелоИзСтроки(ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_2_2(1, ОписаниеОшибки()));
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
	КонецПопытки;
КонецФункции

Функция ШаблонURL_2_3POST(Запрос)
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	
	// записать в лог запрос до обработки
	СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
	СтруктураДанныхЗапроса.Вставить("Ссылка","");
	СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на начисление резерва в 1С");
	СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_3");
	СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
	СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
	СтруктураДанныхЗапроса.Вставить("Ответ","До обработки запроса");
	СтруктураДанныхЗапроса.Вставить("UIDELMA","");
		
	ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);

	СтруктураЗапроса = ПЛ_ОбменELMA.ПЛ_ПрочитатьХМЛ_в_Структуру(ТекстВходящегоЗапроса);
	
	Попытка
	
		Результат=ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_2_3(СтруктураЗапроса);
		
		Если ЗначениеЗаполнено(Результат.Ссылка) Тогда
			СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
			СтруктураДанныхЗапроса.Вставить("Ссылка",Результат.Ссылка);
			СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение запроса на начисление резерва в 1С");
			СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_3");
			СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
			СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
			СтруктураДанныхЗапроса.Вставить("Ответ",Результат.Ответ);
			СтруктураДанныхЗапроса.Вставить("UIDELMA",Результат.UIDELMA);
		
			ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		КонецЕсли;

		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
		Ответ = Новый HTTPСервисОтвет(400);
		
	    Ответ.УстановитьТелоИзСтроки(ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_2_3(1, ОписаниеОшибки()));
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
	КонецПопытки;

КонецФункции

Функция ШаблонURL_1_7POST(Запрос)
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	
	СтруктураЗапроса = ПЛ_ОбменELMA.ПЛ_ПрочитатьХМЛ_в_Структуру(ТекстВходящегоЗапроса);
	
	Попытка
	
		Результат=ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_1_7(СтруктураЗапроса);
		
		Если ЗначениеЗаполнено(Результат.Ссылка) Тогда
			СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
			СтруктураДанныхЗапроса.Вставить("Ссылка",Результат.Ссылка);
			СтруктураДанныхЗапроса.Вставить("ТипЗапроса","1С - снятие резерва");
			СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_1_7(");
			СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
			СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
			СтруктураДанныхЗапроса.Вставить("Ответ",Результат.Ответ);
			СтруктураДанныхЗапроса.Вставить("UIDELMA",Результат.UIDELMA);
			
			ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		КонецЕсли;


		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
		Ответ = Новый HTTPСервисОтвет(400);
		
	    Ответ.УстановитьТелоИзСтроки(ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_1_7(1, ОписаниеОшибки()));
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
	КонецПопытки;

КонецФункции

Функция ШаблонURL_1_12POST(Запрос)
	
	Попытка
	    ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	
		СтруктураЗапроса = ПЛ_ОбменELMA.ПЛ_ПрочитатьХМЛ_в_Структуру(ТекстВходящегоЗапроса);
		
		Результат = ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_1_12(СтруктураЗапроса);
		
		СтруктураДанныхЗапроса = ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
		СтруктураДанныхЗапроса.Вставить("Ссылка", Неопределено);
		СтруктураДанныхЗапроса.Вставить("IDРесурса", "");
		СтруктураДанныхЗапроса.Вставить("ТипЗапроса", "Обновление остатка по номенклатуре и складу");
		СтруктураДанныхЗапроса.Вставить("ИмяМетода", "ПЛ_ОбработкаСтруктурыЗапроса_1_12");
		СтруктураДанныхЗапроса.Вставить("ДатаОтправки", Результат.Дата);
		СтруктураДанныхЗапроса.Вставить("Запрос", ТекстВходящегоЗапроса);
		СтруктураДанныхЗапроса.Вставить("Ответ", Результат.Ответ);
		СтруктураДанныхЗапроса.Вставить("UIDELMA", "");
		
		ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);

		Ответ = Новый HTTPСервисОтвет(Результат.Статус);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
				
	    Возврат Ответ;
	
	Исключение
		
		Ответ = Новый HTTPСервисОтвет(400);
		
	    Ответ.УстановитьТелоИзСтроки(ПЛ_ОбменELMA.ПЛ_СформироватьСтатусОтвета_1_12(1, ОписаниеОшибки()));
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
		
	КонецПопытки;
КонецФункции

Функция ШаблонURL_2_4POST(Запрос)
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
		
	Попытка
	
		Результат=ПЛ_ОбменELMA.ПЛ_ОбработкаСтруктурыЗапроса_2_4(ТекстВходящегоЗапроса);
		
		Если ЗначениеЗаполнено(Результат.Ссылка) Тогда
			СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
			СтруктураДанныхЗапроса.Вставить("Ссылка",Результат.Ссылка);
			СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Ответ на получение заявки на закуп по MinMax из ERP ");
			СтруктураДанныхЗапроса.Вставить("ИмяМетода","ПЛ_ОбработкаСтруктурыЗапроса_2_4");
			СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
			СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
			СтруктураДанныхЗапроса.Вставить("Ответ",Результат.Ответ);
			СтруктураДанныхЗапроса.Вставить("UIDELMA",Результат.UIDELMA);
			
			ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		КонецЕсли;


		Ответ = Новый HTTPСервисОтвет(200);
		
	    Ответ.УстановитьТелоИзСтроки(Результат.Ответ);
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
		
	КонецПопытки;

КонецФункции

Функция ШаблонURL_front_compliancePOST(Запрос)
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	
	// записать в лог запрос до обработки
	СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
	СтруктураДанныхЗапроса.Вставить("Ссылка","");
	СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение соответсвий кнопки фронта и номенклатуры");
	СтруктураДанныхЗапроса.Вставить("ИмяМетода","MRS_ОбработкаСтруктурыСоответсвийФронта");
	СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
	СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
	СтруктураДанныхЗапроса.Вставить("Ответ","До обработки запроса");
	СтруктураДанныхЗапроса.Вставить("UIDELMA","");
		
	ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
	
	Попытка
	
		Результат = ПЛ_ОбменELMA.MRS_ОбработкаСтруктурыСоответсвийФронта(ТекстВходящегоЗапроса);
		
		СтруктураДанныхЗапроса=ПЛ_ОбменELMA.СоздатьСтруктуруДанныхЗапроса();
		СтруктураДанныхЗапроса.Вставить("Ссылка","");
		СтруктураДанныхЗапроса.Вставить("ТипЗапроса","Получение соответсвий кнопки фронта и номенклатуры");
		СтруктураДанныхЗапроса.Вставить("ИмяМетода","MRS_ОбработкаСтруктурыСоответсвийФронта");
		СтруктураДанныхЗапроса.Вставить("ДатаОтправки",ТекущаяДата());
		СтруктураДанныхЗапроса.Вставить("Запрос",ТекстВходящегоЗапроса);
		СтруктураДанныхЗапроса.Вставить("Ответ",Результат.ТекстОшибки);
		СтруктураДанныхЗапроса.Вставить("UIDELMA","");
	
		ПЛ_ОбменELMA.ПЛ_ЗаписьЛогаЗапросов(СтруктураДанныхЗапроса);
		
		Если Результат.ЕстьОшибки Тогда
			
			Ответ = Новый HTTPСервисОтвет(400);
			
			ОтветТекст = ПЛ_ОбменELMA.MRS_СформироватьСтатусОтвета_ЗаписатьСоответствияФронта(1, Результат.ТекстОшибки);
		
			Ответ.УстановитьТелоИзСтроки(ОтветТекст);
			
			
		Иначе
			
			РезультатЗаписи = ПЛ_ОбменELMA.MRS_ЗаписатьСоответствияФронта(Результат.Соответствия);	
			
			Ответ = Новый HTTPСервисОтвет(200); 
			
			ОтветТекст = ПЛ_ОбменELMA.MRS_СформироватьСтатусОтвета_ЗаписатьСоответствияФронта(0);
				
			Ответ.УстановитьТелоИзСтроки(ОтветТекст);
			
		КонецЕсли;
		
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		
	    Возврат Ответ;
	
	Исключение
		
		Ответ = Новый HTTPСервисОтвет(400);
		
		ИнформОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
			
		ОтветТекст = ПЛ_ОбменELMA.MRS_СформироватьСтатусОтвета_ЗаписатьСоответствияФронта(1, ИнформОшибки);
		
		Ответ.УстановитьТелоИзСтроки(ОтветТекст);
		
		Ответ.Заголовки.Вставить("Content-Type","application/xml; charset=utf-8");
		
	    Возврат Ответ;
		
	КонецПопытки;

КонецФункции

Функция ШаблонURL_get_itemsPOST(Запрос)
	
	ТекстВходящегоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
	
	Попытка
		
		Результат = ПЛ_ОбменELMA.ОбработатьОтветПоискНоменклатуры(ТекстВходящегоЗапроса);
		
		Ответ = Новый HTTPСервисОтвет(200);
	
		Ответ.УстановитьТелоИзСтроки(Результат);
		
	Исключение
		
		Ответ = Новый HTTPСервисОтвет(400);
		Результат = ПЛ_ОбменELMA.MRS_СформироватьСтатусОтвета_ПоискНоменклатуры(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
		Ответ.УстановитьТелоИзСтроки(Результат);
		Возврат Ответ;
		
	КонецПопытки;
	
	Возврат Ответ;
		
КонецФункции

Функция ШаблонURL_5_0POST(Запрос)
	
	ТекстВходящегоЗапроса = битОбмен.тсмЗаписьЛогаВходящегоЗапроса(Запрос,"5_0");
	Структ =  битОбмен.тсмПрочитатьХМЛ_в_Структуру_ТЗ_5_0(ТекстВходящегоЗапроса);
	
		Результат = битОбмен.тсмОбработкаСтруктурыЗапроса_5_0(Структ);
		
		битОбмен.тсмЗаписьЛогаИсходящегоЗапроса(Результат,"5_0_Ответ");
		
	    Ответ = Новый HTTPСервисОтвет(200);
		Ответ.УстановитьТелоИзСтроки(Результат);
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
		Возврат Ответ;

КонецФункции

Функция ШаблонURL_4_1_POST(Запрос)
	
	ТекстВходящегоЗапроса = битОбмен.тсмЗаписьЛогаВходящегоЗапроса(Запрос, "4.1");
	
	Структ = битОбмен.тсмПрочитатьХМЛ_в_Структуру(ТекстВходящегоЗапроса);
	
	Попытка
	
		Результат = битОбмен.тсмОбработкаСтруктурыЗапроса_4_1(Структ);
		битОбмен.тсмЗаписьЛогаИсходящегоЗапроса(Результат,"4_1_Ответ");
		Ответ = Новый HTTPСервисОтвет(200);
	    Ответ.УстановитьТелоИзСтроки(Результат);
		Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
	    Возврат Ответ;
	
	Исключение
		Возврат битОбмен.тсмСформироватьСтатусОтвета(1,"Ошибка " + ОписаниеОшибки());
	КонецПопытки;

КонецФункции

//Деев 17.10.2025 CPM-280 Загрузка ОС из Элма через 1С УХ
Функция ШаблонURL_OrdersPOST(Запрос)
	
	ТекстВходящегоЗапроса = битОбмен.тсмЗаписьЛогаВходящегоЗапроса(Запрос, "orders");

	Структ = битОбмен.ПрочитатьXMLСВложеннымиМассивами(ТекстВходящегоЗапроса);

	Результат = битОбмен.MRS_orders_POST_Обработчик(Структ);
	
	битОбмен.тсмЗаписьЛогаИсходящегоЗапроса(Результат,"orders_Ответ");
	
	Ответ = Новый HTTPСервисОтвет(200);
	
	Ответ.УстановитьТелоИзСтроки(Результат);
	
	Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
	
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Валидирует входящие данные от ЕЛМА
//
// Параметры:
//  RequestErp - Структура - данные от ЕЛМА
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ТекстОшибки - Строка
//
Функция ВалидироватьRequestErp(RequestErp)
	
	Результат = Новый Структура("Успех, ТекстОшибки", Истина, "");
	
	// Проверка типа данных
	Если ТипЗнч(RequestErp) <> Тип("Структура") И ТипЗнч(RequestErp) <> Тип("Соответствие") Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Неверный формат JSON";
		Возврат Результат;
		
	КонецЕсли;
	
	// Проверка обязательных полей
	Если НЕ RequestErp.Свойство("Uid_ERP") Или НЕ ЗначениеЗаполнено(RequestErp.Uid_ERP) Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Uid_ERP не заполнен";
		Возврат Результат;
		
	КонецЕсли;
	
	Если НЕ RequestErp.Свойство("Status") Или НЕ ЗначениеЗаполнено(RequestErp.Status) Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Status не заполнен";
		Возврат Результат;
		
	КонецЕсли;
	
	// Проверка допустимости статуса
	ДопустимыеСтатусы = Новый Массив;
	ДопустимыеСтатусы.Добавить("Не согласовано");
	ДопустимыеСтатусы.Добавить("Согласован");
	ДопустимыеСтатусы.Добавить("Подписан");
	ДопустимыеСтатусы.Добавить("На подписании");
	ДопустимыеСтатусы.Добавить("Отправлен на согласование"); 
	ДопустимыеСтатусы.Добавить("В архиве");
	ДопустимыеСтатусы.Добавить("Действует");
		
	Если ДопустимыеСтатусы.Найти(RequestErp.Status) = Неопределено Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = СтрШаблон("Недопустимый статус: %1", RequestErp.Status);
		Возврат Результат;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

