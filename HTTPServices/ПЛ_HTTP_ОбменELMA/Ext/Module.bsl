////////////////////////////////////////////////////////////////////////////////
// Модуль HTTP сервиса для приема callback от ЕЛМА
//
// Обеспечивает прием обновлений статусов процессов согласования от ЕЛМА
// в режиме реал-тайм (callback-архитектура)
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Обрабатывает callback от ЕЛМА с обновлением статуса процесса
// POST /callback
//
// Входящий JSON (RequestErp):
// {
//   "Uid_ERP": "550e8400-e29b-41d4-a716-446655440000",
//   "Uid_Elma": "262d1c28-1711-4e9d-b65c-65d8ed8c0d68",
//   "Status": "НаСогласовании|Согласован|Подписан|Отклонен|Отменен",
//   "URLProcess": "https://elma.company.ru/process/12345"
// }
//
// Исходящий JSON (ResponseERP):
// {
//   "Status": "OK|Error",
//   "Error": "",
//   "Uid_ERP": "550e8400-e29b-41d4-a716-446655440000"
// }
//
Функция ШаблонURL_callbackPOST(Запрос)
	
	ОтветСтруктура = Новый Структура("Status, Error, Uid_ERP", "Error", "", "");
	КодОтвета = 200;
	
	Попытка
		
		// 1. Чтение тела запроса
		ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
		
		Если ПустаяСтрока(ТелоЗапроса) Тогда
			
			ОтветСтруктура.Error = "Тело запроса пустое";
			КодОтвета = 400;
			
		Иначе
			
			// 2. Парсинг JSON
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
			RequestErp = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			// 3. Валидация входящих данных
			РезультатВалидации = ВалидироватьRequestErp(RequestErp);
			
			Если НЕ РезультатВалидации.Успех Тогда
				
				ОтветСтруктура.Error = РезультатВалидации.ТекстОшибки;
				Если RequestErp.Свойство("Uid_ERP") Тогда
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
				КонецЕсли;
				КодОтвета = 400;
				
			Иначе
				
				// 4. Обработка callback
				РезультатОбработки = MRS_ИнтеграцияЕЛМАСервер.ОбработатьCallbackОтЕЛМА(RequestErp, ТелоЗапроса);
				
				Если РезультатОбработки.Успех Тогда
					
					ОтветСтруктура.Status = "OK";
					ОтветСтруктура.Error = "";
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
					КодОтвета = 200;
					
				Иначе
					
					ОтветСтруктура.Status = "Error";
					ОтветСтруктура.Error = РезультатОбработки.ТекстОшибки;
					ОтветСтруктура.Uid_ERP = RequestErp.Uid_ERP;
					КодОтвета = 404; // Документ не найден
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	Исключение
		
		ОтветСтруктура.Status = "Error";
		ОтветСтруктура.Error = "Внутренняя ошибка сервера: " + КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		КодОтвета = 500;
		
		// Логирование критической ошибки
		ЗаписьЖурналаРегистрации("MRS.ЕЛМА.Callback", 
			УровеньЖурналаРегистрации.Ошибка,,, 
			"Критическая ошибка обработки callback: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
	КонецПопытки;
	
	// Формирование HTTP ответа
	Ответ = Новый HTTPСервисОтвет(КодОтвета);
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	// Сериализация ответа в JSON
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ОтветСтруктура);
	JSONОтвет = ЗаписьJSON.Закрыть();
	
	Ответ.УстановитьТелоИзСтроки(JSONОтвет, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Валидирует входящие данные от ЕЛМА
//
// Параметры:
//  RequestErp - Структура - данные от ЕЛМА
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево
//   * ТекстОшибки - Строка
//
Функция ВалидироватьRequestErp(RequestErp)
	
	Результат = Новый Структура("Успех, ТекстОшибки", Истина, "");
	
	// Проверка типа данных
	Если ТипЗнч(RequestErp) <> Тип("Структура") И ТипЗнч(RequestErp) <> Тип("Соответствие") Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Неверный формат JSON";
		Возврат Результат;
		
	КонецЕсли;
	
	// Проверка обязательных полей
	Если НЕ RequestErp.Свойство("Uid_ERP") Или НЕ ЗначениеЗаполнено(RequestErp.Uid_ERP) Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Uid_ERP не заполнен";
		Возврат Результат;
		
	КонецЕсли;
	
	Если НЕ RequestErp.Свойство("Status") Или НЕ ЗначениеЗаполнено(RequestErp.Status) Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = "Status не заполнен";
		Возврат Результат;
		
	КонецЕсли;
	
	// Проверка допустимости статуса
	ДопустимыеСтатусы = Новый Массив;
	ДопустимыеСтатусы.Добавить("НаСогласовании");
	ДопустимыеСтатусы.Добавить("Согласован");
	ДопустимыеСтатусы.Добавить("Подписан");
	ДопустимыеСтатусы.Добавить("Отклонен");
	ДопустимыеСтатусы.Добавить("Отменен");
	
	Если ДопустимыеСтатусы.Найти(RequestErp.Status) = Неопределено Тогда
		
		Результат.Успех = Ложь;
		Результат.ТекстОшибки = СтрШаблон("Недопустимый статус: %1", RequestErp.Status);
		Возврат Результат;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти